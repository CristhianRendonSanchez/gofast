{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":15,"name":"gofast_registro_negocio","code":"\n\/***************************************************\n * GOFAST \u2013 SHORTCODE REGISTRO MULTIPLE DE NEGOCIOS\n ***************************************************\/\nfunction gofast_registro_negocio_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) session_start();\n    if (empty($_SESSION['gofast_user_id'])) {\n        return \"<div class='gofast-box'>Debes iniciar sesi\u00f3n para registrar tu negocio.<\/div>\";\n    }\n\n    $user_id = intval($_SESSION['gofast_user_id']);\n\n    \/* Modo *\/\n    $editing_id = isset($_GET['edit']) ? intval($_GET['edit']) : 0;\n    $add_new    = isset($_GET['add']);\n\n    $negocio = null;\n\n    \/* Si edita, obtener datos *\/\n    if ($editing_id) {\n        $negocio = $wpdb->get_row($wpdb->prepare(\n            \"SELECT * FROM negocios_gofast WHERE id=%d AND user_id=%d\",\n            $editing_id, $user_id\n        ));\n    }\n\n    \/* Listado *\/\n    $negocios = $wpdb->get_results($wpdb->prepare(\n        \"SELECT * FROM negocios_gofast WHERE user_id=%d ORDER BY id DESC\",\n        $user_id\n    ));\n\n    \/* Para mostrar errores *\/\n    $errores = [];\n    \n    \/\/ Mostrar errores si vienen de la redirecci\u00f3n (si hay par\u00e1metros de error)\n    if (isset($_GET['error'])) {\n        $error_msg = sanitize_text_field($_GET['error']);\n        if ($error_msg) {\n            $errores[] = $error_msg;\n        }\n    }\n\n    \/* ======================\n       Valores del FORM\n    ====================== *\/\n    $tipos_default = [\n        \"Panader\u00eda\",\n        \"Pasteler\u00eda \/ Reposter\u00eda\",\n        \"Cafeter\u00eda\",\n        \"Restaurante\",\n        \"Comida r\u00e1pida\",\n        \"Helader\u00eda\",\n        \"Pizzer\u00eda\",\n        \"Asadero\",\n        \"Supermercado \/ Minimarket\",\n        \"Carnicer\u00eda\",\n        \"Pescader\u00eda\",\n        \"Fruver\",\n        \"Boutique\",\n        \"Zapater\u00eda\",\n        \"Tienda de accesorios\",\n        \"Papeler\u00eda\",\n        \"Librer\u00eda\",\n        \"Tienda de regalos\",\n        \"Florister\u00eda\",\n        \"Ferreter\u00eda\",\n        \"Tienda de mascotas \/ Pet shop\",\n        \"Tienda de tecnolog\u00eda\",\n        \"Tienda de electrodom\u00e9sticos\",\n        \"Peluquer\u00eda \/ Barber\u00eda\",\n        \"Spa \/ Centro de belleza\",\n        \"Taller de motos o autos\",\n        \"Servicio t\u00e9cnico de celulares\",\n        \"Lavander\u00eda\",\n        \"Fotocopiadora\",\n        \"Estudio fotogr\u00e1fico\",\n        \"Agencia de publicidad\",\n        \"Gimnasio\",\n        \"Droguer\u00eda \/ Farmacia\",\n        \"Consultorio m\u00e9dico\",\n        \"Odontolog\u00eda\",\n        \"\u00d3ptica\",\n        \"Centro de terapias\",\n        \"Veterinaria\",\n        \"Pintura\",\n        \"Decoraci\u00f3n\",\n        \"Inmobiliaria\",\n        \"Colegio\",\n        \"Tienda online\",\n        \"Marketing digital\",\n        \"Tienda Er\u00f3tica\",\n        \"Tienda de qu\u00edmicos \/ aseo\",\n        \"Lencer\u00eda para el hogar\",\n        \"Otro\"\n    ];\n\n    if ($negocio) {\n        if (!in_array($negocio->tipo, $tipos_default)) {\n            $tipo_val      = \"Otro\";\n            $tipo_otro_val = esc_attr($negocio->tipo);\n        } else {\n            $tipo_val      = esc_attr($negocio->tipo);\n            $tipo_otro_val = \"\";\n        }\n    } else {\n        $tipo_val      = \"\";\n        $tipo_otro_val = \"\";\n    }\n\n    $whatsapp_val = $negocio ? esc_attr($negocio->whatsapp) : '';\n\n    $nombre_val = $negocio ? esc_attr($negocio->nombre) : '';\n    $dir_val    = $negocio ? esc_attr($negocio->direccion_full) : '';\n    $barrio_val = $negocio ? intval($negocio->barrio_id) : 0;\n\n    $barrios = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n\n    ob_start();\n?>\n\n<div class=\"gofast-checkout-wrapper\">\n\n    <?php if (!empty($errores)): ?>\n        <div class=\"gofast-recargo-box\" style=\"background:#ffe0e0;border-left-color:#ff3333;\">\n            <?php foreach ($errores as $e): ?>\n                \u2022 <?= esc_html($e) ?><br>\n            <?php endforeach; ?>\n        <\/div>\n    <?php endif; ?>\n\n    <?php if ($add_new || $editing_id): ?>\n    <div class=\"gofast-box\">\n        <h3><?= $editing_id ? \"Editar negocio\" : \"Registrar nuevo negocio\" ?><\/h3>\n\n        <form method=\"post\">\n\n            <label>Nombre del negocio<\/label>\n            <input type=\"text\" name=\"nombre_negocio\" value=\"<?= $nombre_val ?>\" required>\n\n            <label>Tipo de negocio<\/label>\n            <select name=\"tipo_negocio\" id=\"tipo_negocio\" class=\"gofast-select\" required>\n                <option value=\"\">\u2014 Selecciona \u2014<\/option>\n                <?php foreach ($tipos_default as $t): ?>\n                    <option value=\"<?= esc_attr($t) ?>\" <?= $tipo_val === $t ? \"selected\" : \"\" ?>>\n                        <?= esc_html($t) ?>\n                    <\/option>\n                <?php endforeach; ?>\n            <\/select>\n\n            <div id=\"tipo_otro_wrapper\" style=\"display:none;\">\n                <label>Especifica el tipo<\/label>\n                <input type=\"text\" name=\"tipo_otro\" id=\"tipo_otro\" \n                       value=\"<?= $tipo_otro_val ?>\" placeholder=\"Ej: Barber\u00eda\">\n            <\/div>\n\n            <label>Barrio<\/label>\n            <select name=\"barrio_id\" class=\"gofast-select\" required>\n                <option value=\"\">\u2014 Seleccionar barrio \u2014<\/option>\n                <?php foreach ($barrios as $b): ?>\n                    <option value=\"<?= $b->id ?>\" <?= ($barrio_val == $b->id ? \"selected\" : \"\") ?>>\n                        <?= esc_html($b->nombre) ?>\n                    <\/option>\n                <?php endforeach; ?>\n            <\/select>\n\n            <label>Direcci\u00f3n completa<\/label>\n            <input type=\"text\" name=\"direccion_full\" value=\"<?= $dir_val ?>\" required>\n\n            <label>WhatsApp del negocio<\/label>\n            <input type=\"text\" \n                   name=\"whatsapp\" \n                   value=\"<?= esc_attr(gofast_clean_whatsapp($whatsapp_val)) ?>\" \n                   placeholder=\"Ej: 3001234567\"\n                   pattern=\"[0-9]*\"\n                   inputmode=\"numeric\">\n\n            <div class=\"gofast-btn-group\" style=\"margin-top:20px;\">\n                <button name=\"gofast_guardar_negocio\" class=\"gofast-btn-request\">\ud83d\udcbe Guardar<\/button>\n                <a href=\"\/mi-negocio\" class=\"gofast-btn-action gofast-secondary\">\u2b05 Cancelar<\/a>\n            <\/div>\n\n        <\/form>\n    <\/div>\n\n    <?php else: ?>\n\n    <div class=\"gofast-box gofast-box-negocios\">\n        <a href=\"?add=1\" class=\"gofast-btn-request gofast-btn-registrar-negocio\" style=\"margin-bottom:16px;\">\n            <span class=\"gofast-btn-icon\">\u2795<\/span>\n            <span class=\"gofast-btn-text\">Registrar nuevo negocio<\/span>\n        <\/a>\n\n        <div class=\"gofast-negocios-table-wrapper\">\n            <table class=\"gofast-negocios-table\">\n\n                <tr>\n                    <th>Nombre<\/th>\n                    <th>Direcci\u00f3n<\/th>\n                    <th>Barrio<\/th>\n                    <th>Acciones<\/th>\n                <\/tr>\n\n                <?php foreach ($negocios as $n): ?>\n                <tr>\n                    <td><?= esc_html($n->nombre) ?><\/td>\n                    <td><?= esc_html($n->direccion_full) ?><\/td>\n                    <td><?= esc_html($wpdb->get_var(\"SELECT nombre FROM barrios WHERE id={$n->barrio_id}\")) ?><\/td>\n                    <td class=\"gofast-actions\">\n                        <a href=\"?edit=<?= $n->id ?>\" class=\"gofast-btn-edit\">Editar<\/a>\n                        <a href=\"?delete=<?= $n->id ?>\" class=\"gofast-btn-delete\"\n                           onclick=\"return confirm('\u00bfEliminar este negocio?');\">Eliminar<\/a>\n                    <\/td>\n                <\/tr>\n                <?php endforeach; ?>\n\n            <\/table>\n        <\/div>\n    <\/div>\n\n    <?php endif; ?>\n<\/div>\n\n<?php return ob_get_clean(); }\n\nadd_shortcode('gofast_registro_negocio', 'gofast_registro_negocio_shortcode');\n\n\n\/***************************************************\n * JS + SELECT2 + L\u00d3GICA DEL CAMPO OTRO + Z-INDEX CORREGIDO\n ***************************************************\/\nadd_action('wp_footer', function(){ ?>\n<script>\n(function(){\n\nconst normalize = s => s.toLowerCase().normalize(\"NFD\")\n    .replace(\/[\\u0300-\\u036f]\/g, \"\")\n    .trim();\n\n\/***************************************************\n *  Funci\u00f3n para obtener z-index correcto\n ***************************************************\/\nfunction getSelect2ZIndex() {\n    \/\/ Si el men\u00fa m\u00f3vil est\u00e1 abierto, usar z-index m\u00e1s bajo\n    if (document.body.classList.contains('gofast-menu-open')) {\n        return 9998;\n    }\n    \/\/ Si no, usar z-index moderado para no quedar por encima de todo\n    return 1000;\n}\n\nfunction initSelect2(container){\n    if (!window.jQuery || !jQuery.fn.select2) return;\n\n    const zIndex = getSelect2ZIndex();\n\n    jQuery(container).find('.gofast-select').select2({\n        placeholder: \"\ud83d\udd0d Escribe para buscar...\",\n        width: '100%',\n        dropdownParent: jQuery('body'),\n        allowClear: true,\n        minimumResultsForSearch: 0,\n        selectOnClose: true,\n        dropdownAutoWidth: true,\n        dropdownCssClass: \"gofast-select-down\",\n        language: {\n            noResults: function() {\n                return \"No se encontraron resultados\";\n            },\n            searching: function() {\n                return \"Buscando...\";\n            }\n        },\n\n        matcher: function(params, data){\n            \/\/ Si no hay data, retornar null\n            if (!data) return null;\n            \n            \/\/ Si es un optgroup (tiene children), dejarlo pasar para que Select2 lo maneje\n            if (data.children && Array.isArray(data.children)) {\n                return data;\n            }\n            \n            \/\/ Si no tiene id, es un optgroup label o separador\n            if (!data.id) {\n                if (!params.term || !params.term.trim()) {\n                    return data;\n                }\n                return null;\n            }\n            \n            \/\/ Si no tiene text, no mostrar\n            if (!data.text) return null;\n            \n            \/\/ Si no hay t\u00e9rmino de b\u00fasqueda, mostrar todas las opciones\n            if (!params.term || !params.term.trim()) {\n                data.matchScore = 0;\n                return data;\n            }\n\n            const term = normalize(params.term);\n            if (!term) {\n                data.matchScore = 0;\n                return data;\n            }\n\n            const text = normalize(data.text);\n            \n            \/\/ PRIMERO: Verificar coincidencia exacta (ignorando may\u00fasculas y tildes)\n            if (text === term) {\n                data.matchScore = 10000;\n                return data;\n            }\n            \n            \/\/ SEGUNDO: Verificar si el texto comienza exactamente con el t\u00e9rmino\n            if (text.indexOf(term) === 0) {\n                data.matchScore = 9500;\n                return data;\n            }\n            \n            \/\/ Palabras comunes a ignorar en la b\u00fasqueda\n            const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n            \n            const searchWords = term.split(\/\\s+\/).filter(Boolean).filter(word => {\n                return word.length > 2 && !stopWords.includes(word);\n            });\n            \n            \/\/ Detectar si el t\u00e9rmino de b\u00fasqueda parece ser completo (m\u00faltiples palabras o palabra larga)\n            const isCompleteSearch = term.split(\/\\s+\/).length >= 2 || term.length >= 10;\n            \n            \/\/ Si despu\u00e9s de filtrar no quedan palabras, buscar el t\u00e9rmino completo\n            if (searchWords.length === 0) {\n                if (text.indexOf(term) !== -1) {\n                    data.matchScore = 7000;\n                    return data;\n                }\n                return null;\n            }\n            \n            \/\/ Verificar que al menos una palabra significativa est\u00e9 presente\n            const significantMatches = searchWords.filter(word => {\n                if (word.length <= 2) {\n                    return text.split(\/\\s+\/).some(textWord => textWord.indexOf(word) === 0);\n                }\n                return text.indexOf(word) !== -1;\n            });\n            \n            if (significantMatches.length === 0) return null;\n            \n            const allSignificantMatch = searchWords.length === significantMatches.length;\n            \n            \/\/ Si la b\u00fasqueda parece completa y no hay coincidencia exacta, ser m\u00e1s estricto\n            if (isCompleteSearch && text !== term && text.indexOf(term) !== 0) {\n                \/\/ Solo mostrar si el t\u00e9rmino completo est\u00e1 presente (aunque no al inicio)\n                if (text.indexOf(term) === -1) {\n                    \/\/ Verificar si al menos todas las palabras significativas est\u00e1n presentes\n                    const allWordsPresent = searchWords.every(word => text.indexOf(word) !== -1);\n                    if (!allWordsPresent) {\n                        return null; \/\/ Filtrar si no est\u00e1n todas las palabras\n                    }\n                }\n            }\n\n            \/\/ Sistema de puntuaci\u00f3n\n            let score = 0;\n            \n            const textWithoutStopWords = text.split(\/\\s+\/).filter(w => !stopWords.includes(w)).join(' ');\n            const termWithoutStopWords = searchWords.join(' ');\n            \n            \/\/ Coincidencia exacta sin stop words\n            if (textWithoutStopWords === termWithoutStopWords) {\n                score = 10000;\n            } \n            \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 al inicio\n            else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {\n                score = 9000;\n            } \n            \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 en cualquier parte\n            else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {\n                score = 8000;\n            } \n            \/\/ Al menos una palabra significativa al inicio\n            else if (searchWords.some(word => text.indexOf(word) === 0)) {\n                score = 7000;\n            } \n            \/\/ El t\u00e9rmino completo est\u00e1 en cualquier parte\n            else if (text.indexOf(term) !== -1) {\n                score = 6000;\n            } \n            \/\/ Coincidencias parciales\n            else {\n                score = allSignificantMatch ? 5000 : 3000;\n                \n                let lastIndex = -1;\n                let wordsInOrder = true;\n                searchWords.forEach(word => {\n                    const wordIndex = text.indexOf(word, lastIndex + 1);\n                    if (wordIndex === -1) {\n                        wordsInOrder = false;\n                    } else {\n                        if (wordIndex < lastIndex) wordsInOrder = false;\n                        lastIndex = wordIndex;\n                        if (text.indexOf(word) === 0) score += 500;\n                    }\n                });\n                \n                if (wordsInOrder) score += 1000;\n            }\n            \n            data.matchScore = score;\n            return data;\n        },\n\n        sorter: results => results.sort((a,b)=> (b.matchScore||0)-(a.matchScore||0)),\n\n        templateResult: function(data, container){\n            \/\/ Manejar optgroups (no tienen id pero tienen children)\n            if (!data || !data.text) {\n                if (data && data.children) return data.text; \/\/ Retornar label del optgroup\n                return data ? data.text : '';\n            }\n            \n            \/\/ Si no tiene id, es un optgroup label, retornar sin modificar\n            if (!data.id) return data.text;\n\n            let originalText = data.text;\n            \n            \/\/ Obtener el t\u00e9rmino de b\u00fasqueda del campo activo\n            let searchTerm = \"\";\n            const $activeField = jQuery('.select2-container--open .select2-search__field');\n            if ($activeField.length) {\n                searchTerm = $activeField.val() || \"\";\n            }\n            \n            if (!searchTerm || !searchTerm.trim()) {\n                const $result = jQuery('<span>' + originalText + '<\/span>');\n                if (data.matchScore !== undefined) {\n                    $result.attr('data-match-score', data.matchScore);\n                }\n                return $result;\n            }\n\n            \/\/ Normalizar para b\u00fasqueda sin tildes\n            const normalizedSearch = normalize(searchTerm);\n            const normalizedText = normalize(originalText);\n            \n            \/\/ Dividir t\u00e9rmino en palabras significativas\n            const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n            const searchWords = normalizedSearch.split(\/\\s+\/).filter(Boolean).filter(word => {\n                return word.length > 2 && !stopWords.includes(word);\n            });\n            \n            \/\/ Si no hay palabras significativas, buscar el t\u00e9rmino completo\n            const wordsToHighlight = searchWords.length > 0 ? searchWords : [normalizedSearch];\n            \n            \/\/ Encontrar coincidencias en el texto normalizado y mapear a texto original\n            const highlightRanges = [];\n            \n            wordsToHighlight.forEach(function(word) {\n                let searchPos = 0;\n                while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {\n                    const endPos = searchPos + word.length;\n                    \n                    \/\/ Mapear posiciones normalizadas a originales\n                    let origStart = -1;\n                    let origEnd = -1;\n                    let normPos = 0;\n                    \n                    \/\/ Encontrar inicio\n                    for (let i = 0; i < originalText.length && origStart === -1; i++) {\n                        const charNorm = normalize(originalText[i]);\n                        if (normPos === searchPos) {\n                            origStart = i;\n                        }\n                        normPos += charNorm.length;\n                    }\n                    \n                    \/\/ Encontrar fin\n                    if (origStart >= 0) {\n                        normPos = searchPos;\n                        for (let i = origStart; i < originalText.length; i++) {\n                            const charNorm = normalize(originalText[i]);\n                            normPos += charNorm.length;\n                            if (normPos >= endPos) {\n                                origEnd = i + 1;\n                                break;\n                            }\n                        }\n                        \n                        if (origStart >= 0 && origEnd > origStart) {\n                            highlightRanges.push({ start: origStart, end: origEnd });\n                        }\n                    }\n                    \n                    searchPos = endPos;\n                }\n            });\n            \n            \/\/ Fusionar rangos solapados\n            if (highlightRanges.length > 0) {\n                highlightRanges.sort((a, b) => a.start - b.start);\n                const mergedRanges = [highlightRanges[0]];\n                \n                for (let i = 1; i < highlightRanges.length; i++) {\n                    const current = highlightRanges[i];\n                    const last = mergedRanges[mergedRanges.length - 1];\n                    \n                    if (current.start <= last.end) {\n                        last.end = Math.max(last.end, current.end);\n                    } else {\n                        mergedRanges.push(current);\n                    }\n                }\n                \n                \/\/ Construir resultado con resaltados\n                const parts = [];\n                let lastIndex = 0;\n                \n                mergedRanges.forEach(function(range) {\n                    \/\/ Agregar texto antes del rango\n                    if (range.start > lastIndex) {\n                        parts.push(originalText.substring(lastIndex, range.start));\n                    }\n                    \n                    \/\/ Agregar texto resaltado\n                    const matchText = originalText.substring(range.start, range.end);\n                    parts.push('<span style=\"background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;\">' + \n                               matchText + '<\/span>');\n                    \n                    lastIndex = range.end;\n                });\n                \n                \/\/ Agregar texto restante despu\u00e9s del \u00faltimo rango\n                if (lastIndex < originalText.length) {\n                    parts.push(originalText.substring(lastIndex));\n                }\n                \n                const result = parts.join('');\n                \n                \/\/ Crear elemento jQuery con el HTML renderizado correctamente\n                const $result = jQuery('<span>').html(result);\n                \/\/ Agregar atributo data con el score para poder filtrar despu\u00e9s\n                if (data.matchScore !== undefined) {\n                    $result.attr('data-match-score', data.matchScore);\n                }\n                return $result;\n            }\n            \n            \/\/ Si no hay coincidencias, retornar texto sin resaltar\n            const $result = jQuery('<span>').text(originalText);\n            if (data.matchScore !== undefined) {\n                $result.attr('data-match-score', data.matchScore);\n            }\n            return $result;\n        }\n    }).on('select2:open', function(e) {\n        \/\/ Aplicar z-index din\u00e1mico cuando se abre\n        setTimeout(function() {\n            const currentZIndex = getSelect2ZIndex();\n            const $container = jQuery(e.target).closest('.select2-container');\n            const $dropdown = jQuery('.select2-dropdown');\n            \n            \/\/ Aplicar z-index por debajo del men\u00fa (men\u00fa: 999)\n            const zIndex = 998;\n            \n            if ($container.length) {\n                $container.css('z-index', zIndex);\n            }\n            if ($dropdown.length) {\n                $dropdown.css('z-index', zIndex);\n            }\n            \n            \/\/ Asegurar que todos los dropdowns abiertos tengan z-index moderado\n            jQuery('.select2-container--open').css('z-index', zIndex);\n            jQuery('.select2-dropdown').css('z-index', zIndex);\n            \n            \/\/ Agregar listener para b\u00fasqueda din\u00e1mica y mejorar UX (especialmente m\u00f3vil)\n            const $searchField = $container.find('.select2-search__field');\n            if ($searchField.length) {\n                \/\/ Detectar si es m\u00f3vil\n                const isMobile = window.innerWidth <= 768;\n                \n                \/\/ Hacer el campo m\u00e1s visible y claro\n                $searchField.attr('placeholder', isMobile ? '\ud83d\udd0d Escribe para buscar entre 5000+ barrios...' : '\ud83d\udd0d Escribe aqu\u00ed para buscar...');\n                $searchField.attr('autocomplete', 'off');\n                $searchField.attr('inputmode', 'text'); \/\/ Mejor teclado en m\u00f3vil\n                $searchField.attr('spellcheck', 'false');\n                \n                \/\/ Estilos base\n                const baseStyles = {\n                    'outline': 'none',\n                    'border': '2px solid #F4C524',\n                    'border-radius': '8px'\n                };\n                \n                \/\/ Estilos espec\u00edficos para m\u00f3vil\n                if (isMobile) {\n                    Object.assign(baseStyles, {\n                        'font-size': '18px',\n                        'padding': '16px 20px',\n                        'min-height': '56px',\n                        'border': '3px solid #F4C524',\n                        'border-radius': '12px',\n                        '-webkit-appearance': 'none',\n                        '-moz-appearance': 'none',\n                        'appearance': 'none'\n                    });\n                } else {\n                    Object.assign(baseStyles, {\n                        'font-size': '16px',\n                        'padding': '12px 16px'\n                    });\n                }\n                \n                $searchField.css(baseStyles);\n                \n                \/\/ Remover listeners anteriores para evitar duplicados\n                $searchField.off('input.select2-dynamic-search keyup.select2-dynamic-search focus.select2-dynamic-search');\n                \n                \/\/ Funci\u00f3n para forzar actualizaci\u00f3n del dropdown\n                const forceUpdate = function() {\n                    const $select = jQuery(e.target);\n                    if ($select.length && $select.data('select2')) {\n                        const select2Instance = $select.data('select2');\n                        \/\/ Forzar actualizaci\u00f3n del dropdown\n                        if (select2Instance && select2Instance.dropdown) {\n                            \/\/ Obtener el t\u00e9rmino de b\u00fasqueda actual\n                            const searchTerm = $searchField.val() || '';\n                            \/\/ Forzar b\u00fasqueda y actualizaci\u00f3n\n                            select2Instance.dataAdapter.query({ term: searchTerm }, function(data) {\n                                select2Instance.updateResults(data);\n                                \n                                \/\/ Despu\u00e9s de actualizar resultados, filtrar si hay coincidencias exactas\n                                setTimeout(function() {\n                                    const $dropdown = jQuery('.select2-dropdown');\n                                    const $results = $dropdown.find('.select2-results__options');\n                                    const $items = $results.find('.select2-results__option[role=\"option\"]:not(.select2-results__option--loading)');\n                                    \n                                    if ($items.length > 0) {\n                                        \/\/ Verificar si hay coincidencias exactas (score 10000)\n                                        let hasExactMatch = false;\n                                        $items.each(function() {\n                                            const $item = jQuery(this);\n                                            const $span = $item.find('span[data-match-score]');\n                                            if ($span.length) {\n                                                const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                if (score >= 10000) {\n                                                    hasExactMatch = true;\n                                                    return false; \/\/ break\n                                                }\n                                            }\n                                        });\n                                        \n                                        if (hasExactMatch) {\n                                            \/\/ Ocultar elementos con score < 9500\n                                            $items.each(function() {\n                                                const $item = jQuery(this);\n                                                const $span = $item.find('span[data-match-score]');\n                                                if ($span.length) {\n                                                    const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                    if (score < 9500) {\n                                                        $item.hide();\n                                                    } else {\n                                                        $item.show();\n                                                    }\n                                                } else {\n                                                    $item.show(); \/\/ Mostrar si no tiene score\n                                                }\n                                            });\n                                        } else {\n                                            \/\/ Si no hay exactas, verificar si hay muy cercanas (>= 9000)\n                                            let hasVeryClose = false;\n                                            $items.each(function() {\n                                                const $item = jQuery(this);\n                                                const $span = $item.find('span[data-match-score]');\n                                                if ($span.length) {\n                                                    const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                    if (score >= 9000) {\n                                                        hasVeryClose = true;\n                                                        return false; \/\/ break\n                                                    }\n                                                }\n                                            });\n                                            \n                                            if (hasVeryClose) {\n                                                \/\/ Mostrar solo las muy cercanas (hasta 5)\n                                                let count = 0;\n                                                $items.each(function() {\n                                                    const $item = jQuery(this);\n                                                    const $span = $item.find('span[data-match-score]');\n                                                    if ($span.length) {\n                                                        const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                        if (score >= 9000 && count < 5) {\n                                                            $item.show();\n                                                            count++;\n                                                        } else {\n                                                            $item.hide();\n                                                        }\n                                                    } else {\n                                                        $item.hide(); \/\/ Ocultar si no tiene score\n                                                    }\n                                                });\n                                            } else {\n                                                \/\/ Mostrar todos (hasta 10)\n                                                let count = 0;\n                                                $items.each(function() {\n                                                    if (count < 10) {\n                                                        jQuery(this).show();\n                                                        count++;\n                                                    } else {\n                                                        jQuery(this).hide();\n                                                    }\n                                                });\n                                            }\n                                        }\n                                    }\n                                }, 150);\n                            });\n                        }\n                    }\n                };\n                \n                \/\/ Agregar listeners para b\u00fasqueda din\u00e1mica\n                $searchField.on('input.select2-dynamic-search', function() {\n                    forceUpdate();\n                });\n                \n                $searchField.on('keyup.select2-dynamic-search', function(e) {\n                    \/\/ Actualizar en cada tecla presionada\n                    setTimeout(forceUpdate, 10);\n                });\n                \n                \/\/ Enfocar autom\u00e1ticamente el campo cuando se abre (m\u00e1s tiempo en m\u00f3vil)\n                setTimeout(function() {\n                    $searchField.focus();\n                    \/\/ En m\u00f3vil, hacer scroll al campo si es necesario\n                    if (isMobile) {\n                        setTimeout(function() {\n                            $searchField[0].scrollIntoView({ behavior: 'smooth', block: 'center' });\n                        }, 200);\n                    }\n                }, isMobile ? 200 : 100);\n            }\n        }, 10);\n    });\n}\n\n\/******** CAMPO OTRO =============*\/\ndocument.addEventListener('DOMContentLoaded', function(){\n\n    initSelect2('.gofast-checkout-wrapper');\n\n    const tipoSelect  = document.getElementById(\"tipo_negocio\");\n    const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n    const inputOtro   = document.getElementById(\"tipo_otro\");\n\n    const tiposDefault = [\n        \"Panader\u00eda\",\n        \"Pasteler\u00eda \/ Reposter\u00eda\",\n        \"Cafeter\u00eda\",\n        \"Restaurante\",\n        \"Comida r\u00e1pida\",\n        \"Helader\u00eda\",\n        \"Pizzer\u00eda\",\n        \"Asadero\",\n        \"Supermercado \/ Minimarket\",\n        \"Carnicer\u00eda\",\n        \"Pescader\u00eda\",\n        \"Fruver\",\n        \"Boutique\",\n        \"Zapater\u00eda\",\n        \"Tienda de accesorios\",\n        \"Papeler\u00eda\",\n        \"Librer\u00eda\",\n        \"Tienda de regalos\",\n        \"Florister\u00eda\",\n        \"Ferreter\u00eda\",\n        \"Tienda de mascotas \/ Pet shop\",\n        \"Tienda de tecnolog\u00eda\",\n        \"Tienda de electrodom\u00e9sticos\",\n        \"Peluquer\u00eda \/ Barber\u00eda\",\n        \"Spa \/ Centro de belleza\",\n        \"Taller de motos o autos\",\n        \"Servicio t\u00e9cnico de celulares\",\n        \"Lavander\u00eda\",\n        \"Fotocopiadora\",\n        \"Estudio fotogr\u00e1fico\",\n        \"Agencia de publicidad\",\n        \"Gimnasio\",\n        \"Droguer\u00eda \/ Farmacia\",\n        \"Consultorio m\u00e9dico\",\n        \"Odontolog\u00eda\",\n        \"\u00d3ptica\",\n        \"Centro de terapias\",\n        \"Veterinaria\",\n        \"Pintura\",\n        \"Decoraci\u00f3n\",\n        \"Inmobiliaria\",\n        \"Colegio\",\n        \"Tienda online\",\n        \"Marketing digital\",\n        \"Tienda Er\u00f3tica\",\n        \"Tienda de qu\u00edmicos \/ aseo\",\n        \"Lencer\u00eda para el hogar\",\n        \"Otro\"\n    ];\n\n    function toggleOtro() {\n        \/\/ Validar que los elementos existan antes de acceder a sus propiedades\n        if (!wrapperOtro || !inputOtro) {\n            return; \/\/ Salir silenciosamente si los elementos no existen\n        }\n\n        const valor = tipoSelect ? tipoSelect.value.trim() : \"\";\n\n        if (valor === \"\") {\n            wrapperOtro.style.display = \"none\";\n            inputOtro.required = false;\n            return;\n        }\n\n        if (valor === \"Otro\") {\n            wrapperOtro.style.display = \"block\";\n            inputOtro.required = true;\n            return;\n        }\n\n        if (!tiposDefault.includes(valor)) {\n            wrapperOtro.style.display = \"block\";\n            inputOtro.required = true;\n            return;\n        }\n\n        wrapperOtro.style.display = \"none\";\n        inputOtro.required = false;\n    }\n\n    \/\/ Exponer la funci\u00f3n globalmente de forma segura\n    window.toggleOtro = toggleOtro;\n\n    \/\/ Solo registrar event listener y setTimeout si los elementos existen\n    if (tipoSelect && wrapperOtro && inputOtro) {\n        jQuery('#tipo_negocio').on('select2:select', toggleOtro);\n        setTimeout(toggleOtro, 200);\n    }\n\n    \/\/ Observar cambios en el men\u00fa m\u00f3vil para ajustar z-index\n    const observer = new MutationObserver(function(mutations) {\n        mutations.forEach(function(mutation) {\n            if (mutation.attributeName === 'class') {\n                const currentZIndex = getSelect2ZIndex();\n                \/\/ Aplicar z-index por debajo del men\u00fa (men\u00fa: 999)\n                const zIndex = document.body.classList.contains('gofast-menu-open') ? 9998 : 998;\n                jQuery('.select2-container--open').each(function() {\n                    const $select = jQuery(this).prev('select');\n                    const isBarrioField = $select.length && $select.attr('name') === 'barrio_id';\n                    jQuery(this).css('z-index', isBarrioField ? 998 : zIndex);\n                });\n                jQuery('.select2-dropdown').each(function() {\n                    jQuery(this).css('z-index', zIndex);\n                });\n            }\n        });\n    });\n    \n    \/\/ Asegurar z-index correcto cuando se hace scroll\n    let scrollTimeout;\n    window.addEventListener('scroll', function() {\n        clearTimeout(scrollTimeout);\n        scrollTimeout = setTimeout(function() {\n            const zIndex = document.body.classList.contains('gofast-menu-open') ? 9998 : 998;\n            jQuery('.select2-container--open').each(function() {\n                const $select = jQuery(this).prev('select');\n                const isBarrioField = $select.length && $select.attr('name') === 'barrio_id';\n                jQuery(this).css('z-index', isBarrioField ? 998 : zIndex);\n            });\n            jQuery('.select2-dropdown').css('z-index', zIndex);\n        }, 10);\n    }, { passive: true });\n\n    observer.observe(document.body, {\n        attributes: true,\n        attributeFilter: ['class']\n    });\n\n    \/\/ Tambi\u00e9n cerrar Select2 cuando se abre el men\u00fa m\u00f3vil\n    const menuToggle = document.querySelector('.gofast-hamburger');\n    if (menuToggle) {\n        menuToggle.addEventListener('click', function() {\n            \/\/ Si el men\u00fa se est\u00e1 abriendo, cerrar todos los Select2\n            setTimeout(function() {\n                if (document.body.classList.contains('gofast-menu-open')) {\n                    jQuery('.select2-container--open').select2('close');\n                }\n            }, 50);\n        });\n    }\n});\n\n})();\n<\/script>\n<?php });\n\n","active":true,"modified":"2025-12-12 13:42:36","revision":"1"}]}