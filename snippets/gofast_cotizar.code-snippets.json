{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":5,"name":"gofast_cotizar","code":"\n\/*******************************************************\n * \u2705 GOFAST \u2014 COTIZAR V2 (Selector inteligente con negocios)\n * Shortcode: [gofast_cotizar]\n * URL: \/cotizar\n *******************************************************\/\nfunction gofast_cotizar_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    \/\/ Recuperar cotizaci\u00f3n anterior\n    $old_data = $_SESSION['gofast_last_quote'] ?? [\n        'origen'   => '',\n        'destinos' => []\n    ];\n\n    \/\/ Guardar si env\u00edan formulario\n    if (isset($_POST['gofast_cotizar'])) {\n        $_SESSION['gofast_last_quote'] = [\n            'origen'   => sanitize_text_field($_POST['origen']),\n            'destinos' => array_map('sanitize_text_field', $_POST['destino'] ?? []),\n            'negocio_id' => isset($_POST['negocio_id']) ? intval($_POST['negocio_id']) : 0,\n            'cliente_id' => isset($_POST['cliente_id']) ? intval($_POST['cliente_id']) : 0,\n        ];\n    }\n\n    \/\/ Limpiar\n    if (isset($_POST['gofast_reset'])) {\n        unset($_SESSION['gofast_last_quote']);\n        $old_data = ['origen' => '', 'destinos' => []];\n    }\n\n    \/*******************************************************\n     * \ud83d\udd25 1. Negocios del usuario logueado Y todos los negocios si es mensajero\/admin\n     *******************************************************\/\n    $user_id = $_SESSION['gofast_user_id'] ?? 0;\n    $rol = strtolower($_SESSION['gofast_user_rol'] ?? '');\n    $es_mensajero_o_admin = ($rol === 'mensajero' || $rol === 'admin');\n\n    $mis_negocios = [];\n    if ($user_id) {\n        $mis_negocios = $wpdb->get_results($wpdb->prepare(\n            \"SELECT id, nombre, barrio_id \n             FROM negocios_gofast \n             WHERE user_id=%d \n             ORDER BY id DESC\",\n            $user_id\n        ));\n    }\n    \n    \/\/ Si es mensajero o admin, obtener TODOS los negocios\n    $todos_negocios = [];\n    if ($es_mensajero_o_admin) {\n        $todos_negocios = $wpdb->get_results(\n            \"SELECT n.id, n.nombre, n.direccion_full, n.barrio_id, n.whatsapp, n.user_id,\n                    u.nombre as cliente_nombre, u.telefono as cliente_telefono\n             FROM negocios_gofast n\n             INNER JOIN usuarios_gofast u ON n.user_id = u.id\n             WHERE n.activo = 1 AND u.activo = 1\n             ORDER BY n.nombre ASC\"\n        );\n    }\n\n    \/\/ Barrios prioritarios\n    $barrios_prioritarios = [];\n    foreach ($mis_negocios as $n) {\n        if ($n->barrio_id && !in_array($n->barrio_id, $barrios_prioritarios, true)) {\n            $barrios_prioritarios[] = $n->barrio_id;\n        }\n    }\n\n    \/*******************************************************\n     * \ud83d\udd25 2. Obtener TODOS los barrios y reordenarlos\n     *******************************************************\/\n    $barrios_all = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n    $barrios     = [];\n\n    \/\/ Asegurar que siempre haya barrios (incluso si la consulta falla, usar array vac\u00edo)\n    if (!$barrios_all) {\n        $barrios_all = [];\n    }\n\n    \/\/ Primero los barrios de negocios\n    foreach ($barrios_all as $b) {\n        if (in_array($b->id, $barrios_prioritarios, true)) {\n            $barrios[] = $b;\n        }\n    }\n    \/\/ Luego los dem\u00e1s\n    foreach ($barrios_all as $b) {\n        if (!in_array($b->id, $barrios_prioritarios, true)) {\n            $barrios[] = $b;\n        }\n    }\n    \n    \/\/ Si no hay barrios prioritarios, usar todos los barrios directamente\n    if (empty($barrios_prioritarios) && !empty($barrios_all)) {\n        $barrios = $barrios_all;\n    }\n\n    \/*******************************************************\n     * \ud83d\udd25 3. AUTOPRELLENAR ORIGEN si no existe\n     *******************************************************\/\n    if (empty($old_data['origen']) && !empty($barrios_prioritarios)) {\n        $old_data['origen'] = $barrios_prioritarios[0];\n    }\n\n    \/\/ URL para el formulario\n    $url_solicitar = esc_url( home_url('\/solicitar-mensajero') );\n\n    ob_start();\n    ?>\n    <div class=\"gofast-form\">\n\n        <?php if (!empty($old_data['origen'])): ?>\n            <div class=\"gofast-box\" style=\"background:#fff3cd;padding:10px;border-radius:6px;margin-bottom:12px;\">\n                \u26a1 Se ha cargado tu \u00faltima cotizaci\u00f3n o tu negocio registrado.\n            <\/div>\n        <?php endif; ?>\n\n        <form method=\"post\" action=\"<?php echo $url_solicitar; ?>\" id=\"gofast-form\">\n\n            <!-- ORIGEN -->\n            <div class=\"gofast-row\">\n                <div style=\"flex:1;\">\n                    <label><strong>Origen<\/strong><\/label>\n                    <select name=\"origen\" class=\"gofast-select\" id=\"origen\" required>\n                        <option value=\"\">Buscar direcci\u00f3n...<\/option>\n                        <?php \n                        \/\/ Agregar opciones de negocios al select (todos los negocios si es mensajero\/admin, solo del usuario si es cliente)\n                        $negocios_a_mostrar = $es_mensajero_o_admin && !empty($todos_negocios) ? $todos_negocios : $mis_negocios;\n                        \n                        if (!empty($negocios_a_mostrar)): \n                            foreach ($negocios_a_mostrar as $n):\n                                \/\/ Para todos los negocios, usar estructura completa\n                                if ($es_mensajero_o_admin && isset($n->cliente_nombre)) {\n                                    $barrio_nombre = $wpdb->get_var($wpdb->prepare(\n                                        \"SELECT nombre FROM barrios WHERE id = %d\",\n                                        $n->barrio_id\n                                    ));\n                                    $isSelected = ((string)$old_data['origen'] === (string)$n->barrio_id);\n                        ?>\n                            <option value=\"<?= esc_attr($n->barrio_id) ?>\" \n                                    data-is-negocio=\"true\"\n                                    data-negocio-id=\"<?= esc_attr($n->id) ?>\"\n                                    data-cliente-id=\"<?= esc_attr($n->user_id) ?>\"\n                                    <?= $isSelected ? 'selected' : '' ?>>\n                                \ud83c\udfea <?= esc_html($n->nombre) ?> \u2014 <?= esc_html($barrio_nombre ?: 'Sin barrio') ?> (Cliente: <?= esc_html($n->cliente_nombre) ?>)\n                            <\/option>\n                        <?php \n                                } else {\n                                    \/\/ Para negocios del usuario (estructura simple)\n                                    $barrio_nombre = $wpdb->get_var(\n                                        $wpdb->prepare(\"SELECT nombre FROM barrios WHERE id=%d\", $n->barrio_id)\n                                    );\n                                    $isSelected = ((string)$old_data['origen'] === (string)$n->barrio_id);\n                        ?>\n                            <option value=\"<?= esc_attr($n->barrio_id) ?>\" \n                                    data-is-negocio=\"true\"\n                                    data-negocio-id=\"<?= esc_attr($n->id) ?>\"\n                                    data-cliente-id=\"<?= esc_attr($n->user_id) ?>\"\n                                    <?= $isSelected ? 'selected' : '' ?>>\n                                \ud83c\udfea <?= esc_html($n->nombre) ?> \u2014 <?= esc_html($barrio_nombre) ?>\n                            <\/option>\n                        <?php \n                                }\n                            endforeach;\n                        endif; \n                        ?>\n                        <?php if (!empty($barrios)): ?>\n                            <?php foreach ($barrios as $b): ?>\n                                <option value=\"<?= esc_attr($b->id) ?>\"\n                                    <?= ((string)$old_data['origen'] === (string)$b->id ? 'selected' : '') ?>>\n                                    <?= esc_html($b->nombre) ?>\n                                <\/option>\n                            <?php endforeach; ?>\n                        <?php else: ?>\n                            <!-- Fallback: mostrar todos los barrios directamente si $barrios est\u00e1 vac\u00edo -->\n                            <?php \n                            $barrios_fallback = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n                            if (!empty($barrios_fallback)): \n                            ?>\n                                <?php foreach ($barrios_fallback as $b): ?>\n                                    <option value=\"<?= esc_attr($b->id) ?>\"\n                                        <?= ((string)$old_data['origen'] === (string)$b->id ? 'selected' : '') ?>>\n                                        <?= esc_html($b->nombre) ?>\n                                    <\/option>\n                                <?php endforeach; ?>\n                            <?php endif; ?>\n                        <?php endif; ?>\n                    <\/select>\n                <\/div>\n\n                <!-- PRIMER DESTINO -->\n                <div style=\"flex:1;\">\n                    <label><strong>Primer destino<\/strong><\/label>\n                    <select name=\"destino[]\" class=\"gofast-select\" id=\"destino-principal\" required>\n                        <option value=\"\">Buscar direcci\u00f3n...<\/option>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\"\n                                <?= in_array($b->id, $old_data['destinos'], true) ? 'selected' : '' ?>>\n                                <?= esc_html($b->nombre) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                <\/div>\n            <\/div>\n\n            <!-- DESTINOS ADICIONALES -->\n            <div class=\"gofast-destinos-grid\">\n                <div class=\"gofast-destinos-label\">\n                    <label><strong>Destinos adicionales<\/strong><\/label>\n                <\/div>\n\n                <div id=\"destinos-wrapper\">\n                    <div id=\"destinos-extra\"><\/div>\n                    <button type=\"button\" id=\"btn-add-destino\"\n                            class=\"gofast-add-button\" onclick=\"addDestino()\">\n                        \u2795 Agregar destino adicional\n                    <\/button>\n                <\/div>\n            <\/div>\n\n            <!-- TEMPLATE -->\n            <template id=\"tpl-destino\">\n                <div class=\"gofast-destino-item\">\n                    <select name=\"destino[]\" class=\"gofast-select\" required>\n                        <option value=\"\">Buscar direcci\u00f3n...<\/option>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\">\n                                <?= esc_html($b->nombre) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                    <button type=\"button\" class=\"gofast-remove\" onclick=\"removeDestino(this)\">\u274c<\/button>\n                <\/div>\n            <\/template>\n\n            <div class=\"gofast-btn-group\">\n                <button type=\"submit\" name=\"gofast_cotizar\"\n                        class=\"gofast-submit\" id=\"btn-submit\">\n                    Cotizar \ud83d\ude80\n                <\/button>\n            <\/div>\n\n            <div id=\"gofast-loading\"\n                 style=\"display:none;text-align:center;margin-top:10px;\">\n                <div class=\"loader\"><\/div>\n                <p>Procesando tu solicitud...<\/p>\n            <\/div>\n        <\/form>\n    <\/div>\n    <?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_cotizar', 'gofast_cotizar_shortcode');\n\n\/*******************************************************\n * \u2705 JS: Select2 + UX Mejorado\n *******************************************************\/\nadd_action('wp_footer', function () { ?>\n<script>\n(function(){\n\n  \/***************************************************\n   *  Normalizador (quita tildes)\n   ***************************************************\/\n  const normalize = s => (s || \"\")\n      .toLowerCase()\n      .normalize(\"NFD\")\n      .replace(\/[\\u0300-\\u036f]\/g, \"\")\n      .trim();\n\n  \/***************************************************\n   *  MATCHER EXCLUSIVO PARA ORIGEN (con optgroups)\n   ***************************************************\/\n  function matcherOrigen(params, data){\n    \/\/ Si no hay data, retornar null\n    if (!data) return null;\n    \n    \/\/ Si es un optgroup (tiene children), verificar si tiene hijos que coincidan\n    if (data.children && Array.isArray(data.children)) {\n      \/\/ Si no hay b\u00fasqueda, mostrar el optgroup completo\n      if (!params.term || !params.term.trim()) {\n        return data;\n      }\n      \n      \/\/ Si hay b\u00fasqueda, verificar si alg\u00fan hijo coincide\n      const term = normalize(params.term);\n      const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n      const searchWords = term.split(\/\\s+\/).filter(Boolean).filter(word => {\n        return word.length > 2 && !stopWords.includes(word);\n      });\n      \n      const hasMatchingChild = data.children.some(child => {\n        if (!child || !child.text || !child.id) return false;\n        const childText = normalize(child.text);\n        \n        \/\/ Si no hay palabras significativas, buscar el t\u00e9rmino completo\n        if (searchWords.length === 0) {\n          return childText.indexOf(term) !== -1;\n        }\n        \n        \/\/ Verificar que al menos una palabra significativa coincida\n        return searchWords.some(word => {\n          if (word.length <= 2) {\n            return childText.split(\/\\s+\/).some(textWord => textWord.indexOf(word) === 0);\n          }\n          return childText.indexOf(word) !== -1;\n        });\n      });\n      \n      \/\/ Solo mostrar el optgroup si tiene hijos que coincidan\n      return hasMatchingChild ? data : null;\n    }\n    \n    \/\/ Si no tiene id, es un optgroup label o separador\n    if (!data.id) {\n      \/\/ Sin b\u00fasqueda, mostrar labels\n      if (!params.term || !params.term.trim()) {\n        return data;\n      }\n      \/\/ Con b\u00fasqueda, ocultar labels\n      return null;\n    }\n    \n    \/\/ Si no tiene text, no mostrar\n    if (!data.text) return null;\n    \n    \/\/ Si no hay t\u00e9rmino de b\u00fasqueda, mostrar todas las opciones\n    if (!params.term || !params.term.trim()) {\n      data.matchScore = 0;\n      return data;\n    }\n\n    const term = normalize(params.term);\n    if (!term) {\n      data.matchScore = 0;\n      return data;\n    }\n\n    const text = normalize(data.text);\n    \n    \/\/ Palabras comunes a ignorar en la b\u00fasqueda\n    const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n    \n    const searchWords = term.split(\/\\s+\/).filter(Boolean).filter(word => {\n      return word.length > 2 && !stopWords.includes(word);\n    });\n    \n    \/\/ Si despu\u00e9s de filtrar no quedan palabras, buscar el t\u00e9rmino completo\n    if (searchWords.length === 0) {\n      if (text.indexOf(term) !== -1) {\n        data.matchScore = 7000;\n        return data;\n      }\n      return null;\n    }\n    \n    \/\/ Verificar que al menos una palabra significativa est\u00e9 presente\n    const significantMatches = searchWords.filter(word => {\n      if (word.length <= 2) {\n        return text.split(\/\\s+\/).some(textWord => textWord.indexOf(word) === 0);\n      }\n      return text.indexOf(word) !== -1;\n    });\n    \n    if (significantMatches.length === 0) return null;\n    \n    const allSignificantMatch = searchWords.length === significantMatches.length;\n\n    \/\/ Sistema de puntuaci\u00f3n\n    let score = 0;\n    \n    const textWithoutStopWords = text.split(\/\\s+\/).filter(w => !stopWords.includes(w)).join(' ');\n    const termWithoutStopWords = searchWords.join(' ');\n    \n    if (textWithoutStopWords === termWithoutStopWords) {\n      score = 10000;\n    } else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {\n      score = 9000;\n    } else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {\n      score = 8000;\n    } else if (searchWords.some(word => text.indexOf(word) === 0)) {\n      score = 7000;\n    } else if (text.indexOf(term) !== -1) {\n      score = 6000;\n    } else {\n      score = allSignificantMatch ? 5000 : 3000;\n      \n      let lastIndex = -1;\n      let wordsInOrder = true;\n      searchWords.forEach(word => {\n        const wordIndex = text.indexOf(word, lastIndex + 1);\n        if (wordIndex === -1) {\n          wordsInOrder = false;\n        } else {\n          if (wordIndex < lastIndex) wordsInOrder = false;\n          lastIndex = wordIndex;\n          if (text.indexOf(word) === 0) score += 500;\n        }\n      });\n      \n      if (wordsInOrder) score += 1000;\n    }\n    \n    data.matchScore = score;\n    return data;\n  }\n\n  \/***************************************************\n   *  MATCHER UNIFICADO (para origen y destinos)\n   *  Maneja optgroups pero con l\u00f3gica de b\u00fasqueda simple\n   ***************************************************\/\n  function matcherDestinos(params, data){\n    \/\/ Si no hay data, retornar null\n    if (!data) return null;\n    \n    \/\/ Si es un optgroup (tiene children), dejarlo pasar para que Select2 lo maneje\n    \/\/ Select2 procesar\u00e1 los hijos individualmente con este mismo matcher\n    if (data.children && Array.isArray(data.children)) {\n      return data;\n    }\n    \n    \/\/ Si no tiene id, es un optgroup label o separador\n    \/\/ Sin b\u00fasqueda, mostrarlo; con b\u00fasqueda, ocultarlo\n    if (!data.id) {\n      if (!params.term || !params.term.trim()) {\n        return data;\n      }\n      return null;\n    }\n    \n    \/\/ Si no tiene text, no mostrar\n    if (!data.text) return null;\n    \n    \/\/ Si no hay t\u00e9rmino de b\u00fasqueda, mostrar todas las opciones\n    if (!params.term || !params.term.trim()) {\n      data.matchScore = 0;\n      return data;\n    }\n\n    const term = normalize(params.term);\n    if (!term) {\n      data.matchScore = 0;\n      return data;\n    }\n\n    const text = normalize(data.text);\n    \n    \/\/ PRIMERO: Verificar coincidencia exacta (ignorando may\u00fasculas y tildes)\n    if (text === term) {\n      data.matchScore = 10000;\n      return data;\n    }\n    \n    \/\/ SEGUNDO: Verificar si el texto comienza exactamente con el t\u00e9rmino\n    if (text.indexOf(term) === 0) {\n      data.matchScore = 9500;\n      return data;\n    }\n    \n    \/\/ Palabras comunes a ignorar en la b\u00fasqueda\n    const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n    \n    const searchWords = term.split(\/\\s+\/).filter(Boolean).filter(word => {\n      return word.length > 2 && !stopWords.includes(word);\n    });\n    \n    \/\/ Detectar si el t\u00e9rmino de b\u00fasqueda parece ser completo (m\u00faltiples palabras o palabra larga)\n    const isCompleteSearch = term.split(\/\\s+\/).length >= 2 || term.length >= 10;\n    \n    \/\/ Si despu\u00e9s de filtrar no quedan palabras, buscar el t\u00e9rmino completo\n    if (searchWords.length === 0) {\n      if (text.indexOf(term) !== -1) {\n        data.matchScore = 7000;\n        return data;\n      }\n      return null;\n    }\n    \n    \/\/ Verificar que al menos una palabra significativa est\u00e9 presente\n    const significantMatches = searchWords.filter(word => {\n      if (word.length <= 2) {\n        return text.split(\/\\s+\/).some(textWord => textWord.indexOf(word) === 0);\n      }\n      return text.indexOf(word) !== -1;\n    });\n    \n    if (significantMatches.length === 0) return null;\n    \n    const allSignificantMatch = searchWords.length === significantMatches.length;\n    \n    \/\/ Si la b\u00fasqueda parece completa y no hay coincidencia exacta, ser m\u00e1s estricto\n    if (isCompleteSearch && text !== term && text.indexOf(term) !== 0) {\n      \/\/ Solo mostrar si el t\u00e9rmino completo est\u00e1 presente (aunque no al inicio)\n      if (text.indexOf(term) === -1) {\n        \/\/ Verificar si al menos todas las palabras significativas est\u00e1n presentes\n        const allWordsPresent = searchWords.every(word => text.indexOf(word) !== -1);\n        if (!allWordsPresent) {\n          return null; \/\/ Filtrar si no est\u00e1n todas las palabras\n        }\n      }\n    }\n\n    \/\/ Sistema de puntuaci\u00f3n\n    let score = 0;\n    \n    const textWithoutStopWords = text.split(\/\\s+\/).filter(w => !stopWords.includes(w)).join(' ');\n    const termWithoutStopWords = searchWords.join(' ');\n    \n    \/\/ Coincidencia exacta sin stop words\n    if (textWithoutStopWords === termWithoutStopWords) {\n      score = 10000;\n    } \n    \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 al inicio\n    else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {\n      score = 9000;\n    } \n    \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 en cualquier parte\n    else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {\n      score = 8000;\n    } \n    \/\/ Al menos una palabra significativa al inicio\n    else if (searchWords.some(word => text.indexOf(word) === 0)) {\n      score = 7000;\n    } \n    \/\/ El t\u00e9rmino completo est\u00e1 en cualquier parte\n    else if (text.indexOf(term) !== -1) {\n      score = 6000;\n    } \n    \/\/ Coincidencias parciales\n    else {\n      score = allSignificantMatch ? 5000 : 3000;\n      \n      let lastIndex = -1;\n      let wordsInOrder = true;\n      searchWords.forEach(word => {\n        const wordIndex = text.indexOf(word, lastIndex + 1);\n        if (wordIndex === -1) {\n          wordsInOrder = false;\n        } else {\n          if (wordIndex < lastIndex) wordsInOrder = false;\n          lastIndex = wordIndex;\n          if (text.indexOf(word) === 0) score += 500;\n        }\n      });\n      \n      if (wordsInOrder) score += 1000;\n    }\n    \n    data.matchScore = score;\n    return data;\n  }\n\n  \/***************************************************\n   *  INIT SELECT2 (UNIFICADO + ALWAYS DOWN)\n   ***************************************************\/\n  function initSelect2(container){\n    if (window.jQuery && jQuery.fn.select2) {\n\n      jQuery(container).find('.gofast-select').each(function() {\n        \/\/ Evitar inicializar dos veces\n        if (jQuery(this).data('select2')) {\n          return;\n        }\n        \n        \/\/ Usar el mismo matcher para todos (origen y destinos)\n        \/\/ La presentaci\u00f3n de optgroups se mantiene en el HTML\n        jQuery(this).select2({\n          placeholder: \"\ud83d\udd0d Escribe para buscar direcci\u00f3n...\",\n          width: '100%',\n          dropdownParent: jQuery('body'),       \/\/ \ud83d\udc49 dropdown en <body>\n          allowClear: true,\n          minimumResultsForSearch: 0,  \/\/ SIEMPRE mostrar campo de b\u00fasqueda\n          selectOnClose: true,\n          dropdownAutoWidth: true,\n          dropdownCssClass: \"gofast-select-down\",\n          \/\/ Forzar que Select2 procese optgroups correctamente\n          templateSelection: function(data) {\n            return data.text || data.id;\n          },\n\n        \/\/ Usar el mismo matcher para todos (simplificado, igual que destino)\n        matcher: matcherDestinos,\n\n        sorter: function(results){\n          return results.sort(function(a,b){\n            return (b.matchScore || 0) - (a.matchScore || 0);\n          });\n        },\n        \n\n        templateResult: function(data, container){\n          \/\/ Manejar optgroups (no tienen id pero tienen children)\n          if (!data || !data.text) {\n            if (data && data.children) return data.text; \/\/ Retornar label del optgroup\n            return data ? data.text : '';\n          }\n          \n          \/\/ Si no tiene id, es un optgroup label, retornar sin modificar\n          if (!data.id) return data.text;\n\n          let originalText = data.text;\n          \n          \/\/ Obtener el t\u00e9rmino de b\u00fasqueda del campo activo\n          let searchTerm = \"\";\n          const $activeField = jQuery('.select2-container--open .select2-search__field');\n          if ($activeField.length) {\n            searchTerm = $activeField.val() || \"\";\n          }\n          \n          if (!searchTerm || !searchTerm.trim()) {\n            const $result = jQuery('<span>' + originalText + '<\/span>');\n            if (data.matchScore !== undefined) {\n              $result.attr('data-match-score', data.matchScore);\n            }\n            return $result;\n          }\n\n          \/\/ Normalizar para b\u00fasqueda sin tildes\n          const normalizedSearch = normalize(searchTerm);\n          const normalizedText = normalize(originalText);\n          \n          \/\/ Dividir t\u00e9rmino en palabras significativas\n          const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n          const searchWords = normalizedSearch.split(\/\\s+\/).filter(Boolean).filter(word => {\n            return word.length > 2 && !stopWords.includes(word);\n          });\n          \n          \/\/ Si no hay palabras significativas, buscar el t\u00e9rmino completo\n          const wordsToHighlight = searchWords.length > 0 ? searchWords : [normalizedSearch];\n          \n          \/\/ Encontrar coincidencias en el texto normalizado y mapear a texto original\n          const highlightRanges = [];\n          \n          wordsToHighlight.forEach(function(word) {\n            let searchPos = 0;\n            while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {\n              const endPos = searchPos + word.length;\n              \n              \/\/ Mapear posiciones normalizadas a originales\n              \/\/ Construir texto normalizado car\u00e1cter por car\u00e1cter para mapear correctamente\n              let origStart = -1;\n              let origEnd = -1;\n              let normPos = 0;\n              \n              \/\/ Encontrar inicio\n              for (let i = 0; i < originalText.length && origStart === -1; i++) {\n                const charNorm = normalize(originalText[i]);\n                if (normPos === searchPos) {\n                  origStart = i;\n                }\n                normPos += charNorm.length;\n              }\n              \n              \/\/ Encontrar fin\n              if (origStart >= 0) {\n                normPos = searchPos;\n                for (let i = origStart; i < originalText.length; i++) {\n                  const charNorm = normalize(originalText[i]);\n                  normPos += charNorm.length;\n                  if (normPos >= endPos) {\n                    origEnd = i + 1;\n                    break;\n                  }\n                }\n                \n                if (origStart >= 0 && origEnd > origStart) {\n                  highlightRanges.push({ start: origStart, end: origEnd });\n                }\n              }\n              \n              searchPos = endPos;\n            }\n          });\n          \n          \/\/ Fusionar rangos solapados\n          if (highlightRanges.length > 0) {\n            highlightRanges.sort((a, b) => a.start - b.start);\n            const mergedRanges = [highlightRanges[0]];\n            \n            for (let i = 1; i < highlightRanges.length; i++) {\n              const current = highlightRanges[i];\n              const last = mergedRanges[mergedRanges.length - 1];\n              \n              if (current.start <= last.end) {\n                last.end = Math.max(last.end, current.end);\n              } else {\n                mergedRanges.push(current);\n              }\n            }\n            \n            \/\/ Construir resultado con resaltados\n            const parts = [];\n            let lastIndex = 0;\n            \n            mergedRanges.forEach(function(range) {\n              \/\/ Agregar texto antes del rango\n              if (range.start > lastIndex) {\n                parts.push(originalText.substring(lastIndex, range.start));\n              }\n              \n              \/\/ Agregar texto resaltado\n              const matchText = originalText.substring(range.start, range.end);\n              parts.push('<span style=\"background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;\">' + \n                         matchText + '<\/span>');\n              \n              lastIndex = range.end;\n            });\n            \n            \/\/ Agregar texto restante despu\u00e9s del \u00faltimo rango\n            if (lastIndex < originalText.length) {\n              parts.push(originalText.substring(lastIndex));\n            }\n            \n            const result = parts.join('');\n            \n            \/\/ Crear elemento jQuery con el HTML renderizado correctamente\n            const $result = jQuery('<span>').html(result);\n            \/\/ Agregar atributo data con el score para poder filtrar despu\u00e9s\n            if (data.matchScore !== undefined) {\n              $result.attr('data-match-score', data.matchScore);\n            }\n            return $result;\n          }\n          \n          \/\/ Si no hay coincidencias, retornar texto sin resaltar\n          const $result = jQuery('<span>').text(originalText);\n          if (data.matchScore !== undefined) {\n            $result.attr('data-match-score', data.matchScore);\n          }\n          return $result;\n        }\n        }).on('select2:open', function(e) {\n          const $select = jQuery(this);\n          const $container = $select.next('.select2-container');\n          \n          \/\/ FORZAR que el dropdown siempre abra hacia abajo\n          \/\/ Usar requestAnimationFrame para asegurar que se ejecute despu\u00e9s de que Select2 posicione el dropdown\n          requestAnimationFrame(function() {\n            \/\/ Remover clase --above si existe y agregar --below\n            $container.removeClass('select2-container--above').addClass('select2-container--below');\n            \n            \/\/ Obtener el dropdown y forzar posici\u00f3n hacia abajo\n            const $dropdown = jQuery('.select2-dropdown');\n            if ($dropdown.length) {\n              \/\/ Forzar posici\u00f3n hacia abajo - el CSS ya maneja esto, pero lo reforzamos aqu\u00ed\n              $dropdown.css({\n                'top': '',\n                'bottom': 'auto',\n                'margin-top': '4px',\n                'margin-bottom': '0',\n                'position': 'absolute',\n                'transform': 'none'\n              });\n              \n              \/\/ Asegurar que el contenedor tenga la clase correcta\n              $container.removeClass('select2-container--above').addClass('select2-container--below');\n            }\n          });\n          \n          \/\/ Asegurar que el campo de b\u00fasqueda sea visible\n          setTimeout(function() {\n            const $dropdown = jQuery('.select2-dropdown');\n            const $searchContainer = $dropdown.find('.select2-search--dropdown');\n            const $searchField = $searchContainer.find('.select2-search__field');\n            \n            if ($searchContainer.length) {\n              $searchContainer.css({\n                'display': 'block',\n                'visibility': 'visible',\n                'opacity': '1'\n              });\n            }\n            \n            if ($searchField.length) {\n              $searchField.css({\n                'display': 'block',\n                'visibility': 'visible',\n                'opacity': '1'\n              });\n              \n              \/\/ Enfocar el campo\n              setTimeout(function() {\n                $searchField.focus();\n              }, 100);\n              \n              \/\/ Forzar actualizaci\u00f3n din\u00e1mica al escribir\n              $searchField.on('input.select2-dynamic', function() {\n                const select2Instance = jQuery(e.target).data('select2');\n                if (select2Instance) {\n                  const term = jQuery(this).val() || '';\n                  select2Instance.dataAdapter.query({ term: term }, function(data) {\n                    select2Instance.updateResults(data);\n                    \n                    \/\/ Despu\u00e9s de actualizar resultados, filtrar si hay coincidencias exactas\n                    setTimeout(function() {\n                      const $results = $dropdown.find('.select2-results__options');\n                      const $items = $results.find('.select2-results__option[role=\"option\"]:not(.select2-results__option--loading)');\n                      \n                      if ($items.length > 0) {\n                        \/\/ Verificar si hay coincidencias exactas (score 10000)\n                        let hasExactMatch = false;\n                        $items.each(function() {\n                          const $item = jQuery(this);\n                          const $span = $item.find('span[data-match-score]');\n                          if ($span.length) {\n                            const score = parseInt($span.attr('data-match-score') || '0', 10);\n                            if (score >= 10000) {\n                              hasExactMatch = true;\n                              return false; \/\/ break\n                            }\n                          }\n                        });\n                        \n                        if (hasExactMatch) {\n                          \/\/ Ocultar elementos con score < 9500\n                          $items.each(function() {\n                            const $item = jQuery(this);\n                            const $span = $item.find('span[data-match-score]');\n                            if ($span.length) {\n                              const score = parseInt($span.attr('data-match-score') || '0', 10);\n                              if (score < 9500) {\n                                $item.hide();\n                              } else {\n                                $item.show();\n                              }\n                            } else {\n                              $item.show(); \/\/ Mostrar si no tiene score\n                            }\n                          });\n                        } else {\n                          \/\/ Si no hay exactas, verificar si hay muy cercanas (>= 9000)\n                          let hasVeryClose = false;\n                          $items.each(function() {\n                            const $item = jQuery(this);\n                            const $span = $item.find('span[data-match-score]');\n                            if ($span.length) {\n                              const score = parseInt($span.attr('data-match-score') || '0', 10);\n                              if (score >= 9000) {\n                                hasVeryClose = true;\n                                return false; \/\/ break\n                              }\n                            }\n                          });\n                          \n                          if (hasVeryClose) {\n                            \/\/ Mostrar solo las muy cercanas (hasta 5)\n                            let count = 0;\n                            $items.each(function() {\n                              const $item = jQuery(this);\n                              const $span = $item.find('span[data-match-score]');\n                              if ($span.length) {\n                                const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                if (score >= 9000 && count < 5) {\n                                  $item.show();\n                                  count++;\n                                } else {\n                                  $item.hide();\n                                }\n                              } else {\n                                $item.hide(); \/\/ Ocultar si no tiene score\n                              }\n                            });\n                          } else {\n                            \/\/ Mostrar todos (hasta 10)\n                            let count = 0;\n                            $items.each(function() {\n                              if (count < 10) {\n                                jQuery(this).show();\n                                count++;\n                              } else {\n                                jQuery(this).hide();\n                              }\n                            });\n                          }\n                        }\n                      }\n                    }, 150);\n                  });\n                }\n              });\n            }\n          }, 50);\n        });\n      }); \/\/ Cerrar .each()\n    }\n  }\n\n  \/***************************************************\n   *  A\u00f1adir y remover destino\n   ***************************************************\/\n  function addDestino(){\n    const tpl = document.getElementById('tpl-destino');\n    const cont = document.getElementById('destinos-extra');\n    const btn  = document.getElementById('btn-add-destino');\n\n    cont.appendChild(tpl.content.cloneNode(true));\n    cont.parentNode.appendChild(btn);\n\n    initSelect2('#destinos-extra');\n  }\n  function removeDestino(btn){\n    btn.parentElement.remove();\n  }\n\n  window.addDestino    = addDestino;\n  window.removeDestino = removeDestino;\n\n  \/***************************************************\n   *  Validaci\u00f3n UX\n   ***************************************************\/\n  document.addEventListener('DOMContentLoaded', function(){\n\n    initSelect2('.gofast-form');\n\n    const form      = document.getElementById('gofast-form');\n    const submitBtn = document.getElementById('btn-submit');\n    const loader    = document.getElementById('gofast-loading');\n\n    if (!form) return;\n\n    \/\/ Manejar cambio del select de origen para agregar campos hidden de negocio\n    const origenSelect = document.getElementById('origen');\n    if (origenSelect) {\n      origenSelect.addEventListener('change', function() {\n        \/\/ Eliminar campos hidden anteriores\n        const existingNegocioId = document.getElementById('hidden-negocio-id');\n        const existingClienteId = document.getElementById('hidden-cliente-id');\n        if (existingNegocioId) existingNegocioId.remove();\n        if (existingClienteId) existingClienteId.remove();\n        \n        \/\/ Obtener la opci\u00f3n seleccionada\n        const selectedOption = this.options[this.selectedIndex];\n        if (selectedOption) {\n          const isNegocio = selectedOption.getAttribute('data-is-negocio') === 'true';\n          const negocioId = selectedOption.getAttribute('data-negocio-id');\n          const clienteId = selectedOption.getAttribute('data-cliente-id');\n          \n          if (isNegocio && negocioId) {\n            \/\/ Agregar campos hidden para negocio_id y cliente_id\n            const negocioInput = document.createElement('input');\n            negocioInput.type = 'hidden';\n            negocioInput.name = 'negocio_id';\n            negocioInput.id = 'hidden-negocio-id';\n            negocioInput.value = negocioId;\n            form.appendChild(negocioInput);\n            \n            if (clienteId) {\n              const clienteInput = document.createElement('input');\n              clienteInput.type = 'hidden';\n              clienteInput.name = 'cliente_id';\n              clienteInput.id = 'hidden-cliente-id';\n              clienteInput.value = clienteId;\n              form.appendChild(clienteInput);\n            }\n          }\n        }\n      });\n      \n      \/\/ Ejecutar al cargar la p\u00e1gina si ya hay una opci\u00f3n seleccionada\n      if (origenSelect.value) {\n        origenSelect.dispatchEvent(new Event('change'));\n      }\n    }\n\n    form.addEventListener('submit', function(e){\n      const origen = document.getElementById('origen').value;\n      const destino = document.getElementById('destino-principal').value;\n\n      if (!origen || !destino){\n        e.preventDefault();\n        alert(\"Debes seleccionar origen y al menos un destino \u26a0\ufe0f\");\n        return false;\n      }\n\n      submitBtn.disabled   = true;\n      loader.style.display = 'block';\n    });\n  });\n\n})();\n<\/script>\n<?php });\n\n","active":true,"modified":"2025-12-05 17:14:38","revision":"1"}]}