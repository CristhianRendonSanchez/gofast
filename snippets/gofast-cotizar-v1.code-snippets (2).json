/*******************************************************
 * ‚úÖ GOFAST ‚Äî COTIZAR V2 (Selector inteligente con negocios)
 *******************************************************/
 function gofast_cotizar_shortcode() {
    global $wpdb;

    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }

    // Recuperar cotizaci√≥n anterior
    $old_data = $_SESSION['gofast_last_quote'] ?? [
        'origen'   => '',
        'destinos' => []
    ];

    // Guardar si env√≠an formulario
    if (isset($_POST['gofast_cotizar'])) {
        $_SESSION['gofast_last_quote'] = [
            'origen'   => sanitize_text_field($_POST['origen']),
            'destinos' => array_map('sanitize_text_field', $_POST['destino'] ?? [])
        ];
    }

    // Limpiar
    if (isset($_POST['gofast_reset'])) {
        unset($_SESSION['gofast_last_quote']);
        $old_data = ['origen' => '', 'destinos' => []];
    }

    /*******************************************************
     * üî• 1. Negocios del usuario logueado
     *******************************************************/
    $user_id = $_SESSION['gofast_user_id'] ?? 0;

    $mis_negocios = [];
    if ($user_id) {
        $mis_negocios = $wpdb->get_results($wpdb->prepare(
            "SELECT id, nombre, barrio_id 
             FROM negocios_gofast 
             WHERE user_id=%d 
             ORDER BY id DESC",
            $user_id
        ));
    }

    // Barrios prioritarios
    $barrios_prioritarios = [];
    foreach ($mis_negocios as $n) {
        if ($n->barrio_id && !in_array($n->barrio_id, $barrios_prioritarios, true)) {
            $barrios_prioritarios[] = $n->barrio_id;
        }
    }

    /*******************************************************
     * üî• 2. Obtener TODOS los barrios y reordenarlos
     *******************************************************/
    $barrios_all = $wpdb->get_results("SELECT id, nombre FROM barrios ORDER BY nombre ASC");
    $barrios     = [];

    // Asegurar que siempre haya barrios (incluso si la consulta falla, usar array vac√≠o)
    if (!$barrios_all) {
        $barrios_all = [];
    }

    // Primero los barrios de negocios
    foreach ($barrios_all as $b) {
        if (in_array($b->id, $barrios_prioritarios, true)) {
            $barrios[] = $b;
        }
    }
    // Luego los dem√°s
    foreach ($barrios_all as $b) {
        if (!in_array($b->id, $barrios_prioritarios, true)) {
            $barrios[] = $b;
        }
    }
    
    // Si no hay barrios prioritarios, usar todos los barrios directamente
    if (empty($barrios_prioritarios) && !empty($barrios_all)) {
        $barrios = $barrios_all;
    }

    /*******************************************************
     * üî• 3. AUTOPRELLENAR ORIGEN si no existe
     *******************************************************/
    if (empty($old_data['origen']) && !empty($barrios_prioritarios)) {
        $old_data['origen'] = $barrios_prioritarios[0];
    }

    ob_start();
    ?>
    <div class="gofast-form">

        <?php if (!empty($old_data['origen'])): ?>
            <div class="gofast-box" style="background:#fff3cd;padding:10px;border-radius:6px;margin-bottom:12px;">
                ‚ö° Se ha cargado tu √∫ltima cotizaci√≥n o tu negocio registrado.
            </div>
        <?php endif; ?>

        <form method="post" action="/solicitar-mensajero" id="gofast-form">

            <!-- ORIGEN -->
            <div class="gofast-row">
                <div style="flex:1;">
                    <label><strong>Origen</strong></label>
                    <select name="origen" class="gofast-select" id="origen" required>
                        <option value="">Buscar direcci√≥n...</option>
                        <?php 
                        // Agregar opciones de negocios al select para que se muestren cuando est√°n seleccionados
                        if (!empty($mis_negocios)): 
                            foreach ($mis_negocios as $n):
                                $barrio_nombre = $wpdb->get_var(
                                    $wpdb->prepare("SELECT nombre FROM barrios WHERE id=%d", $n->barrio_id)
                                );
                                $isSelected = ((string)$old_data['origen'] === (string)$n->barrio_id);
                        ?>
                            <option value="<?= esc_attr($n->barrio_id) ?>" 
                                    data-is-negocio="true"
                                    <?= $isSelected ? 'selected' : '' ?>>
                                üè™ <?= esc_html($n->nombre) ?> ‚Äî <?= esc_html($barrio_nombre) ?>
                            </option>
                        <?php 
                            endforeach;
                        endif; 
                        ?>
                        <?php if (!empty($barrios)): ?>
                            <?php foreach ($barrios as $b): ?>
                                <option value="<?= esc_attr($b->id) ?>"
                                    <?= ((string)$old_data['origen'] === (string)$b->id ? 'selected' : '') ?>>
                                    <?= esc_html($b->nombre) ?>
                                </option>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <!-- Fallback: mostrar todos los barrios directamente si $barrios est√° vac√≠o -->
                            <?php 
                            $barrios_fallback = $wpdb->get_results("SELECT id, nombre FROM barrios ORDER BY nombre ASC");
                            if (!empty($barrios_fallback)): 
                            ?>
                                <?php foreach ($barrios_fallback as $b): ?>
                                    <option value="<?= esc_attr($b->id) ?>"
                                        <?= ((string)$old_data['origen'] === (string)$b->id ? 'selected' : '') ?>>
                                        <?= esc_html($b->nombre) ?>
                                    </option>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        <?php endif; ?>
                    </select>
                </div>

                <!-- PRIMER DESTINO -->
                <div style="flex:1;">
                    <label><strong>Primer destino</strong></label>
                    <select name="destino[]" class="gofast-select" id="destino-principal" required>
                        <option value="">Buscar direcci√≥n...</option>
                        <?php foreach ($barrios as $b): ?>
                            <option value="<?= esc_attr($b->id) ?>"
                                <?= in_array($b->id, $old_data['destinos'], true) ? 'selected' : '' ?>>
                                <?= esc_html($b->nombre) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>

            <!-- DESTINOS ADICIONALES -->
            <div class="gofast-destinos-grid">
                <div class="gofast-destinos-label">
                    <label><strong>Destinos adicionales</strong></label>
                </div>

                <div id="destinos-wrapper">
                    <div id="destinos-extra"></div>
                    <button type="button" id="btn-add-destino"
                            class="gofast-add-button" onclick="addDestino()">
                        ‚ûï Agregar destino adicional
                    </button>
                </div>
            </div>

            <!-- TEMPLATE -->
            <template id="tpl-destino">
                <div class="gofast-destino-item">
                    <select name="destino[]" class="gofast-select" required>
                        <option value="">Buscar direcci√≥n...</option>
                        <?php foreach ($barrios as $b): ?>
                            <option value="<?= esc_attr($b->id) ?>">
                                <?= esc_html($b->nombre) ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                    <button type="button" class="gofast-remove" onclick="removeDestino(this)">‚ùå</button>
                </div>
            </template>

            <div class="gofast-btn-group">
                <button type="submit" name="gofast_cotizar"
                        class="gofast-submit" id="btn-submit">
                    Cotizar üöÄ
                </button>
            </div>

            <div id="gofast-loading"
                 style="display:none;text-align:center;margin-top:10px;">
                <div class="loader"></div>
                <p>Procesando tu solicitud...</p>
            </div>
        </form>
    </div>
    <?php
    return ob_get_clean();
}
add_shortcode('gofast_cotizar', 'gofast_cotizar_shortcode');

/*******************************************************
 * ‚úÖ JS: Select2 + UX Mejorado
 *******************************************************/
add_action('wp_footer', function () { ?>
<script>
(function(){

  /***************************************************
   *  Normalizador (quita tildes)
   ***************************************************/
  const normalize = s => (s || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim();

  /***************************************************
   *  MATCHER EXCLUSIVO PARA ORIGEN (con optgroups)
   ***************************************************/
  function matcherOrigen(params, data){
    // Si no hay data, retornar null
    if (!data) return null;
    
    // Si es un optgroup (tiene children), verificar si tiene hijos que coincidan
    if (data.children && Array.isArray(data.children)) {
      // Si no hay b√∫squeda, mostrar el optgroup completo
      if (!params.term || !params.term.trim()) {
        return data;
      }
      
      // Si hay b√∫squeda, verificar si alg√∫n hijo coincide
      const term = normalize(params.term);
      const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];
      const searchWords = term.split(/\s+/).filter(Boolean).filter(word => {
        return word.length > 2 && !stopWords.includes(word);
      });
      
      const hasMatchingChild = data.children.some(child => {
        if (!child || !child.text || !child.id) return false;
        const childText = normalize(child.text);
        
        // Si no hay palabras significativas, buscar el t√©rmino completo
        if (searchWords.length === 0) {
          return childText.indexOf(term) !== -1;
        }
        
        // Verificar que al menos una palabra significativa coincida
        return searchWords.some(word => {
          if (word.length <= 2) {
            return childText.split(/\s+/).some(textWord => textWord.indexOf(word) === 0);
          }
          return childText.indexOf(word) !== -1;
        });
      });
      
      // Solo mostrar el optgroup si tiene hijos que coincidan
      return hasMatchingChild ? data : null;
    }
    
    // Si no tiene id, es un optgroup label o separador
    if (!data.id) {
      // Sin b√∫squeda, mostrar labels
      if (!params.term || !params.term.trim()) {
        return data;
      }
      // Con b√∫squeda, ocultar labels
      return null;
    }
    
    // Si no tiene text, no mostrar
    if (!data.text) return null;
    
    // Si no hay t√©rmino de b√∫squeda, mostrar todas las opciones
    if (!params.term || !params.term.trim()) {
      data.matchScore = 0;
      return data;
    }

    const term = normalize(params.term);
    if (!term) {
      data.matchScore = 0;
      return data;
    }

    const text = normalize(data.text);
    
    // Palabras comunes a ignorar en la b√∫squeda
    const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];
    
    const searchWords = term.split(/\s+/).filter(Boolean).filter(word => {
      return word.length > 2 && !stopWords.includes(word);
    });
    
    // Si despu√©s de filtrar no quedan palabras, buscar el t√©rmino completo
    if (searchWords.length === 0) {
      if (text.indexOf(term) !== -1) {
        data.matchScore = 7000;
        return data;
      }
      return null;
    }
    
    // Verificar que al menos una palabra significativa est√© presente
    const significantMatches = searchWords.filter(word => {
      if (word.length <= 2) {
        return text.split(/\s+/).some(textWord => textWord.indexOf(word) === 0);
      }
      return text.indexOf(word) !== -1;
    });
    
    if (significantMatches.length === 0) return null;
    
    const allSignificantMatch = searchWords.length === significantMatches.length;

    // Sistema de puntuaci√≥n
    let score = 0;
    
    const textWithoutStopWords = text.split(/\s+/).filter(w => !stopWords.includes(w)).join(' ');
    const termWithoutStopWords = searchWords.join(' ');
    
    if (textWithoutStopWords === termWithoutStopWords) {
      score = 10000;
    } else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {
      score = 9000;
    } else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {
      score = 8000;
    } else if (searchWords.some(word => text.indexOf(word) === 0)) {
      score = 7000;
    } else if (text.indexOf(term) !== -1) {
      score = 6000;
    } else {
      score = allSignificantMatch ? 5000 : 3000;
      
      let lastIndex = -1;
      let wordsInOrder = true;
      searchWords.forEach(word => {
        const wordIndex = text.indexOf(word, lastIndex + 1);
        if (wordIndex === -1) {
          wordsInOrder = false;
        } else {
          if (wordIndex < lastIndex) wordsInOrder = false;
          lastIndex = wordIndex;
          if (text.indexOf(word) === 0) score += 500;
        }
      });
      
      if (wordsInOrder) score += 1000;
    }
    
    data.matchScore = score;
    return data;
  }

  /***************************************************
   *  MATCHER UNIFICADO (para origen y destinos)
   *  Maneja optgroups pero con l√≥gica de b√∫squeda simple
   ***************************************************/
  function matcherDestinos(params, data){
    // Si no hay data, retornar null
    if (!data) return null;
    
    // Si es un optgroup (tiene children), dejarlo pasar para que Select2 lo maneje
    // Select2 procesar√° los hijos individualmente con este mismo matcher
    if (data.children && Array.isArray(data.children)) {
      return data;
    }
    
    // Si no tiene id, es un optgroup label o separador
    // Sin b√∫squeda, mostrarlo; con b√∫squeda, ocultarlo
    if (!data.id) {
      if (!params.term || !params.term.trim()) {
        return data;
      }
      return null;
    }
    
    // Si no tiene text, no mostrar
    if (!data.text) return null;
    
    // Si no hay t√©rmino de b√∫squeda, mostrar todas las opciones
    if (!params.term || !params.term.trim()) {
      data.matchScore = 0;
      return data;
    }

    const term = normalize(params.term);
    if (!term) {
      data.matchScore = 0;
      return data;
    }

    const text = normalize(data.text);
    
    // Palabras comunes a ignorar en la b√∫squeda
    const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];
    
    const searchWords = term.split(/\s+/).filter(Boolean).filter(word => {
      return word.length > 2 && !stopWords.includes(word);
    });
    
    // Si despu√©s de filtrar no quedan palabras, buscar el t√©rmino completo
    if (searchWords.length === 0) {
      if (text.indexOf(term) !== -1) {
        data.matchScore = 7000;
        return data;
      }
      return null;
    }
    
    // Verificar que al menos una palabra significativa est√© presente
    const significantMatches = searchWords.filter(word => {
      if (word.length <= 2) {
        return text.split(/\s+/).some(textWord => textWord.indexOf(word) === 0);
      }
      return text.indexOf(word) !== -1;
    });
    
    if (significantMatches.length === 0) return null;
    
    const allSignificantMatch = searchWords.length === significantMatches.length;

    // Sistema de puntuaci√≥n
    let score = 0;
    
    const textWithoutStopWords = text.split(/\s+/).filter(w => !stopWords.includes(w)).join(' ');
    const termWithoutStopWords = searchWords.join(' ');
    
    if (textWithoutStopWords === termWithoutStopWords) {
      score = 10000;
    } else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {
      score = 9000;
    } else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {
      score = 8000;
    } else if (searchWords.some(word => text.indexOf(word) === 0)) {
      score = 7000;
    } else if (text.indexOf(term) !== -1) {
      score = 6000;
    } else {
      score = allSignificantMatch ? 5000 : 3000;
      
      let lastIndex = -1;
      let wordsInOrder = true;
      searchWords.forEach(word => {
        const wordIndex = text.indexOf(word, lastIndex + 1);
        if (wordIndex === -1) {
          wordsInOrder = false;
        } else {
          if (wordIndex < lastIndex) wordsInOrder = false;
          lastIndex = wordIndex;
          if (text.indexOf(word) === 0) score += 500;
        }
      });
      
      if (wordsInOrder) score += 1000;
    }
    
    data.matchScore = score;
    return data;
  }

  /***************************************************
   *  INIT SELECT2 (UNIFICADO + ALWAYS DOWN)
   ***************************************************/
  function initSelect2(container){
    if (window.jQuery && jQuery.fn.select2) {

      jQuery(container).find('.gofast-select').each(function() {
        // Evitar inicializar dos veces
        if (jQuery(this).data('select2')) {
          return;
        }
        
        // Usar el mismo matcher para todos (origen y destinos)
        // La presentaci√≥n de optgroups se mantiene en el HTML
        jQuery(this).select2({
          placeholder: "üîç Escribe para buscar direcci√≥n...",
          width: '100%',
          dropdownParent: jQuery('body'),       // üëâ dropdown en <body>
          allowClear: true,
          minimumResultsForSearch: 0,  // SIEMPRE mostrar campo de b√∫squeda
          selectOnClose: true,
          dropdownAutoWidth: true,
          dropdownCssClass: "gofast-select-down",
          // Forzar que Select2 procese optgroups correctamente
          templateSelection: function(data) {
            return data.text || data.id;
          },

        // Usar el mismo matcher para todos (simplificado, igual que destino)
        matcher: matcherDestinos,

        sorter: function(results){
          return results.sort(function(a,b){
            return (b.matchScore || 0) - (a.matchScore || 0);
          });
        },

        templateResult: function(data, container){
          // Manejar optgroups (no tienen id pero tienen children)
          if (!data || !data.text) {
            if (data && data.children) return data.text; // Retornar label del optgroup
            return data ? data.text : '';
          }
          
          // Si no tiene id, es un optgroup label, retornar sin modificar
          if (!data.id) return data.text;

          let originalText = data.text;
          
          // Obtener el t√©rmino de b√∫squeda del campo activo
          let searchTerm = "";
          const $activeField = jQuery('.select2-container--open .select2-search__field');
          if ($activeField.length) {
            searchTerm = $activeField.val() || "";
          }
          
          if (!searchTerm || !searchTerm.trim()) {
            return jQuery('<span>' + originalText + '</span>');
          }

          // Normalizar para b√∫squeda sin tildes
          const normalizedSearch = normalize(searchTerm);
          const normalizedText = normalize(originalText);
          
          // Dividir t√©rmino en palabras
          const searchWords = normalizedSearch.split(/\s+/).filter(Boolean);
          
          // Crear array de caracteres para mapeo preciso
          const textChars = originalText.split('');
          const normalizedChars = normalizedText.split('');
          
          // Encontrar y resaltar cada palabra
          let result = originalText;
          let offset = 0;
          
          // Procesar palabras en orden inverso para mantener √≠ndices correctos
          searchWords.slice().reverse().forEach(function(word) {
            let searchPos = 0;
            const matches = [];
            
            // Encontrar todas las ocurrencias de la palabra
            while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {
              matches.push({ start: searchPos, end: searchPos + word.length });
              searchPos += word.length;
            }
            
            // Procesar matches en orden inverso para mantener √≠ndices
            matches.reverse().forEach(function(match) {
              // Mapear posici√≥n normalizada a posici√≥n original
              let originalStart = 0;
              let originalEnd = 0;
              let normalizedPos = 0;
              
              // Encontrar inicio
              for (let i = 0; i < textChars.length; i++) {
                const charNorm = normalize(textChars[i]);
                if (normalizedPos === match.start) {
                  originalStart = i;
                  break;
                }
                normalizedPos += charNorm.length;
              }
              
              // Encontrar fin
              normalizedPos = match.start;
              for (let i = originalStart; i < textChars.length; i++) {
                const charNorm = normalize(textChars[i]);
                normalizedPos += charNorm.length;
                if (normalizedPos >= match.end) {
                  originalEnd = i + 1;
                  break;
                }
              }
              
              // Resaltar
              const before = result.substring(0, originalStart);
              const matchText = result.substring(originalStart, originalEnd);
              const after = result.substring(originalEnd);
              result = before + 
                       '<span style="background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;">' + 
                       matchText + '</span>' + after;
            });
          });
          
          return jQuery('<span>' + result + '</span>');
        }
        }).on('select2:open', function(e) {
          const $select = jQuery(this);
          const $container = $select.next('.select2-container');
          
          // FORZAR que el dropdown siempre abra hacia abajo
          // Usar requestAnimationFrame para asegurar que se ejecute despu√©s de que Select2 posicione el dropdown
          requestAnimationFrame(function() {
            // Remover clase --above si existe y agregar --below
            $container.removeClass('select2-container--above').addClass('select2-container--below');
            
            // Obtener el dropdown y forzar posici√≥n hacia abajo
            const $dropdown = jQuery('.select2-dropdown');
            if ($dropdown.length) {
              // Forzar posici√≥n hacia abajo - el CSS ya maneja esto, pero lo reforzamos aqu√≠
              $dropdown.css({
                'top': '',
                'bottom': 'auto',
                'margin-top': '4px',
                'margin-bottom': '0',
                'position': 'absolute',
                'transform': 'none'
              });
              
              // Asegurar que el contenedor tenga la clase correcta
              $container.removeClass('select2-container--above').addClass('select2-container--below');
            }
          });
          
          // Asegurar que el campo de b√∫squeda sea visible
          setTimeout(function() {
            const $dropdown = jQuery('.select2-dropdown');
            const $searchContainer = $dropdown.find('.select2-search--dropdown');
            const $searchField = $searchContainer.find('.select2-search__field');
            
            if ($searchContainer.length) {
              $searchContainer.css({
                'display': 'block',
                'visibility': 'visible',
                'opacity': '1'
              });
            }
            
            if ($searchField.length) {
              $searchField.css({
                'display': 'block',
                'visibility': 'visible',
                'opacity': '1'
              });
              
              // Enfocar el campo
              setTimeout(function() {
                $searchField.focus();
              }, 100);
              
              // Forzar actualizaci√≥n din√°mica al escribir
              $searchField.on('input.select2-dynamic', function() {
                const select2Instance = jQuery(e.target).data('select2');
                if (select2Instance) {
                  const term = jQuery(this).val() || '';
                  select2Instance.dataAdapter.query({ term: term }, function(data) {
                    select2Instance.updateResults(data);
                  });
                }
              });
            }
          }, 50);
        });
      }); // Cerrar .each()
    }
  }

  /***************************************************
   *  A√±adir y remover destino
   ***************************************************/
  function addDestino(){
    const tpl = document.getElementById('tpl-destino');
    const cont = document.getElementById('destinos-extra');
    const btn  = document.getElementById('btn-add-destino');

    cont.appendChild(tpl.content.cloneNode(true));
    cont.parentNode.appendChild(btn);

    initSelect2('#destinos-extra');
  }
  function removeDestino(btn){
    btn.parentElement.remove();
  }

  window.addDestino    = addDestino;
  window.removeDestino = removeDestino;

  /***************************************************
   *  Validaci√≥n UX
   ***************************************************/
  document.addEventListener('DOMContentLoaded', function(){

    initSelect2('.gofast-form');

    const form      = document.getElementById('gofast-form');
    const submitBtn = document.getElementById('btn-submit');
    const loader    = document.getElementById('gofast-loading');

    if (!form) return;

    form.addEventListener('submit', function(e){
      const origen = document.getElementById('origen').value;
      const destino = document.getElementById('destino-principal').value;

      if (!origen || !destino){
        e.preventDefault();
        alert("Debes seleccionar origen y al menos un destino ‚ö†Ô∏è");
        return false;
      }

      submitBtn.disabled   = true;
      loader.style.display = 'block';
    });
  });

})();
</script>
<?php });
