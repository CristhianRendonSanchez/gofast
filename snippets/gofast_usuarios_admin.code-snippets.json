{
  "generator": "Code Snippets v3.9.2",
  "date_created": "2025-11-21 22:43",
  "snippets": [
    {
      "id": 25,
      "name": "gofast_usuarios_admin",
      "code": "/***************************************************\n * GOFAST ‚Äì ADMIN GESTI√ìN DE USUARIOS\n * Shortcode: [gofast_usuarios_admin]\n * URL: /admin-usuarios\n ***************************************************/\nfunction gofast_usuarios_admin_shortcode() {\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    global $wpdb;\n\n    $tabla = 'usuarios_gofast';\n    $mensaje = '';\n\n    /* ==========================================================\n       0. Validar usuario admin\n    ========================================================== */\n    $usuario = null;\n    if (!empty($_SESSION['gofast_user_id'])) {\n        $uid = (int) $_SESSION['gofast_user_id'];\n        $usuario = $wpdb->get_row(\n            $wpdb->prepare(\n                \"SELECT id, nombre, rol, activo \n                 FROM usuarios_gofast \n                 WHERE id = %d AND activo = 1\",\n                $uid\n            )\n        );\n    }\n\n    if (!$usuario || strtolower($usuario->rol) !== 'admin') {\n        return \"<div class='gofast-box'>\n                    ‚ö†Ô∏è Solo los administradores pueden gestionar usuarios.\n                </div>\";\n    }\n\n    /* ==========================================================\n       1. Procesar POST (crear, editar, eliminar)\n    ========================================================== */\n    if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n\n        if (\n            empty($_POST['gofast_usuarios_nonce']) ||\n            !wp_verify_nonce($_POST['gofast_usuarios_nonce'], 'gofast_usuarios_admin')\n        ) {\n            return \"<div class='gofast-box'>üîí Error de seguridad al guardar cambios.</div>\";\n        }\n\n        /* ----------------------------------------------\n           A) Crear nuevo usuario\n        ---------------------------------------------- */\n        if (!empty($_POST['gofast_crear_usuario'])) {\n\n            $nombre    = sanitize_text_field($_POST['nuevo_nombre'] ?? '');\n            $telefono  = sanitize_text_field($_POST['nuevo_telefono'] ?? '');\n            $email     = sanitize_email($_POST['nuevo_email'] ?? '');\n            $password  = $_POST['nuevo_password'] ?? '';\n            $rol       = sanitize_text_field($_POST['nuevo_rol'] ?? 'cliente');\n            $activo    = !empty($_POST['nuevo_activo']) ? 1 : 0;\n\n            if ($nombre === '' || $telefono === '' || $email === '' || $password === '') {\n                $mensaje = \"‚ö†Ô∏è Todos los campos son obligatorios.\";\n            } elseif (!is_email($email)) {\n                $mensaje = \"‚ö†Ô∏è El correo no es v√°lido.\";\n            } elseif (!in_array($rol, ['cliente', 'mensajero', 'admin'], true)) {\n                $mensaje = \"‚ö†Ô∏è Rol no v√°lido.\";\n            } else {\n                $tel_norm = preg_replace('/\\D+/', '', $telefono);\n\n                // Verificar duplicados\n                $existe = $wpdb->get_row(\n                    $wpdb->prepare(\n                        \"SELECT id FROM $tabla \n                         WHERE email = %s \n                            OR REPLACE(REPLACE(REPLACE(telefono, '+',''), ' ','') ,'-','') = %s\",
                        $email,\n                        $tel_norm\n                    )\n                );\n\n                if ($existe) {\n                    $mensaje = \"‚ö†Ô∏è Ya existe un usuario con ese correo o tel√©fono.\";\n                } else {\n                    $hash = password_hash($password, PASSWORD_DEFAULT);\n\n                    $ok = $wpdb->insert(\n                        $tabla,\n                        [\n                            'nombre'         => $nombre,\n                            'telefono'       => $telefono,\n                            'email'          => $email,\n                            'password_hash'  => $hash,\n                            'rol'            => $rol,\n                            'activo'         => $activo,\n                            'fecha_registro' => current_time('mysql'),\n                            'remember_token' => null\n                        ],\n                        ['%s','%s','%s','%s','%s','%d','%s','%s']\n                    );\n\n                    if ($ok !== false) {\n                        $mensaje = \"‚úÖ Usuario creado correctamente.\";\n                    } else {\n                        $mensaje = \"‚ùå Error al crear usuario: \" . esc_html($wpdb->last_error);\n                    }\n                }\n            }\n        }\n\n        /* ----------------------------------------------\n           B) Editar usuarios existentes\n        ---------------------------------------------- */\n        if (!empty($_POST['gofast_guardar_usuarios'])) {\n\n            // Actualizar usuarios\n            if (!empty($_POST['usuarios']) && is_array($_POST['usuarios'])) {\n                foreach ($_POST['usuarios'] as $user_id => $data) {\n                    $user_id = (int) $user_id;\n                    if ($user_id <= 0) continue;\n\n                    $nombre   = sanitize_text_field($data['nombre'] ?? '');\n                    $telefono = sanitize_text_field($data['telefono'] ?? '');\n                    $email    = sanitize_email($data['email'] ?? '');\n                    $rol      = sanitize_text_field($data['rol'] ?? 'cliente');\n                    $activo   = !empty($data['activo']) ? 1 : 0;\n                    $password = $data['password'] ?? '';\n\n                    if (!in_array($rol, ['cliente', 'mensajero', 'admin'], true)) {\n                        continue;\n                    }\n\n                    $update_data = [\n                        'nombre'   => $nombre,\n                        'telefono' => $telefono,\n                        'email'    => $email,\n                        'rol'      => $rol,\n                        'activo'   => $activo\n                    ];\n\n                    // Si hay nueva contrase√±a, actualizarla\n                    if ($password !== '') {\n                        $update_data['password_hash'] = password_hash($password, PASSWORD_DEFAULT);\n                    }\n\n                    $wpdb->update(\n                        $tabla,\n                        $update_data,\n                        ['id' => $user_id],\n                        $password !== '' ? ['%s','%s','%s','%s','%d','%s'] : ['%s','%s','%s','%s','%d'],\n                        ['%d']\n                    );\n                }\n            }\n\n            // Eliminar usuarios\n            if (!empty($_POST['eliminar_usuario']) && is_array($_POST['eliminar_usuario'])) {\n                foreach ($_POST['eliminar_usuario'] as $user_id => $flag) {\n                    if ($flag != '1') continue;\n                    $user_id = (int) $user_id;\n                    if ($user_id > 0 && $user_id !== (int) $_SESSION['gofast_user_id']) {\n                        // No permitir auto-eliminarse\n                        $wpdb->update($tabla, ['activo' => 0], ['id' => $user_id]);\n                    }\n                }\n            }\n\n            if ($mensaje === '') {\n                $mensaje = \"‚úÖ Cambios guardados correctamente.\";\n            }\n        }\n    }\n\n    /* ==========================================================\n       2. Filtros (GET)\n    ========================================================== */\n    $filtro_rol = isset($_GET['rol']) ? sanitize_text_field($_GET['rol']) : '';\n    $filtro_activo = isset($_GET['activo']) ? sanitize_text_field($_GET['activo']) : '';\n    $buscar = isset($_GET['q']) ? sanitize_text_field($_GET['q']) : '';\n\n    $where = \"1=1\";\n    $params = [];\n\n    if ($filtro_rol !== '' && $filtro_rol !== 'todos') {\n        $where .= \" AND rol = %s\";\n        $params[] = $filtro_rol;\n    }\n\n    if ($filtro_activo !== '' && $filtro_activo !== 'todos') {\n        $where .= \" AND activo = %d\";\n        $params[] = ($filtro_activo === 'activo') ? 1 : 0;\n    }\n\n    if ($buscar !== '') {\n        $like = '%' . $wpdb->esc_like($buscar) . '%';\n        $where .= \" AND (nombre LIKE %s OR email LIKE %s OR telefono LIKE %s)\";\n        $params[] = $like;\n        $params[] = $like;\n        $params[] = $like;\n    }\n\n    /* ==========================================================\n       3. Paginaci√≥n\n    ========================================================== */\n    $por_pagina = 20;\n    $pagina = isset($_GET['pg']) ? max(1, (int) $_GET['pg']) : 1;\n    $offset = ($pagina - 1) * $por_pagina;\n\n    if (!empty($params)) {\n        $sql_count = $wpdb->prepare(\n            \"SELECT COUNT(*) FROM $tabla WHERE $where\",\n            $params\n        );\n    } else {\n        $sql_count = \"SELECT COUNT(*) FROM $tabla WHERE $where\";\n    }\n\n    $total_registros = (int) $wpdb->get_var($sql_count);\n    $total_paginas = max(1, (int) ceil($total_registros / $por_pagina));\n\n    $params_datos = $params;\n    $params_datos[] = $por_pagina;\n    $params_datos[] = $offset;\n\n    $sql_datos = $wpdb->prepare(\n        \"SELECT * FROM $tabla \n         WHERE $where\n         ORDER BY fecha_registro DESC\n         LIMIT %d OFFSET %d\",\n        $params_datos\n    );\n\n    $usuarios = $wpdb->get_results($sql_datos);\n\n    /* ==========================================================\n       4. HTML\n    ========================================================== */\n    ob_start();\n    ?>\n\n<div class=\"gofast-home\">\n    <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;\">\n        <div>\n            <h1 style=\"margin-bottom:8px;\">üë• Gesti√≥n de Usuarios</h1>\n            <p class=\"gofast-home-text\">\n                Crea, edita y gestiona usuarios del sistema.\n            </p>\n        </div>\n        <a href=\"<?php echo esc_url( home_url('/dashboard-admin') ); ?>\" class=\"gofast-btn-request\" style=\"text-decoration:none;\">\n            ‚Üê Volver al Dashboard\n        </a>\n    </div>\n\n    <?php if ($mensaje): ?>\n        <div class=\"gofast-box\" style=\"margin-bottom:15px;\">\n            <?= esc_html($mensaje); ?>\n        </div>\n    <?php endif; ?>\n\n    <form method=\"post\">\n        <?php wp_nonce_field('gofast_usuarios_admin', 'gofast_usuarios_nonce'); ?>\n\n        <!-- =====================================================\n             A) CREAR NUEVO USUARIO\n        ====================================================== -->\n        <div class=\"gofast-box\" style=\"margin-bottom:20px;\">\n            <h3 style=\"margin-top:0;\">‚ûï Nuevo usuario</h3>\n\n            <div class=\"gofast-recargo-nuevo\" style=\"display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;\">\n                <div>\n                    <label>Nombre completo</label>\n                    <input type=\"text\" name=\"nuevo_nombre\" placeholder=\"Ej: Juan P√©rez\" required>\n                </div>\n                <div>\n                    <label>Tel√©fono</label>\n                    <input type=\"text\" name=\"nuevo_telefono\" placeholder=\"Ej: 3001234567\" required>\n                </div>\n                <div>\n                    <label>Email</label>\n                    <input type=\"email\" name=\"nuevo_email\" placeholder=\"Ej: juan@example.com\" required>\n                </div>\n                <div>\n                    <label>Contrase√±a</label>\n                    <input type=\"password\" name=\"nuevo_password\" placeholder=\"M√≠nimo 6 caracteres\" required minlength=\"6\">\n                </div>\n                <div>\n                    <label>Rol</label>\n                    <select name=\"nuevo_rol\" required>\n                        <option value=\"cliente\">Cliente</option>\n                        <option value=\"mensajero\">Mensajero</option>\n                        <option value=\"admin\">Administrador</option>\n                    </select>\n                </div>\n                <div style=\"display:flex;align-items:flex-end;\">\n                    <label class=\"gofast-switch\">\n                        <input type=\"checkbox\" name=\"nuevo_activo\" value=\"1\" checked>\n                        <span class=\"gofast-switch-slider\"></span>\n                        <span class=\"gofast-switch-label\">Activo</span>\n                    </label>\n                </div>\n                <div style=\"display:flex;align-items:flex-end;\">\n                    <button type=\"submit\" name=\"gofast_crear_usuario\" class=\"gofast-small-btn\">\n                        üíæ Crear usuario\n                    </button>\n                </div>\n            </div>\n        </div>\n\n        <!-- =====================================================\n             B) FILTROS\n        ====================================================== -->\n        <div class=\"gofast-box\" style=\"margin-bottom:20px;\">\n            <form method=\"get\" class=\"gofast-pedidos-filtros\">\n                <div class=\"gofast-pedidos-filtros-row\">\n                    <div>\n                        <label>Rol</label>\n                        <select name=\"rol\">\n                            <option value=\"todos\"<?php selected($filtro_rol, 'todos'); ?>>Todos</option>\n                            <option value=\"cliente\"<?php selected($filtro_rol, 'cliente'); ?>>Cliente</option>\n                            <option value=\"mensajero\"<?php selected($filtro_rol, 'mensajero'); ?>>Mensajero</option>\n                            <option value=\"admin\"<?php selected($filtro_rol, 'admin'); ?>>Admin</option>\n                        </select>\n                    </div>\n\n                    <div>\n                        <label>Estado</label>\n                        <select name=\"activo\">\n                            <option value=\"todos\"<?php selected($filtro_activo, 'todos'); ?>>Todos</option>\n                            <option value=\"activo\"<?php selected($filtro_activo, 'activo'); ?>>Activo</option>\n                            <option value=\"inactivo\"<?php selected($filtro_activo, 'inactivo'); ?>>Inactivo</option>\n                        </select>\n                    </div>\n\n                    <div>\n                        <label>Buscar</label>\n                        <input type=\"text\" name=\"q\" placeholder=\"Nombre, email o tel√©fono\" value=\"<?php echo esc_attr($buscar); ?>\">\n                    </div>\n\n                    <div class=\"gofast-pedidos-filtros-actions\">\n                        <button type=\"submit\" class=\"gofast-btn-mini\">Filtrar</button>\n                        <a href=\"<?php echo esc_url( get_permalink() ); ?>\" class=\"gofast-btn-mini gofast-btn-outline\">Limpiar</a>\n                    </div>\n                </div>\n            </form>\n        </div>\n\n        <!-- =====================================================\n             C) LISTADO DE USUARIOS\n        ====================================================== -->\n        <div class=\"gofast-box\">\n            <h3 style=\"margin-top:0;\">üìã Usuarios (<?= number_format($total_registros); ?>)</h3>\n\n            <?php if (empty($usuarios)): ?>\n                <p>No se encontraron usuarios con los filtros seleccionados.</p>\n            <?php else: ?>\n\n                <div class=\"gofast-table-wrap\">\n                    <table class=\"gofast-table\">\n                        <thead>\n                            <tr>\n                                <th>ID</th>\n                                <th>Nombre</th>\n                                <th>Email</th>\n                                <th>Tel√©fono</th>\n                                <th>Rol</th>\n                                <th>Estado</th>\n                                <th>Registro</th>\n                                <th>Acciones</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                        <?php foreach ($usuarios as $u):\n                            $es_yo = ((int) $u->id === (int) $_SESSION['gofast_user_id']);\n                            ?>\n                            <tr class=\"<?= $u->activo ? 'gofast-row-active' : 'gofast-row-inactive'; ?>\">\n                                <td>#<?= (int) $u->id; ?></td>\n                                <td>\n                                    <input type=\"text\"\n                                           name=\"usuarios[<?= esc_attr($u->id); ?>][nombre]\"\n                                           value=\"<?= esc_attr($u->nombre); ?>\"\n                                           style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                </td>\n                                <td>\n                                    <input type=\"email\"\n                                           name=\"usuarios[<?= esc_attr($u->id); ?>][email]\"\n                                           value=\"<?= esc_attr($u->email); ?>\"\n                                           style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                </td>\n                                <td>\n                                    <input type=\"text\"\n                                           name=\"usuarios[<?= esc_attr($u->id); ?>][telefono]\"\n                                           value=\"<?= esc_attr($u->telefono); ?>\"\n                                           style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                </td>\n                                <td>\n                                    <select name=\"usuarios[<?= esc_attr($u->id); ?>][rol]\"\n                                            style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                        <option value=\"cliente\"<?php selected($u->rol, 'cliente'); ?>>Cliente</option>\n                                        <option value=\"mensajero\"<?php selected($u->rol, 'mensajero'); ?>>Mensajero</option>\n                                        <option value=\"admin\"<?php selected($u->rol, 'admin'); ?>>Admin</option>\n                                    </select>\n                                </td>\n                                <td>\n                                    <label class=\"gofast-switch\">\n                                        <input type=\"checkbox\"\n                                               name=\"usuarios[<?= esc_attr($u->id); ?>][activo]\"\n                                               value=\"1\"\n                                               <?= $u->activo ? 'checked' : ''; ?>>\n                                        <span class=\"gofast-switch-slider\"></span>\n                                        <span class=\"gofast-switch-label\">Activo</span>\n                                    </label>\n                                </td>\n                                <td><?= esc_html( date_i18n('Y-m-d', strtotime($u->fecha_registro)) ); ?></td>\n                                <td>\n                                    <div style=\"display:flex;flex-direction:column;gap:4px;\">\n                                        <input type=\"password\"\n                                               name=\"usuarios[<?= esc_attr($u->id); ?>][password]\"\n                                               placeholder=\"Nueva contrase√±a (opcional)\"\n                                               style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:12px;\">\n                                        <?php if (!$es_yo): ?>\n                                            <button type=\"button\"\n                                                    class=\"gofast-small-btn gofast-chip-danger gofast-delete-usuario\"\n                                                    data-usuario-id=\"<?= esc_attr($u->id); ?>\">\n                                                üóëÔ∏è Desactivar\n                                            </button>\n                                        <?php else: ?>\n                                            <span style=\"font-size:11px;color:#666;\">(T√∫)</span>\n                                        <?php endif; ?>\n                                    </div>\n                                </td>\n                            </tr>\n                        <?php endforeach; ?>\n                        </tbody>\n                    </table>\n                </div>\n\n                <?php if ($total_paginas > 1): ?>\n                    <div class=\"gofast-pagination\">\n                        <?php\n                        $base_url = get_permalink();\n                        $query_args = $_GET;\n\n                        for ($i = 1; $i <= $total_paginas; $i++):\n                            $query_args['pg'] = $i;\n                            $url = esc_url( add_query_arg($query_args, $base_url) );\n                            $active = ($i === $pagina) ? 'gofast-page-current' : '';\n                            ?>\n                            <a href=\"<?php echo $url; ?>\" class=\"gofast-page-link <?php echo $active; ?>\">\n                                <?php echo $i; ?>\n                            </a>\n                        <?php endfor; ?>\n                    </div>\n                <?php endif; ?>\n\n                <div style=\"margin-top:18px;text-align:right;\">\n                    <button type=\"submit\"\n                            name=\"gofast_guardar_usuarios\"\n                            value=\"1\"\n                            class=\"gofast-btn-request\"\n                            style=\"max-width:260px;margin-left:auto;\">\n                        üíæ Guardar cambios\n                    </button>\n                </div>\n\n            <?php endif; ?>\n        </div>\n    </form>\n</div>\n\n<script>\ndocument.addEventListener('DOMContentLoaded', function(){\n    // Eliminar usuario\n    document.querySelectorAll('.gofast-delete-usuario').forEach(function(btn){\n        btn.addEventListener('click', function(){\n            const id = btn.getAttribute('data-usuario-id');\n            if (!id) return;\n\n            if (!confirm('¬øSeguro que quieres desactivar este usuario?')) {\n                return;\n            }\n\n            const form = btn.closest('form');\n            if (!form) return;\n\n            let input = form.querySelector('input[name=\"eliminar_usuario['+id+']\"]');\n            if (!input) {\n                input = document.createElement('input');\n                input.type = 'hidden';\n                input.name = 'eliminar_usuario['+id+']';\n                input.value = '1';\n                form.appendChild(input);\n            }\n\n            let flag = form.querySelector('input[name=\"gofast_guardar_usuarios\"]');\n            if (!flag) {\n                flag = document.createElement('input');\n                flag.type = 'hidden';\n                flag.name = 'gofast_guardar_usuarios';\n                flag.value = '1';\n                form.appendChild(flag);\n            }\n\n            form.submit();\n        });\n    });\n});\n</script>\n\n<?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_usuarios_admin', 'gofast_usuarios_admin_shortcode');\n",
      "active": true,
      "modified": "2025-11-21 22:43",
      "revision": "1"
    }
  ]
}

