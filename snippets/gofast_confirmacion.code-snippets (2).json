{
  "generator": "Code Snippets v3.9.2",
  "date_created": "2025-11-21 22:43",
  "snippets": [
    {
      "id": 9,
      "name": "goFast_confirmacion",
      "code": "add_shortcode(\"gofast_confirmacion\", function() {\n\n    if (session_status() === PHP_SESSION_NONE) session_start();\n    global $wpdb;\n\n    $table = \"servicios_gofast\";\n\n    /* ==========================================================\n       1. Validar ID\n    ========================================================== */\n    if (empty($_GET[\"id\"])) {\n        return \"<div class='gofast-box'>\u274c No se encontr\u00f3 el pedido.</div>\";\n    }\n\n    $id = intval($_GET[\"id\"]);\n    $pedido = $wpdb->get_row($wpdb->prepare(\"SELECT * FROM $table WHERE id = %d\", $id));\n\n    if (!$pedido) {\n        return \"<div class='gofast-box'>\u26a0\ufe0f Pedido no encontrado.</div>\";\n    }\n\n    /* ==========================================================\n       2. Vincular usuario autom\u00e1ticamente por tel\u00e9fono\n    ========================================================== */\n    if (!empty($pedido->telefono_cliente) && empty($_SESSION[\"gofast_user_id\"])) {\n        $tel = trim($pedido->telefono_cliente);\n\n        $u = $wpdb->get_row($wpdb->prepare(\n            \"SELECT id FROM usuarios_gofast WHERE telefono = %s LIMIT 1\",\n            $tel\n        ));\n\n        if ($u) {\n            // \u26a0\ufe0f Asocia en DB pero no inicia sesi\u00f3n \"visible\"\n            $wpdb->update($table, [\"user_id\" => $u->id], [\"id\" => $id]);\n            $_SESSION[\"gofast_auto_linked\"] = true;\n            $_SESSION[\"gofast_user_id\"] = intval($u->id);\n        }\n    }\n\n    /* ==========================================================\n       3. Decodificar JSON de destinos\n    ========================================================== */\n    $json = json_decode($pedido->destinos, true);\n    $destinos = $json[\"destinos\"] ?? [];\n\n    /* ==========================================================\n       4. Preparar mensaje para WhatsApp\n    ========================================================== */\n    $telefono_empresa = \"573004452422\";\n    $mensaje = urlencode(\n        \"\ud83d\ude80 Hola, acabo de solicitar un servicio en GoFast.\\n\\n\" .\n        \"\ud83d\udce6 Servicio: #$id\\n\" .\n        \"\ud83d\udccd Origen: {$pedido->direccion_origen}\\n\" .\n        \"\ud83d\udcb0 Total: $\" . number_format($pedido->total, 0, ',', '.') . \"\\n\\n\" .\n        \"Por favor confirmar la recogida. Gracias.\"\n    );\n\n    /* ==========================================================\n       5. INTERFAZ VISUAL (igual que la versi\u00f3n anterior)\n    ========================================================== */\n    ob_start();\n    ?>\n\n<div class=\"gofast-box\" style=\"max-width:650px;margin:25px auto;padding:20px;\">\n    <!-- \u26a0\ufe0f ALERTA IMPORTANTE -->\n    <div style=\"background:#fff9d6;border-left:5px solid #F4C524;padding:14px 16px;margin-bottom:25px;border-radius:8px;line-height:1.5;\">\n        <b>Importante:</b><br>\n        \u2022 Un coordinador te contactar\u00e1 pronto para asignar el mensajero.<br>\n        \u2022 Si deseas cancelar, hazlo lo antes posible.<br>\n        \u2022 Si ya fue asignado un mensajero, deber\u00e1s cubrir el valor del servicio.\n    </div>\n\n    <!-- \ud83d\udcac BOT\u00d3N PRINCIPAL -->\n    <div style=\"text-align:center;margin-bottom:30px;\">\n        <h2 style=\"margin-bottom:10px;font-weight:800;color:#25D366;\">\n            \u2705 \u00a1Servicio registrado con \u00e9xito!\n        </h2>\n        <p style=\"font-size:17px;margin-bottom:20px;\">\n            N\u00famero de servicio: <b>#<?= $pedido->id ?></b><br>\n            <span style=\"font-size:15px;\">Confirma tu pedido tocando el bot\u00f3n verde \ud83d\udc47</span>\n        </p>\n\n        <a id=\"btnWhatsApp\"\n           href=\"#\"\n           target=\"_blank\"\n           style=\"display:inline-block;background:#25D366;color:white;font-size:20px;font-weight:800;padding:18px 36px;border-radius:12px;text-decoration:none;box-shadow:0 4px 8px rgba(0,0,0,0.15);transition:all .2s ease;\">\n           \ud83d\udcac Confirmar por WhatsApp\n        </a>\n\n        <p style=\"margin-top:12px;color:#555;font-size:14px;\">\n            Si no se abre autom\u00e1ticamente, toca el bot\u00f3n de nuevo.\n        </p>\n    </div>\n\n    <!-- \ud83d\udccd DESTINOS -->\n    <div style=\"margin-top:15px;\">\n        <h3 style=\"margin-bottom:10px;font-size:18px;\">\ud83d\udef5 Destinos</h3>\n\n        <?php\n        $mostro_destinos = false;\n        if (!empty($destinos)):\n            foreach ($destinos as $d):\n                // Mostrar destino si tiene direcciÃ³n O barrio\n                $tiene_direccion = !empty($d[\"direccion\"]);\n                $tiene_barrio = !empty($d[\"barrio_nombre\"]);\n                \n                if ($tiene_direccion || $tiene_barrio) {\n                    $mostro_destinos = true; ?>\n                    <div class=\"gofast-route-item\" style=\"background:#f8f8f8;padding:10px 12px;border-radius:8px;margin-bottom:8px;border-left:4px solid #F4C524;\">\n                        <?php if ($tiene_direccion): ?>\n                            <strong><?= esc_html($d[\"direccion\"]) ?></strong>\n                            <?php if ($tiene_barrio): ?>\n                                <br><small style=\"color:#666;\">\ud83d\udccd <?= esc_html($d[\"barrio_nombre\"]) ?></small>\n                            <?php endif; ?>\n                        <?php elseif ($tiene_barrio): ?>\n                            <strong>\ud83d\udccd <?= esc_html($d[\"barrio_nombre\"]) ?></strong>\n                        <?php endif; ?>\n                        <?php if (!empty($d[\"monto\"]) && intval($d[\"monto\"]) > 0): ?>\n                            <br><b style=\"color:#4CAF50;\">\ud83d\udcb0 $<?= number_format($d[\"monto\"], 0, ',', '.') ?></b>\n                        <?php endif; ?>\n                    </div>\n        <?php   }\n            endforeach;\n        endif;\n        if (!$mostro_destinos): ?>\n            <p style=\"color:#666;\">(No se registraron destinos)</p>\n        <?php endif; ?>\n    </div>\n\n    <!-- \ud83d\udc64 RESUMEN DEL CLIENTE -->\n    <div style=\"margin-top:25px;background:#fafafa;border-radius:10px;padding:14px 18px;line-height:1.6;font-size:15px;\">\n        <h3 style=\"margin-top:0;font-size:17px;\">\ud83d\udc64 Detalle del cliente</h3>\n        <p><strong>Nombre:</strong> <?= esc_html($pedido->nombre_cliente) ?></p>\n        <p><strong>Tel\u00e9fono:</strong> <?= esc_html($pedido->telefono_cliente) ?></p>\n        <p><strong>Direcci\u00f3n origen:</strong> <?= esc_html($pedido->direccion_origen) ?></p>\n        <p><strong>Total:</strong> $<?= number_format($pedido->total, 0) ?></p>\n        <p><strong>Estado:</strong> <?= ucfirst($pedido->tracking_estado) ?></p>\n    </div>\n\n    <!-- \ud83d\udd04 BOTONES INFERIORES -->\n    <div class=\"gofast-btn-group\" style=\"margin-top:25px;text-align:center;\">\n        <a href=\"/\" class=\"gofast-btn-action\">\ud83d\udd04 Hacer otra cotizaci\u00f3n</a>\n        <?php if (!empty($_SESSION[\"gofast_user_id\"]) && empty($_SESSION[\"gofast_auto_linked\"])): ?>\n            <a href=\"/mis-pedidos\" class=\"gofast-btn-action gofast-secondary\">\ud83d\udce6 Ver mis pedidos</a>\n        <?php else: ?>\n            <a href=\"/auth?registro=1\" class=\"gofast-btn-action gofast-secondary\">\ud83d\udc64 Crear cuenta para ver tus pedidos</a>\n        <?php endif; ?>\n    </div>\n\n</div>\n\n<script>\ndocument.addEventListener(\"DOMContentLoaded\", () => {\n    const btn = document.getElementById(\"btnWhatsApp\");\n    const phone = \"<?= $telefono_empresa ?>\";\n    const msg = \"<?= $mensaje ?>\";\n    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);\n\n    const url = isMobile\n        ? `https://wa.me/${phone}?text=${msg}`\n        : `https://web.whatsapp.com/send?phone=${phone}&text=${msg}`;\n\n    btn.href = url;\n\n    setTimeout(() => {\n        if (!document.hidden) {\n            alert(\"Si WhatsApp no se abri\u00f3 autom\u00e1ticamente, toca el bot\u00f3n verde para confirmar tu pedido.\");\n        }\n    }, 5000);\n});\n</script>\n\n<?php\n    return ob_get_clean();\n});\n",
      "active": true,
      "modified": "2025-11-14 02:02:32",
      "revision": "1"
    }
  ]
}
