{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":33,"name":"gofast_solicitar_intermunicipal","code":"\n\/*******************************************************\n * \ud83d\ude9a GOFAST \u2014 SOLICITAR ENV\u00cdO INTERMUNICIPAL\n * Shortcode: [gofast_solicitar_intermunicipal]\n * URL: \/solicitar-intermunicipal\n * \n * P\u00e1gina de confirmaci\u00f3n y solicitud del servicio intermunicipal\n *******************************************************\/\n\nfunction gofast_solicitar_intermunicipal_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    \/\/ Inicializar variable de error\n    $error = '';\n    \n    \/\/ Debug visible: mostrar si se recibi\u00f3 POST\n    $debug_info = '';\n    if (!empty($_POST)) {\n        $debug_info = '<div style=\"background: #fff3cd; padding: 10px; margin: 10px 0; border: 1px solid #ffc107;\">';\n        $debug_info .= '<strong>DEBUG POST:<\/strong> ';\n        $debug_info .= 'confirmar_intermunicipal=' . (isset($_POST['confirmar_intermunicipal']) ? 'SI' : 'NO') . ' | ';\n        $debug_info .= 'nombre=' . (isset($_POST['nombre']) ? $_POST['nombre'] : 'NO') . ' | ';\n        $debug_info .= 'telefono=' . (isset($_POST['telefono']) ? $_POST['telefono'] : 'NO');\n        $debug_info .= '<\/div>';\n    }\n\n    \/\/ Verificar que hay datos de cotizaci\u00f3n\n    $cotizacion = isset($_SESSION['gofast_intermunicipal']) ? $_SESSION['gofast_intermunicipal'] : null;\n    \n    if (!$cotizacion || empty($cotizacion['destino'])) {\n        \/\/ Redirigir al cotizador si no hay datos\n        $url_cotizar = esc_url(home_url('\/cotizar-intermunicipal'));\n        return '<script>window.location.href = \"'.$url_cotizar.'\";<\/script>';\n    }\n\n    $origen = isset($cotizacion['origen']) ? $cotizacion['origen'] : 'Tulu\u00e1';\n    $origen_direccion = isset($cotizacion['origen_direccion']) ? $cotizacion['origen_direccion'] : 'Tulu\u00e1';\n    $origen_tipo = isset($cotizacion['origen_tipo']) ? $cotizacion['origen_tipo'] : 'tulua';\n    $negocio_id = isset($cotizacion['negocio_id']) ? intval($cotizacion['negocio_id']) : null;\n    $negocio_user_id = isset($cotizacion['negocio_user_id']) ? intval($cotizacion['negocio_user_id']) : null;\n    $negocio_nombre = isset($cotizacion['negocio_nombre']) ? $cotizacion['negocio_nombre'] : null;\n    $negocio_whatsapp = isset($cotizacion['negocio_whatsapp']) ? $cotizacion['negocio_whatsapp'] : null;\n    $usuario_nombre = isset($cotizacion['usuario_nombre']) ? $cotizacion['usuario_nombre'] : '';\n    $usuario_telefono = isset($cotizacion['usuario_telefono']) ? $cotizacion['usuario_telefono'] : '';\n    $destino = isset($cotizacion['destino']) ? $cotizacion['destino'] : '';\n    $valor_envio = isset($cotizacion['valor']) ? intval($cotizacion['valor']) : 0;\n    $direccion_recogida = isset($cotizacion['direccion_recogida']) ? $cotizacion['direccion_recogida'] : '';\n\n    \/\/ Obtener destinos intermunicipales desde la base de datos\n    $destinos_intermunicipales = [];\n    \n    \/\/ Verificar si la tabla existe antes de consultar\n    $table_exists = $wpdb->get_var(\"SHOW TABLES LIKE 'destinos_intermunicipales'\");\n    \n    if ($table_exists) {\n        $destinos_db = $wpdb->get_results(\n            \"SELECT id, nombre, valor \n             FROM destinos_intermunicipales \n             WHERE activo = 1 \n             ORDER BY orden ASC, nombre ASC\"\n        );\n        \n        if ($destinos_db && is_array($destinos_db)) {\n            foreach ($destinos_db as $destino_db) {\n                if (isset($destino_db->nombre) && isset($destino_db->valor)) {\n                    $destinos_intermunicipales[$destino_db->nombre] = intval($destino_db->valor);\n                }\n            }\n        }\n    }\n    \n    \/\/ Fallback si la tabla no existe o no hay resultados\n    if (empty($destinos_intermunicipales)) {\n        $destinos_intermunicipales = [\n            'Andaluc\u00eda' => 20000,\n            'Bugalagrande' => 25000,\n            'Riofr\u00edo' => 20000,\n            'Buga' => 35000,\n            'San Pedro' => 25000,\n            'Los chanchos' => 20000,\n            'Sal\u00f3nica' => 35000,\n            'La Marina' => 25000,\n            'Presidente' => 30000,\n            'La Paila' => 35000,\n            'Zarzal' => 50000,\n        ];\n    }\n\n    \/\/ Validar que el destino existe\n    if (!isset($destinos_intermunicipales[$destino])) {\n        unset($_SESSION['gofast_intermunicipal']);\n        return '<div class=\"gofast-box\">Error: Destino no v\u00e1lido. <a href=\"'.esc_url(home_url('\/cotizar-intermunicipal')).'\">Volver al cotizador<\/a><\/div>';\n    }\n\n    \/\/ Obtener usuario logueado si existe\n    $usuario = null;\n    $negocio_datos = null;\n    $rol = strtolower($_SESSION['gofast_user_rol'] ?? '');\n    $es_mensajero_o_admin = ($rol === 'mensajero' || $rol === 'admin');\n    \n    if (!empty($_SESSION['gofast_user_id'])) {\n        $user_id = intval($_SESSION['gofast_user_id']);\n        if ($user_id > 0) {\n            $usuario = $wpdb->get_row($wpdb->prepare(\n                \"SELECT id, nombre, telefono, email, rol \n                 FROM usuarios_gofast \n                 WHERE id = %d AND activo = 1\",\n                $user_id\n            ));\n            \n            \/\/ Si se seleccion\u00f3 un negocio, obtener sus datos\n            if ($negocio_id && $negocio_id > 0) {\n                \/\/ Si es mensajero\/admin y hay negocio_user_id, buscar por ese user_id\n                if ($es_mensajero_o_admin && $negocio_user_id) {\n                    $negocio_datos = $wpdb->get_row($wpdb->prepare(\n                        \"SELECT n.id, n.nombre, n.direccion_full, n.whatsapp, n.user_id\n                         FROM negocios_gofast n\n                         WHERE n.id = %d AND n.user_id = %d AND n.activo = 1\",\n                        $negocio_id,\n                        $negocio_user_id\n                    ));\n                } else {\n                    \/\/ Buscar negocio del usuario logueado\n                    $negocio_datos = $wpdb->get_row($wpdb->prepare(\n                        \"SELECT id, nombre, direccion_full, whatsapp\n                         FROM negocios_gofast\n                         WHERE id = %d AND user_id = %d AND activo = 1\",\n                        $negocio_id,\n                        $user_id\n                    ));\n                }\n            }\n        }\n    }\n\n    \/\/ Procesar confirmaci\u00f3n del servicio\n    \/\/ IMPORTANTE: Esto debe ejecutarse ANTES de ob_start()\n    if (!empty($_POST['confirmar_intermunicipal'])) {\n        \n        \/\/ Debug: verificar que el POST se est\u00e1 recibiendo\n        error_log('=== GOFAST INTERMUNICIPAL DEBUG ===');\n        error_log('POST recibido - confirmar_intermunicipal: ' . (isset($_POST['confirmar_intermunicipal']) ? 'SI' : 'NO'));\n        \n        $nombre = sanitize_text_field($_POST['nombre'] ?? '');\n        $telefono = sanitize_text_field($_POST['telefono'] ?? '');\n        $direccion_destino = sanitize_text_field($_POST['direccion_destino'] ?? '');\n        $direccion_recogida_nueva = sanitize_text_field($_POST['direccion_recogida'] ?? '');\n        \n        error_log('Datos POST - nombre: ' . ($nombre ?: 'VACIO') . ', telefono: ' . ($telefono ?: 'VACIO') . ', direccion: ' . ($direccion_destino ?: 'VACIO'));\n        error_log('Destino: ' . ($destino ?: 'VACIO') . ', Valor: ' . $valor_envio);\n\n        \/\/ Validaciones\n        if (empty($nombre) || empty($telefono) || empty($direccion_destino)) {\n            $error = 'Debes completar todos los campos obligatorios.';\n        } elseif (empty($destino) || $valor_envio <= 0) {\n            $error = 'Error: Datos de cotizaci\u00f3n incompletos. Por favor, vuelve a cotizar.';\n            unset($_SESSION['gofast_intermunicipal']);\n        } else {\n            \/\/ Construir JSON de destinos (formato compatible con servicios_gofast)\n            $direccion_origen_final = ($origen_tipo === 'negocio' && $negocio_datos) \n                ? $origen_direccion \n                : $origen;\n            \n            $destinos_json = json_encode([\n                'origen' => [\n                    'barrio_id' => ($negocio_datos && isset($negocio_datos->barrio_id)) ? intval($negocio_datos->barrio_id) : 0,\n                    'barrio_nombre' => $origen,\n                    'sector_id' => 0,\n                    'direccion' => $direccion_origen_final,\n                    'negocio_id' => $negocio_id,\n                ],\n                'destinos' => [[\n                    'barrio_id' => 0,\n                    'barrio_nombre' => $destino,\n                    'sector_id' => 0,\n                    'direccion' => $direccion_destino,\n                    'monto' => $valor_envio,\n                    'direccion_recogida' => !empty($direccion_recogida_nueva) ? $direccion_recogida_nueva : $direccion_recogida,\n                ]],\n                'tipo_servicio' => 'intermunicipal', \/\/ Indicador especial\n            ], JSON_UNESCAPED_UNICODE);\n\n            \/\/ Guardar servicio en la base de datos\n            \/\/ Incluir el destino en direccion_origen para que se muestre correctamente\n            $direccion_origen_servicio = ($origen_tipo === 'negocio' && $negocio_datos) \n                ? $origen . ' \u2014 ' . $origen_direccion . ' \u2192 ' . $destino . ' (Intermunicipal)'\n                : $origen . ' \u2192 ' . $destino . ' (Intermunicipal)';\n            \n            \/\/ Determinar user_id: si es mensajero\/admin y hay negocio_user_id, usar ese\n            $user_id_servicio = $usuario ? $usuario->id : null;\n            if ($es_mensajero_o_admin && $negocio_user_id) {\n                $user_id_servicio = $negocio_user_id; \/\/ Asociar al cliente propietario del negocio\n            } elseif ($negocio_datos && !$es_mensajero_o_admin) {\n                \/\/ Si es cliente normal y seleccion\u00f3 su negocio, usar su user_id\n                $user_id_servicio = $usuario ? $usuario->id : null;\n            }\n            \n            \/\/ Si hay negocio seleccionado, usar datos del NEGOCIO (no del cliente)\n            $nombre_final = $nombre;\n            $telefono_final = $telefono;\n            if ($negocio_datos && $origen_tipo === 'negocio') {\n                $nombre_final = $negocio_datos->nombre; \/\/ Nombre del negocio\n                $telefono_final = $negocio_datos->whatsapp ?: ($negocio_datos->cliente_telefono ?? $telefono); \/\/ WhatsApp del negocio primero\n            }\n            \n            \/\/ Si es mensajero, asignarse autom\u00e1ticamente\n            $mensajero_id_servicio = null;\n            $estado_servicio = 'pendiente';\n            $tracking_estado_servicio = 'pendiente';\n            if ($usuario && strtolower($usuario->rol) === 'mensajero') {\n                $mensajero_id_servicio = $usuario->id;\n                $estado_servicio = 'asignado';\n                $tracking_estado_servicio = 'asignado';\n            }\n            \n            $insertado = $wpdb->insert('servicios_gofast', [\n                'nombre_cliente' => $nombre_final,\n                'telefono_cliente' => $telefono_final,\n                'direccion_origen' => $direccion_origen_servicio,\n                'destinos' => $destinos_json,\n                'total' => $valor_envio,\n                'estado' => $estado_servicio,\n                'tracking_estado' => $tracking_estado_servicio,\n                'mensajero_id' => $mensajero_id_servicio,\n                'user_id' => $user_id_servicio,\n                'fecha' => gofast_date_mysql()\n            ]);\n\n            \/\/ \u26a0\ufe0f Si falla el INSERT, mostramos el error en pantalla\n            if ($insertado === false) {\n                $error = 'Error al guardar el servicio: ' . esc_html($wpdb->last_error);\n                error_log('Error al insertar servicio intermunicipal: ' . $wpdb->last_error);\n            } else {\n                $service_id = (int) $wpdb->insert_id;\n                \n                if (!$service_id || $service_id <= 0) {\n                    $error = 'Error: No se pudo obtener el ID del servicio guardado.';\n                    error_log('Error: insert_id no v\u00e1lido despu\u00e9s de insertar servicio intermunicipal');\n                } else {\n                    \/\/ Limpiar sesi\u00f3n\n                    unset($_SESSION['gofast_intermunicipal']);\n                    \n                    \/\/ Guardar en sesi\u00f3n para referencia\n                    $_SESSION['gofast_pending_service'] = $service_id;\n                    \n                    \/\/ Si es admin o mensajero, NO redirigir a servicio-registrado, solo mostrar mensaje\n                    if ($es_mensajero_o_admin) {\n                        \/\/ Mostrar mensaje de \u00e9xito y limpiar\n                        $success_message = '<div class=\"gofast-box\" style=\"background:#d4edda;border-left:4px solid #28a745;padding:16px;margin:20px auto;max-width:600px;\">';\n                        $success_message .= '<h2 style=\"margin-top:0;color:#155724;\">\u2705 Servicio Registrado Exitosamente<\/h2>';\n                        $success_message .= '<p><strong>ID del Servicio:<\/strong> #' . esc_html($service_id) . '<\/p>';\n                        $success_message .= '<p><strong>Total:<\/strong> $' . number_format($valor_envio, 0, ',', '.') . '<\/p>';\n                        $success_message .= '<p style=\"margin-bottom:0;\"><a href=\"' . esc_url(home_url('\/mis-pedidos')) . '\" class=\"gofast-btn\" style=\"display:inline-block;margin-top:12px;\">Ver mis pedidos<\/a><\/p>';\n                        $success_message .= '<\/div>';\n                        return $success_message;\n                    } else {\n                        \/\/ Cliente normal: redirigir a p\u00e1gina de confirmaci\u00f3n\n                        $url_confirmacion = esc_url(home_url('\/servicio-registrado?id=' . $service_id));\n                        \n                        \/\/ Usar wp_redirect si es posible, sino JavaScript\n                        \/\/ Pero primero necesitamos evitar que se ejecute ob_start()\n                        \/\/ Retornar el script de redirecci\u00f3n inmediatamente\n                        $redirect_script = '<script type=\"text\/javascript\">';\n                        $redirect_script .= 'window.location.href = \"'.esc_js($url_confirmacion).'\";';\n                        $redirect_script .= '<\/script>';\n                        $redirect_script .= '<noscript>';\n                        $redirect_script .= '<meta http-equiv=\"refresh\" content=\"0;url='.esc_attr($url_confirmacion).'\">';\n                        $redirect_script .= '<\/noscript>';\n                        \n                        return $redirect_script;\n                    }\n                }\n            }\n        }\n    }\n\n    \/\/ Validar que tenemos los datos necesarios\n    if (empty($destino) || $valor_envio <= 0) {\n        unset($_SESSION['gofast_intermunicipal']);\n        return '<div class=\"gofast-box\">Error: Datos de cotizaci\u00f3n incompletos. <a href=\"'.esc_url(home_url('\/cotizar-intermunicipal')).'\">Volver al cotizador<\/a><\/div>';\n    }\n\n    \/\/ Si hay un error despu\u00e9s de procesar el POST, continuar para mostrarlo\n    \/\/ Si no hay error y se proces\u00f3 correctamente, ya se hizo return arriba\n    \n    ob_start();\n    ?>\n    <div class=\"gofast-checkout-wrapper\">\n        \n        <!-- Columna izquierda: Resumen -->\n        <div class=\"gofast-box\">\n            <h2 style=\"margin-top: 0;\">\ud83d\udce6 Resumen del Env\u00edo Intermunicipal<\/h2>\n            \n            <div class=\"gofast-route-item\">\n                <div>\n                    <strong>Origen:<\/strong> <?php echo esc_html($origen); ?>\n                    <?php if ($origen_tipo === 'negocio' && $negocio_datos): ?>\n                        <br><small style=\"color: #666; font-size: 12px;\">\n                            \ud83d\udccd <?php echo esc_html($origen_direccion); ?>\n                        <\/small>\n                    <?php endif; ?>\n                <\/div>\n            <\/div>\n\n            <div class=\"gofast-route-item\">\n                <div>\n                    <strong>Destino:<\/strong> <?php echo esc_html($destino); ?>\n                <\/div>\n            <\/div>\n\n            <div class=\"gofast-total-box\">\n                \ud83d\udcb0 Total a pagar: $<?php echo number_format($valor_envio, 0, ',', '.'); ?>\n            <\/div>\n\n            <!-- Condiciones importantes -->\n            <div class=\"gofast-box\" style=\"background: #fff3cd; border-left: 5px solid var(--gofast-amber); padding: 16px; margin-top: 20px;\">\n                <h3 style=\"margin-top: 0; color: #856404; font-size: 16px;\">\u26a0\ufe0f Condiciones Importantes<\/h3>\n                <ul style=\"margin: 0; padding-left: 20px; color: #856404; font-size: 14px;\">\n                    <li>El pedido debe estar <strong>pago con anticipaci\u00f3n<\/strong>.<\/li>\n                    <li>El valor del env\u00edo debe ser <strong>cancelado antes<\/strong> de despachar.<\/li>\n                    <li>Solo se aceptan env\u00edos para <strong>zona urbana<\/strong>.<\/li>\n                    <li>Se debe anexar la <strong>ubicaci\u00f3n en tiempo real<\/strong> del cliente que recibe el domicilio en el destino.<\/li>\n                    <li>La disponibilidad est\u00e1 sujeta a la administraci\u00f3n.<\/li>\n                    <li>En caso de devoluci\u00f3n se cobrar\u00e1 recargo adicional.<\/li>\n                <\/ul>\n            <\/div>\n        <\/div>\n\n        <!-- Columna derecha: Formulario -->\n        <div class=\"gofast-box\">\n            <h2 style=\"margin-top: 0;\">\ud83d\udcdd Datos del Cliente<\/h2>\n\n            <?php if (!empty($error)): ?>\n                <div class=\"gofast-box\" style=\"background: #ffe5e5; border-left: 5px solid var(--gofast-danger); padding: 12px; margin-bottom: 16px;\">\n                    \u26a0\ufe0f <strong>Error:<\/strong> <?php echo esc_html($error); ?>\n                <\/div>\n            <?php endif; ?>\n\n            <form method=\"post\" action=\"<?php echo esc_url($_SERVER['REQUEST_URI']); ?>\" id=\"form-confirmar-intermunicipal\">\n                \n                <label><strong>Nombre completo<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                <input type=\"text\" name=\"nombre\" \n                       value=\"<?php \n                           \/\/ Si es negocio, usar nombre del negocio; si es Tulu\u00e1, usar nombre del usuario\n                           if ($origen_tipo === 'negocio' && $negocio_nombre) {\n                               echo esc_attr($negocio_nombre);\n                           } elseif ($origen_tipo === 'tulua' && !empty($usuario_nombre)) {\n                               echo esc_attr($usuario_nombre);\n                           } elseif ($usuario) {\n                               echo esc_attr($usuario->nombre);\n                           }\n                       ?>\" \n                       required \n                       class=\"gofast-box input\"\n                       placeholder=\"Ej: Juan P\u00e9rez\">\n\n                <label><strong>Tel\u00e9fono \/ WhatsApp<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                <input type=\"text\" name=\"telefono\" \n                       value=\"<?php \n                           \/\/ Si es negocio, usar WhatsApp del negocio; si es Tulu\u00e1, usar tel\u00e9fono del usuario\n                           if ($origen_tipo === 'negocio' && $negocio_whatsapp) {\n                               echo esc_attr($negocio_whatsapp);\n                           } elseif ($origen_tipo === 'tulua' && !empty($usuario_telefono)) {\n                               echo esc_attr($usuario_telefono);\n                           } elseif ($usuario) {\n                               echo esc_attr($usuario->telefono);\n                           }\n                       ?>\" \n                       required \n                       class=\"gofast-box input\"\n                       placeholder=\"Ej: 3112345678\">\n\n                <label><strong>Direcci\u00f3n de Recogida<\/strong><\/label>\n                <input type=\"text\" name=\"direccion_recogida\" \n                       value=\"<?php echo esc_attr($direccion_recogida); ?>\"\n                       class=\"gofast-box input\"\n                       placeholder=\"Ej: Calle 5 #10-20, Barrio Centro\">\n                <small style=\"color: #666; font-size: 13px; display: block; margin-top: 4px; margin-bottom: 16px;\">\n                    Especifica la direcci\u00f3n exacta donde se recoger\u00e1 el pedido en el origen.\n                <\/small>\n\n                <label><strong>Direcci\u00f3n de destino (zona urbana)<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                <textarea name=\"direccion_destino\" \n                          required \n                          class=\"gofast-box input\"\n                          rows=\"3\"\n                          placeholder=\"Ej: Calle 10 # 5-20, Barrio Centro\"><\/textarea>\n                <small style=\"color: #666; font-size: 13px; display: block; margin-top: -12px; margin-bottom: 16px;\">\n                    Especifica la direcci\u00f3n completa en <?php echo esc_html($destino); ?> (solo zona urbana)\n                <\/small>\n\n                <div class=\"gofast-box\" style=\"background: #e8f4ff; border-left: 4px solid #1f6feb; padding: 12px; margin-bottom: 16px;\">\n                    <strong style=\"color: #004085;\">\ud83d\udca1 Recordatorio:<\/strong>\n                    <p style=\"margin: 8px 0 0 0; color: #004085; font-size: 13px;\">\n                        Aseg\u00farate de que el pedido este pago con anticipaci\u00f3n antes de confirmar. \n                        y pagarle al mensajero el valor del env\u00edo. Solo despu\u00e9s de esto se despachar\u00e1 el pedido.\n                        <strong>Recuerda:<\/strong> Se debe anexar la ubicaci\u00f3n en tiempo real del cliente que recibe el domicilio en el destino.\n                    <\/p>\n                <\/div>\n\n                <div class=\"gofast-btn-group\">\n                    <button type=\"submit\" name=\"confirmar_intermunicipal\" class=\"gofast-submit\">\n                        \u2705 Confirmar y Solicitar Servicio\n                    <\/button>\n                    <a href=\"<?php echo esc_url(home_url('\/cotizar-intermunicipal')); ?>\" \n                       class=\"gofast-btn gofast-secondary\" \n                       style=\"text-align: center; text-decoration: none; display: block;\">\n                        \ud83d\udd04 Hacer otra cotizaci\u00f3n\n                    <\/a>\n                <\/div>\n\n            <\/form>\n        <\/div>\n\n    <\/div>\n    \n    <script>\n    (function() {\n        \/\/ Proteger contra errores de toggleOtro si se ejecuta desde otro archivo\n        const tipoSelectExists = document.getElementById(\"tipo_negocio\");\n        const wrapperOtroExists = document.getElementById(\"tipo_otro_wrapper\");\n        \n        \/\/ Si los elementos no existen, crear una funci\u00f3n segura desde el inicio\n        if (!tipoSelectExists || !wrapperOtroExists) {\n            if (typeof window.toggleOtro === 'undefined') {\n                window.toggleOtro = function() {\n                    \/\/ Funci\u00f3n vac\u00eda segura - no hacer nada\n                    return;\n                };\n            } else if (typeof window.toggleOtro === 'function') {\n                \/\/ Si existe y los elementos no est\u00e1n presentes, proteger la funci\u00f3n\n                const originalToggleOtro = window.toggleOtro;\n                window.toggleOtro = function() {\n                    try {\n                        const tipoSelect = document.getElementById(\"tipo_negocio\");\n                        const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                        if (tipoSelect && wrapperOtro && tipoSelect.parentNode && wrapperOtro.parentNode) {\n                            return originalToggleOtro();\n                        }\n                    } catch(e) {\n                        \/\/ Silenciar error completamente\n                        return;\n                    }\n                };\n            }\n        }\n        \n        \/\/ Tambi\u00e9n prevenir que setTimeout ejecute toggleOtro si no est\u00e1n los elementos\n        (function() {\n            const originalSetTimeout = window.setTimeout;\n            window.setTimeout = function(func, delay) {\n                if (typeof func === 'function') {\n                    try {\n                        const funcStr = func.toString();\n                        if (funcStr.includes('toggleOtro')) {\n                            const tipoSelect = document.getElementById(\"tipo_negocio\");\n                            const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                            if (!tipoSelect || !wrapperOtro) {\n                                \/\/ Retornar un timeout vac\u00edo en lugar de null para evitar errores\n                                return originalSetTimeout(function() {}, 0);\n                            }\n                        }\n                    } catch(e) {\n                        \/\/ Si hay alg\u00fan error al verificar, continuar normalmente\n                    }\n                }\n                return originalSetTimeout.apply(this, arguments);\n            };\n        })();\n    })();\n    <\/script>\n    \n    <?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_solicitar_intermunicipal', 'gofast_solicitar_intermunicipal_shortcode');\n\n\/\/ Hook para procesar el POST ANTES de renderizar la p\u00e1gina (similar a redireccion.php)\nadd_action('template_redirect', function() {\n    \/\/ Solo procesar si hay POST de confirmar_intermunicipal\n    if (!isset($_POST['confirmar_intermunicipal'])) {\n        return;\n    }\n    \n    \/\/ Verificar que estamos en la p\u00e1gina correcta\n    $current_url = $_SERVER['REQUEST_URI'] ?? '';\n    if (strpos($current_url, '\/solicitar-intermunicipal') === false) {\n        return;\n    }\n    \n    global $wpdb;\n    \n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n    \n    \/\/ Verificar que hay datos de cotizaci\u00f3n\n    $cotizacion = isset($_SESSION['gofast_intermunicipal']) ? $_SESSION['gofast_intermunicipal'] : null;\n    \n    if (!$cotizacion || empty($cotizacion['destino'])) {\n        return; \/\/ Dejar que el shortcode maneje el error\n    }\n    \n    $origen = isset($cotizacion['origen']) ? $cotizacion['origen'] : 'Tulu\u00e1';\n    $origen_direccion = isset($cotizacion['origen_direccion']) ? $cotizacion['origen_direccion'] : 'Tulu\u00e1';\n    $origen_tipo = isset($cotizacion['origen_tipo']) ? $cotizacion['origen_tipo'] : 'tulua';\n    $negocio_id = isset($cotizacion['negocio_id']) ? intval($cotizacion['negocio_id']) : null;\n    $negocio_user_id = isset($cotizacion['negocio_user_id']) ? intval($cotizacion['negocio_user_id']) : null;\n    $destino = isset($cotizacion['destino']) ? $cotizacion['destino'] : '';\n    $valor_envio = isset($cotizacion['valor']) ? intval($cotizacion['valor']) : 0;\n    \n    \/\/ Obtener usuario y negocio\n    $usuario = null;\n    $negocio_datos = null;\n    $rol = '';\n    \n    if (!empty($_SESSION['gofast_user_id'])) {\n        $user_id = intval($_SESSION['gofast_user_id']);\n        if ($user_id > 0) {\n            $usuario = $wpdb->get_row($wpdb->prepare(\n                \"SELECT id, nombre, telefono, email, rol \n                 FROM usuarios_gofast \n                 WHERE id = %d AND activo = 1\",\n                $user_id\n            ));\n            \n            if ($usuario) {\n                $rol = strtolower($usuario->rol ?? '');\n            }\n            \n            if ($negocio_id && $negocio_id > 0) {\n                \/\/ Si es mensajero\/admin y hay negocio_user_id, buscar por ese user_id\n                if (($rol === 'mensajero' || $rol === 'admin') && $negocio_user_id) {\n                    $negocio_datos = $wpdb->get_row($wpdb->prepare(\n                        \"SELECT n.*, u.nombre as cliente_nombre, u.telefono as cliente_telefono\n                         FROM negocios_gofast n\n                         INNER JOIN usuarios_gofast u ON n.user_id = u.id\n                         WHERE n.id = %d AND n.user_id = %d AND n.activo = 1\",\n                        $negocio_id,\n                        $negocio_user_id\n                    ));\n                } else {\n                    \/\/ Buscar negocio del usuario logueado\n                    $negocio_datos = $wpdb->get_row($wpdb->prepare(\n                        \"SELECT id, nombre, direccion_full, whatsapp, barrio_id\n                         FROM negocios_gofast\n                         WHERE id = %d AND user_id = %d AND activo = 1\",\n                        $negocio_id,\n                        $user_id\n                    ));\n                }\n            }\n        }\n    }\n    \n    \/\/ Procesar datos del formulario\n    $nombre = sanitize_text_field($_POST['nombre'] ?? '');\n    $telefono = sanitize_text_field($_POST['telefono'] ?? '');\n    $direccion_destino = sanitize_text_field($_POST['direccion_destino'] ?? '');\n    \n    \/\/ Validaciones\n    if (empty($nombre) || empty($telefono) || empty($direccion_destino) || empty($destino) || $valor_envio <= 0) {\n        return; \/\/ Dejar que el shortcode muestre el error\n    }\n    \n    \/\/ Construir JSON de destinos\n    $direccion_origen_final = ($origen_tipo === 'negocio' && $negocio_datos) \n        ? $origen_direccion \n        : $origen;\n    \n    $destinos_json = json_encode([\n        'origen' => [\n            'barrio_id' => ($negocio_datos && isset($negocio_datos->barrio_id)) ? intval($negocio_datos->barrio_id) : 0,\n            'barrio_nombre' => $origen,\n            'sector_id' => 0,\n            'direccion' => $direccion_origen_final,\n            'negocio_id' => $negocio_id,\n        ],\n        'destinos' => [[\n            'barrio_id' => 0,\n            'barrio_nombre' => $destino,\n            'sector_id' => 0,\n            'direccion' => $direccion_destino,\n            'monto' => $valor_envio,\n        ]],\n        'tipo_servicio' => 'intermunicipal',\n    ], JSON_UNESCAPED_UNICODE);\n    \n    \/\/ Guardar servicio\n    \/\/ Construir direccion_origen seg\u00fan reglas (sin incluir destino, eso va en el JSON):\n    \/\/ 1. Solo barrio (si no hay negocio y no hay direcci\u00f3n)\n    \/\/ 2. Negocio + direcci\u00f3n (si hay negocio)\n    \/\/ 3. Barrio + direcci\u00f3n (si hay direcci\u00f3n pero no negocio)\n    if ($origen_tipo === 'negocio' && $negocio_datos) {\n        \/\/ Caso 2: Negocio + direcci\u00f3n\n        $dir_origen_negocio = $origen_direccion ?: '';\n        if (!empty($dir_origen_negocio)) {\n            $direccion_origen_servicio = $negocio_datos->nombre . ' \u2014 ' . $dir_origen_negocio;\n        } else {\n            $direccion_origen_servicio = $negocio_datos->nombre;\n        }\n    } elseif (!empty($origen_direccion) && $origen_direccion !== 'Tulu\u00e1') {\n        \/\/ Caso 3: Barrio + direcci\u00f3n\n        $direccion_origen_servicio = $origen . ' \u2014 ' . $origen_direccion;\n    } else {\n        \/\/ Caso 1: Solo barrio\n        $direccion_origen_servicio = $origen;\n    }\n    \n            \/\/ Determinar user_id: si es mensajero\/admin y hay negocio_user_id, usar ese\n            $user_id_servicio = $usuario ? $usuario->id : null;\n            $es_mensajero_o_admin = ($rol === 'mensajero' || $rol === 'admin');\n            if ($es_mensajero_o_admin && $negocio_user_id) {\n                $user_id_servicio = $negocio_user_id; \/\/ Asociar al cliente propietario del negocio\n            } elseif ($negocio_datos && !$es_mensajero_o_admin) {\n                \/\/ Si es cliente normal y seleccion\u00f3 su negocio, usar su user_id\n                $user_id_servicio = $usuario ? $usuario->id : null;\n            }\n            \n            \/\/ Si hay negocio seleccionado, usar datos del NEGOCIO (no del cliente)\n            $nombre_final = $nombre;\n            $telefono_final = $telefono;\n            if ($negocio_datos && $origen_tipo === 'negocio') {\n                $nombre_final = $negocio_datos->nombre; \/\/ Nombre del negocio\n                $telefono_final = $negocio_datos->whatsapp ?: ($negocio_datos->cliente_telefono ?? $telefono); \/\/ WhatsApp del negocio primero\n            }\n            \n            \/\/ Si es mensajero, asignarse autom\u00e1ticamente\n            $mensajero_id_servicio = null;\n            $estado_servicio = 'pendiente';\n            $tracking_estado_servicio = 'pendiente';\n            if ($usuario && strtolower($usuario->rol) === 'mensajero') {\n                $mensajero_id_servicio = $usuario->id;\n                $estado_servicio = 'asignado';\n                $tracking_estado_servicio = 'asignado';\n            }\n            \n            $insertado = $wpdb->insert('servicios_gofast', [\n                'nombre_cliente' => $nombre_final,\n                'telefono_cliente' => $telefono_final,\n                'direccion_origen' => $direccion_origen_servicio,\n                'destinos' => $destinos_json,\n                'total' => $valor_envio,\n                'estado' => $estado_servicio,\n                'tracking_estado' => $tracking_estado_servicio,\n                'mensajero_id' => $mensajero_id_servicio,\n                'user_id' => $user_id_servicio,\n                'fecha' => gofast_date_mysql()\n            ]);\n    \n    if ($insertado !== false) {\n        $service_id = (int) $wpdb->insert_id;\n        \n        if ($service_id > 0) {\n            \/\/ Limpiar sesi\u00f3n\n            unset($_SESSION['gofast_intermunicipal']);\n            $_SESSION['gofast_pending_service'] = $service_id;\n            \n            \/\/ Redirigir usando wp_safe_redirect (m\u00e1s confiable que JavaScript)\n            $url_confirmacion = esc_url(home_url('\/servicio-registrado?id=' . $service_id));\n            wp_safe_redirect($url_confirmacion);\n            exit;\n        }\n    }\n}, 1); \/\/ Prioridad 1 para ejecutarse temprano\n\n","active":true,"modified":"2025-12-10 23:35:44","revision":"1"}]}