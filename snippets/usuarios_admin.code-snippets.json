{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":26,"name":"usuarios_admin","code":"\/***************************************************\n * GOFAST \u2013 ADMIN GESTI\u00d3N DE USUARIOS\n * Shortcode: [gofast_usuarios_admin]\n * URL: \/admin-usuarios\n ***************************************************\/\nfunction gofast_usuarios_admin_shortcode() {\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    global $wpdb;\n\n    $tabla = 'usuarios_gofast';\n    $mensaje = '';\n    $debug_info = []; \/\/ Para debugging\n\n    \/* ==========================================================\n       0. Validar usuario admin\n    ========================================================== *\/\n    $usuario = null;\n    if (!empty($_SESSION['gofast_user_id'])) {\n        $uid = (int) $_SESSION['gofast_user_id'];\n        $usuario = $wpdb->get_row(\n            $wpdb->prepare(\n                \"SELECT id, nombre, rol, activo \n                 FROM usuarios_gofast \n                 WHERE id = %d AND activo = 1\",\n                $uid\n            )\n        );\n    }\n\n    if (!$usuario || strtolower($usuario->rol) !== 'admin') {\n        return \"<div class='gofast-box'>\n                    \u26a0\ufe0f Solo los administradores pueden gestionar usuarios.\n                <\/div>\";\n    }\n\n    \/* ==========================================================\n       1. Procesar POST (crear, editar, eliminar)\n    ========================================================== *\/\n    \/\/ Log SIEMPRE para ver qu\u00e9 se est\u00e1 recibiendo\n    if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n        error_log(\"GOFAST ADMIN - POST recibido. Keys: \" . implode(', ', array_keys($_POST)));\n        error_log(\"GOFAST ADMIN - gofast_crear_usuario: \" . ($_POST['gofast_crear_usuario'] ?? 'NO PRESENTE'));\n        error_log(\"GOFAST ADMIN - gofast_guardar_usuarios: \" . ($_POST['gofast_guardar_usuarios'] ?? 'NO PRESENTE'));\n    }\n    \n    if ($_SERVER['REQUEST_METHOD'] === 'POST') {\n\n        \/* ----------------------------------------------\n           A) Crear nuevo usuario (COPIA EXACTA DE AUTH)\n        ---------------------------------------------- *\/\n        \/\/ Verificar que sea el bot\u00f3n de CREAR, no el de GUARDAR\n        \/\/ Simplificar: solo verificar que exista gofast_crear_usuario\n        if (!empty($_POST['gofast_crear_usuario'])) {\n            \n            \/\/ Log para confirmar que se detect\u00f3 el bot\u00f3n correcto\n            error_log(\"GOFAST ADMIN - \u2705 Bot\u00f3n CREAR USUARIO detectado correctamente\");\n            error_log(\"GOFAST ADMIN - gofast_crear_usuario: \" . ($_POST['gofast_crear_usuario'] ?? 'NO'));\n            error_log(\"GOFAST ADMIN - gofast_guardar_usuarios: \" . ($_POST['gofast_guardar_usuarios'] ?? 'NO'));\n            \n            \/\/ Obtener datos del POST\n            $nombre    = trim($_POST['nuevo_nombre'] ?? '');\n            $telefono  = trim($_POST['nuevo_telefono'] ?? '');\n            $email     = trim($_POST['nuevo_email'] ?? '');\n            $password  = $_POST['nuevo_password'] ?? '';\n            $rol       = sanitize_text_field($_POST['nuevo_rol'] ?? 'cliente');\n            $activo    = !empty($_POST['nuevo_activo']) ? 1 : 0;\n            \n            \/\/ Log inicial para debugging\n            error_log(\"GOFAST ADMIN - Intentando crear usuario. POST recibido: \" . print_r($_POST, true));\n            \n            \/\/ Validaciones (igual que auth)\n            if ($nombre === '' || $telefono === '' || $email === '' || $password === '') {\n                $mensaje = \"\u26a0\ufe0f Todos los campos son obligatorios.\";\n                error_log(\"GOFAST ADMIN - Validaci\u00f3n fall\u00f3: campos vac\u00edos\");\n            } elseif (!is_email($email)) {\n                $mensaje = \"\u26a0\ufe0f El correo no es v\u00e1lido.\";\n                error_log(\"GOFAST ADMIN - Validaci\u00f3n fall\u00f3: email inv\u00e1lido: \" . $email);\n            } elseif (strlen($password) < 6) {\n                $mensaje = \"\u26a0\ufe0f La contrase\u00f1a debe tener al menos 6 caracteres.\";\n                error_log(\"GOFAST ADMIN - Validaci\u00f3n fall\u00f3: contrase\u00f1a muy corta\");\n            } elseif (!in_array($rol, ['cliente', 'mensajero', 'admin'], true)) {\n                $mensaje = \"\u26a0\ufe0f Rol no v\u00e1lido.\";\n                error_log(\"GOFAST ADMIN - Validaci\u00f3n fall\u00f3: rol inv\u00e1lido: \" . $rol);\n            } else {\n                \/\/ Normalizar y validar tel\u00e9fono (igual que auth)\n                $tel_norm = preg_replace('\/\\D+\/', '', $telefono);\n                if (strlen($tel_norm) < 10) {\n                    $mensaje = \"\u26a0\ufe0f El tel\u00e9fono debe tener al menos 10 d\u00edgitos.\";\n                    error_log(\"GOFAST ADMIN - Validaci\u00f3n fall\u00f3: tel\u00e9fono muy corto: \" . $tel_norm);\n                } else {\n                    \/\/ Verificar duplicados (igual que auth)\n                    $sql = \"\n                        SELECT id\n                        FROM $tabla\n                        WHERE email = %s\n                           OR REPLACE(REPLACE(REPLACE(telefono, '+',''), ' ','') ,'-','') = %s\n                        LIMIT 1\n                    \";\n                    $existe = $wpdb->get_row($wpdb->prepare($sql, $email, $tel_norm));\n\n                    if ($existe) {\n                        $mensaje = \"\u26a0\ufe0f Ya existe un usuario con ese correo o tel\u00e9fono (ID: #{$existe->id}).\";\n                        error_log(\"GOFAST ADMIN - Usuario duplicado detectado. ID existente: \" . $existe->id);\n                    } else {\n                        \/\/ Hash de contrase\u00f1a (igual que auth)\n                        $hash = password_hash($password, PASSWORD_DEFAULT);\n                        \n                        if (!$hash) {\n                            $mensaje = \"\u274c Error al generar hash de contrase\u00f1a.\";\n                            error_log(\"GOFAST ADMIN - Error al generar hash de contrase\u00f1a\");\n                        } else {\n                            \/\/ Preparar datos para inserci\u00f3n (igual que auth)\n                            $datos_insert = [\n                                'nombre'         => $nombre,\n                                'telefono'       => $telefono,\n                                'email'          => $email,\n                                'password_hash'  => $hash,\n                                'rol'            => $rol,\n                                'activo'         => $activo,\n                                'fecha_registro' => gofast_current_time('mysql')\n                            ];\n                            \n                            \/\/ Verificar si el campo remember_token existe (igual que auth)\n                            $tabla_info = $wpdb->get_results(\"SHOW COLUMNS FROM $tabla LIKE 'remember_token'\");\n                            if (!empty($tabla_info)) {\n                                $datos_insert['remember_token'] = null;\n                            }\n                            \n                            \/\/ Preparar formatos (igual que auth)\n                            $formatos = ['%s','%s','%s','%s','%s','%d','%s'];\n                            if (!empty($tabla_info)) {\n                                $formatos[] = '%s'; \/\/ remember_token\n                            }\n\n                            \/\/ Inserci\u00f3n (igual que auth - EXACTAMENTE IGUAL)\n                            error_log(\"GOFAST ADMIN - Intentando insertar usuario. Datos: \" . print_r($datos_insert, true));\n                            error_log(\"GOFAST ADMIN - Formatos: \" . print_r($formatos, true));\n                            \n                            $ok = $wpdb->insert($tabla, $datos_insert, $formatos);\n                            \n                            error_log(\"GOFAST ADMIN - Resultado insert: \" . var_export($ok, true));\n                            error_log(\"GOFAST ADMIN - Insert ID: \" . $wpdb->insert_id);\n                            error_log(\"GOFAST ADMIN - Last Error: \" . ($wpdb->last_error ?: 'NINGUNO'));\n                            error_log(\"GOFAST ADMIN - Last Query: \" . $wpdb->last_query);\n\n                            if (!$ok) {\n                                $error_db = $wpdb->last_error;\n                                $mensaje = \"\u274c Error al crear usuario en la base de datos.\";\n                                \n                                \/\/ Log detallado SIEMPRE\n                                error_log(\"GOFAST ADMIN - ERROR al crear usuario: \" . ($error_db ?: 'SIN ERROR PERO FALSE'));\n                                error_log(\"GOFAST ADMIN - Datos intentados: \" . print_r($datos_insert, true));\n                                error_log(\"GOFAST ADMIN - Formatos: \" . print_r($formatos, true));\n                                error_log(\"GOFAST ADMIN - SQL: \" . $wpdb->last_query);\n                                \n                                \/\/ Agregar m\u00e1s detalles al mensaje\n                                if ($error_db) {\n                                    $mensaje .= \" Detalle: \" . esc_html($error_db);\n                                } else {\n                                    $mensaje .= \" (Ver logs para m\u00e1s detalles)\";\n                                }\n                            } else {\n                                $user_id = (int) $wpdb->insert_id;\n                                \n                                if ($user_id > 0) {\n                                    $mensaje = \"\u2705 Usuario creado correctamente (ID: #{$user_id}).\";\n                                    \n                                    error_log(\"GOFAST ADMIN - \u2705 Usuario creado exitosamente. ID: {$user_id}\");\n                                    \n                                    \/\/ Redirigir para evitar reenv\u00edo del formulario\n                                    wp_redirect(add_query_arg(['usuario_creado' => '1'], get_permalink()));\n                                    exit;\n                                } else {\n                                    $mensaje = \"\u274c Error: Usuario no se cre\u00f3 (insert_id = 0). Ver logs.\";\n                                    error_log(\"GOFAST ADMIN - ERROR: Insert retorn\u00f3 true pero insert_id es 0\");\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        \/* ----------------------------------------------\n           B) Editar usuarios existentes (verificar nonce espec\u00edfico)\n        ---------------------------------------------- *\/\n        \/\/ Verificar que sea el bot\u00f3n de GUARDAR, no el de CREAR\n        if (!empty($_POST['gofast_guardar_usuarios']) && empty($_POST['gofast_crear_usuario'])) {\n            \n            \/\/ Log para confirmar que se detect\u00f3 el bot\u00f3n correcto\n            error_log(\"GOFAST ADMIN - \u2705 Bot\u00f3n GUARDAR CAMBIOS detectado correctamente\");\n            error_log(\"GOFAST ADMIN - gofast_guardar_usuarios: \" . ($_POST['gofast_guardar_usuarios'] ?? 'NO'));\n            error_log(\"GOFAST ADMIN - gofast_crear_usuario: \" . ($_POST['gofast_crear_usuario'] ?? 'NO'));\n\n            if (\n                empty($_POST['gofast_usuarios_nonce']) ||\n                !wp_verify_nonce($_POST['gofast_usuarios_nonce'], 'gofast_usuarios_admin')\n            ) {\n                $mensaje = \"\ud83d\udd12 Error de seguridad al guardar cambios.\";\n            } else {\n\n                \/\/ Actualizar usuarios\n                if (!empty($_POST['usuarios']) && is_array($_POST['usuarios'])) {\n                    foreach ($_POST['usuarios'] as $user_id => $data) {\n                        $user_id = (int) $user_id;\n                        if ($user_id <= 0) continue;\n\n                        $nombre   = sanitize_text_field($data['nombre'] ?? '');\n                        $telefono = sanitize_text_field($data['telefono'] ?? '');\n                        $email    = sanitize_email($data['email'] ?? '');\n                        $rol      = sanitize_text_field($data['rol'] ?? 'cliente');\n                        $activo   = !empty($data['activo']) ? 1 : 0;\n                        $password = $data['password'] ?? '';\n\n                        if (!in_array($rol, ['cliente', 'mensajero', 'admin'], true)) {\n                            continue;\n                        }\n\n                        $update_data = [\n                            'nombre'   => $nombre,\n                            'telefono' => $telefono,\n                            'email'    => $email,\n                            'rol'      => $rol,\n                            'activo'   => $activo\n                        ];\n\n                        \/\/ Si hay nueva contrase\u00f1a, actualizarla\n                        if ($password !== '') {\n                            $update_data['password_hash'] = password_hash($password, PASSWORD_DEFAULT);\n                        }\n\n                        $wpdb->update(\n                            $tabla,\n                            $update_data,\n                            ['id' => $user_id],\n                            $password !== '' ? ['%s','%s','%s','%s','%d','%s'] : ['%s','%s','%s','%s','%d'],\n                            ['%d']\n                        );\n                    }\n                }\n\n                \/\/ Eliminar usuarios\n                if (!empty($_POST['eliminar_usuario']) && is_array($_POST['eliminar_usuario'])) {\n                    foreach ($_POST['eliminar_usuario'] as $user_id => $flag) {\n                        if ($flag != '1') continue;\n                        $user_id = (int) $user_id;\n                        if ($user_id > 0 && $user_id !== (int) $_SESSION['gofast_user_id']) {\n                            \/\/ No permitir auto-eliminarse\n                            $wpdb->update($tabla, ['activo' => 0], ['id' => $user_id]);\n                        }\n                    }\n                }\n\n                if ($mensaje === '') {\n                    $mensaje = \"\u2705 Cambios guardados correctamente.\";\n                }\n            }\n        }\n    }\n\n    \/\/ Mostrar mensaje de \u00e9xito si viene de redirecci\u00f3n\n    if (isset($_GET['usuario_creado']) && $_GET['usuario_creado'] === '1') {\n        $mensaje = \"\u2705 Usuario creado correctamente.\";\n    }\n    \n    \/\/ Si hay POST pero no hay mensaje, podr\u00eda ser un problema silencioso\n    if ($_SERVER['REQUEST_METHOD'] === 'POST' && empty($mensaje) && !empty($_POST['gofast_crear_usuario'])) {\n        $mensaje = \"\u26a0\ufe0f No se pudo procesar la solicitud. Verifica los datos e intenta de nuevo.\";\n        error_log(\"GOFAST ADMIN - \u26a0\ufe0f POST recibido pero mensaje vac\u00edo. POST: \" . print_r($_POST, true));\n        error_log(\"GOFAST ADMIN - \u26a0\ufe0f Variables: nombre=\" . ($_POST['nuevo_nombre'] ?? 'VAC\u00cdO') . \", email=\" . ($_POST['nuevo_email'] ?? 'VAC\u00cdO'));\n    }\n\n    \/* ==========================================================\n       2. Filtros (GET)\n    ========================================================== *\/\n    $filtro_rol = isset($_GET['rol']) ? sanitize_text_field($_GET['rol']) : '';\n    $filtro_activo = isset($_GET['activo']) ? sanitize_text_field($_GET['activo']) : '';\n    $buscar = isset($_GET['q']) ? sanitize_text_field($_GET['q']) : '';\n\n    $where = \"1=1\";\n    $params = [];\n\n    if ($filtro_rol !== '' && $filtro_rol !== 'todos') {\n        $where .= \" AND rol = %s\";\n        $params[] = $filtro_rol;\n    }\n\n    if ($filtro_activo !== '' && $filtro_activo !== 'todos') {\n        $where .= \" AND activo = %d\";\n        $params[] = ($filtro_activo === 'activo') ? 1 : 0;\n    }\n\n    if ($buscar !== '') {\n        $like = '%' . $wpdb->esc_like($buscar) . '%';\n        $where .= \" AND (nombre LIKE %s OR email LIKE %s OR telefono LIKE %s)\";\n        $params[] = $like;\n        $params[] = $like;\n        $params[] = $like;\n    }\n\n    \/* ==========================================================\n       3. Paginaci\u00f3n\n    ========================================================== *\/\n    $por_pagina = 20;\n    $pagina = isset($_GET['pg']) ? max(1, (int) $_GET['pg']) : 1;\n    $offset = ($pagina - 1) * $por_pagina;\n\n    if (!empty($params)) {\n        $sql_count = $wpdb->prepare(\n            \"SELECT COUNT(*) FROM $tabla WHERE $where\",\n            $params\n        );\n    } else {\n        $sql_count = \"SELECT COUNT(*) FROM $tabla WHERE $where\";\n    }\n\n    $total_registros = (int) $wpdb->get_var($sql_count);\n    $total_paginas = max(1, (int) ceil($total_registros \/ $por_pagina));\n\n    $params_datos = $params;\n    $params_datos[] = $por_pagina;\n    $params_datos[] = $offset;\n\n    $sql_datos = $wpdb->prepare(\n        \"SELECT * FROM $tabla \n         WHERE $where\n         ORDER BY fecha_registro DESC\n         LIMIT %d OFFSET %d\",\n        $params_datos\n    );\n\n    $usuarios = $wpdb->get_results($sql_datos);\n\n    \/* ==========================================================\n       4. HTML\n    ========================================================== *\/\n    ob_start();\n    ?>\n\n<div class=\"gofast-home\">\n    <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;\">\n        <div>\n            <h1 style=\"margin-bottom:8px;\">\ud83d\udc65 Gesti\u00f3n de Usuarios<\/h1>\n            <p class=\"gofast-home-text\">\n                Crea, edita y gestiona usuarios del sistema.\n            <\/p>\n        <\/div>\n        <a href=\"<?php echo esc_url( home_url('\/dashboard-admin') ); ?>\" class=\"gofast-btn-request\" style=\"text-decoration:none;\">\n            \u2190 Volver al Dashboard\n        <\/a>\n    <\/div>\n\n    <?php \n    \/\/ Debug: verificar si hay POST pero no mensaje\n    if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['gofast_crear_usuario']) && empty($mensaje)) {\n        error_log(\"GOFAST ADMIN - \u26a0\ufe0f POST recibido pero mensaje vac\u00edo. Esto indica un problema.\");\n    }\n    ?>\n    \n    <?php if ($mensaje): ?>\n        <div class=\"gofast-box\" style=\"margin-bottom:15px;background:<?= strpos($mensaje, '\u2705') !== false ? '#d4edda' : (strpos($mensaje, '\u274c') !== false ? '#f8d7da' : '#fff3cd'); ?>;border-left:4px solid <?= strpos($mensaje, '\u2705') !== false ? '#28a745' : (strpos($mensaje, '\u274c') !== false ? '#dc3545' : '#ffc107'); ?>;padding:15px;\">\n            <strong style=\"font-size:16px;\"><?= esc_html($mensaje); ?><\/strong>\n        <\/div>\n    <?php elseif ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['gofast_crear_usuario']) && empty($mensaje)): ?>\n        <!-- Si hay POST pero no hay mensaje, mostrar advertencia -->\n        <div class=\"gofast-box\" style=\"margin-bottom:15px;background:#f8d7da;border-left:4px solid #dc3545;padding:15px;\">\n            <strong style=\"font-size:16px;\">\u26a0\ufe0f Se recibi\u00f3 el formulario pero no se proces\u00f3. Verifica los logs o contacta al administrador.<\/strong>\n            <br><small>POST recibido: <?= !empty($_POST['gofast_crear_usuario']) ? 'S\u00cd' : 'NO'; ?><\/small>\n        <\/div>\n    <?php endif; ?>\n    \n    <?php if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['gofast_crear_usuario'])): ?>\n        <!-- Debug temporal: mostrar que se recibi\u00f3 el POST -->\n        <div class=\"gofast-box\" style=\"margin-bottom:15px;background:#e3f2fd;border-left:4px solid #2196F3;padding:15px;font-size:12px;\">\n            <strong>\ud83d\udd0d Debug POST recibido:<\/strong><br>\n            Nombre: <?= esc_html($_POST['nuevo_nombre'] ?? 'VAC\u00cdO'); ?><br>\n            Email: <?= esc_html($_POST['nuevo_email'] ?? 'VAC\u00cdO'); ?><br>\n            Tel\u00e9fono: <?= esc_html($_POST['nuevo_telefono'] ?? 'VAC\u00cdO'); ?><br>\n            Password: <?= !empty($_POST['nuevo_password']) ? 'SET (' . strlen($_POST['nuevo_password']) . ' chars)' : 'VAC\u00cdO'; ?><br>\n            Rol: <?= esc_html($_POST['nuevo_rol'] ?? 'VAC\u00cdO'); ?><br>\n            Activo: <?= !empty($_POST['nuevo_activo']) ? 'S\u00cd' : 'NO'; ?><br>\n            Nonce recibido: <?= !empty($_POST['gofast_usuarios_nonce']) ? 'S\u00cd (' . substr($_POST['gofast_usuarios_nonce'], 0, 8) . '...)' : 'NO'; ?><br>\n            Mensaje actual: <strong style=\"color:<?= $mensaje ? (strpos($mensaje, '\u2705') !== false ? '#28a745' : (strpos($mensaje, '\u274c') !== false ? '#dc3545' : '#ffc107')) : '#dc3545'; ?>\"><?= $mensaje ? esc_html($mensaje) : 'NINGUNO - ESTO ES UN PROBLEMA'; ?><\/strong>\n        <\/div>\n    <?php endif; ?>\n    \n    <?php if (defined('WP_DEBUG') && WP_DEBUG && !empty($debug_info)): ?>\n        <div class=\"gofast-box\" style=\"margin-bottom:15px;background:#f8f9fa;font-size:12px;font-family:monospace;padding:15px;max-height:300px;overflow-y:auto;\">\n            <strong>\ud83d\udd0d Debug Info:<\/strong><br>\n            <?php foreach ($debug_info as $info): ?>\n                <?= esc_html($info); ?><br>\n            <?php endforeach; ?>\n        <\/div>\n    <?php endif; ?>\n    \n    <?php if (defined('WP_DEBUG') && WP_DEBUG && !empty($_POST)): ?>\n        <div class=\"gofast-box\" style=\"margin-bottom:15px;background:#e8f4f8;font-size:11px;font-family:monospace;padding:10px;max-height:200px;overflow-y:auto;\">\n            <strong>\ud83d\udccb POST Data recibido:<\/strong><br>\n            <pre><?= esc_html(print_r($_POST, true)); ?><\/pre>\n        <\/div>\n    <?php endif; ?>\n\n    <!-- =====================================================\n         A) CREAR NUEVO USUARIO (FORMULARIO SEPARADO)\n    ====================================================== -->\n    <form method=\"post\" action=\"\" style=\"margin-bottom:20px;\">\n        <?php wp_nonce_field('gofast_usuarios_admin', 'gofast_usuarios_nonce'); ?>\n        <div class=\"gofast-box\">\n            <h3 style=\"margin-top:0;\">\u2795 Nuevo usuario<\/h3>\n\n            <div class=\"gofast-recargo-nuevo\" style=\"display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;\">\n                <div>\n                    <label>Nombre completo<\/label>\n                    <input type=\"text\" name=\"nuevo_nombre\" placeholder=\"Ej: Juan P\u00e9rez\" required>\n                <\/div>\n                <div>\n                    <label>Tel\u00e9fono<\/label>\n                    <input type=\"text\" name=\"nuevo_telefono\" placeholder=\"Ej: 3001234567\" required>\n                <\/div>\n                <div>\n                    <label>Email<\/label>\n                    <input type=\"email\" name=\"nuevo_email\" placeholder=\"Ej: juan@example.com\" required>\n                <\/div>\n                <div>\n                    <label>Contrase\u00f1a<\/label>\n                    <input type=\"password\" name=\"nuevo_password\" placeholder=\"M\u00ednimo 6 caracteres\" required minlength=\"6\">\n                <\/div>\n                <div>\n                    <label>Rol<\/label>\n                    <select name=\"nuevo_rol\" required>\n                        <option value=\"cliente\">Cliente<\/option>\n                        <option value=\"mensajero\">Mensajero<\/option>\n                        <option value=\"admin\">Administrador<\/option>\n                    <\/select>\n                <\/div>\n                <div style=\"display:flex;align-items:flex-end;\">\n                    <label class=\"gofast-switch\">\n                        <input type=\"checkbox\" name=\"nuevo_activo\" value=\"1\" checked>\n                        <span class=\"gofast-switch-slider\"><\/span>\n                        <span class=\"gofast-switch-label\">Activo<\/span>\n                    <\/label>\n                <\/div>\n                <div style=\"display:flex;align-items:flex-end;\">\n                    <button type=\"submit\" name=\"gofast_crear_usuario\" class=\"gofast-small-btn\">\n                        \ud83d\udcbe Crear usuario\n                    <\/button>\n                <\/div>\n            <\/div>\n        <\/div>\n    <\/form>\n\n    <!-- =====================================================\n         B) FILTROS (FORMULARIO SEPARADO)\n    ====================================================== -->\n    <div class=\"gofast-box\" style=\"margin-bottom:20px;\">\n        <form method=\"get\" class=\"gofast-pedidos-filtros\">\n                <div class=\"gofast-pedidos-filtros-row\">\n                    <div>\n                        <label>Rol<\/label>\n                        <select name=\"rol\">\n                            <option value=\"todos\"<?php selected($filtro_rol, 'todos'); ?>>Todos<\/option>\n                            <option value=\"cliente\"<?php selected($filtro_rol, 'cliente'); ?>>Cliente<\/option>\n                            <option value=\"mensajero\"<?php selected($filtro_rol, 'mensajero'); ?>>Mensajero<\/option>\n                            <option value=\"admin\"<?php selected($filtro_rol, 'admin'); ?>>Admin<\/option>\n                        <\/select>\n                    <\/div>\n\n                    <div>\n                        <label>Estado<\/label>\n                        <select name=\"activo\">\n                            <option value=\"todos\"<?php selected($filtro_activo, 'todos'); ?>>Todos<\/option>\n                            <option value=\"activo\"<?php selected($filtro_activo, 'activo'); ?>>Activo<\/option>\n                            <option value=\"inactivo\"<?php selected($filtro_activo, 'inactivo'); ?>>Inactivo<\/option>\n                        <\/select>\n                    <\/div>\n\n                    <div>\n                        <label>Buscar<\/label>\n                        <input type=\"text\" name=\"q\" placeholder=\"Nombre, email o tel\u00e9fono\" value=\"<?php echo esc_attr($buscar); ?>\">\n                    <\/div>\n\n                    <div class=\"gofast-pedidos-filtros-actions\">\n                        <button type=\"submit\" class=\"gofast-btn-mini\">Filtrar<\/button>\n                        <a href=\"<?php echo esc_url( get_permalink() ); ?>\" class=\"gofast-btn-mini gofast-btn-outline\">Limpiar<\/a>\n                    <\/div>\n                <\/div>\n        <\/form>\n    <\/div>\n\n    <!-- =====================================================\n         C) LISTADO DE USUARIOS (FORMULARIO SEPARADO)\n    ====================================================== -->\n    <form method=\"post\">\n        <input type=\"hidden\" name=\"gofast_usuarios_nonce\" value=\"<?= wp_create_nonce('gofast_usuarios_admin'); ?>\">\n        <div class=\"gofast-box\">\n            <h3 style=\"margin-top:0;\">\ud83d\udccb Usuarios (<?= number_format($total_registros); ?>)<\/h3>\n\n            <?php if (empty($usuarios)): ?>\n                <p>No se encontraron usuarios con los filtros seleccionados.<\/p>\n            <?php else: ?>\n\n                <div class=\"gofast-table-wrap\">\n                    <table class=\"gofast-table\">\n                        <thead>\n                            <tr>\n                                <th>ID<\/th>\n                                <th>Nombre<\/th>\n                                <th>Email<\/th>\n                                <th>Tel\u00e9fono<\/th>\n                                <th>Rol<\/th>\n                                <th>Estado<\/th>\n                                <th>Registro<\/th>\n                                <th>Acciones<\/th>\n                            <\/tr>\n                        <\/thead>\n                        <tbody>\n                        <?php foreach ($usuarios as $u):\n                            $es_yo = ((int) $u->id === (int) $_SESSION['gofast_user_id']);\n                            ?>\n                            <tr class=\"<?= $u->activo ? 'gofast-row-active' : 'gofast-row-inactive'; ?>\">\n                                <td>#<?= (int) $u->id; ?><\/td>\n                                <td>\n                                    <input type=\"text\"\n                                           name=\"usuarios[<?= esc_attr($u->id); ?>][nombre]\"\n                                           value=\"<?= esc_attr($u->nombre); ?>\"\n                                           style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                <\/td>\n                                <td>\n                                    <input type=\"email\"\n                                           name=\"usuarios[<?= esc_attr($u->id); ?>][email]\"\n                                           value=\"<?= esc_attr($u->email); ?>\"\n                                           style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                <\/td>\n                                <td>\n                                    <input type=\"text\"\n                                           name=\"usuarios[<?= esc_attr($u->id); ?>][telefono]\"\n                                           value=\"<?= esc_attr($u->telefono); ?>\"\n                                           style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                <\/td>\n                                <td>\n                                    <select name=\"usuarios[<?= esc_attr($u->id); ?>][rol]\"\n                                            style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;\">\n                                        <option value=\"cliente\"<?php selected($u->rol, 'cliente'); ?>>Cliente<\/option>\n                                        <option value=\"mensajero\"<?php selected($u->rol, 'mensajero'); ?>>Mensajero<\/option>\n                                        <option value=\"admin\"<?php selected($u->rol, 'admin'); ?>>Admin<\/option>\n                                    <\/select>\n                                <\/td>\n                                <td>\n                                    <label class=\"gofast-switch\">\n                                        <input type=\"checkbox\"\n                                               name=\"usuarios[<?= esc_attr($u->id); ?>][activo]\"\n                                               value=\"1\"\n                                               <?= $u->activo ? 'checked' : ''; ?>>\n                                        <span class=\"gofast-switch-slider\"><\/span>\n                                        <span class=\"gofast-switch-label\">Activo<\/span>\n                                    <\/label>\n                                <\/td>\n                                <td><?= esc_html( gofast_date_format($u->fecha_registro, 'Y-m-d') ); ?><\/td>\n                                <td>\n                                    <div style=\"display:flex;flex-direction:column;gap:4px;\">\n                                        <input type=\"password\"\n                                               name=\"usuarios[<?= esc_attr($u->id); ?>][password]\"\n                                               placeholder=\"Nueva contrase\u00f1a (opcional)\"\n                                               style=\"width:100%;padding:4px 8px;border:1px solid #ddd;border-radius:4px;font-size:12px;\">\n                                        <?php if (!$es_yo): ?>\n                                            <button type=\"button\"\n                                                    class=\"gofast-small-btn gofast-chip-danger gofast-delete-usuario\"\n                                                    data-usuario-id=\"<?= esc_attr($u->id); ?>\">\n                                                \ud83d\uddd1\ufe0f Desactivar\n                                            <\/button>\n                                        <?php else: ?>\n                                            <span style=\"font-size:11px;color:#666;\">(T\u00fa)<\/span>\n                                        <?php endif; ?>\n                                    <\/div>\n                                <\/td>\n                            <\/tr>\n                        <?php endforeach; ?>\n                        <\/tbody>\n                    <\/table>\n                <\/div>\n\n                <?php if ($total_paginas > 1): ?>\n                    <div class=\"gofast-pagination\">\n                        <?php\n                        $base_url = get_permalink();\n                        $query_args = $_GET;\n\n                        for ($i = 1; $i <= $total_paginas; $i++):\n                            $query_args['pg'] = $i;\n                            $url = esc_url( add_query_arg($query_args, $base_url) );\n                            $active = ($i === $pagina) ? 'gofast-page-current' : '';\n                            ?>\n                            <a href=\"<?php echo $url; ?>\" class=\"gofast-page-link <?php echo $active; ?>\">\n                                <?php echo $i; ?>\n                            <\/a>\n                        <?php endfor; ?>\n                    <\/div>\n                <?php endif; ?>\n\n                <div style=\"margin-top:18px;text-align:right;\">\n                    <button type=\"submit\"\n                            name=\"gofast_guardar_usuarios\"\n                            value=\"1\"\n                            class=\"gofast-btn-request\"\n                            style=\"max-width:260px;margin-left:auto;\">\n                        \ud83d\udcbe Guardar cambios\n                    <\/button>\n                <\/div>\n\n            <?php endif; ?>\n        <\/div>\n    <\/form>\n<\/div>\n\n<script>\ndocument.addEventListener('DOMContentLoaded', function(){\n    \/\/ Proteger contra errores de toggleOtro si no existe\n    if (typeof toggleOtro === 'function') {\n        try {\n            const tipoSelect = document.getElementById(\"tipo_negocio\");\n            const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n            if (tipoSelect && wrapperOtro) {\n                setTimeout(toggleOtro, 200);\n            }\n        } catch(e) {\n            console.log('toggleOtro error capturado:', e);\n        }\n    }\n    \n    \/\/ Eliminar usuario\n    document.querySelectorAll('.gofast-delete-usuario').forEach(function(btn){\n        btn.addEventListener('click', function(){\n            const id = btn.getAttribute('data-usuario-id');\n            if (!id) return;\n\n            if (!confirm('\u00bfSeguro que quieres desactivar este usuario?')) {\n                return;\n            }\n\n            const form = btn.closest('form');\n            if (!form) return;\n\n            let input = form.querySelector('input[name=\"eliminar_usuario['+id+']\"]');\n            if (!input) {\n                input = document.createElement('input');\n                input.type = 'hidden';\n                input.name = 'eliminar_usuario['+id+']';\n                input.value = '1';\n                form.appendChild(input);\n            }\n\n            let flag = form.querySelector('input[name=\"gofast_guardar_usuarios\"]');\n            if (!flag) {\n                flag = document.createElement('input');\n                flag.type = 'hidden';\n                flag.name = 'gofast_guardar_usuarios';\n                flag.value = '1';\n                form.appendChild(flag);\n            }\n\n            form.submit();\n        });\n    });\n});\n<\/script>\n\n<?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_usuarios_admin', 'gofast_usuarios_admin_shortcode');\n\n","active":true,"modified":"2025-12-06 16:14:28","revision":"1"}]}