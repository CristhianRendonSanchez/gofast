{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":24,"name":"redireccion","code":"\n\/***************************************************\n * GOFAST \u2013 PROCESAR ADD, EDIT Y DELETE ANTES DE HEADER\n ***************************************************\/\nadd_action('template_redirect', function() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) session_start();\n    if (empty($_SESSION['gofast_user_id'])) return;\n\n    $user_id = intval($_SESSION['gofast_user_id']);\n\n    \/* ==========================================\n       1) ELIMINAR NEGOCIO\n    ========================================== *\/\n    if (isset($_GET['delete'])) {\n\n        $delete_id = intval($_GET['delete']);\n\n        $exists = $wpdb->get_var($wpdb->prepare(\n            \"SELECT id FROM negocios_gofast WHERE id=%d AND user_id=%d\",\n            $delete_id, $user_id\n        ));\n\n        if ($exists) {\n            $wpdb->delete(\"negocios_gofast\", [\"id\" => $delete_id]);\n        }\n\n        wp_safe_redirect(\"\/mi-negocio\");\n        exit;\n    }\n\n    \/* ==========================================\n       2) GUARDAR (INSERT \/ UPDATE)\n    ========================================== *\/\n    if (isset($_POST['gofast_guardar_negocio'])) {\n\n        $editing_id = isset($_GET['edit']) ? intval($_GET['edit']) : 0;\n\n        $nombre     = sanitize_text_field($_POST['nombre_negocio'] ?? '');\n        $tipo       = sanitize_text_field($_POST['tipo_negocio'] ?? '');\n        $tipo_otro  = sanitize_text_field($_POST['tipo_otro'] ?? '');\n        $whatsapp   = gofast_clean_whatsapp($_POST['whatsapp'] ?? '');\n        $barrio_id  = intval($_POST['barrio_id'] ?? 0);\n        $direccion  = sanitize_text_field($_POST['direccion_full'] ?? '');\n\n        \/\/ Si el usuario seleccion\u00f3 \"Otro\", usar el valor escrito\n        if ($tipo === \"Otro\" && !empty($tipo_otro)) {\n            $tipo = $tipo_otro;\n        }\n\n        \/\/ Validaciones m\u00ednimas\n        if (!$nombre || !$tipo || !$barrio_id || !$direccion) {\n            return; \/\/ vuelve al formulario\n        }\n\n        \/\/ Sector del barrio\n        $sector_id = intval($wpdb->get_var(\n            $wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id=%d\", $barrio_id)\n        ));\n\n        if ($editing_id) {\n            \/\/ UPDATE\n            $wpdb->update(\n                \"negocios_gofast\",\n                [\n                    \"nombre\"        => $nombre,\n                    \"tipo\"          => $tipo,\n                    \"barrio_id\"     => $barrio_id,\n                    \"sector_id\"     => $sector_id,\n                    \"direccion_full\"=> $direccion,\n                    \"whatsapp\"      => $whatsapp,\n                    \"updated_at\"    => gofast_current_time('mysql')\n                ],\n                [\"id\" => $editing_id, \"user_id\" => $user_id]\n            );\n        } else {\n            \/\/ INSERT\n            $wpdb->insert(\n                \"negocios_gofast\",\n                [\n                    \"user_id\"       => $user_id,\n                    \"nombre\"        => $nombre,\n                    \"tipo\"          => $tipo,\n                    \"barrio_id\"     => $barrio_id,\n                    \"sector_id\"     => $sector_id,\n                    \"direccion_full\"=> $direccion,\n                    \"whatsapp\"      => $whatsapp,\n                    \"activo\"        => 1,\n                    \"created_at\"    => gofast_current_time('mysql')\n                ]\n            );\n        }\n\n        wp_safe_redirect(\"\/mi-negocio\");\n        exit;\n    }\n});\n\n","active":true,"modified":"2025-12-06 22:00:47","revision":"1"}]}