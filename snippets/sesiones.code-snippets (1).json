{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":16,"name":"sesiones","code":"\n\/***************************************************\n * GOFAST \u2013 ACTIVAR SESIONES GLOBALES EN TODO WP\n * Con persistencia mejorada y restauraci\u00f3n desde cookies\n ***************************************************\/\n\n\/\/ Configurar tiempo de vida de sesi\u00f3n (30 d\u00edas en segundos)\nini_set('session.gc_maxlifetime', 2592000); \/\/ 30 d\u00edas\nini_set('session.cookie_lifetime', 2592000); \/\/ 30 d\u00edas\n\nfunction gofast_start_session() {\n    if (session_status() === PHP_SESSION_NONE) {\n        \/\/ Configurar par\u00e1metros de sesi\u00f3n antes de iniciar\n        session_set_cookie_params([\n            'lifetime' => 2592000, \/\/ 30 d\u00edas\n            'path' => '\/',\n            'domain' => '',\n            'secure' => false, \/\/ Cambiar a true si usas HTTPS\n            'httponly' => true,\n            'samesite' => 'Lax'\n        ]);\n        session_start();\n    }\n    \n    \/\/ Restaurar sesi\u00f3n desde cookie persistente si no hay sesi\u00f3n activa\n    gofast_restore_session_from_cookie();\n}\nadd_action('init', 'gofast_start_session', 1);\n\n\/**\n * Restaurar sesi\u00f3n desde cookie persistente\n * Esta funci\u00f3n se ejecuta autom\u00e1ticamente al iniciar sesi\u00f3n\n *\/\nfunction gofast_restore_session_from_cookie() {\n    \/\/ Solo restaurar si no hay sesi\u00f3n activa\n    if (!empty($_SESSION['gofast_user_id'])) {\n        return; \/\/ Ya hay sesi\u00f3n activa\n    }\n    \n    \/\/ Verificar si existe cookie persistente\n    if (empty($_COOKIE['gofast_token'])) {\n        return; \/\/ No hay cookie\n    }\n    \n    global $wpdb;\n    \n    $token = sanitize_text_field($_COOKIE['gofast_token']);\n    \n    \/\/ Verificar si el campo remember_token existe\n    $tabla_info = $wpdb->get_results(\"SHOW COLUMNS FROM usuarios_gofast LIKE 'remember_token'\");\n    if (empty($tabla_info)) {\n        return; \/\/ Campo no existe\n    }\n    \n    \/\/ Buscar usuario por token\n    $usuario = $wpdb->get_row(\n        $wpdb->prepare(\n            \"SELECT id, rol, activo FROM usuarios_gofast WHERE remember_token = %s AND activo = 1 LIMIT 1\",\n            $token\n        )\n    );\n    \n    if ($usuario) {\n        \/\/ Restaurar sesi\u00f3n\n        $_SESSION['gofast_user_id']  = (int) $usuario->id;\n        $_SESSION['gofast_user_rol'] = strtolower($usuario->rol ?: 'cliente');\n    } else {\n        \/\/ Token inv\u00e1lido, eliminar cookie\n        setcookie(\"gofast_token\", \"\", time() - 3600, \"\/\", \"\", false, true);\n    }\n}\n\n","active":true,"priority":1,"modified":"2025-12-02 16:21:16","revision":"1"}]}