{"generator":"Code Snippets v3.9.2","date_created":"2025-11-21 22:43","snippets":[{"id":7,"name":"solicitar-mensajero","code":"\/* ==========================================================\n   SHORTCODE: GOFAST RESULTADO \u2014 VERSI\u00d3N FINAL COMPLETA + NEGOCIOS\n   ========================================================== *\/\n\nfunction gofast_resultado_cotizacion() {\n    global $wpdb;\n\n    \/* ----------------------------------------------------------\n       \u2705 Validaci\u00f3n inicial\n    ---------------------------------------------------------- *\/\n    if (!isset($_POST['origen']) || !isset($_POST['destino'])) {\n        return \"<div class='gofast-box'>No se encontr\u00f3 la cotizaci\u00f3n.<\/div>\";\n    }\n\n    $origen   = intval($_POST['origen']);\n    $destinos = array_map('intval', (array) $_POST['destino']);\n\n    \/* ==========================================================\n       \u2705 0) DETECTAR USUARIO GOFAST LOGUEADO\n    ========================================================== *\/\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    $usuario             = null;\n    $direcciones_previas = [];\n    $negocio_usado       = null; \/\/ \u2b50 negocio detectado como origen (si aplica)\n\n    if (!empty($_SESSION['gofast_user_id'])) {\n\n        $user_id = intval($_SESSION['gofast_user_id']);\n\n        \/\/ \u2705 Datos del usuario\n        $usuario = $wpdb->get_row(\"\n            SELECT id, nombre, telefono, email, rol \n            FROM usuarios_gofast \n            WHERE id = $user_id AND activo = 1\n        \");\n\n        \/\/ \u2705 Cargar negocios del usuario (incluye whatsapp)\n        $mis_negocios = $wpdb->get_results($wpdb->prepare(\n            \"SELECT id, nombre, direccion_full, barrio_id, sector_id, whatsapp\n             FROM negocios_gofast\n             WHERE user_id = %d AND activo = 1\",\n            $user_id\n        ));\n\n        \/\/ \ud83d\udd0d Detectar si el ORIGEN corresponde al barrio de un negocio\n        foreach ((array) $mis_negocios as $n) {\n            if (intval($n->barrio_id) === $origen) {\n                $negocio_usado = $n;\n                break;\n            }\n        }\n\n        \/\/ \u2705 Direcciones usadas anteriormente (solo si NO usamos negocio)\n        if ($usuario && !$negocio_usado) {\n\n            \/\/ Normalizar tel\u00e9fono del usuario (solo d\u00edgitos)\n            $tel_norm = preg_replace('\/\\D+\/', '', $usuario->telefono);\n\n            \/\/ Direcciones previas usando match de tel\u00e9fono flexible\n            $direcciones_previas = $wpdb->get_col(\n                $wpdb->prepare(\n                    \"SELECT DISTINCT direccion_origen\n                     FROM servicios_gofast\n                     WHERE direccion_origen <> ''\n                       AND (\n                            user_id = %d\n                            OR REPLACE(REPLACE(REPLACE(telefono_cliente, '+', ''), '-', ''), ' ', '') = %s\n                       )\n                     ORDER BY id DESC\n                     LIMIT 10\",\n                    $usuario->id,\n                    $tel_norm\n                )\n            );\n        }\n    }\n\n    \/* ==========================================================\n       \u2705 1) Datos del ORIGEN\n    ========================================================== *\/\n    $sector_origen = intval($wpdb->get_var(\"SELECT sector_id FROM barrios WHERE id = $origen\"));\n    $nombre_origen = $wpdb->get_var(\"SELECT nombre FROM barrios WHERE id = $origen\");\n\n    \/* ==========================================================\n       \u2705 2) Recargos activos (FIJOS + POR VALOR)\n    ========================================================== *\/\n\n    \/\/ \ud83d\udd39 Recargos FIJOS (siempre se aplican por cada trayecto)\n    $recargos_fijos = $wpdb->get_results(\"\n        SELECT id, nombre, valor_fijo \n        FROM recargos\n        WHERE activo = 1 AND tipo = 'fijo'\n    \");\n\n    $recargo_fijo_por_envio   = 0;\n    $recargos_fijos_aplicados = []; \/\/ solo nombres\n\n    foreach ((array) $recargos_fijos as $r) {\n        $monto = intval($r->valor_fijo);\n        if ($monto > 0) {\n            $recargo_fijo_por_envio += $monto;\n            $recargos_fijos_aplicados[] = $r->nombre;\n        }\n    }\n\n    \/\/ \ud83d\udd39 Recargos VARIABLES por rango de valor (ej: lluvia)\n    $recargos_variables = $wpdb->get_results(\"\n        SELECT r.id, r.nombre, rr.monto_min, rr.monto_max, rr.recargo\n        FROM recargos r\n        JOIN recargos_rangos rr ON rr.recargo_id = r.id\n        WHERE r.activo = 1 AND r.tipo = 'por_valor'\n        ORDER BY rr.monto_min ASC\n    \");\n\n    \/\/ Helper: dado un valor de tarifa, devuelve:\n    \/\/  - total recargo variable\n    \/\/  - nombres de recargos aplicados\n    $calcular_recargos_variables = function($valor) use ($recargos_variables) {\n        $valor = intval($valor);\n        $total_variable = 0;\n        $nombres = [];\n\n        foreach ((array) $recargos_variables as $r) {\n            $min = intval($r->monto_min);\n            $max = intval($r->monto_max);\n            $rec = intval($r->recargo);\n\n            $cumple_min = ($valor >= $min);\n            $cumple_max = ($max <= 0) ? true : ($valor <= $max);\n\n            if ($cumple_min && $cumple_max && $rec > 0) {\n                $total_variable += $rec;\n                $nombres[] = $r->nombre;\n            }\n        }\n\n        return [\n            'total'   => $total_variable,\n            'nombres' => $nombres,\n        ];\n    };\n\n    \/* ==========================================================\n       \u2705 3) Procesar destinos + tarifas\n    ========================================================== *\/\n    $detalle_envios                = [];\n    $total                         = 0;\n    $total_recargos_aplicados      = 0; \/\/ suma de TODO lo extra vs tarifa base\n    $recargos_variables_aplicados  = []; \/\/ nombres \u00fanicos\n\n    foreach ($destinos as $destino) {\n\n        $sector_destino = intval($wpdb->get_var(\"SELECT sector_id FROM barrios WHERE id = $destino\"));\n        $nombre_destino = $wpdb->get_var(\"SELECT nombre FROM barrios WHERE id = $destino\");\n\n        $precio = $wpdb->get_var(\n            $wpdb->prepare(\n                \"SELECT precio FROM tarifas \n                 WHERE origen_sector_id=%d AND destino_sector_id=%d\",\n                $sector_origen,\n                $sector_destino\n            )\n        );\n\n        $precio = $precio ? intval($precio) : 0;\n\n        \/\/ Recargos variables para este trayecto\n        $calc_var                  = $calcular_recargos_variables($precio);\n        $recargo_variable_monto    = $calc_var['total'];\n        $recargo_variable_nombres  = $calc_var['nombres'];\n\n        \/\/ Marcar recargos variables aplicados (para mostrar solo nombres luego)\n        foreach ($recargo_variable_nombres as $nombre_recargo) {\n            $recargos_variables_aplicados[$nombre_recargo] = true;\n        }\n\n        \/\/ Total de recargos para este trayecto\n        $recargo_total_trayecto = $recargo_fijo_por_envio + $recargo_variable_monto;\n\n        \/\/ Total final trayecto\n        $total_trayecto = $precio + $recargo_total_trayecto;\n\n        $detalle_envios[] = [\n            \"destino\"                  => $nombre_destino,\n            \"valor\"                    => $precio,\n            \"recargo_fijo\"             => $recargo_fijo_por_envio,\n            \"recargo_variable_monto\"   => $recargo_variable_monto,\n            \"recargo_variable_nombres\" => $recargo_variable_nombres,\n            \"recargo_total\"            => $recargo_total_trayecto,\n            \"total_trayecto\"           => $total_trayecto,\n        ];\n\n        $total                    += $total_trayecto;\n        $total_recargos_aplicados += $recargo_total_trayecto;\n    }\n\n    \/\/ Lista final de nombres de recargos aplicados (sin duplicados)\n    $lista_nombres_recargos = [];\n\n    foreach ($recargos_fijos_aplicados as $nombre) {\n        if ($nombre !== '' && !in_array($nombre, $lista_nombres_recargos, true)) {\n            $lista_nombres_recargos[] = $nombre;\n        }\n    }\n\n    foreach (array_keys($recargos_variables_aplicados) as $nombre) {\n        if ($nombre !== '' && !in_array($nombre, $lista_nombres_recargos, true)) {\n            $lista_nombres_recargos[] = $nombre;\n        }\n    }\n\n    \/* ==========================================================\n       \u2705 4) VALORES POR DEFECTO (NEGOCIO \/ USUARIO)\n    ========================================================== *\/\n\n    \/\/ Regla 1.C: whatsapp negocio si existe, si no tel\u00e9fono usuario\n    $nombre_default =\n        $negocio_usado ? $negocio_usado->nombre :\n        ($usuario ? $usuario->nombre : '');\n\n    $telefono_default =\n        ($negocio_usado && !empty($negocio_usado->whatsapp))\n            ? $negocio_usado->whatsapp\n            : ($usuario ? $usuario->telefono : '');\n\n    $dir_origen_default =\n        $negocio_usado ? $negocio_usado->direccion_full : '';\n\n    \/* ==========================================================\n\t   \u2705 5) SI CONFIRMA \u2192 GUARDAR SERVICIO Y REDIRIGIR\n\t========================================================== *\/\n\tif (!empty($_POST['confirmar'])) {\n\n\t\t$nombre = sanitize_text_field($_POST['nombre']);\n\t\t$tel    = sanitize_text_field($_POST['telefono']);\n\n\t\t\/\/ Direcci\u00f3n origen\n\t\t$dir_origen = !empty($_POST['dir_origen_custom'])\n\t\t\t? sanitize_text_field($_POST['dir_origen_custom'])\n\t\t\t: sanitize_text_field($_POST['dir_origen']);\n\n\t\t\/\/ Direcciones destino opcionales\n\t\t$dirs_dest   = isset($_POST['dir_destino'])   ? (array) $_POST['dir_destino']   : [];\n\t\t$montos_dest = isset($_POST['monto_destino']) ? (array) $_POST['monto_destino'] : [];\n\n\t\tforeach ($montos_dest as $i => $m) {\n\t\t\t$m = trim($m);\n\t\t\t$montos_dest[$i] = ($m === \"\" ? 0 : intval(preg_replace('\/[^\\d]\/', '', $m)));\n\t\t}\n\n\t\t\/\/ JSON de origen\n\t\t$origen_completo = [\n\t\t\t\"barrio_id\"     => $origen,\n\t\t\t\"barrio_nombre\" => $nombre_origen,\n\t\t\t\"sector_id\"     => $sector_origen,\n\t\t\t\"direccion\"     => $dir_origen,\n\t\t];\n\n\t\t\/\/ JSON de destinos\n\t\t$destinos_completos = [];\n\t\tforeach ($destinos as $i => $dest_id) {\n\n\t\t\t$barrio_nombre = $wpdb->get_var(\"SELECT nombre FROM barrios WHERE id = $dest_id\");\n\t\t\t$sector_id     = intval($wpdb->get_var(\"SELECT sector_id FROM barrios WHERE id = $dest_id\"));\n\n\t\t\t$destinos_completos[] = [\n\t\t\t\t\"barrio_id\"     => $dest_id,\n\t\t\t\t\"barrio_nombre\" => $barrio_nombre,\n\t\t\t\t\"sector_id\"     => $sector_id,\n\t\t\t\t\"direccion\"     => !empty($dirs_dest[$i]) ? sanitize_text_field($dirs_dest[$i]) : \"\",\n\t\t\t\t\"monto\"         => !empty($montos_dest[$i]) ? $montos_dest[$i] : 0,\n\t\t\t];\n\t\t}\n\n\t\t$json_final = json_encode(\n\t\t\t[\n\t\t\t\t\"origen\"   => $origen_completo,\n\t\t\t\t\"destinos\" => $destinos_completos,\n\t\t\t],\n\t\t\tJSON_UNESCAPED_UNICODE\n\t\t);\n\n\t\t\/\/ Guardar servicio\n\t\t$insertado = $wpdb->insert(\"servicios_gofast\", [\n\t\t\t\"nombre_cliente\"   => $nombre,\n\t\t\t\"telefono_cliente\" => $tel,\n\t\t\t\"direccion_origen\" => $dir_origen,\n\t\t\t\"destinos\"         => $json_final,\n\t\t\t\"total\"            => $total,\n\t\t\t\"estado\"           => \"pendiente\",\n\t\t\t\"tracking_estado\"  => \"pendiente\",\n\t\t\t\"mensajero_id\"     => null,\n\t\t\t\"user_id\"          => $usuario ? $usuario->id : null,\n\t\t]);\n\n\t\t\/\/ \u26a0\ufe0f Si falla el INSERT, mostramos el error en pantalla\n\t\tif ($insertado === false) {\n\t\t\treturn \"<div class='gofast-box'>\n\t\t\t\t\t\t<b>Error al guardar el servicio:<\/b><br>\" .\n\t\t\t\t\t\tesc_html($wpdb->last_error) .\n\t\t\t\t   \"<\/div>\";\n\t\t}\n\n\t\t$service_id = (int) $wpdb->insert_id;\n\n\t\tif (!$service_id) {\n\t\t\treturn \"<div class='gofast-box'>No se pudo obtener el ID del servicio.<\/div>\";\n\t\t}\n\n\t\t$_SESSION[\"gofast_pending_service\"] = $service_id;\n\n\t\t\/\/ \u2705 IMPORTANTE: redirigir con JavaScript (no con wp_redirect)\n\t\t$url = esc_url( home_url('\/servicio-registrado?id=' . $service_id) );\n\n\t\treturn '<script>window.location.href = \"'.$url.'\";<\/script>';\n\t}\n\n\n    \/* ==========================================================\n       \u2705 6) HTML FINAL\n    ========================================================== *\/\n    ob_start();\n    ?>\n\n    <div class=\"gofast-checkout-wrapper\">\n\n        <!-- \u2705 COLUMNA IZQUIERDA -->\n        <div class=\"gofast-box\">\n\n            <h3>Detalle<\/h3>\n\n            <?php foreach ($detalle_envios as $d): ?>\n                <div class=\"gofast-route-item\">\n                    \ud83d\udef5 <?= esc_html($nombre_origen) ?> \u2192 <?= esc_html($d[\"destino\"]) ?>\n                    <b>$<?= number_format($d[\"total_trayecto\"], 0, ',', '.') ?><\/b>\n                <\/div>\n            <?php endforeach; ?>\n\n            <?php if (!empty($lista_nombres_recargos)): ?>\n                <div class=\"gofast-recargo-box\">\n                    \ud83d\udfe1 <b>Recargos activos aplicados<\/b><br>\n                    En esta cotizaci\u00f3n se est\u00e1n aplicando los siguientes recargos adicionales al valor base del domicilio:\n                    <ul style=\"margin-top:8px;\">\n                        <?php foreach ($lista_nombres_recargos as $nombre): ?>\n                            <li><?= esc_html($nombre) ?><\/li>\n                        <?php endforeach; ?>\n                    <\/ul>\n                    <small>Estos recargos ya est\u00e1n incluidos en el total mostrado.<\/small>\n                <\/div>\n            <?php endif; ?>\n\n            <div class=\"gofast-total-box\" style=\"margin-top:20px; text-align:left;\">\n                \ud83d\udcb0 Total: <b>$<?= number_format($total, 0, ',', '.') ?><\/b>\n            <\/div>\n\n        <\/div>\n\n        <!-- \u2705 COLUMNA DERECHA -->\n        <div class=\"gofast-box\">\n\n            <h3>Datos del servicio<\/h3>\n\n            <form method=\"post\">\n\t\t\t\t<input type=\"hidden\" name=\"origen\" value=\"<?= esc_attr($origen) ?>\">\n\t\t\t\t<?php foreach ($destinos as $d): ?>\n\t\t\t\t\t<input type=\"hidden\" name=\"destino[]\" value=\"<?= esc_attr($d) ?>\">\n\t\t\t\t<?php endforeach; ?>\n\n\t\t\t\t<input type=\"hidden\" name=\"confirmar\" value=\"1\">\n\n                <div class=\"gofast-2col\">\n                    <div>\n                        <label>Tu nombre<\/label>\n                        <input type=\"text\" name=\"nombre\" required\n                               value=\"<?= esc_attr($nombre_default) ?>\">\n                    <\/div>\n\n                    <div>\n                        <label>WhatsApp<\/label>\n                        <input type=\"tel\" name=\"telefono\" required pattern=\"[0-9]{10}\"\n                               value=\"<?= esc_attr($telefono_default) ?>\">\n                    <\/div>\n                <\/div>\n\n                <label>Direcci\u00f3n origen<\/label>\n\n                <?php if ($negocio_usado): ?>\n\n                    <!-- Origen desde negocio -->\n                    <input type=\"text\" name=\"dir_origen\"\n                           value=\"<?= esc_attr($dir_origen_default) ?>\" required>\n\n                <?php elseif (!empty($direcciones_previas)): ?>\n\n                    <select name=\"dir_origen\" class=\"gofast-select\" required>\n                        <option value=\"\">\u2014 Seleccionar \u2014<\/option>\n                        <?php foreach ($direcciones_previas as $dir): ?>\n                            <option value=\"<?= esc_attr($dir) ?>\"><?= esc_html($dir) ?><\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n\n                    <small>Si no aparece tu direcci\u00f3n, escribe una nueva:<\/small>\n                    <input type=\"text\" name=\"dir_origen_custom\"\n                           placeholder=\"Calle 10 #5-22\" style=\"margin-top:8px;\">\n\n                <?php else: ?>\n\n                    <input type=\"text\" name=\"dir_origen\" required placeholder=\"Calle 10 #5-22\">\n\n                <?php endif; ?>\n\n                <br><br>\n\n                <b>Direcciones destino + monto a pagar<\/b><br><br>\n\n                <?php foreach ($detalle_envios as $d): ?>\n                    <div class=\"gofast-dir-item\">\n                        <label><?= esc_html($d[\"destino\"]) ?><\/label>\n\n                        <!-- Direcci\u00f3n destino OPCIONAL -->\n                        <input type=\"text\" name=\"dir_destino[]\" placeholder=\"Ej: Calle 12 #3-15\">\n\n                        <!-- Monto OPCIONAL -->\n                        <input type=\"text\" name=\"monto_destino[]\" class=\"gofast-money\" placeholder=\"$ 0\">\n                    <\/div>\n                <?php endforeach; ?>\n\n                <div class=\"gofast-btn-group\">\n                   <button type=\"submit\" class=\"gofast-btn-request\">\n\t\t\t\t\t\t\ud83d\udc8c Solicitar servicio\n\t\t\t\t\t<\/button>\n\n                    <a href=\"\/\" class=\"gofast-btn-action gofast-secondary\">\ud83d\udd04 Hacer otra cotizaci\u00f3n<\/a>\n                <\/div>\n\n            <\/form>\n\n        <\/div>\n\n    <\/div>\n\n    <script>\n    document.addEventListener('DOMContentLoaded', function () {\n      if (window.jQuery && jQuery.fn.select2) {\n        try { if (jQuery.fn.select2.amd) { jQuery.fn.select2.amd = undefined; } } catch(e) {}\n\n        jQuery('.gofast-select').each(function(){\n          jQuery(this).select2({\n            placeholder: \"Buscar direcci\u00f3n...\",\n            width: '100%',\n            dropdownParent: jQuery(this).closest('.gofast-box')\n          });\n        });\n      }\n    });\n    <\/script>\n\n    <?php\n    return ob_get_clean();\n}\n\nadd_shortcode(\"gofast_resultado\", \"gofast_resultado_cotizacion\");\n","active":true,"modified":"2025-11-21 20:21:59","revision":"1"}]}