{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":31,"name":"gofast_compras","code":"\n\/***************************************************\n * GOFAST \u2013 M\u00d3DULO DE COMPRAS\n * Shortcode: [gofast_compras]\n * URL: \/compras\n * \n * Funcionalidades:\n * - Mensajero: Crear compras (se asigna a s\u00ed mismo) y ver sus compras\n * - Admin: Crear compras (asignar mensajero), ver todas, cambiar estados\n ***************************************************\/\nfunction gofast_compras_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    \/\/ Validar sesi\u00f3n\n    if (empty($_SESSION['gofast_user_id'])) {\n        return \"<div class='gofast-box'>Debes iniciar sesi\u00f3n para acceder a las compras.<\/div>\";\n    }\n\n    $user_id = (int) $_SESSION['gofast_user_id'];\n    $rol = strtolower($_SESSION['gofast_user_rol'] ?? 'cliente');\n\n    \/\/ Solo mensajero y admin pueden acceder\n    if ($rol !== 'mensajero' && $rol !== 'admin') {\n        return \"<div class='gofast-box'>\u26a0\ufe0f Solo mensajeros y administradores pueden acceder a las compras.<\/div>\";\n    }\n\n    \/\/ Obtener datos del usuario\n    $usuario = $wpdb->get_row(\n        $wpdb->prepare(\n            \"SELECT id, nombre, rol, activo FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n            $user_id\n        )\n    );\n\n    if (!$usuario) {\n        return \"<div class='gofast-box'>Usuario no encontrado.<\/div>\";\n    }\n\n    $mensaje = '';\n    $mensaje_tipo = ''; \/\/ success, error\n\n    \/*********************************************\n     * PROCESAMIENTO DE FORMULARIOS\n     *********************************************\/\n\n    \/\/ 1. CREAR COMPRA (Mensajero o Admin)\n    if (isset($_POST['gofast_crear_compra']) && wp_verify_nonce($_POST['gofast_compra_nonce'], 'gofast_crear_compra')) {\n        $valor = floatval($_POST['valor'] ?? 0);\n        $barrio_id = isset($_POST['barrio_id']) ? (int) $_POST['barrio_id'] : 0;\n        $mensajero_id = isset($_POST['mensajero_id']) ? (int) $_POST['mensajero_id'] : $user_id;\n\n        if ($valor < 6000 || $valor > 20000) {\n            $mensaje = 'El valor debe estar entre 6000 y 20000.';\n            $mensaje_tipo = 'error';\n        } elseif (empty($barrio_id)) {\n            $mensaje = 'El destino es obligatorio.';\n            $mensaje_tipo = 'error';\n        } else {\n            \/\/ Validar que el barrio existe\n            $barrio_existe = $wpdb->get_var($wpdb->prepare(\"SELECT id FROM barrios WHERE id = %d\", $barrio_id));\n            \n            if (!$barrio_existe) {\n                $mensaje = 'El destino seleccionado no existe.';\n                $mensaje_tipo = 'error';\n            } else {\n                \/\/ Si es admin creando para otro mensajero, validar que existe\n                if ($rol === 'admin' && $mensajero_id !== $user_id) {\n                    $mensajero_valido = $wpdb->get_var(\n                        $wpdb->prepare(\n                            \"SELECT id FROM usuarios_gofast WHERE id = %d AND rol = 'mensajero' AND activo = 1\",\n                            $mensajero_id\n                        )\n                    );\n                    if (!$mensajero_valido) {\n                        $mensaje = 'El mensajero seleccionado no existe o est\u00e1 inactivo.';\n                        $mensaje_tipo = 'error';\n                    }\n                } else {\n                    \/\/ Mensajero crea para s\u00ed mismo\n                    $mensajero_id = $user_id;\n                }\n\n                if (empty($mensaje)) {\n                $insertado = $wpdb->insert(\n                    'compras_gofast',\n                    [\n                        'mensajero_id' => $mensajero_id,\n                        'valor' => $valor,\n                        'barrio_id' => $barrio_id,\n                        'estado' => 'pendiente',\n                        'creado_por' => $user_id,\n                        'observaciones' => null,\n                        'fecha_creacion' => gofast_date_mysql()\n                    ],\n                    ['%d', '%f', '%d', '%s', '%d', '%s', '%s']\n                );\n\n                    if ($insertado) {\n                        $mensaje = 'Compra creada correctamente.';\n                        $mensaje_tipo = 'success';\n                    } else {\n                        $mensaje = 'Error al crear la compra.';\n                        $mensaje_tipo = 'error';\n                    }\n                }\n            }\n        }\n    }\n\n    \/\/ 2. CAMBIAR ESTADO (Mensajero y Admin)\n    if (isset($_POST['gofast_cambiar_estado']) && wp_verify_nonce($_POST['gofast_estado_nonce'], 'gofast_cambiar_estado')) {\n        $compra_id = (int) $_POST['compra_id'];\n        $nuevo_estado = sanitize_text_field($_POST['nuevo_estado'] ?? '');\n\n        \/\/ Obtener la compra para validar permisos\n        $compra = $wpdb->get_row($wpdb->prepare(\"SELECT * FROM compras_gofast WHERE id = %d\", $compra_id));\n\n        if (!$compra) {\n            $mensaje = 'Compra no encontrada.';\n            $mensaje_tipo = 'error';\n        } else {\n            \/\/ Validar permisos\n            $puede_cambiar = false;\n            $estados_permitidos = [];\n\n            if ($rol === 'admin') {\n                \/\/ Admin puede cambiar a cualquier estado\n                $puede_cambiar = true;\n                $estados_permitidos = ['pendiente', 'en_proceso', 'completada', 'cancelada'];\n            } elseif ($rol === 'mensajero') {\n                \/\/ Mensajero solo puede cambiar estados de sus propias compras\n                if ((int) $compra->mensajero_id === $user_id) {\n                    $puede_cambiar = true;\n                    \/\/ Mensajero solo puede cambiar a: pendiente, en_proceso, completada (NO cancelada)\n                    $estados_permitidos = ['pendiente', 'en_proceso', 'completada'];\n                }\n            }\n\n            if (!$puede_cambiar) {\n                $mensaje = 'No tienes permisos para modificar esta compra.';\n                $mensaje_tipo = 'error';\n            } elseif (!in_array($nuevo_estado, $estados_permitidos, true)) {\n                $mensaje = 'Estado no permitido para tu rol.';\n                $mensaje_tipo = 'error';\n            } else {\n                $actualizado = $wpdb->update(\n                    'compras_gofast',\n                    [\n                        'estado' => $nuevo_estado,\n                        'fecha_actualizacion' => gofast_date_mysql()\n                    ],\n                    ['id' => $compra_id],\n                    ['%s', '%s'],\n                    ['%d']\n                );\n\n                if ($actualizado !== false) {\n                    $mensaje = 'Estado de la compra actualizado correctamente.';\n                    $mensaje_tipo = 'success';\n                } else {\n                    $mensaje = 'Error al actualizar el estado.';\n                    $mensaje_tipo = 'error';\n                }\n            }\n        }\n    }\n\n    \/\/ 3. EDITAR COMPRA (Solo Admin) - Modal unificado\n    if (isset($_POST['gofast_editar_compra']) && wp_verify_nonce($_POST['gofast_editar_compra_nonce'], 'gofast_editar_compra') && $rol === 'admin') {\n        $compra_id = (int) $_POST['compra_id'];\n        $nuevo_valor = isset($_POST['nuevo_valor']) ? floatval($_POST['nuevo_valor']) : 0;\n        $nuevo_barrio_id = isset($_POST['nuevo_barrio_id']) ? (int) $_POST['nuevo_barrio_id'] : 0;\n\n        \/\/ Validar que la compra existe\n        $compra_existe = $wpdb->get_var($wpdb->prepare(\"SELECT id FROM compras_gofast WHERE id = %d\", $compra_id));\n        \n        if (!$compra_existe) {\n            $mensaje = 'La compra no existe.';\n            $mensaje_tipo = 'error';\n        } elseif ($nuevo_valor < 6000 || $nuevo_valor > 20000) {\n            $mensaje = 'El valor debe estar entre 6000 y 20000.';\n            $mensaje_tipo = 'error';\n        } elseif ($nuevo_barrio_id <= 0) {\n            $mensaje = 'El destino es obligatorio.';\n            $mensaje_tipo = 'error';\n        } else {\n            \/\/ Validar que el barrio existe\n            $barrio_existe = $wpdb->get_var($wpdb->prepare(\"SELECT id FROM barrios WHERE id = %d\", $nuevo_barrio_id));\n            \n            if (!$barrio_existe) {\n                $mensaje = 'El destino seleccionado no existe.';\n                $mensaje_tipo = 'error';\n            } else {\n                $actualizado = $wpdb->update(\n                    'compras_gofast',\n                    [\n                        'valor' => $nuevo_valor,\n                        'barrio_id' => $nuevo_barrio_id,\n                        'fecha_actualizacion' => gofast_date_mysql()\n                    ],\n                    ['id' => $compra_id],\n                    ['%f', '%d', '%s'],\n                    ['%d']\n                );\n\n                if ($actualizado !== false) {\n                    $mensaje = 'Compra actualizada correctamente.';\n                    $mensaje_tipo = 'success';\n                } else {\n                    $mensaje = 'Error al actualizar la compra.';\n                    $mensaje_tipo = 'error';\n                }\n            }\n        }\n    }\n\n    \/\/ 4. EDITAR VALOR (Solo Admin) - Vista m\u00f3vil\n    if (isset($_POST['gofast_editar_valor']) && wp_verify_nonce($_POST['gofast_editar_valor_nonce'], 'gofast_editar_valor') && $rol === 'admin') {\n        $compra_id = (int) $_POST['compra_id'];\n        $nuevo_valor = isset($_POST['nuevo_valor']) ? floatval($_POST['nuevo_valor']) : 0;\n\n        \/\/ Validar que la compra existe\n        $compra_existe = $wpdb->get_var($wpdb->prepare(\"SELECT id FROM compras_gofast WHERE id = %d\", $compra_id));\n        \n        if (!$compra_existe) {\n            $mensaje = 'La compra no existe.';\n            $mensaje_tipo = 'error';\n        } elseif ($nuevo_valor < 6000 || $nuevo_valor > 20000) {\n            $mensaje = 'El valor debe estar entre 6000 y 20000.';\n            $mensaje_tipo = 'error';\n        } else {\n            $actualizado = $wpdb->update(\n                'compras_gofast',\n                [\n                    'valor' => $nuevo_valor,\n                    'fecha_actualizacion' => gofast_date_mysql()\n                ],\n                ['id' => $compra_id],\n                ['%f', '%s'],\n                ['%d']\n            );\n\n            if ($actualizado !== false) {\n                $mensaje = 'Valor de la compra actualizado correctamente.';\n                $mensaje_tipo = 'success';\n            } else {\n                $mensaje = 'Error al actualizar el valor.';\n                $mensaje_tipo = 'error';\n            }\n        }\n    }\n\n    \/\/ 5. CANCELAR COMPRA (Solo Admin)\n    if (isset($_POST['gofast_cancelar_compra']) && wp_verify_nonce($_POST['gofast_cancelar_compra_nonce'], 'gofast_cancelar_compra') && $rol === 'admin') {\n        $compra_id = (int) $_POST['compra_id'];\n\n        \/\/ Validar que la compra existe\n        $compra_existe = $wpdb->get_var($wpdb->prepare(\"SELECT id FROM compras_gofast WHERE id = %d\", $compra_id));\n        \n        if (!$compra_existe) {\n            $mensaje = 'La compra no existe.';\n            $mensaje_tipo = 'error';\n        } else {\n            $actualizado = $wpdb->update(\n                'compras_gofast',\n                [\n                    'estado' => 'cancelada',\n                    'fecha_actualizacion' => gofast_date_mysql()\n                ],\n                ['id' => $compra_id],\n                ['%s', '%s'],\n                ['%d']\n            );\n\n            if ($actualizado !== false) {\n                $mensaje = 'Compra cancelada correctamente.';\n                $mensaje_tipo = 'success';\n            } else {\n                $mensaje = 'Error al cancelar la compra.';\n                $mensaje_tipo = 'error';\n            }\n        }\n    }\n\n    \/\/ 6. ELIMINAR COMPRA (Solo Admin)\n    if (isset($_POST['gofast_eliminar_compra']) && wp_verify_nonce($_POST['gofast_eliminar_compra_nonce'], 'gofast_eliminar_compra') && $rol === 'admin') {\n        $compra_id = (int) $_POST['compra_id'];\n\n        \/\/ Validar que la compra existe\n        $compra_existe = $wpdb->get_var($wpdb->prepare(\"SELECT id FROM compras_gofast WHERE id = %d\", $compra_id));\n        \n        if (!$compra_existe) {\n            $mensaje = 'La compra no existe.';\n            $mensaje_tipo = 'error';\n        } else {\n            $eliminado = $wpdb->delete('compras_gofast', ['id' => $compra_id], ['%d']);\n\n            if ($eliminado) {\n                $mensaje = 'Compra eliminada correctamente.';\n                $mensaje_tipo = 'success';\n            } else {\n                $mensaje = 'Error al eliminar la compra.';\n                $mensaje_tipo = 'error';\n            }\n        }\n    }\n\n    \/*********************************************\n     * FILTROS\n     *********************************************\/\n\n    \/\/ Filtros desde URL o POST\n    $fecha_desde = isset($_GET['fecha_desde']) ? sanitize_text_field($_GET['fecha_desde']) : '';\n    $fecha_hasta = isset($_GET['fecha_hasta']) ? sanitize_text_field($_GET['fecha_hasta']) : '';\n    $valor_min = isset($_GET['valor_min']) ? floatval($_GET['valor_min']) : 0;\n    $valor_max = isset($_GET['valor_max']) ? floatval($_GET['valor_max']) : 0;\n    $estado_filtro = isset($_GET['estado']) ? sanitize_text_field($_GET['estado']) : '';\n\n    \/\/ Valores por defecto seg\u00fan rol\n    if (empty($_GET['fecha_desde']) && empty($_GET['fecha_hasta']) && empty($_GET['estado'])) {\n        if ($rol === 'admin') {\n            \/\/ Admin: mostrar pendientes por defecto\n            $estado_filtro = 'pendiente';\n        } else {\n            \/\/ Mensajero: mostrar d\u00eda actual por defecto (zona horaria Colombia)\n            $fecha_desde = gofast_date_today();\n            $fecha_hasta = gofast_date_today();\n        }\n    }\n\n    \/*********************************************\n     * OBTENER DATOS PARA MOSTRAR\n     *********************************************\/\n\n    \/\/ Lista de mensajeros (solo para admin al crear)\n    $mensajeros = [];\n    if ($rol === 'admin') {\n        $mensajeros = $wpdb->get_results(\n            \"SELECT id, nombre, telefono \n             FROM usuarios_gofast \n             WHERE rol = 'mensajero' AND activo = 1 \n             ORDER BY nombre ASC\"\n        );\n    }\n\n    \/*******************************************************\n     * OBTENER BARRIOS CON PRIORIZACI\u00d3N DE BARRIOS FRECUENTES\n     * (Igual que el cotizador, sin agrupaci\u00f3n por sectores)\n     *******************************************************\/\n    \n    \/\/ 1. Obtener barrios frecuentes del mensajero (si es mensajero)\n    $barrios_prioritarios = [];\n    if ($rol === 'mensajero') {\n        $barrios_frecuentes = $wpdb->get_results($wpdb->prepare(\n            \"SELECT barrio_id, COUNT(*) as veces\n             FROM compras_gofast\n             WHERE mensajero_id = %d\n             GROUP BY barrio_id\n             ORDER BY veces DESC\n             LIMIT 10\",\n            $user_id\n        ));\n        foreach ($barrios_frecuentes as $bf) {\n            $barrios_prioritarios[] = (int) $bf->barrio_id;\n        }\n    }\n    \n    \/\/ 2. Obtener todos los barrios\n    $barrios_all = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n    $barrios = [];\n    \n    \/\/ Asegurar que siempre haya barrios (incluso si la consulta falla, usar array vac\u00edo)\n    if (!$barrios_all) {\n        $barrios_all = [];\n    }\n    \n    \/\/ Primero los barrios prioritarios\n    foreach ($barrios_all as $b) {\n        if (in_array($b->id, $barrios_prioritarios, true)) {\n            $barrios[] = $b;\n        }\n    }\n    \/\/ Luego los dem\u00e1s\n    foreach ($barrios_all as $b) {\n        if (!in_array($b->id, $barrios_prioritarios, true)) {\n            $barrios[] = $b;\n        }\n    }\n    \n    \/\/ Si no hay barrios prioritarios, usar todos los barrios directamente\n    if (empty($barrios_prioritarios) && !empty($barrios_all)) {\n        $barrios = $barrios_all;\n    }\n\n    \/\/ Construir consulta con filtros\n    $where_parts = [];\n    $where_values = [];\n\n    \/\/ Filtro por rol\n    if ($rol === 'mensajero') {\n        $where_parts[] = \"c.mensajero_id = %d\";\n        $where_values[] = $user_id;\n    }\n\n    \/\/ Filtro por fecha\n    if (!empty($fecha_desde)) {\n        $where_parts[] = \"DATE(c.fecha_creacion) >= %s\";\n        $where_values[] = $fecha_desde;\n    }\n    if (!empty($fecha_hasta)) {\n        $where_parts[] = \"DATE(c.fecha_creacion) <= %s\";\n        $where_values[] = $fecha_hasta;\n    }\n\n    \/\/ Filtro por valor\n    if ($valor_min > 0) {\n        $where_parts[] = \"c.valor >= %f\";\n        $where_values[] = $valor_min;\n    }\n    if ($valor_max > 0) {\n        $where_parts[] = \"c.valor <= %f\";\n        $where_values[] = $valor_max;\n    }\n\n    \/\/ Filtro por estado\n    if (!empty($estado_filtro) && in_array($estado_filtro, ['pendiente', 'en_proceso', 'completada', 'cancelada'])) {\n        $where_parts[] = \"c.estado = %s\";\n        $where_values[] = $estado_filtro;\n    }\n\n    \/\/ Construir consulta SQL\n    $sql = \"SELECT c.*, \n                   m.nombre as mensajero_nombre, \n                   m.telefono as mensajero_telefono,\n                   u.nombre as creador_nombre,\n                   b.nombre as barrio_nombre\n            FROM compras_gofast c\n            LEFT JOIN usuarios_gofast m ON c.mensajero_id = m.id\n            LEFT JOIN usuarios_gofast u ON c.creado_por = u.id\n            LEFT JOIN barrios b ON c.barrio_id = b.id\";\n    \n    if (!empty($where_parts)) {\n        $sql .= \" WHERE \" . implode(' AND ', $where_parts);\n    }\n    \n    $sql .= \" ORDER BY c.fecha_creacion DESC\";\n\n    \/\/ Ejecutar consulta con prepared statement\n    if (!empty($where_values)) {\n        $compras = $wpdb->get_results($wpdb->prepare($sql, $where_values));\n    } else {\n        $compras = $wpdb->get_results($sql);\n    }\n\n    \/\/ Contar total sin filtros (para estad\u00edsticas)\n    $total_sin_filtros = 0;\n    if ($rol === 'admin') {\n        $total_sin_filtros = (int) $wpdb->get_var(\"SELECT COUNT(*) FROM compras_gofast\");\n    } else {\n        $total_sin_filtros = (int) $wpdb->get_var($wpdb->prepare(\n            \"SELECT COUNT(*) FROM compras_gofast WHERE mensajero_id = %d\",\n            $user_id\n        ));\n    }\n\n    \/\/ Estad\u00edsticas (solo para admin)\n    $stats = null;\n    if ($rol === 'admin') {\n        $stats = [\n            'total' => (int) $wpdb->get_var(\"SELECT COUNT(*) FROM compras_gofast\"),\n            'pendientes' => (int) $wpdb->get_var(\"SELECT COUNT(*) FROM compras_gofast WHERE estado = 'pendiente'\"),\n            'en_proceso' => (int) $wpdb->get_var(\"SELECT COUNT(*) FROM compras_gofast WHERE estado = 'en_proceso'\"),\n            'completadas' => (int) $wpdb->get_var(\"SELECT COUNT(*) FROM compras_gofast WHERE estado = 'completada'\"),\n            'canceladas' => (int) $wpdb->get_var(\"SELECT COUNT(*) FROM compras_gofast WHERE estado = 'cancelada'\"),\n            'total_valor_pendiente' => (float) $wpdb->get_var(\"SELECT SUM(valor) FROM compras_gofast WHERE estado = 'pendiente'\"),\n            'total_valor_completada' => (float) $wpdb->get_var(\"SELECT SUM(valor) FROM compras_gofast WHERE estado = 'completada'\")\n        ];\n    }\n\n    ob_start();\n    ?>\n\n<div class=\"gofast-home\">\n    <?php if ($rol === 'admin'): ?>\n        <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;\">\n            <div>\n                <h1 style=\"margin-bottom:8px;\">\ud83d\uded2 Compras<\/h1>\n                <p class=\"gofast-home-text\" style=\"margin:0;\">\n                    Gestiona las compras de los mensajeros.\n                <\/p>\n            <\/div>\n            <a href=\"<?php echo esc_url( home_url('\/dashboard-admin') ); ?>\" class=\"gofast-btn-request\" style=\"text-decoration:none;white-space:nowrap;\">\n                \u2190 Volver al Dashboard\n            <\/a>\n        <\/div>\n    <?php endif; ?>\n    \n    <!-- Mensaje de resultado -->\n    <?php if ($mensaje): ?>\n        <div class=\"gofast-box\" style=\"background: <?= $mensaje_tipo === 'success' ? '#d4edda' : '#f8d7da' ?>; border-left: 4px solid <?= $mensaje_tipo === 'success' ? '#28a745' : '#dc3545' ?>; color: <?= $mensaje_tipo === 'success' ? '#155724' : '#721c24' ?>; margin-bottom: 20px;\">\n            <?= esc_html($mensaje) ?>\n        <\/div>\n    <?php endif; ?>\n\n    <!-- Estad\u00edsticas (Solo Admin) -->\n    <?php if ($rol === 'admin' && $stats): ?>\n        <div class=\"gofast-box\" style=\"margin-bottom: 20px;\">\n            <h3>\ud83d\udcca Estad\u00edsticas de Compras<\/h3>\n            <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-top: 15px;\">\n                <div style=\"text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;\">\n                    <div style=\"font-size: 24px; font-weight: 700; color: #333;\"><?= $stats['total'] ?><\/div>\n                    <div style=\"font-size: 13px; color: #666;\">Total<\/div>\n                <\/div>\n                <div style=\"text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px;\">\n                    <div style=\"font-size: 24px; font-weight: 700; color: #856404;\"><?= $stats['pendientes'] ?><\/div>\n                    <div style=\"font-size: 13px; color: #666;\">Pendientes<\/div>\n                <\/div>\n                <div style=\"text-align: center; padding: 15px; background: #cfe2ff; border-radius: 8px;\">\n                    <div style=\"font-size: 24px; font-weight: 700; color: #084298;\"><?= $stats['en_proceso'] ?><\/div>\n                    <div style=\"font-size: 13px; color: #666;\">En Proceso<\/div>\n                <\/div>\n                <div style=\"text-align: center; padding: 15px; background: #d4edda; border-radius: 8px;\">\n                    <div style=\"font-size: 24px; font-weight: 700; color: #155724;\"><?= $stats['completadas'] ?><\/div>\n                    <div style=\"font-size: 13px; color: #666;\">Completadas<\/div>\n                <\/div>\n                <div style=\"text-align: center; padding: 15px; background: #f8d7da; border-radius: 8px;\">\n                    <div style=\"font-size: 24px; font-weight: 700; color: #721c24;\"><?= $stats['canceladas'] ?><\/div>\n                    <div style=\"font-size: 13px; color: #666;\">Canceladas<\/div>\n                <\/div>\n            <\/div>\n            <?php if ($stats['total_valor_pendiente'] > 0 || $stats['total_valor_completada'] > 0): ?>\n                <div style=\"margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;\">\n                    <div style=\"display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;\">\n                        <div>\n                            <strong>Pendiente:<\/strong> $<?= number_format($stats['total_valor_pendiente'], 0, ',', '.') ?>\n                        <\/div>\n                        <div>\n                            <strong>Completada:<\/strong> $<?= number_format($stats['total_valor_completada'], 0, ',', '.') ?>\n                        <\/div>\n                    <\/div>\n                <\/div>\n            <?php endif; ?>\n        <\/div>\n    <?php endif; ?>\n\n    <!-- Formulario para crear compra -->\n    <div class=\"gofast-box\" style=\"margin-bottom: 20px;\">\n        <h3>\ud83d\uded2 Crear Compra<\/h3>\n        \n        <form method=\"post\" id=\"form-crear-compra\">\n            <?php wp_nonce_field('gofast_crear_compra', 'gofast_compra_nonce'); ?>\n            \n            <?php if ($rol === 'admin'): ?>\n                <label><strong>Mensajero<\/strong> <span style=\"color: #dc3545;\">*<\/span><\/label>\n                <select name=\"mensajero_id\" class=\"gofast-select\" id=\"mensajero-select\" required>\n                    <option value=\"\">\u2014 Selecciona mensajero \u2014<\/option>\n                    <?php foreach ($mensajeros as $m): ?>\n                        <option value=\"<?= esc_attr($m->id) ?>\">\n                            <?= esc_html($m->nombre) ?> \u2014 <?= esc_html($m->telefono) ?>\n                        <\/option>\n                    <?php endforeach; ?>\n                <\/select>\n            <?php else: ?>\n                <div style=\"background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 16px;\">\n                    <strong>Mensajero:<\/strong> <?= esc_html($usuario->nombre) ?>\n                <\/div>\n            <?php endif; ?>\n\n            <label><strong>Valor de la compra<\/strong><\/label>\n            <input type=\"number\" \n                   name=\"valor\" \n                   id=\"valor-compra\"\n                   step=\"1\" \n                   min=\"6000\" \n                   max=\"20000\"\n                   required \n                   placeholder=\"Ej: 10000\"\n                   style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin-bottom: 16px;\">\n\n            <label><strong>Destino<\/strong><\/label>\n            <select name=\"barrio_id\" class=\"gofast-select\" id=\"destino-compra\" required>\n                <option value=\"\">Buscar destino...<\/option>\n                <?php if (!empty($barrios)): ?>\n                    <?php foreach ($barrios as $b): ?>\n                        <option value=\"<?= esc_attr($b->id) ?>\">\n                            <?= esc_html($b->nombre) ?>\n                        <\/option>\n                    <?php endforeach; ?>\n                <?php else: ?>\n                    <!-- Fallback: mostrar todos los barrios directamente si $barrios est\u00e1 vac\u00edo -->\n                    <?php \n                    $barrios_fallback = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n                    if (!empty($barrios_fallback)): \n                    ?>\n                        <?php foreach ($barrios_fallback as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\">\n                                <?= esc_html($b->nombre) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <?php endif; ?>\n                <?php endif; ?>\n            <\/select>\n\n            <div class=\"gofast-btn-group\" style=\"margin-top: 20px;\">\n                <button type=\"submit\" name=\"gofast_crear_compra\" class=\"gofast-submit\">\n                    \u2705 Crear Compra\n                <\/button>\n            <\/div>\n        <\/form>\n    <\/div>\n\n    <!-- Filtros -->\n    <div class=\"gofast-box\" style=\"margin-bottom: 20px;\">\n        <h3>\ud83d\udd0d Filtros<\/h3>\n        <form method=\"get\" action=\"\" class=\"gofast-filtros-form\">\n            <!-- Mantener otros par\u00e1metros GET si existen -->\n            <?php foreach ($_GET as $key => $value): ?>\n                <?php if (!in_array($key, ['fecha_desde', 'fecha_hasta', 'valor_min', 'valor_max', 'estado'])): ?>\n                    <input type=\"hidden\" name=\"<?= esc_attr($key) ?>\" value=\"<?= esc_attr($value) ?>\">\n                <?php endif; ?>\n            <?php endforeach; ?>\n            \n            <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;\">\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Fecha desde<\/label>\n                    <input type=\"date\" \n                           name=\"fecha_desde\" \n                           value=\"<?= esc_attr($fecha_desde) ?>\"\n                           style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                <\/div>\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Fecha hasta<\/label>\n                    <input type=\"date\" \n                           name=\"fecha_hasta\" \n                           value=\"<?= esc_attr($fecha_hasta) ?>\"\n                           style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                <\/div>\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Valor m\u00ednimo<\/label>\n                    <input type=\"number\" \n                           name=\"valor_min\" \n                           value=\"<?= $valor_min > 0 ? esc_attr($valor_min) : '' ?>\"\n                           step=\"0.01\"\n                           min=\"0\"\n                           placeholder=\"Ej: 10000\"\n                           style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                <\/div>\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Valor m\u00e1ximo<\/label>\n                    <input type=\"number\" \n                           name=\"valor_max\" \n                           value=\"<?= $valor_max > 0 ? esc_attr($valor_max) : '' ?>\"\n                           step=\"0.01\"\n                           min=\"0\"\n                           placeholder=\"Ej: 100000\"\n                           style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                <\/div>\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Estado<\/label>\n                    <select name=\"estado\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                        <option value=\"\">Todos<\/option>\n                        <option value=\"pendiente\" <?= $estado_filtro === 'pendiente' ? 'selected' : '' ?>>\u23f3 Pendiente<\/option>\n                        <option value=\"en_proceso\" <?= $estado_filtro === 'en_proceso' ? 'selected' : '' ?>>\ud83d\udd04 En Proceso<\/option>\n                        <option value=\"completada\" <?= $estado_filtro === 'completada' ? 'selected' : '' ?>>\u2705 Completada<\/option>\n                        <option value=\"cancelada\" <?= $estado_filtro === 'cancelada' ? 'selected' : '' ?>>\u274c Cancelada<\/option>\n                    <\/select>\n                <\/div>\n            <\/div>\n            \n            <div style=\"display: flex; gap: 10px; flex-wrap: wrap;\">\n                <button type=\"submit\" class=\"gofast-btn\" style=\"background: var(--gofast-yellow); flex: 1; min-width: 120px;\">\n                    \ud83d\udd0d Filtrar\n                <\/button>\n                <?php\n                \/\/ Construir URL sin los par\u00e1metros de filtro\n                $clean_url = remove_query_arg(['fecha_desde', 'fecha_hasta', 'valor_min', 'valor_max', 'estado']);\n                if (empty($clean_url) || $clean_url === home_url('\/')) {\n                    $clean_url = home_url('\/compras');\n                }\n                ?>\n                <a href=\"<?= esc_url($clean_url) ?>\" \n                   class=\"gofast-btn gofast-secondary\" \n                   style=\"flex: 1; min-width: 120px; text-align: center; text-decoration: none; display: inline-block;\">\n                    \ud83d\udd04 Limpiar\n                <\/a>\n            <\/div>\n        <\/form>\n        \n        <?php if (!empty($compras) || !empty($fecha_desde) || !empty($fecha_hasta) || $valor_min > 0 || $valor_max > 0 || !empty($estado_filtro)): ?>\n            <div style=\"margin-top: 12px; padding: 10px; background: #e7f3ff; border-radius: 6px; font-size: 13px;\">\n                <strong>Resultados:<\/strong> \n                <?= count($compras) ?> compra(s) encontrada(s)\n                <?php if (isset($total_sin_filtros) && $total_sin_filtros > count($compras)): ?>\n                    (de <?= $total_sin_filtros ?> total)\n                <?php endif; ?>\n            <\/div>\n        <?php endif; ?>\n    <\/div>\n\n    <!-- Listado de compras -->\n    <div class=\"gofast-box\">\n        <h3><?= $rol === 'admin' ? '\ud83d\udccb Todas las Compras' : '\ud83d\udccb Mis Compras' ?><\/h3>\n        \n        <?php if (empty($compras)): ?>\n            <p style=\"text-align: center; color: #666; padding: 20px;\">\n                No hay compras registradas.\n            <\/p>\n        <?php else: ?>\n            <!-- Vista Desktop: Tabla -->\n            <div class=\"gofast-compras-table-wrapper gofast-compras-desktop\">\n                <div class=\"gofast-table-wrap\">\n                    <table class=\"gofast-table gofast-compras-table\">\n                    <thead>\n                        <tr>\n                            <th>ID<\/th>\n                            <th>Fecha<\/th>\n                            <?php if ($rol === 'admin'): ?>\n                                <th>Mensajero<\/th>\n                                <th>Creado por<\/th>\n                            <?php endif; ?>\n                            <th>Valor<\/th>\n                            <th>Destino<\/th>\n                            <th>Estado<\/th>\n                            <?php if ($rol === 'admin'): ?>\n                                <th>Acciones<\/th>\n                            <?php endif; ?>\n                        <\/tr>\n                    <\/thead>\n                    <tbody>\n                        <?php foreach ($compras as $c): ?>\n                            <tr>\n                                <td>#<?= esc_html($c->id) ?><\/td>\n                                <td><?= gofast_date_format($c->fecha_creacion, 'd\/m\/Y H:i') ?><\/td>\n                                <?php if ($rol === 'admin'): ?>\n                                    <td>\n                                        <?= esc_html($c->mensajero_nombre) ?><br>\n                                        <small style=\"color: #666;\"><?= esc_html($c->mensajero_telefono) ?><\/small>\n                                    <\/td>\n                                    <td><?= esc_html($c->creador_nombre) ?><\/td>\n                                <?php endif; ?>\n                                <td>\n                                    <strong>$<?= number_format($c->valor, 0, ',', '.') ?><\/strong>\n                                <\/td>\n                                <td>\n                                    <?= esc_html($c->barrio_nombre ?? 'N\/A') ?>\n                                <\/td>\n                                <td>\n                                    <?php\n                                    $estado_class = '';\n                                    $estado_text = '';\n                                    switch ($c->estado) {\n                                        case 'pendiente':\n                                            $estado_class = 'gofast-badge-estado-pendiente';\n                                            $estado_text = '\u23f3 Pendiente';\n                                            break;\n                                        case 'en_proceso':\n                                            $estado_class = 'gofast-badge-estado-en-ruta';\n                                            $estado_text = '\ud83d\udd04 En Proceso';\n                                            break;\n                                        case 'completada':\n                                            $estado_class = 'gofast-badge-estado-entregado';\n                                            $estado_text = '\u2705 Completada';\n                                            break;\n                                        case 'cancelada':\n                                            $estado_class = 'gofast-badge-estado-cancelado';\n                                            $estado_text = '\u274c Cancelada';\n                                            break;\n                                    }\n                                    \n                                    \/\/ Mostrar select de estado si es admin o mensajero (solo sus compras)\n                                    $puede_cambiar_estado = false;\n                                    if ($rol === 'admin') {\n                                        $puede_cambiar_estado = true;\n                                    } elseif ($rol === 'mensajero' && (int) $c->mensajero_id === $user_id) {\n                                        $puede_cambiar_estado = true;\n                                    }\n                                    ?>\n                                    \n                                    <?php if ($puede_cambiar_estado): ?>\n                                        <form method=\"post\" style=\"display: inline-block;\" class=\"gofast-estado-form\">\n                                            <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                            <input type=\"hidden\" name=\"gofast_cambiar_estado\" value=\"1\">\n                                            <input type=\"hidden\" name=\"compra_id\" value=\"<?= esc_attr($c->id) ?>\">\n                                            <select name=\"nuevo_estado\" \n                                                    onchange=\"this.form.submit();\"\n                                                    style=\"padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; cursor: pointer;\">\n                                                <option value=\"pendiente\" <?= $c->estado === 'pendiente' ? 'selected' : '' ?>>\u23f3 Pendiente<\/option>\n                                                <option value=\"en_proceso\" <?= $c->estado === 'en_proceso' ? 'selected' : '' ?>>\ud83d\udd04 En Proceso<\/option>\n                                                <option value=\"completada\" <?= $c->estado === 'completada' ? 'selected' : '' ?>>\u2705 Completada<\/option>\n                                                <?php if ($rol === 'admin'): ?>\n                                                    <option value=\"cancelada\" <?= $c->estado === 'cancelada' ? 'selected' : '' ?>>\u274c Cancelada<\/option>\n                                                <?php endif; ?>\n                                            <\/select>\n                                        <\/form>\n                                    <?php else: ?>\n                                        <span class=\"gofast-badge-estado <?= $estado_class ?>\">\n                                            <?= $estado_text ?>\n                                        <\/span>\n                                    <?php endif; ?>\n                                <\/td>\n                                <?php if ($rol === 'admin'): ?>\n                                    <td style=\"white-space:nowrap;\">\n                                        <button type=\"button\" \n                                                class=\"gofast-btn-mini gofast-btn-editar-compra\" \n                                                data-compra-id=\"<?= esc_attr($c->id) ?>\"\n                                                data-compra-valor=\"<?= esc_attr($c->valor) ?>\"\n                                                data-compra-barrio-id=\"<?= esc_attr($c->barrio_id) ?>\"\n                                                data-compra-barrio-nombre=\"<?= esc_attr($c->barrio_nombre ?? 'N\/A') ?>\"\n                                                data-compra-mensajero=\"<?= esc_attr($c->mensajero_nombre) ?>\"\n                                                data-compra-fecha=\"<?= esc_attr(gofast_date_format($c->fecha_creacion, 'd\/m\/Y H:i')) ?>\"\n                                                data-compra-estado=\"<?= esc_attr($c->estado) ?>\">\n                                            \u270f\ufe0f Editar\n                                        <\/button>\n                                        <form method=\"post\" style=\"display:inline-block;margin-left:4px;\" onsubmit=\"return confirm('\u00bfEst\u00e1s seguro de eliminar esta compra? Esta acci\u00f3n no se puede deshacer.');\">\n                                            <?php wp_nonce_field('gofast_eliminar_compra', 'gofast_eliminar_compra_nonce'); ?>\n                                            <input type=\"hidden\" name=\"gofast_eliminar_compra\" value=\"1\">\n                                            <input type=\"hidden\" name=\"compra_id\" value=\"<?= esc_attr($c->id) ?>\">\n                                            <button type=\"submit\" class=\"gofast-btn-mini\" style=\"background:#dc3545;color:#fff;\">\n                                                \ud83d\uddd1\ufe0f Eliminar\n                                            <\/button>\n                                        <\/form>\n                                    <\/td>\n                                <?php endif; ?>\n                            <\/tr>\n                        <?php endforeach; ?>\n                    <\/tbody>\n                <\/table>\n                <\/div>\n            <\/div>\n\n            <!-- Vista M\u00f3vil: Cards -->\n            <div class=\"gofast-compras-cards gofast-compras-mobile\">\n                <?php foreach ($compras as $c): ?>\n                    <?php\n                    $estado_class = '';\n                    $estado_text = '';\n                    $estado_color = '';\n                    switch ($c->estado) {\n                        case 'pendiente':\n                            $estado_class = 'gofast-badge-estado-pendiente';\n                            $estado_text = '\u23f3 Pendiente';\n                            $estado_color = '#fff3cd';\n                            break;\n                        case 'en_proceso':\n                            $estado_class = 'gofast-badge-estado-en-ruta';\n                            $estado_text = '\ud83d\udd04 En Proceso';\n                            $estado_color = '#cfe2ff';\n                            break;\n                        case 'completada':\n                            $estado_class = 'gofast-badge-estado-entregado';\n                            $estado_text = '\u2705 Completada';\n                            $estado_color = '#d4edda';\n                            break;\n                        case 'cancelada':\n                            $estado_class = 'gofast-badge-estado-cancelado';\n                            $estado_text = '\u274c Cancelada';\n                            $estado_color = '#f8d7da';\n                            break;\n                    }\n                    ?>\n                    <div class=\"gofast-compra-card\" style=\"background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid <?= $estado_color ?>;\">\n                        <div style=\"display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;\">\n                            <div>\n                                <div style=\"font-size: 12px; color: #666; margin-bottom: 4px;\">ID: #<?= esc_html($c->id) ?><\/div>\n                                <div style=\"font-size: 11px; color: #999;\"><?= gofast_date_format($c->fecha_creacion, 'd\/m\/Y H:i') ?><\/div>\n                            <\/div>\n                            <span class=\"gofast-badge-estado <?= $estado_class ?>\" style=\"font-size: 12px; padding: 4px 10px;\">\n                                <?= $estado_text ?>\n                            <\/span>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px;\">\n            <?php if ($rol === 'admin'): ?>\n                <!-- Admin puede editar valor -->\n                <label style=\"display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px;\">Valor:<\/label>\n                <form method=\"post\">\n                    <?php wp_nonce_field('gofast_editar_valor', 'gofast_editar_valor_nonce'); ?>\n                    <input type=\"hidden\" name=\"gofast_editar_valor\" value=\"1\">\n                    <input type=\"hidden\" name=\"compra_id\" value=\"<?= esc_attr($c->id) ?>\">\n                    <input type=\"number\" \n                           name=\"nuevo_valor\" \n                           value=\"<?= esc_attr($c->valor) ?>\"\n                           step=\"1\"\n                           min=\"6000\"\n                           max=\"20000\"\n                           style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; font-weight: 700;\"\n                           onchange=\"if(confirm('\u00bfActualizar valor de esta compra?')) this.form.submit();\">\n                <\/form>\n            <?php else: ?>\n                                <div style=\"font-size: 24px; font-weight: 700; color: #000;\">\n                                    $<?= number_format($c->valor, 0, ',', '.') ?>\n                                <\/div>\n                            <?php endif; ?>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                            <div style=\"font-size: 13px; color: #666; margin-bottom: 4px;\">Destino:<\/div>\n                            <div style=\"font-size: 14px; font-weight: 600; color: #000;\">\n                                <?= esc_html($c->barrio_nombre ?? 'N\/A') ?>\n                            <\/div>\n                        <\/div>\n\n                        <?php if ($rol === 'admin'): ?>\n                            <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                                <div style=\"font-size: 13px; color: #666; margin-bottom: 4px;\">Mensajero:<\/div>\n                                <div style=\"font-size: 14px; font-weight: 600; color: #000;\">\n                                    <?= esc_html($c->mensajero_nombre) ?>\n                                <\/div>\n                                <div style=\"font-size: 12px; color: #666; margin-top: 2px;\">\n                                    <?= esc_html($c->mensajero_telefono) ?>\n                                <\/div>\n                            <\/div>\n                            <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                                <div style=\"font-size: 13px; color: #666; margin-bottom: 4px;\">Creado por:<\/div>\n                                <div style=\"font-size: 14px; font-weight: 600; color: #000;\">\n                                    <?= esc_html($c->creador_nombre) ?>\n                                <\/div>\n                            <\/div>\n                            \n                            <!-- Cambiar estado -->\n                            <form method=\"post\" style=\"margin-top: 12px; margin-bottom: 12px;\" class=\"gofast-estado-form\">\n                                <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                <input type=\"hidden\" name=\"gofast_cambiar_estado\" value=\"1\">\n                                <input type=\"hidden\" name=\"compra_id\" value=\"<?= esc_attr($c->id) ?>\">\n                                <label style=\"display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px;\">Cambiar estado:<\/label>\n                                <select name=\"nuevo_estado\" \n                                        onchange=\"this.form.submit();\"\n                                        style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer;\">\n                                    <option value=\"pendiente\" <?= $c->estado === 'pendiente' ? 'selected' : '' ?>>\u23f3 Pendiente<\/option>\n                                    <option value=\"en_proceso\" <?= $c->estado === 'en_proceso' ? 'selected' : '' ?>>\ud83d\udd04 En Proceso<\/option>\n                                    <option value=\"completada\" <?= $c->estado === 'completada' ? 'selected' : '' ?>>\u2705 Completada<\/option>\n                                    <option value=\"cancelada\" <?= $c->estado === 'cancelada' ? 'selected' : '' ?>>\u274c Cancelada<\/option>\n                                <\/select>\n                            <\/form>\n                            \n                            <!-- Botones de acci\u00f3n -->\n                            <div style=\"display: flex; gap: 8px; margin-top: 12px;\">\n                                <button type=\"button\" \n                                        class=\"gofast-btn-mini gofast-btn-editar-compra\" \n                                        data-compra-id=\"<?= esc_attr($c->id) ?>\"\n                                        data-compra-valor=\"<?= esc_attr($c->valor) ?>\"\n                                        data-compra-barrio-id=\"<?= esc_attr($c->barrio_id) ?>\"\n                                        data-compra-barrio-nombre=\"<?= esc_attr($c->barrio_nombre ?? 'N\/A') ?>\"\n                                        data-compra-mensajero=\"<?= esc_attr($c->mensajero_nombre) ?>\"\n                                        data-compra-fecha=\"<?= esc_attr(gofast_date_format($c->fecha_creacion, 'd\/m\/Y H:i')) ?>\"\n                                        data-compra-estado=\"<?= esc_attr($c->estado) ?>\"\n                                        style=\"flex: 1; padding: 10px; background: var(--gofast-yellow); color: #000; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;\">\n                                    \u270f\ufe0f Editar\n                                <\/button>\n                                \n                                <form method=\"post\" style=\"flex: 1;\" onsubmit=\"return confirm('\u00bfEst\u00e1s seguro de eliminar esta compra? Esta acci\u00f3n no se puede deshacer.');\">\n                                    <?php wp_nonce_field('gofast_eliminar_compra', 'gofast_eliminar_compra_nonce'); ?>\n                                    <input type=\"hidden\" name=\"gofast_eliminar_compra\" value=\"1\">\n                                    <input type=\"hidden\" name=\"compra_id\" value=\"<?= esc_attr($c->id) ?>\">\n                                    <button type=\"submit\" \n                                            style=\"width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;\">\n                                        \ud83d\uddd1\ufe0f Eliminar\n                                    <\/button>\n                                <\/form>\n                            <\/div>\n                        <?php else: ?>\n                            <!-- Mensajero: solo puede cambiar estado de sus compras -->\n                            <?php if ((int) $c->mensajero_id === $user_id): ?>\n                                <form method=\"post\" style=\"margin-top: 12px;\" class=\"gofast-estado-form\">\n                                    <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                    <input type=\"hidden\" name=\"gofast_cambiar_estado\" value=\"1\">\n                                    <input type=\"hidden\" name=\"compra_id\" value=\"<?= esc_attr($c->id) ?>\">\n                                    <label style=\"display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px;\">Cambiar estado:<\/label>\n                                    <select name=\"nuevo_estado\" \n                                            onchange=\"this.form.submit();\"\n                                            style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer;\">\n                                        <option value=\"pendiente\" <?= $c->estado === 'pendiente' ? 'selected' : '' ?>>\u23f3 Pendiente<\/option>\n                                        <option value=\"en_proceso\" <?= $c->estado === 'en_proceso' ? 'selected' : '' ?>>\ud83d\udd04 En Proceso<\/option>\n                                        <option value=\"completada\" <?= $c->estado === 'completada' ? 'selected' : '' ?>>\u2705 Completada<\/option>\n                                    <\/select>\n                                <\/form>\n                            <?php endif; ?>\n                        <?php endif; ?>\n                    <\/div>\n                <?php endforeach; ?>\n            <\/div>\n        <?php endif; ?>\n    <\/div>\n\n<\/div>\n\n<?php if ($rol === 'admin'): ?>\n<!-- Modal para editar compra -->\n<div id=\"modal-editar-compra\" style=\"display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;overflow-y:auto;padding:20px;\">\n    <div style=\"max-width:600px;margin:20px auto;background:#fff;border-radius:8px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,0.3);\">\n        <h2 style=\"margin-top:0;margin-bottom:12px;font-size:20px;\">\u270f\ufe0f Editar Compra<\/h2>\n        \n        <!-- Informaci\u00f3n de la compra -->\n        <div id=\"compra-info\" style=\"background:#f8f9fa;border-left:4px solid var(--gofast-yellow);padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;\">\n            <div style=\"display:grid;grid-template-columns:auto 1fr;gap:8px 12px;align-items:start;\">\n                <strong style=\"color:#666;\">Compra #:<\/strong>\n                <span id=\"info-compra-id\" style=\"font-weight:600;color:#000;\"><\/span>\n                \n                <strong style=\"color:#666;\">Mensajero:<\/strong>\n                <span id=\"info-mensajero\" style=\"font-weight:600;color:#000;\"><\/span>\n                \n                <strong style=\"color:#666;\">Fecha:<\/strong>\n                <span id=\"info-fecha\" style=\"color:#000;\"><\/span>\n                \n                <strong style=\"color:#666;\">Estado:<\/strong>\n                <span id=\"info-estado\" style=\"font-weight:600;color:#000;\"><\/span>\n            <\/div>\n        <\/div>\n        \n        <form method=\"post\" id=\"form-editar-compra\" action=\"\">\n            <?php wp_nonce_field('gofast_editar_compra', 'gofast_editar_compra_nonce'); ?>\n            <input type=\"hidden\" name=\"gofast_editar_compra\" value=\"1\">\n            <input type=\"hidden\" name=\"compra_id\" id=\"editar-compra-id\">\n            \n            <div style=\"margin-bottom:16px;\">\n                <label style=\"display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:#000;\">Valor de la compra:<\/label>\n                <input type=\"number\" \n                       name=\"nuevo_valor\" \n                       id=\"editar-compra-valor\"\n                       step=\"1\"\n                       min=\"6000\"\n                       max=\"20000\"\n                       required\n                       style=\"width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:16px;\">\n            <\/div>\n            \n            <div style=\"margin-bottom:16px;\">\n                <label style=\"display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:#000;\">Destino:<\/label>\n                <select name=\"nuevo_barrio_id\" \n                        id=\"editar-compra-barrio\"\n                        class=\"gofast-select\" \n                        required>\n                    <option value=\"\">Buscar destino...<\/option>\n                    <?php if (!empty($barrios)): ?>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\">\n                                <?= esc_html($b->nombre) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <?php else: ?>\n                        <!-- Fallback: mostrar todos los barrios directamente si $barrios est\u00e1 vac\u00edo -->\n                        <?php \n                        $barrios_fallback = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n                        if (!empty($barrios_fallback)): \n                        ?>\n                            <?php foreach ($barrios_fallback as $b): ?>\n                                <option value=\"<?= esc_attr($b->id) ?>\">\n                                    <?= esc_html($b->nombre) ?>\n                                <\/option>\n                            <?php endforeach; ?>\n                        <?php endif; ?>\n                    <?php endif; ?>\n                <\/select>\n            <\/div>\n            \n            <div style=\"display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:16px;border-top:1px solid #ddd;\">\n                <button type=\"button\" class=\"gofast-btn-mini gofast-btn-outline\" onclick=\"cerrarModalEditarCompra()\">Cancelar<\/button>\n                <button type=\"submit\" class=\"gofast-btn-mini\">Guardar Cambios<\/button>\n            <\/div>\n        <\/form>\n    <\/div>\n<\/div>\n<?php endif; ?>\n\n<style>\n\/* Los estilos de gofast-home ya est\u00e1n en css.css *\/\n\n\/* Estilos para tabla de compras *\/\n.gofast-compras-table-wrapper .gofast-table-wrap {\n    width: 100%;\n    max-width: 100%;\n    overflow-x: auto !important;\n    overflow-y: visible !important;\n    -webkit-overflow-scrolling: touch;\n    display: block;\n    margin: 0;\n    padding: 0;\n}\n\n.gofast-compras-table-wrapper .gofast-compras-table {\n    min-width: 800px;\n    width: 100%;\n    border-collapse: collapse;\n    margin: 0;\n}\n\n\/* Vista Desktop: Mostrar tabla, ocultar cards *\/\n.gofast-compras-desktop {\n    display: block;\n}\n\n\/* Vista M\u00f3vil: Cards (oculta en desktop) *\/\n.gofast-compras-mobile {\n    display: none;\n}\n\n.gofast-compras-cards {\n    width: 100%;\n    max-width: 100%;\n}\n\n.gofast-compra-card {\n    width: 100%;\n    max-width: 100%;\n    box-sizing: border-box;\n}\n\n\/* Estilos para formulario de filtros *\/\n.gofast-filtros-form {\n    width: 100%;\n}\n\n.gofast-filtros-form label {\n    display: block;\n    font-weight: 600;\n    margin-bottom: 4px;\n    font-size: 13px;\n    color: #000;\n}\n\n.gofast-filtros-form input[type=\"date\"],\n.gofast-filtros-form input[type=\"number\"],\n.gofast-filtros-form select {\n    width: 100%;\n    padding: 8px;\n    border: 1px solid #ddd;\n    border-radius: 6px;\n    font-size: 14px;\n    background: #fff;\n    color: #000;\n    box-sizing: border-box;\n}\n\n\/* Responsive para m\u00f3vil - tabla de compras *\/\n@media (max-width: 768px) {\n    \n    .gofast-compras-table-wrapper {\n        width: 100% !important;\n        max-width: 100% !important;\n        overflow-x: visible !important;\n        margin: 0;\n        padding: 0;\n        display: block !important;\n        visibility: visible !important;\n    }\n    \n    .gofast-compras-table-wrapper .gofast-table-wrap {\n        overflow-x: scroll !important;\n        -webkit-overflow-scrolling: touch;\n        scrollbar-width: thin;\n        margin: 0;\n        padding: 0;\n        width: 100%;\n        max-width: 100%;\n        display: block !important;\n        visibility: visible !important;\n    }\n    \n    .gofast-compras-table-wrapper .gofast-table-wrap::-webkit-scrollbar {\n        height: 8px;\n    }\n    \n    .gofast-compras-table-wrapper .gofast-table-wrap::-webkit-scrollbar-track {\n        background: #f1f1f1;\n        border-radius: 4px;\n    }\n    \n    .gofast-compras-table-wrapper .gofast-table-wrap::-webkit-scrollbar-thumb {\n        background: #888;\n        border-radius: 4px;\n    }\n    \n    .gofast-compras-table-wrapper .gofast-compras-table {\n        min-width: 850px;\n        font-size: 13px;\n        display: table !important;\n        visibility: visible !important;\n    }\n    \n    .gofast-compras-table-wrapper .gofast-compras-table th,\n    .gofast-compras-table-wrapper .gofast-compras-table td {\n        padding: 10px 8px;\n        font-size: 12px;\n        white-space: nowrap;\n        display: table-cell !important;\n        visibility: visible !important;\n    }\n    \n    \/* Ocultar columna \"Creado por\" en m\u00f3vil para admin *\/\n    .gofast-compras-table-wrapper .gofast-compras-table th:nth-child(4),\n    .gofast-compras-table-wrapper .gofast-compras-table td:nth-child(4) {\n        display: none !important;\n    }\n    \n    \/* Ocultar tabla en m\u00f3vil, mostrar cards *\/\n    .gofast-compras-desktop {\n        display: none !important;\n    }\n    \n    .gofast-compras-mobile {\n        display: block !important;\n    }\n    \n    .gofast-compras-cards {\n        width: 100% !important;\n        max-width: 100% !important;\n        padding: 0 !important;\n        margin: 0 !important;\n        box-sizing: border-box !important;\n    }\n    \n    .gofast-compra-card {\n        width: 100% !important;\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n    }\n    \n    .gofast-compra-card * {\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n    }\n    \n    \/* Filtros en m\u00f3vil *\/\n    .gofast-filtros-form > div {\n        grid-template-columns: 1fr !important;\n        gap: 12px !important;\n    }\n    \n    .gofast-filtros-form button,\n    .gofast-filtros-form a {\n        width: 100% !important;\n        min-width: 100% !important;\n    }\n    \n}\n\n\/* Para pantallas muy peque\u00f1as *\/\n@media (max-width: 480px) {\n    \n    .gofast-compras-table-wrapper .gofast-compras-table {\n        min-width: 750px;\n        font-size: 12px;\n    }\n    \n    .gofast-compras-table-wrapper .gofast-compras-table th,\n    .gofast-compras-table-wrapper .gofast-compras-table td {\n        padding: 8px 6px;\n        font-size: 11px;\n    }\n    \n    \/* Ocultar ID en m\u00f3vil muy peque\u00f1o *\/\n    .gofast-compras-table-wrapper .gofast-compras-table th:first-child,\n    .gofast-compras-table-wrapper .gofast-compras-table td:first-child {\n        display: none !important;\n    }\n}\n\n\/* Desktop: Mostrar tabla, ocultar cards *\/\n@media (min-width: 769px) {\n    .gofast-compras-desktop {\n        display: block !important;\n    }\n    \n    .gofast-compras-mobile {\n        display: none !important;\n    }\n}\n<\/style>\n\n    <?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_compras', 'gofast_compras_shortcode');\n\n\/***************************************************\n * JavaScript para Select2 en destino de compras\n * Igual que el cotizador, sin optgroups\n ***************************************************\/\nadd_action('wp_footer', function() {\n    if (is_page() && has_shortcode(get_post()->post_content, 'gofast_compras')) {\n        ?>\n        <script>\n        (function(){\n        \n          \/***************************************************\n           *  Proteger contra errores de toggleOtro\n           ***************************************************\/\n          if (typeof toggleOtro === 'function') {\n            const originalToggleOtro = toggleOtro;\n            window.toggleOtro = function() {\n              try {\n                const tipoSelect = document.getElementById(\"tipo_negocio\");\n                const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                if (tipoSelect && wrapperOtro && tipoSelect.parentNode && wrapperOtro.parentNode) {\n                  originalToggleOtro();\n                }\n              } catch(e) {\n                \/\/ Silenciar error completamente\n                return;\n              }\n            };\n          }\n          \n          \/\/ Tambi\u00e9n prevenir que setTimeout ejecute toggleOtro si no est\u00e1n los elementos\n          const originalSetTimeout = window.setTimeout;\n          window.setTimeout = function(func, delay) {\n            if (typeof func === 'function' && func.toString().includes('toggleOtro')) {\n              const tipoSelect = document.getElementById(\"tipo_negocio\");\n              const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n              if (!tipoSelect || !wrapperOtro) {\n                return null; \/\/ No ejecutar si no existen los elementos\n              }\n            }\n            return originalSetTimeout.apply(this, arguments);\n          };\n        \n          \/***************************************************\n           *  Normalizador (quita tildes) - GLOBAL\n           ***************************************************\/\n          window.normalize = function(s) {\n            return (s || \"\")\n              .toLowerCase()\n              .normalize(\"NFD\")\n              .replace(\/[\\u0300-\\u036f]\/g, \"\")\n              .trim();\n          };\n          \n          const normalize = window.normalize;\n        \n          \/***************************************************\n           *  MATCHER UNIFICADO (para destinos) - GLOBAL\n           *  Maneja optgroups pero con l\u00f3gica de b\u00fasqueda simple\n           ***************************************************\/\n          window.matcherDestinos = function(params, data) {\n            \/\/ Si no hay data, retornar null\n            if (!data) return null;\n            \n            \/\/ Si es un optgroup (tiene children), dejarlo pasar para que Select2 lo maneje\n            \/\/ Select2 procesar\u00e1 los hijos individualmente con este mismo matcher\n            if (data.children && Array.isArray(data.children)) {\n              return data;\n            }\n            \n            \/\/ Si no tiene id, es un optgroup label o separador\n            \/\/ Sin b\u00fasqueda, mostrarlo; con b\u00fasqueda, ocultarlo\n            if (!data.id) {\n              if (!params.term || !params.term.trim()) {\n                return data;\n              }\n              return null;\n            }\n            \n            \/\/ Si no tiene text, no mostrar\n            if (!data.text) return null;\n            \n            \/\/ Si no hay t\u00e9rmino de b\u00fasqueda, mostrar todas las opciones\n            if (!params.term || !params.term.trim()) {\n              data.matchScore = 0;\n              return data;\n            }\n        \n            const term = normalize(params.term);\n            if (!term) {\n              data.matchScore = 0;\n              return data;\n            }\n        \n            const text = normalize(data.text);\n            \n            \/\/ PRIMERO: Verificar coincidencia exacta (ignorando may\u00fasculas y tildes)\n            if (text === term) {\n              data.matchScore = 10000;\n              return data;\n            }\n            \n            \/\/ SEGUNDO: Verificar si el texto comienza exactamente con el t\u00e9rmino\n            if (text.indexOf(term) === 0) {\n              data.matchScore = 9500;\n              return data;\n            }\n            \n            \/\/ Palabras comunes a ignorar en la b\u00fasqueda\n            const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n            \n            const searchWords = term.split(\/\\s+\/).filter(Boolean).filter(word => {\n              return word.length > 2 && !stopWords.includes(word);\n            });\n            \n            \/\/ Detectar si el t\u00e9rmino de b\u00fasqueda parece ser completo (m\u00faltiples palabras o palabra larga)\n            const isCompleteSearch = term.split(\/\\s+\/).length >= 2 || term.length >= 10;\n            \n            \/\/ Si despu\u00e9s de filtrar no quedan palabras, buscar el t\u00e9rmino completo\n            if (searchWords.length === 0) {\n              if (text.indexOf(term) !== -1) {\n                data.matchScore = 7000;\n                return data;\n              }\n              return null;\n            }\n            \n            \/\/ Verificar que al menos una palabra significativa est\u00e9 presente\n            const significantMatches = searchWords.filter(word => {\n              if (word.length <= 2) {\n                return text.split(\/\\s+\/).some(textWord => textWord.indexOf(word) === 0);\n              }\n              return text.indexOf(word) !== -1;\n            });\n            \n            if (significantMatches.length === 0) return null;\n            \n            const allSignificantMatch = searchWords.length === significantMatches.length;\n            \n            \/\/ Si la b\u00fasqueda parece completa y no hay coincidencia exacta, ser m\u00e1s estricto\n            if (isCompleteSearch && text !== term && text.indexOf(term) !== 0) {\n              \/\/ Solo mostrar si el t\u00e9rmino completo est\u00e1 presente (aunque no al inicio)\n              if (text.indexOf(term) === -1) {\n                \/\/ Verificar si al menos todas las palabras significativas est\u00e1n presentes\n                const allWordsPresent = searchWords.every(word => text.indexOf(word) !== -1);\n                if (!allWordsPresent) {\n                  return null; \/\/ Filtrar si no est\u00e1n todas las palabras\n                }\n              }\n            }\n        \n            \/\/ Sistema de puntuaci\u00f3n\n            let score = 0;\n            \n            const textWithoutStopWords = text.split(\/\\s+\/).filter(w => !stopWords.includes(w)).join(' ');\n            const termWithoutStopWords = searchWords.join(' ');\n            \n            \/\/ Coincidencia exacta sin stop words\n            if (textWithoutStopWords === termWithoutStopWords) {\n              score = 10000;\n            } \n            \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 al inicio\n            else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {\n              score = 9000;\n            } \n            \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 en cualquier parte\n            else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {\n              score = 8000;\n            } \n            \/\/ Al menos una palabra significativa al inicio\n            else if (searchWords.some(word => text.indexOf(word) === 0)) {\n              score = 7000;\n            } \n            \/\/ El t\u00e9rmino completo est\u00e1 en cualquier parte\n            else if (text.indexOf(term) !== -1) {\n              score = 6000;\n            } \n            \/\/ Coincidencias parciales\n            else {\n              score = allSignificantMatch ? 5000 : 3000;\n              \n              let lastIndex = -1;\n              let wordsInOrder = true;\n              searchWords.forEach(word => {\n                const wordIndex = text.indexOf(word, lastIndex + 1);\n                if (wordIndex === -1) {\n                  wordsInOrder = false;\n                } else {\n                  if (wordIndex < lastIndex) wordsInOrder = false;\n                  lastIndex = wordIndex;\n                  if (text.indexOf(word) === 0) score += 500;\n                }\n              });\n              \n              if (wordsInOrder) score += 1000;\n            }\n            \n            data.matchScore = score;\n            return data;\n          };\n          \n          const matcherDestinos = window.matcherDestinos;\n        \n          \/***************************************************\n           *  INIT SELECT2 (UNIFICADO + ALWAYS DOWN)\n           *  selector: selector del select\n           *  dropdownParent: (opcional) elemento padre para el dropdown (por defecto: body)\n           ***************************************************\/\n          function initSelect2(selector, dropdownParent){\n            if (window.jQuery && jQuery.fn.select2) {\n              const $select = jQuery(selector);\n              \n              if (!$select.length) return;\n              \n              \/\/ Si ya est\u00e1 inicializado, destruirlo primero\n              if ($select.data('select2')) {\n                try {\n                  $select.select2('destroy');\n                } catch(e) {\n                  \/\/ Ignorar errores\n                }\n                \/\/ Limpiar contenedor\n                $select.next('.select2-container').remove();\n                $select.removeClass('select2-hidden-accessible');\n                $select.removeAttr('data-select2-id');\n              }\n              \n              \/\/ Determinar el parent del dropdown\n              const $dropdownParent = dropdownParent ? jQuery(dropdownParent) : jQuery('body');\n              \n              \/\/ Usar el mismo matcher para todos (origen y destinos)\n              \/\/ La presentaci\u00f3n de optgroups se mantiene en el HTML\n              $select.select2({\n                  placeholder: \"\ud83d\udd0d Escribe para buscar direcci\u00f3n...\",\n                  width: '100%',\n                  dropdownParent: $dropdownParent,\n                  allowClear: true,\n                  minimumResultsForSearch: 0,  \/\/ SIEMPRE mostrar campo de b\u00fasqueda\n                  selectOnClose: true,\n                  dropdownAutoWidth: true,\n                  dropdownCssClass: \"gofast-select-down\",\n                  \/\/ Forzar que Select2 procese optgroups correctamente\n                  templateSelection: function(data) {\n                    return data.text || data.id;\n                  },\n        \n                \/\/ Usar el mismo matcher para todos (simplificado, igual que destino)\n                matcher: matcherDestinos,\n        \n                sorter: function(results){\n                  return results.sort(function(a,b){\n                    return (b.matchScore || 0) - (a.matchScore || 0);\n                  });\n                },\n                \n        \n                templateResult: function(data, container){\n                  \/\/ Manejar optgroups (no tienen id pero tienen children)\n                  if (!data || !data.text) {\n                    if (data && data.children) return data.text; \/\/ Retornar label del optgroup\n                    return data ? data.text : '';\n                  }\n                  \n                  \/\/ Si no tiene id, es un optgroup label, retornar sin modificar\n                  if (!data.id) return data.text;\n        \n                  let originalText = data.text;\n                  \n                  \/\/ Obtener el t\u00e9rmino de b\u00fasqueda del campo activo\n                  let searchTerm = \"\";\n                  const $activeField = jQuery('.select2-container--open .select2-search__field');\n                  if ($activeField.length) {\n                    searchTerm = $activeField.val() || \"\";\n                  }\n                  \n                  if (!searchTerm || !searchTerm.trim()) {\n                    const $result = jQuery('<span>' + originalText + '<\/span>');\n                    if (data.matchScore !== undefined) {\n                      $result.attr('data-match-score', data.matchScore);\n                    }\n                    return $result;\n                  }\n        \n                  \/\/ Normalizar para b\u00fasqueda sin tildes\n                  const normalizedSearch = normalize(searchTerm);\n                  const normalizedText = normalize(originalText);\n                  \n                  \/\/ Dividir t\u00e9rmino en palabras significativas\n                  const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n                  const searchWords = normalizedSearch.split(\/\\s+\/).filter(Boolean).filter(word => {\n                    return word.length > 2 && !stopWords.includes(word);\n                  });\n                  \n                  \/\/ Si no hay palabras significativas, buscar el t\u00e9rmino completo\n                  const wordsToHighlight = searchWords.length > 0 ? searchWords : [normalizedSearch];\n                  \n                  \/\/ Encontrar coincidencias en el texto normalizado y mapear a texto original\n                  const highlightRanges = [];\n                  \n                  wordsToHighlight.forEach(function(word) {\n                    let searchPos = 0;\n                    while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {\n                      const endPos = searchPos + word.length;\n                      \n                      \/\/ Mapear posiciones normalizadas a originales\n                      \/\/ Construir texto normalizado car\u00e1cter por car\u00e1cter para mapear correctamente\n                      let origStart = -1;\n                      let origEnd = -1;\n                      let normPos = 0;\n                      \n                      \/\/ Encontrar inicio\n                      for (let i = 0; i < originalText.length && origStart === -1; i++) {\n                        const charNorm = normalize(originalText[i]);\n                        if (normPos === searchPos) {\n                          origStart = i;\n                        }\n                        normPos += charNorm.length;\n                      }\n                      \n                      \/\/ Encontrar fin\n                      if (origStart >= 0) {\n                        normPos = searchPos;\n                        for (let i = origStart; i < originalText.length; i++) {\n                          const charNorm = normalize(originalText[i]);\n                          normPos += charNorm.length;\n                          if (normPos >= endPos) {\n                            origEnd = i + 1;\n                            break;\n                          }\n                        }\n                        \n                        if (origStart >= 0 && origEnd > origStart) {\n                          highlightRanges.push({ start: origStart, end: origEnd });\n                        }\n                      }\n                      \n                      searchPos = endPos;\n                    }\n                  });\n                  \n                  \/\/ Fusionar rangos solapados\n                  if (highlightRanges.length > 0) {\n                    highlightRanges.sort((a, b) => a.start - b.start);\n                    const mergedRanges = [highlightRanges[0]];\n                    \n                    for (let i = 1; i < highlightRanges.length; i++) {\n                      const current = highlightRanges[i];\n                      const last = mergedRanges[mergedRanges.length - 1];\n                      \n                      if (current.start <= last.end) {\n                        last.end = Math.max(last.end, current.end);\n                      } else {\n                        mergedRanges.push(current);\n                      }\n                    }\n                    \n                    \/\/ Construir resultado con resaltados\n                    const parts = [];\n                    let lastIndex = 0;\n                    \n                    mergedRanges.forEach(function(range) {\n                      \/\/ Agregar texto antes del rango\n                      if (range.start > lastIndex) {\n                        parts.push(originalText.substring(lastIndex, range.start));\n                      }\n                      \n                      \/\/ Agregar texto resaltado\n                      const matchText = originalText.substring(range.start, range.end);\n                      parts.push('<span style=\"background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;\">' + \n                                 matchText + '<\/span>');\n                      \n                      lastIndex = range.end;\n                    });\n                    \n                    \/\/ Agregar texto restante despu\u00e9s del \u00faltimo rango\n                    if (lastIndex < originalText.length) {\n                      parts.push(originalText.substring(lastIndex));\n                    }\n                    \n                    const result = parts.join('');\n                    \n                    \/\/ Crear elemento jQuery con el HTML renderizado correctamente\n                    const $result = jQuery('<span>').html(result);\n                    \/\/ Agregar atributo data con el score para poder filtrar despu\u00e9s\n                    if (data.matchScore !== undefined) {\n                      $result.attr('data-match-score', data.matchScore);\n                    }\n                    return $result;\n                  }\n                  \n                  \/\/ Si no hay coincidencias, retornar texto sin resaltar\n                  const $result = jQuery('<span>').text(originalText);\n                  if (data.matchScore !== undefined) {\n                    $result.attr('data-match-score', data.matchScore);\n                  }\n                  return $result;\n                }\n                }).on('select2:open', function(e) {\n                  const $select = jQuery(this);\n                  const $container = $select.next('.select2-container');\n                  \n                  \/\/ FORZAR que el dropdown siempre abra hacia abajo\n                  \/\/ Usar requestAnimationFrame para asegurar que se ejecute despu\u00e9s de que Select2 posicione el dropdown\n                  requestAnimationFrame(function() {\n                    \/\/ Remover clase --above si existe y agregar --below\n                    $container.removeClass('select2-container--above').addClass('select2-container--below');\n                  });\n                });\n            }\n          }\n        \n          \/\/ Inicializar cuando el DOM est\u00e9 listo\n          jQuery(document).ready(function($) {\n            if ($('#destino-compra').length) {\n              initSelect2('#destino-compra');\n            }\n            \n            \/\/ Asegurar que el formulario de crear compra se env\u00ede correctamente\n            $('#form-crear-compra').on('submit', function(e) {\n              \/\/ Verificar que el Select2 tenga un valor seleccionado\n              const $select = $('#destino-compra');\n              if ($select.length && $select.data('select2')) {\n                const selectedValue = $select.val();\n                if (!selectedValue || selectedValue === '') {\n                  e.preventDefault();\n                  alert('Por favor selecciona un destino.');\n                  $select.next('.select2-container').find('.select2-selection').focus();\n                  return false;\n                }\n              }\n              \n              \/\/ Verificar que el valor est\u00e9 en el rango correcto\n              const valor = parseFloat($('#valor-compra').val() || 0);\n              if (valor < 6000 || valor > 20000) {\n                e.preventDefault();\n                alert('El valor debe estar entre 6000 y 20000.');\n                $('#valor-compra').focus();\n                return false;\n              }\n              \n              \/\/ Si es admin, verificar que haya seleccionado un mensajero\n              const $mensajeroSelect = $('#mensajero-select');\n              if ($mensajeroSelect.length) {\n                const mensajeroValue = $mensajeroSelect.val();\n                if (!mensajeroValue || mensajeroValue === '') {\n                  e.preventDefault();\n                  alert('Por favor selecciona un mensajero.');\n                  $mensajeroSelect.focus();\n                  return false;\n                }\n              }\n              \n              return true;\n            });\n            \n            \/\/ Abrir modal de editar compra\n            $(document).on('click', '.gofast-btn-editar-compra', function(e) {\n              e.preventDefault();\n              e.stopPropagation();\n              \n              const btn = $(this);\n              const compraId = btn.attr('data-compra-id');\n              const compraValor = btn.attr('data-compra-valor');\n              const compraBarrioId = btn.attr('data-compra-barrio-id');\n              const compraBarrioNombre = btn.attr('data-compra-barrio-nombre');\n              const compraMensajero = btn.attr('data-compra-mensajero');\n              const compraFecha = btn.attr('data-compra-fecha');\n              const compraEstado = btn.attr('data-compra-estado');\n              \n              \/\/ Verificar que el modal existe\n              const $modal = $('#modal-editar-compra');\n              if (!$modal.length) {\n                console.error('Modal #modal-editar-compra no encontrado');\n                alert('Error: El modal de edici\u00f3n no se encontr\u00f3 en la p\u00e1gina.');\n                return false;\n              }\n              \n              \/\/ Llenar informaci\u00f3n del formulario\n              $('#editar-compra-id').val(compraId || '');\n              $('#editar-compra-valor').val(compraValor || '');\n              \n              \/\/ Llenar informaci\u00f3n de visualizaci\u00f3n\n              $('#info-compra-id').text('#' + (compraId || ''));\n              $('#info-mensajero').text(compraMensajero || '\u2014');\n              $('#info-fecha').text(compraFecha || '\u2014');\n              \n              \/\/ Estado con emoji\n              let estadoText = '';\n              switch(compraEstado) {\n                case 'pendiente': estadoText = '\u23f3 Pendiente'; break;\n                case 'en_proceso': estadoText = '\ud83d\udd04 En Proceso'; break;\n                case 'completada': estadoText = '\u2705 Completada'; break;\n                case 'cancelada': estadoText = '\u274c Cancelada'; break;\n                default: estadoText = compraEstado || '\u2014';\n              }\n              $('#info-estado').text(estadoText);\n              \n              \/\/ Mostrar modal\n              $modal.fadeIn(200, function() {\n                \/\/ Inicializar Select2 despu\u00e9s de mostrar el modal\n                \/\/ Usar un timeout para asegurar que el modal est\u00e9 completamente renderizado\n                setTimeout(function() {\n                  if (window.initSelect2Modal && typeof window.initSelect2Modal === 'function') {\n                    try {\n                      \/\/ Inicializar Select2 usando la misma funci\u00f3n que crear compra\n                      window.initSelect2Modal();\n                      \n                      \/\/ Establecer el valor del barrio despu\u00e9s de inicializar Select2\n                      const $select = $('#editar-compra-barrio');\n                      if (compraBarrioId && $select.length) {\n                        setTimeout(function() {\n                          $select.val(compraBarrioId).trigger('change');\n                        }, 150);\n                      }\n                    } catch(err) {\n                      console.error('Error al inicializar Select2:', err);\n                      \/\/ Si falla Select2, establecer el valor directamente\n                      if (compraBarrioId) {\n                        $('#editar-compra-barrio').val(compraBarrioId);\n                      }\n                    }\n                  } else {\n                    \/\/ Si initSelect2Modal no est\u00e1 disponible, usar initSelect2 directamente\n                    if (typeof initSelect2 === 'function') {\n                      initSelect2('#editar-compra-barrio', $modal);\n                      if (compraBarrioId) {\n                        setTimeout(function() {\n                          $('#editar-compra-barrio').val(compraBarrioId).trigger('change');\n                        }, 150);\n                      }\n                    } else if (compraBarrioId) {\n                      $('#editar-compra-barrio').val(compraBarrioId);\n                    }\n                  }\n                }, 200);\n              });\n              \n              return false;\n            });\n            \n            \/\/ Cerrar modal\n            window.cerrarModalEditarCompra = function() {\n              $('#modal-editar-compra').fadeOut(200);\n            };\n            \n            \/\/ Cerrar modal al hacer clic fuera\n            $(document).on('click', '#modal-editar-compra', function(e) {\n              if (e.target === this) {\n                window.cerrarModalEditarCompra();\n              }\n            });\n            \n            <?php if ($rol === 'admin'): ?>\n            \/\/ Funci\u00f3n para inicializar Select2 en el modal de edici\u00f3n\n            \/\/ Usa la misma funci\u00f3n initSelect2 pero con el modal como dropdownParent\n            window.initSelect2Modal = function() {\n              const $modal = jQuery('#modal-editar-compra');\n              if ($modal.length) {\n                \/\/ Usar la misma funci\u00f3n initSelect2 pero con el modal como parent\n                initSelect2('#editar-compra-barrio', $modal);\n              }\n            };\n            <?php endif; ?>\n          });\n        \n        })();\n        <\/script>\n        <?php\n    }\n});\n\n","active":true,"modified":"2025-12-10 00:39:41","revision":"1"}]}