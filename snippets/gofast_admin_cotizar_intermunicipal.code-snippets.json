{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":35,"name":"gofast_admin_cotizar_intermunicipal","code":"\n\/*******************************************************\n * \u2699\ufe0f GOFAST \u2014 COTIZACI\u00d3N INTERMUNICIPAL PARA ADMINISTRADORES\n * Shortcode: [gofast_admin_cotizar_intermunicipal]\n * URL: \/admin-cotizar-intermunicipal\n * \n * Funcionalidad:\n * - Paso 1: Seleccionar mensajero, origen y destino intermunicipal\n * - Paso 2: Resumen editable con datos del cliente\n * - Botones aceptar\/rechazar\n * - Al aceptar: crea servicio intermunicipal y lo asigna al mensajero seleccionado\n *******************************************************\/\n\nfunction gofast_admin_cotizar_intermunicipal_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    \/\/ Validar que sea admin\n    if (empty($_SESSION['gofast_user_id'])) {\n        return \"<div class='gofast-box'>Debes iniciar sesi\u00f3n como administrador para usar esta funci\u00f3n.<\/div>\";\n    }\n\n    $user_id = (int) $_SESSION['gofast_user_id'];\n    $rol = strtolower($_SESSION['gofast_user_rol'] ?? '');\n\n    \/\/ Verificar rol\n    if ($rol !== 'admin') {\n        $usuario = $wpdb->get_row($wpdb->prepare(\n            \"SELECT rol FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n            $user_id\n        ));\n        if (!$usuario || strtolower($usuario->rol) !== 'admin') {\n            return \"<div class='gofast-box'>\u26a0\ufe0f Solo los administradores pueden usar esta funci\u00f3n.<\/div>\";\n        }\n        $_SESSION['gofast_user_rol'] = 'admin';\n        $rol = 'admin';\n    }\n\n    \/\/ Obtener datos del admin\n    $admin = $wpdb->get_row($wpdb->prepare(\n        \"SELECT id, nombre, telefono, email FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n        $user_id\n    ));\n\n    if (!$admin) {\n        return \"<div class='gofast-box'>Error: Usuario no encontrado.<\/div>\";\n    }\n\n    \/\/ Obtener todos los mensajeros activos\n    $mensajeros = $wpdb->get_results(\n        \"SELECT id, nombre, telefono \n         FROM usuarios_gofast \n         WHERE rol = 'mensajero' AND activo = 1 \n         ORDER BY nombre ASC\"\n    );\n    \n    \/\/ Obtener TODOS los negocios registrados\n    $todos_negocios = $wpdb->get_results(\n        \"SELECT n.id, n.nombre, n.direccion_full, n.barrio_id, n.whatsapp, n.user_id,\n                u.nombre as cliente_nombre, u.telefono as cliente_telefono\n         FROM negocios_gofast n\n         INNER JOIN usuarios_gofast u ON n.user_id = u.id\n         WHERE n.activo = 1 AND u.activo = 1\n         ORDER BY n.nombre ASC\"\n    );\n\n    \/\/ Obtener destinos intermunicipales desde la base de datos\n    $destinos_intermunicipales = [];\n    \n    try {\n        $table_exists = $wpdb->get_var(\"SHOW TABLES LIKE 'destinos_intermunicipales'\");\n        \n        if ($table_exists) {\n            $destinos_db = $wpdb->get_results(\n                \"SELECT id, nombre, valor \n                 FROM destinos_intermunicipales \n                 WHERE activo = 1 \n                 ORDER BY orden ASC, nombre ASC\"\n            );\n            \n            if ($destinos_db && is_array($destinos_db)) {\n                foreach ($destinos_db as $destino_db) {\n                    if (isset($destino_db->nombre) && isset($destino_db->valor)) {\n                        $destinos_intermunicipales[$destino_db->nombre] = intval($destino_db->valor);\n                    }\n                }\n            }\n        }\n    } catch (Exception $e) {\n        error_log('Error al obtener destinos intermunicipales: ' . $e->getMessage());\n    }\n    \n    \/\/ Fallback si la tabla no existe o no hay resultados\n    if (empty($destinos_intermunicipales)) {\n        $destinos_intermunicipales = [\n            'Andaluc\u00eda' => 20000,\n            'Bugalagrande' => 25000,\n            'Riofr\u00edo' => 20000,\n            'Buga' => 35000,\n            'San Pedro' => 25000,\n            'Los chanchos' => 20000,\n            'Sal\u00f3nica' => 35000,\n            'La Marina' => 25000,\n            'Presidente' => 30000,\n            'La Paila' => 35000,\n            'Zarzal' => 50000,\n        ];\n    }\n\n    \/*******************************************************\n     * PROCESAR ACEPTAR\/RECHAZAR\n     * \n     * Para administradores:\n     * - Rechazar: Limpia la sesi\u00f3n y vuelve al paso 1 (formulario de cotizaci\u00f3n)\n     * - Aceptar: Crea el servicio intermunicipal con los datos capturados\n     *   - Si es negocio: usa datos del negocio\/cliente propietario\n     *   - Si es Tulu\u00e1: usa datos del cliente capturados en el resumen\n     *   - Asigna al mensajero seleccionado por el administrador\n     *   - NO redirige a servicio-registrado, muestra mensaje de \u00e9xito en la misma p\u00e1gina\n     *******************************************************\/\n    if (isset($_POST['gofast_admin_aceptar_intermunicipal']) || isset($_POST['gofast_admin_rechazar_intermunicipal'])) {\n        \n        if (isset($_POST['gofast_admin_rechazar_intermunicipal'])) {\n            \/\/ Rechazar: volver al paso 1\n            unset($_SESSION['gofast_admin_cotizacion_intermunicipal']);\n            \/\/ Continuar para mostrar el formulario (no redirigir)\n        } elseif (isset($_POST['gofast_admin_aceptar_intermunicipal'])) {\n            \/\/ Aceptar: crear servicio intermunicipal\n            if (empty($_POST['origen_intermunicipal']) || empty($_POST['destino_intermunicipal']) || empty($_POST['mensajero_id'])) {\n                return \"<div class='gofast-box'>Error: Faltan datos del servicio (mensajero, origen o destino).<\/div>\";\n            }\n\n            $mensajero_id = intval($_POST['mensajero_id']);\n            $origen_seleccionado = sanitize_text_field($_POST['origen_intermunicipal']);\n            $destino_seleccionado = sanitize_text_field($_POST['destino_intermunicipal']);\n            \n            \/\/ Capturar datos del cliente\n            $nombre_cliente = sanitize_text_field($_POST['nombre_cliente'] ?? '');\n            $telefono_cliente = sanitize_text_field($_POST['telefono_cliente'] ?? '');\n            $direccion_recogida = sanitize_text_field($_POST['direccion_recogida'] ?? '');\n            $direccion_destino = sanitize_text_field($_POST['direccion_destino'] ?? '');\n            \n            if (empty($nombre_cliente) || empty($telefono_cliente) || empty($direccion_destino)) {\n                return \"<div class='gofast-box'>Error: Debes completar todos los datos del cliente (nombre, tel\u00e9fono y direcci\u00f3n de destino).<\/div>\";\n            }\n            \n            \/\/ Verificar que el mensajero existe y est\u00e1 activo\n            $mensajero_seleccionado = $wpdb->get_row($wpdb->prepare(\n                \"SELECT id, nombre, telefono FROM usuarios_gofast WHERE id = %d AND rol = 'mensajero' AND activo = 1\",\n                $mensajero_id\n            ));\n            \n            if (!$mensajero_seleccionado) {\n                return \"<div class='gofast-box'>Error: El mensajero seleccionado no es v\u00e1lido.<\/div>\";\n            }\n            \n            if (!isset($destinos_intermunicipales[$destino_seleccionado])) {\n                return \"<div class='gofast-box'>Error: Destino no v\u00e1lido.<\/div>\";\n            }\n\n            $valor_envio = $destinos_intermunicipales[$destino_seleccionado];\n            \n            \/\/ Determinar origen y datos del negocio\n            $origen_nombre = 'Tulu\u00e1';\n            $origen_direccion = 'Tulu\u00e1';\n            $negocio_seleccionado = null;\n            $negocio_user_id = null;\n            \n            if ($origen_seleccionado !== 'tulua') {\n                \/\/ Extraer ID del negocio del formato \"negocio_X\"\n                $negocio_id = 0;\n                if (preg_match('\/^negocio_(\\d+)$\/', $origen_seleccionado, $matches)) {\n                    $negocio_id = intval($matches[1]);\n                } else {\n                    $negocio_id = intval($origen_seleccionado);\n                }\n                \n                foreach ($todos_negocios as $neg) {\n                    if (intval($neg->id) === $negocio_id) {\n                        $negocio_seleccionado = $neg;\n                        $barrio_nombre = $wpdb->get_var($wpdb->prepare(\n                            \"SELECT nombre FROM barrios WHERE id = %d\",\n                            $neg->barrio_id\n                        ));\n                        $origen_nombre = $neg->nombre . ' \u2014 ' . ($barrio_nombre ?: 'Tulu\u00e1');\n                        $origen_direccion = $neg->direccion_full ?: $neg->nombre;\n                        $negocio_user_id = $neg->user_id;\n                        break;\n                    }\n                }\n            }\n\n            \/\/ Construir JSON de destinos (formato intermunicipal)\n            $destinos_json = json_encode([\n                'origen' => [\n                    'barrio_id' => ($negocio_seleccionado && isset($negocio_seleccionado->barrio_id)) ? intval($negocio_seleccionado->barrio_id) : 0,\n                    'barrio_nombre' => $origen_nombre,\n                    'sector_id' => 0,\n                    'direccion' => $origen_direccion,\n                    'negocio_id' => $negocio_seleccionado ? $negocio_seleccionado->id : null,\n                ],\n                'destinos' => [[\n                    'barrio_id' => 0,\n                    'barrio_nombre' => $destino_seleccionado,\n                    'sector_id' => 0,\n                    'direccion' => $direccion_destino,\n                    'monto' => $valor_envio,\n                    'direccion_recogida' => $direccion_recogida,\n                ]],\n                'tipo_servicio' => 'intermunicipal',\n            ], JSON_UNESCAPED_UNICODE);\n\n            \/\/ Construir direccion_origen seg\u00fan reglas (sin incluir destino, eso va en el JSON):\n            \/\/ 1. Solo barrio (si no hay negocio y no hay direcci\u00f3n)\n            \/\/ 2. Negocio + direcci\u00f3n (si hay negocio)\n            \/\/ 3. Barrio + direcci\u00f3n (si hay direcci\u00f3n pero no negocio)\n            if ($negocio_seleccionado) {\n                \/\/ Caso 2: Negocio + direcci\u00f3n\n                $dir_origen_negocio = $origen_direccion ?: '';\n                if (!empty($dir_origen_negocio)) {\n                    $direccion_origen_servicio = $negocio_seleccionado->nombre . ' \u2014 ' . $dir_origen_negocio;\n                } else {\n                    $direccion_origen_servicio = $negocio_seleccionado->nombre;\n                }\n            } elseif (!empty($origen_direccion)) {\n                \/\/ Caso 3: Barrio + direcci\u00f3n\n                $direccion_origen_servicio = $origen_nombre . ' \u2014 ' . $origen_direccion;\n            } else {\n                \/\/ Caso 1: Solo barrio\n                $direccion_origen_servicio = $origen_nombre;\n            }\n            \n            \/\/ Si es negocio, usar datos del negocio; si es Tulu\u00e1, usar los datos capturados\n            if ($negocio_seleccionado) {\n                $nombre_cliente = $negocio_seleccionado->nombre;\n                $telefono_cliente = $negocio_seleccionado->whatsapp ?: $negocio_seleccionado->cliente_telefono;\n            }\n            \n            $user_id_servicio = $negocio_user_id ?: null; \/\/ Si es Tulu\u00e1, ser\u00e1 null\n            \n            \/\/ Verificar si existe el campo asignado_por_user_id\n            $column_exists = $wpdb->get_results(\"SHOW COLUMNS FROM servicios_gofast LIKE 'asignado_por_user_id'\");\n            \n            $data_insert = [\n                'nombre_cliente' => $nombre_cliente,\n                'telefono_cliente' => $telefono_cliente,\n                'direccion_origen' => $direccion_origen_servicio,\n                'destinos' => $destinos_json,\n                'total' => $valor_envio,\n                'estado' => 'asignado',\n                'tracking_estado' => 'asignado',\n                'mensajero_id' => $mensajero_id,\n                'user_id' => $user_id_servicio,\n                'fecha' => gofast_current_time('mysql'),\n            ];\n            \n            \/\/ Si existe el campo, guardar qui\u00e9n asign\u00f3 (el admin)\n            if (!empty($column_exists)) {\n                $data_insert['asignado_por_user_id'] = $admin->id;\n            }\n            \n            \/\/ Crear servicio y asignarlo al mensajero seleccionado\n            $insertado = $wpdb->insert('servicios_gofast', $data_insert);\n\n            if ($insertado === false) {\n                return \"<div class='gofast-box'><b>Error al crear el servicio:<\/b><br>\" . esc_html($wpdb->last_error) . \"<\/div>\";\n            }\n\n            $service_id = (int) $wpdb->insert_id;\n            unset($_SESSION['gofast_admin_cotizacion_intermunicipal']);\n            \n            \/\/ Guardar mensaje de \u00e9xito en sesi\u00f3n\n            $_SESSION['gofast_admin_success_intermunicipal'] = [\n                'message' => '\u2705 Servicio intermunicipal creado exitosamente y asignado a ' . esc_html($mensajero_seleccionado->nombre),\n                'service_id' => $service_id,\n                'total' => $valor_envio\n            ];\n            \n            \/\/ Continuar para mostrar el formulario de nuevo (no redirigir)\n        }\n    }\n\n    \/*******************************************************\n     * PASO 2: MOSTRAR RESUMEN EDITABLE\n     *******************************************************\/\n    if (isset($_POST['gofast_admin_cotizar_intermunicipal']) || !empty($_SESSION['gofast_admin_cotizacion_intermunicipal'])) {\n        \n        \/\/ Guardar en sesi\u00f3n\n        if (isset($_POST['gofast_admin_cotizar_intermunicipal'])) {\n            $mensajero_id = intval($_POST['mensajero_id'] ?? 0);\n            $origen_seleccionado = sanitize_text_field($_POST['origen_intermunicipal'] ?? 'tulua');\n            $destino_seleccionado = sanitize_text_field($_POST['destino_intermunicipal'] ?? '');\n            \n            if ($mensajero_id > 0 && !empty($destino_seleccionado) && isset($destinos_intermunicipales[$destino_seleccionado])) {\n                $_SESSION['gofast_admin_cotizacion_intermunicipal'] = [\n                    'mensajero_id' => $mensajero_id,\n                    'origen' => $origen_seleccionado,\n                    'destino' => $destino_seleccionado,\n                    'valor' => $destinos_intermunicipales[$destino_seleccionado],\n                ];\n            }\n        }\n\n        $cotizacion = $_SESSION['gofast_admin_cotizacion_intermunicipal'] ?? null;\n        \n        if (!$cotizacion || empty($cotizacion['origen']) || empty($cotizacion['destino']) || empty($cotizacion['mensajero_id'])) {\n            \/\/ Volver al paso 1\n            unset($_SESSION['gofast_admin_cotizacion_intermunicipal']);\n        } else {\n            \/\/ Mostrar resumen editable\n            return gofast_admin_mostrar_resumen_intermunicipal($cotizacion);\n        }\n    }\n\n    \/*******************************************************\n     * PASO 1: FORMULARIO DE COTIZACI\u00d3N\n     *******************************************************\/\n    \n    \/\/ Recuperar \u00faltima cotizaci\u00f3n\n    $old_data = $_SESSION['gofast_admin_last_quote_intermunicipal'] ?? ['mensajero_id' => '', 'origen' => 'tulua', 'destino' => ''];\n\n    \/\/ Mostrar mensaje de \u00e9xito si existe\n    $success_message = '';\n    if (!empty($_SESSION['gofast_admin_success_intermunicipal'])) {\n        $success = $_SESSION['gofast_admin_success_intermunicipal'];\n        $success_message = \"<div class='gofast-box' style='background:#d4edda;border-left:4px solid #28a745;padding:12px;margin-bottom:16px;'>\";\n        $success_message .= \"<strong>\u2705 \" . esc_html($success['message']) . \"<\/strong><br>\";\n        $success_message .= \"<small>ID del servicio: #\" . esc_html($success['service_id']) . \" | Total: $\" . number_format($success['total'], 0, ',', '.') . \"<\/small>\";\n        $success_message .= \"<\/div>\";\n        unset($_SESSION['gofast_admin_success_intermunicipal']);\n    }\n\n    ob_start();\n    ?>\n\n    <div class=\"gofast-form\">\n        <?php if (!empty($success_message)): ?>\n            <?= $success_message ?>\n        <?php endif; ?>\n        \n        <div class=\"gofast-box\" style=\"background:#e3f2fd;border-left:4px solid #2196F3;padding:12px;margin-bottom:16px;\">\n            <strong>\u2699\ufe0f Modo Administrador - Intermunicipal<\/strong><br>\n            <small>Crea servicios intermunicipales y as\u00edgnalos a cualquier mensajero. Si seleccionas un negocio, el servicio quedar\u00e1 en el historial del cliente propietario. Al aceptar, el servicio se crear\u00e1 y asignar\u00e1 al mensajero seleccionado.<\/small>\n        <\/div>\n\n        <form method=\"post\" action=\"\" id=\"gofast-admin-form-intermunicipal\">\n            <div class=\"gofast-row\">\n                <div style=\"flex:1;\">\n                    <label><strong>Mensajero <span style=\"color: var(--gofast-danger);\">*<\/span><\/strong><\/label>\n                    <select name=\"mensajero_id\" class=\"gofast-select\" id=\"mensajero_id\" required>\n                        <option value=\"\">Seleccionar mensajero...<\/option>\n                        <?php foreach ($mensajeros as $m): ?>\n                            <option value=\"<?= esc_attr($m->id) ?>\"\n                                <?= ((string)$old_data['mensajero_id'] === (string)$m->id ? 'selected' : '') ?>>\n                                \ud83d\ude9a <?= esc_html($m->nombre) ?> (<?= esc_html($m->telefono) ?>)\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                <\/div>\n            <\/div>\n\n            <div class=\"gofast-row\">\n                <div style=\"flex:1;\">\n                    <label><strong>Origen<\/strong><\/label>\n                    <select name=\"origen_intermunicipal\" class=\"gofast-select\" id=\"origen-intermunicipal\" required>\n                        <option value=\"tulua\" <?= ($old_data['origen'] === 'tulua') ? 'selected' : '' ?>>\n                            \ud83d\ude9a Tulu\u00e1 (Datos del cliente)\n                        <\/option>\n                        <?php \n                        if (!empty($todos_negocios)): \n                            foreach ($todos_negocios as $neg): \n                                $barrio_nombre = $wpdb->get_var($wpdb->prepare(\n                                    \"SELECT nombre FROM barrios WHERE id = %d\",\n                                    $neg->barrio_id\n                                ));\n                                $negocio_value = 'negocio_' . $neg->id;\n                                $isSelected = ($old_data['origen'] === $negocio_value);\n                        ?>\n                            <option value=\"<?= esc_attr($negocio_value) ?>\" \n                                    data-negocio-id=\"<?= esc_attr($neg->id) ?>\"\n                                    data-negocio-nombre=\"<?= esc_attr($neg->nombre) ?>\"\n                                    data-negocio-direccion=\"<?= esc_attr($neg->direccion_full) ?>\"\n                                    data-cliente-id=\"<?= esc_attr($neg->user_id) ?>\"\n                                    <?= $isSelected ? 'selected' : '' ?>>\n                                \ud83c\udfea <?= esc_html($neg->nombre) ?> \u2014 <?= esc_html($barrio_nombre ?: 'Tulu\u00e1') ?>\n                            <\/option>\n                        <?php \n                            endforeach;\n                        endif; \n                        ?>\n                    <\/select>\n                    <?php if (!empty($todos_negocios)): ?>\n                        <small style=\"color: #666; font-size: 12px; display: block; margin-top: 4px;\">\n                            Si seleccionas un negocio, el servicio quedar\u00e1 asociado al cliente propietario y aparecer\u00e1 en su historial.\n                        <\/small>\n                    <?php endif; ?>\n                <\/div>\n            <\/div>\n\n            <div class=\"gofast-row\">\n                <div style=\"flex:1;\">\n                    <label><strong>Destino Intermunicipal<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                    <select name=\"destino_intermunicipal\" class=\"gofast-select\" id=\"destino-intermunicipal\" required>\n                        <option value=\"\">Selecciona un destino...<\/option>\n                        <?php foreach ($destinos_intermunicipales as $destino => $valor): ?>\n                            <option value=\"<?= esc_attr($destino) ?>\" \n                                    data-valor=\"<?= esc_attr($valor) ?>\"\n                                    <?= ($old_data['destino'] === $destino) ? 'selected' : '' ?>>\n                                <?= esc_html($destino) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                <\/div>\n            <\/div>\n\n            <!-- Resumen del valor -->\n            <div id=\"resumen-valor\" style=\"display: none; margin-top: 16px;\">\n                <div class=\"gofast-box\" style=\"background: #fff9d6; border-left: 5px solid var(--gofast-yellow); padding: 14px;\">\n                    <div style=\"font-size: 18px; font-weight: 700; color: #000;\">\n                        \ud83d\udcb0 Valor del env\u00edo: <span id=\"valor-envio\">$0<\/span>\n                    <\/div>\n                <\/div>\n            <\/div>\n\n            <div class=\"gofast-btn-group\" style=\"margin-top: 24px;\">\n                <button type=\"submit\" name=\"gofast_admin_cotizar_intermunicipal\" class=\"gofast-submit\">\n                    Ver resumen \ud83d\ude80\n                <\/button>\n            <\/div>\n        <\/form>\n    <\/div>\n\n    <script>\n    document.addEventListener('DOMContentLoaded', function(){\n        if (window.jQuery && jQuery.fn.select2) {\n            jQuery('.gofast-select').select2({\n                placeholder: '\ud83d\udd0d Escribe para buscar...',\n                width: '100%',\n                dropdownParent: jQuery('body'),\n                allowClear: true,\n                minimumResultsForSearch: 0,\n            });\n        }\n\n        const selectDestino = document.getElementById('destino-intermunicipal');\n        const resumenValor = document.getElementById('resumen-valor');\n        const valorEnvio = document.getElementById('valor-envio');\n\n        if (selectDestino && resumenValor && valorEnvio) {\n            selectDestino.addEventListener('change', function() {\n                const selectedOption = this.options[this.selectedIndex];\n                if (selectedOption && selectedOption.value) {\n                    const valor = parseInt(selectedOption.getAttribute('data-valor') || '0');\n                    valorEnvio.textContent = '$' + valor.toLocaleString('es-CO');\n                    resumenValor.style.display = 'block';\n                } else {\n                    resumenValor.style.display = 'none';\n                }\n            });\n        }\n\n        const form = document.getElementById('gofast-admin-form-intermunicipal');\n        if (form) {\n            form.addEventListener('submit', function(e) {\n                const mensajero = document.getElementById('mensajero_id').value;\n                const destino = selectDestino ? selectDestino.value : '';\n                if (!mensajero) {\n                    e.preventDefault();\n                    alert('\u26a0\ufe0f Debes seleccionar un mensajero.');\n                    return false;\n                }\n                if (!destino) {\n                    e.preventDefault();\n                    alert('\u26a0\ufe0f Debes seleccionar un destino para continuar.');\n                    return false;\n                }\n            });\n        }\n    });\n    <\/script>\n\n    <?php\n    return ob_get_clean();\n}\n\n\/*******************************************************\n * FUNCI\u00d3N: MOSTRAR RESUMEN EDITABLE CON DATOS DEL CLIENTE\n * \n * Para administradores:\n * - Muestra el resumen del servicio intermunicipal\n * - Muestra el mensajero asignado\n * - Permite capturar\/editar datos del cliente (nombre, tel\u00e9fono, direcciones)\n * - Si es negocio: prellena con datos del negocio\n * - Si es Tulu\u00e1: permite ingresar datos del cliente manualmente\n * - Botones para aceptar (crear servicio y asignar al mensajero) o rechazar (volver)\n *******************************************************\/\nfunction gofast_admin_mostrar_resumen_intermunicipal($cotizacion) {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    $mensajero_id = $cotizacion['mensajero_id'] ?? 0;\n    $origen_seleccionado = $cotizacion['origen'] ?? 'tulua';\n    $destino_seleccionado = $cotizacion['destino'] ?? '';\n    $valor_envio = $cotizacion['valor'] ?? 0;\n\n    \/\/ Obtener datos del mensajero\n    $mensajero = $wpdb->get_row($wpdb->prepare(\n        \"SELECT id, nombre, telefono FROM usuarios_gofast WHERE id = %d AND rol = 'mensajero' AND activo = 1\",\n        $mensajero_id\n    ));\n\n    if (!$mensajero) {\n        return \"<div class='gofast-box'>Error: Mensajero no encontrado.<\/div>\";\n    }\n\n    \/\/ Obtener todos los negocios para mostrar el origen\n    $todos_negocios = $wpdb->get_results(\n        \"SELECT n.id, n.nombre, n.direccion_full, n.barrio_id, n.whatsapp, n.user_id,\n                u.nombre as cliente_nombre, u.telefono as cliente_telefono\n         FROM negocios_gofast n\n         INNER JOIN usuarios_gofast u ON n.user_id = u.id\n         WHERE n.activo = 1 AND u.activo = 1\n         ORDER BY n.nombre ASC\"\n    );\n\n    \/\/ Determinar nombre del origen y direcci\u00f3n del negocio\n    $origen_nombre = 'Tulu\u00e1';\n    $origen_direccion = '';\n    $negocio_seleccionado = null;\n    $es_negocio = false;\n    \n    if ($origen_seleccionado !== 'tulua') {\n        $es_negocio = true;\n        $negocio_id = 0;\n        if (preg_match('\/^negocio_(\\d+)$\/', $origen_seleccionado, $matches)) {\n            $negocio_id = intval($matches[1]);\n        }\n        \n        foreach ($todos_negocios as $neg) {\n            if (intval($neg->id) === $negocio_id) {\n                $negocio_seleccionado = $neg;\n                $barrio_nombre = $wpdb->get_var($wpdb->prepare(\n                    \"SELECT nombre FROM barrios WHERE id = %d\",\n                    $neg->barrio_id\n                ));\n                $origen_nombre = $neg->nombre . ' \u2014 ' . ($barrio_nombre ?: 'Tulu\u00e1');\n                $origen_direccion = $neg->direccion_full ?: '';\n                break;\n            }\n        }\n    }\n\n    ob_start();\n    ?>\n\n    <div class=\"gofast-checkout-wrapper\">\n        <div class=\"gofast-box\" style=\"max-width:800px;margin:0 auto;\">\n            \n            <div style=\"background:#e3f2fd;border-left:4px solid #2196F3;padding:12px;margin-bottom:20px;border-radius:8px;\">\n                <strong>\u2699\ufe0f Resumen del Servicio Intermunicipal<\/strong><br>\n                <small>Mensajero asignado: <strong><?= esc_html($mensajero->nombre) ?><\/strong><\/small><br>\n                <small>Completa los datos del cliente antes de aceptar.<\/small>\n            <\/div>\n\n            <h3 style=\"margin-top:0;\">\ud83d\udccd Origen: <?= esc_html($origen_nombre) ?><\/h3>\n            \n            <?php if (!empty($origen_direccion)): ?>\n                <div style=\"margin:12px 0;padding:12px;background:#e8f4ff;border-left:4px solid #2196F3;border-radius:8px;\">\n                    <strong>\ud83c\udfe2 Direcci\u00f3n del Negocio:<\/strong><br>\n                    <?= esc_html($origen_direccion) ?>\n                <\/div>\n            <?php endif; ?>\n            \n            <h3>\ud83c\udfaf Destino: <?= esc_html($destino_seleccionado) ?><\/h3>\n\n            <div class=\"gofast-total-box\" style=\"margin:20px 0;text-align:center;\">\n                \ud83d\udcb0 <strong style=\"font-size:24px;\">Total: $<?= number_format($valor_envio, 0, ',', '.') ?><\/strong>\n            <\/div>\n\n            <!-- Formulario con datos del cliente -->\n            <form method=\"post\" id=\"form-aceptar-rechazar-intermunicipal\">\n                <input type=\"hidden\" name=\"mensajero_id\" value=\"<?= esc_attr($mensajero_id) ?>\">\n                <input type=\"hidden\" name=\"origen_intermunicipal\" value=\"<?= esc_attr($origen_seleccionado) ?>\">\n                <input type=\"hidden\" name=\"destino_intermunicipal\" value=\"<?= esc_attr($destino_seleccionado) ?>\">\n\n                <h3 style=\"margin-top:24px;\">\ud83d\udcdd Datos del Cliente<\/h3>\n                \n                <label><strong>Nombre completo<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                <input type=\"text\" name=\"nombre_cliente\" \n                       value=\"<?= $es_negocio && $negocio_seleccionado ? esc_attr($negocio_seleccionado->nombre) : '' ?>\"\n                       required \n                       class=\"gofast-box input\"\n                       placeholder=\"Ej: Juan P\u00e9rez\">\n\n                <label><strong>Tel\u00e9fono \/ WhatsApp<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                <input type=\"text\" name=\"telefono_cliente\" \n                       value=\"<?= $es_negocio && $negocio_seleccionado ? esc_attr($negocio_seleccionado->whatsapp ?: $negocio_seleccionado->cliente_telefono) : '' ?>\"\n                       required \n                       class=\"gofast-box input\"\n                       placeholder=\"Ej: 3112345678\">\n\n                <label><strong>Direcci\u00f3n de Recogida<\/strong><\/label>\n                <input type=\"text\" name=\"direccion_recogida\" \n                       value=\"<?= $es_negocio && $negocio_seleccionado ? esc_attr($negocio_seleccionado->direccion_full) : '' ?>\"\n                       class=\"gofast-box input\"\n                       placeholder=\"Ej: Calle 5 #10-20, Barrio Centro\">\n                <small style=\"color: #666; font-size: 13px; display: block; margin-top: 4px; margin-bottom: 16px;\">\n                    Especifica la direcci\u00f3n exacta donde se recoger\u00e1 el pedido en el origen.\n                <\/small>\n\n                <label><strong>Direcci\u00f3n de destino (zona urbana)<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                <textarea name=\"direccion_destino\" \n                          required \n                          class=\"gofast-box input\"\n                          rows=\"3\"\n                          placeholder=\"Ej: Calle 10 # 5-20, Barrio Centro\"><\/textarea>\n                <small style=\"color: #666; font-size: 13px; display: block; margin-top: -12px; margin-bottom: 16px;\">\n                    Especifica la direcci\u00f3n completa en <?= esc_html($destino_seleccionado) ?> (solo zona urbana)\n                <\/small>\n\n                <div class=\"gofast-box\" style=\"background: #e8f4ff; border-left: 4px solid #1f6feb; padding: 12px; margin-top: 20px; margin-bottom: 16px;\">\n                    <strong style=\"color: #004085;\">\ud83d\udca1 Recordatorio:<\/strong>\n                    <p style=\"margin: 8px 0 0 0; color: #004085; font-size: 13px;\">\n                        Aseg\u00farate de que el pedido este pago con anticipaci\u00f3n antes de confirmar. \n                        y que el mensajero reciba el valor del env\u00edo antes de despachar el pedido. Solo despu\u00e9s de esto se despachar\u00e1 el pedido.\n                        <strong>Recuerda:<\/strong> Se debe anexar la ubicaci\u00f3n en tiempo real del cliente que recibe el domicilio en el destino.\n                    <\/p>\n                <\/div>\n\n                <div class=\"gofast-btn-group\" style=\"margin-top:24px;\">\n                    <button type=\"submit\" name=\"gofast_admin_aceptar_intermunicipal\" class=\"gofast-btn-request\" style=\"background:#4CAF50;color:#fff;\">\n                        \u2705 Aceptar y crear servicio\n                    <\/button>\n                    <button type=\"submit\" name=\"gofast_admin_rechazar_intermunicipal\" class=\"gofast-btn-action gofast-secondary\" formnovalidate>\n                        \u274c Rechazar y volver\n                    <\/button>\n                <\/div>\n            <\/form>\n\n        <\/div>\n    <\/div>\n\n    <?php\n    return ob_get_clean();\n}\n\nadd_shortcode('gofast_admin_cotizar_intermunicipal', 'gofast_admin_cotizar_intermunicipal_shortcode');\n","active":true,"modified":"2025-12-10 23:36:31","revision":"1"}]}