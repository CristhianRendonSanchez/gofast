{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":28,"name":"gofast_mensajero_cotizar","code":"\/*******************************************************\n * \ud83d\ude9a GOFAST \u2014 COTIZACI\u00d3N R\u00c1PIDA PARA MENSAJEROS\n * Shortcode: [gofast_mensajero_cotizar]\n * URL: \/mensajero-cotizar\n *\n * Funcionalidad:\n * - Paso 1: Seleccionar origen y destinos (igual que cotizar normal)\n * - Paso 2: Resumen editable (eliminar\/agregar destinos sin recotizar)\n * - Botones aceptar\/rechazar\n * - Al aceptar: crea servicio y lo asigna autom\u00e1ticamente al mensajero\n *******************************************************\/\n\nfunction gofast_mensajero_cotizar_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    \/\/ Validar que sea mensajero o admin\n    if (empty($_SESSION['gofast_user_id'])) {\n        return \"<div class='gofast-box'>Debes iniciar sesi\u00f3n como mensajero o administrador para usar esta funci\u00f3n.<\/div>\";\n    }\n\n    $user_id = (int) $_SESSION['gofast_user_id'];\n    $rol = strtolower($_SESSION['gofast_user_rol'] ?? '');\n\n    \/\/ Verificar rol\n    if ($rol !== 'mensajero' && $rol !== 'admin') {\n        $usuario = $wpdb->get_row($wpdb->prepare(\n            \"SELECT rol FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n            $user_id\n        ));\n        if (!$usuario || (strtolower($usuario->rol) !== 'mensajero' && strtolower($usuario->rol) !== 'admin')) {\n            return \"<div class='gofast-box'>\u26a0\ufe0f Solo los mensajeros y administradores pueden usar esta funci\u00f3n.<\/div>\";\n        }\n        $_SESSION['gofast_user_rol'] = strtolower($usuario->rol);\n        $rol = $_SESSION['gofast_user_rol'];\n    }\n\n    \/\/ Obtener datos del mensajero\/admin\n    $mensajero = $wpdb->get_row($wpdb->prepare(\n        \"SELECT id, nombre, telefono, email FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n        $user_id\n    ));\n\n    if (!$mensajero) {\n        return \"<div class='gofast-box'>Error: Usuario no encontrado.<\/div>\";\n    }\n    \n    \/\/ Obtener TODOS los negocios registrados para mensajero\/admin\n    $todos_negocios = $wpdb->get_results(\n        \"SELECT n.id, n.nombre, n.direccion_full, n.barrio_id, n.whatsapp, n.user_id,\n                u.nombre as cliente_nombre, u.telefono as cliente_telefono\n         FROM negocios_gofast n\n         INNER JOIN usuarios_gofast u ON n.user_id = u.id\n         WHERE n.activo = 1 AND u.activo = 1\n         ORDER BY n.nombre ASC\"\n    );\n\n    \/*******************************************************\n     * PROCESAR ACEPTAR\/RECHAZAR\n     *******************************************************\/\n    if (isset($_POST['gofast_mensajero_aceptar']) || isset($_POST['gofast_mensajero_rechazar'])) {\n        \n        if (isset($_POST['gofast_mensajero_rechazar'])) {\n            \/\/ Rechazar: volver al paso 1\n            unset($_SESSION['gofast_mensajero_cotizacion']);\n            \/\/ Continuar para mostrar el formulario (no redirigir)\n        } elseif (isset($_POST['gofast_mensajero_aceptar'])) {\n            \/\/ Aceptar: crear servicio\n            if (empty($_POST['origen']) || empty($_POST['destinos_finales'])) {\n                return \"<div class='gofast-box'>Error: Faltan datos del servicio.<\/div>\";\n            }\n\n            $origen = intval($_POST['origen']);\n            \/\/ Obtener negocio_id de la sesi\u00f3n o detectar por barrio_id\n            $negocio_id = isset($_SESSION['gofast_mensajero_cotizacion']['negocio_id']) ? intval($_SESSION['gofast_mensajero_cotizacion']['negocio_id']) : 0;\n            $negocio_user_id = isset($_SESSION['gofast_mensajero_cotizacion']['negocio_user_id']) ? intval($_SESSION['gofast_mensajero_cotizacion']['negocio_user_id']) : null;\n            \n            \/\/ Si no hay negocio_id en sesi\u00f3n, intentar detectarlo por barrio_id\n            if ($negocio_id == 0 && $origen > 0 && !empty($todos_negocios)) {\n                foreach ($todos_negocios as $neg) {\n                    if (intval($neg->barrio_id) === $origen) {\n                        $negocio_id = intval($neg->id);\n                        $negocio_user_id = intval($neg->user_id);\n                        break;\n                    }\n                }\n            }\n            \n            $destinos_finales = array_map('intval', explode(',', $_POST['destinos_finales']));\n            $destinos_finales = array_filter($destinos_finales);\n\n            if (empty($destinos_finales)) {\n                return \"<div class='gofast-box'>Debes tener al menos un destino.<\/div>\";\n            }\n            \n            \/\/ Obtener recargos seleccionables por destino\n            $recargos_seleccionables_por_destino = [];\n            if (!empty($_POST['recargo_seleccionable']) && is_array($_POST['recargo_seleccionable'])) {\n                foreach ($_POST['recargo_seleccionable'] as $destino_id => $recargo_id) {\n                    $destino_id = intval($destino_id);\n                    $recargo_id = intval($recargo_id);\n                    if ($destino_id > 0 && $recargo_id > 0) {\n                        $recargos_seleccionables_por_destino[$destino_id] = $recargo_id;\n                    }\n                }\n            }\n            \n            \/\/ Obtener datos del negocio si se seleccion\u00f3 uno\n            $negocio_seleccionado = null;\n            $cliente_propietario = null;\n            if ($negocio_id > 0) {\n                if ($negocio_user_id) {\n                    \/\/ Buscar por negocio_id y user_id del cliente propietario\n                    $negocio_seleccionado = $wpdb->get_row($wpdb->prepare(\n                        \"SELECT n.*, u.nombre as cliente_nombre, u.telefono as cliente_telefono\n                         FROM negocios_gofast n\n                         INNER JOIN usuarios_gofast u ON n.user_id = u.id\n                         WHERE n.id = %d AND n.user_id = %d AND n.activo = 1 AND u.activo = 1\",\n                        $negocio_id,\n                        $negocio_user_id\n                    ));\n                } else {\n                    \/\/ Buscar solo por negocio_id\n                    $negocio_seleccionado = $wpdb->get_row($wpdb->prepare(\n                        \"SELECT n.*, u.nombre as cliente_nombre, u.telefono as cliente_telefono\n                         FROM negocios_gofast n\n                         INNER JOIN usuarios_gofast u ON n.user_id = u.id\n                         WHERE n.id = %d AND n.activo = 1 AND u.activo = 1\",\n                        $negocio_id\n                    ));\n                }\n                \n                if ($negocio_seleccionado) {\n                    $cliente_propietario = $negocio_seleccionado->user_id;\n                }\n            }\n\n            \/\/ Calcular tarifas y recargos\n            $sector_origen = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $origen)));\n            $nombre_origen = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $origen));\n\n            \/\/ Recargos fijos\n            $recargos_fijos = $wpdb->get_results(\"SELECT id, nombre, valor_fijo FROM recargos WHERE activo = 1 AND tipo = 'fijo'\");\n            $recargo_fijo_por_envio = 0;\n            foreach ((array) $recargos_fijos as $r) {\n                $monto = intval($r->valor_fijo);\n                if ($monto > 0) {\n                    $recargo_fijo_por_envio += $monto;\n                }\n            }\n\n            \/\/ Recargos variables\n            $recargos_variables = $wpdb->get_results(\"SELECT r.id, r.nombre, rr.monto_min, rr.monto_max, rr.recargo FROM recargos r JOIN recargos_rangos rr ON rr.recargo_id = r.id WHERE r.activo = 1 AND r.tipo = 'por_valor' ORDER BY rr.monto_min ASC\");\n            \n            $calcular_recargos_variables = function($valor) use ($recargos_variables) {\n                $valor = intval($valor);\n                $total_variable = 0;\n                foreach ((array) $recargos_variables as $r) {\n                    $min = intval($r->monto_min);\n                    $max = intval($r->monto_max);\n                    $rec = intval($r->recargo);\n                    $cumple_min = ($valor >= $min);\n                    $cumple_max = ($max <= 0) ? true : ($valor <= $max);\n                    if ($cumple_min && $cumple_max && $rec > 0) {\n                        $total_variable += $rec;\n                    }\n                }\n                return $total_variable;\n            };\n\n            \/\/ Calcular total\n            $total = 0;\n            $destinos_completos = [];\n            \n            foreach ($destinos_finales as $dest_id) {\n                $sector_destino = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $dest_id)));\n                $nombre_destino = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $dest_id));\n\n                $precio = $wpdb->get_var($wpdb->prepare(\n                    \"SELECT precio FROM tarifas WHERE origen_sector_id=%d AND destino_sector_id=%d\",\n                    $sector_origen,\n                    $sector_destino\n                ));\n                $precio = $precio ? intval($precio) : 0;\n\n                $recargo_variable = $calcular_recargos_variables($precio);\n                $recargo_total = $recargo_fijo_por_envio + $recargo_variable;\n                \n                \/\/ Agregar recargo seleccionable si existe para este destino\n                $recargo_seleccionable_valor = 0;\n                $recargo_seleccionable_id = null;\n                $recargo_seleccionable_nombre = null;\n                if (isset($recargos_seleccionables_por_destino[$dest_id])) {\n                    $recargo_seleccionable_id = $recargos_seleccionables_por_destino[$dest_id];\n                    $recargo_seleccionable = $wpdb->get_row($wpdb->prepare(\n                        \"SELECT id, nombre, valor_fijo FROM recargos WHERE id = %d AND tipo = 'por_volumen_peso' AND activo = 1\",\n                        $recargo_seleccionable_id\n                    ));\n                    if ($recargo_seleccionable) {\n                        $recargo_seleccionable_valor = intval($recargo_seleccionable->valor_fijo);\n                        $recargo_seleccionable_nombre = $recargo_seleccionable->nombre;\n                    }\n                }\n                \n                $total_trayecto = $precio + $recargo_total + $recargo_seleccionable_valor;\n                $total += $total_trayecto;\n\n                $destinos_completos[] = [\n                    'barrio_id' => $dest_id,\n                    'barrio_nombre' => $nombre_destino,\n                    'sector_id' => $sector_destino,\n                    'direccion' => '',\n                    'monto' => 0,\n                    'recargo_seleccionable_id' => $recargo_seleccionable_id,\n                    'recargo_seleccionable_valor' => $recargo_seleccionable_valor,\n                    'recargo_seleccionable_nombre' => $recargo_seleccionable_nombre,\n                ];\n            }\n\n            \/\/ JSON final - Direcci\u00f3n para el JSON (puede ser diferente de direccion_origen_servicio)\n            $direccion_origen_json = '';\n            if ($negocio_seleccionado) {\n                $direccion_origen_json = $negocio_seleccionado->direccion_full ?: '';\n            }\n            \n            $origen_completo = [\n                'barrio_id' => $origen,\n                'barrio_nombre' => $nombre_origen,\n                'sector_id' => $sector_origen,\n                'direccion' => $direccion_origen_json,\n                'negocio_id' => $negocio_seleccionado ? $negocio_seleccionado->id : null,\n            ];\n\n            $json_final = json_encode([\n                'origen' => $origen_completo,\n                'destinos' => $destinos_completos,\n            ], JSON_UNESCAPED_UNICODE);\n\n            \/\/ Verificar si existe el campo asignado_por_user_id\n            $column_exists = $wpdb->get_results(\"SHOW COLUMNS FROM servicios_gofast LIKE 'asignado_por_user_id'\");\n            \n            \/\/ Determinar nombre y tel\u00e9fono del cliente\n            $nombre_cliente = $mensajero->nombre . ' (' . ($rol === 'admin' ? 'Admin' : 'Mensajero') . ')';\n            $telefono_cliente = $mensajero->telefono;\n            $user_id_servicio = $mensajero->id; \/\/ Por defecto el mensajero\/admin\n            \n            \/\/ Construir direccion_origen_servicio seg\u00fan reglas:\n            \/\/ 1. Solo barrio (si no hay negocio)\n            \/\/ 2. Negocio + direcci\u00f3n (si hay negocio)\n            if ($negocio_seleccionado) {\n                \/\/ Usar datos del NEGOCIO (no del cliente)\n                $nombre_cliente = $negocio_seleccionado->nombre; \/\/ Nombre del negocio\n                $telefono_cliente = $negocio_seleccionado->whatsapp ?: $negocio_seleccionado->cliente_telefono; \/\/ WhatsApp del negocio primero\n                $user_id_servicio = $cliente_propietario; \/\/ Asociar al cliente propietario del negocio\n                \n                \/\/ Caso 2: Negocio + direcci\u00f3n\n                $dir_origen_negocio = $negocio_seleccionado->direccion_full ?: '';\n                if (!empty($dir_origen_negocio)) {\n                    $direccion_origen_servicio = $negocio_seleccionado->nombre . ' \u2014 ' . $dir_origen_negocio;\n                } else {\n                    $direccion_origen_servicio = $negocio_seleccionado->nombre;\n                }\n            } else {\n                \/\/ Caso 1: Solo barrio\n                $direccion_origen_servicio = $nombre_origen;\n            }\n            \n            $data_insert = [\n                'nombre_cliente' => $nombre_cliente,\n                'telefono_cliente' => $telefono_cliente,\n                'direccion_origen' => $direccion_origen_servicio,\n                'destinos' => $json_final,\n                'total' => $total,\n                'estado' => 'asignado',\n                'tracking_estado' => 'asignado',\n                'mensajero_id' => $mensajero->id,\n                'user_id' => $user_id_servicio, \/\/ Cliente propietario del negocio o mensajero\/admin\n                'fecha' => gofast_current_time('mysql'),\n            ];\n            \n            \/\/ Si existe el campo, guardar qui\u00e9n asign\u00f3 (el mensajero se auto-asign\u00f3)\n            if (!empty($column_exists)) {\n                $data_insert['asignado_por_user_id'] = $mensajero->id;\n            }\n            \n            \/\/ Crear servicio y asignarlo autom\u00e1ticamente al mensajero\n            $insertado = $wpdb->insert('servicios_gofast', $data_insert);\n\n            if ($insertado === false) {\n                return \"<div class='gofast-box'><b>Error al crear el servicio:<\/b><br>\" . esc_html($wpdb->last_error) . \"<\/div>\";\n            }\n\n            $service_id = (int) $wpdb->insert_id;\n            unset($_SESSION['gofast_mensajero_cotizacion']);\n            \n            \/\/ Guardar mensaje de \u00e9xito en sesi\u00f3n\n            $_SESSION['gofast_mensajero_success'] = [\n                'message' => '\u2705 Servicio creado exitosamente',\n                'service_id' => $service_id,\n                'total' => $total\n            ];\n            \n            \/\/ Continuar para mostrar el formulario de nuevo (no redirigir)\n            \/\/ El mensaje se mostrar\u00e1 en el paso 1\n        }\n    }\n\n    \/*******************************************************\n     * PASO 2: MOSTRAR RESUMEN EDITABLE\n     *******************************************************\/\n    if (isset($_POST['gofast_mensajero_cotizar']) || !empty($_SESSION['gofast_mensajero_cotizacion'])) {\n        \n        \/\/ Guardar en sesi\u00f3n\n        if (isset($_POST['gofast_mensajero_cotizar'])) {\n            $origen = intval($_POST['origen'] ?? 0);\n            $negocio_id = isset($_POST['negocio_id']) ? intval($_POST['negocio_id']) : 0;\n            $destinos = array_map('intval', (array) ($_POST['destino'] ?? []));\n            \n            \/\/ Eliminar solo valores vac\u00edos\/cero (permitir duplicados)\n            $destinos = array_filter($destinos, function($id) {\n                return $id > 0;\n            });\n            $destinos = array_values($destinos); \/\/ Reindexar array\n            \n            \/\/ Guardar recargos seleccionables si vienen en el POST\n            $recargos_seleccionables_guardar = [];\n            if (!empty($_POST['recargo_seleccionable']) && is_array($_POST['recargo_seleccionable'])) {\n                foreach ($_POST['recargo_seleccionable'] as $destino_id => $recargo_id) {\n                    $destino_id = intval($destino_id);\n                    $recargo_id = intval($recargo_id);\n                    if ($destino_id > 0 && $recargo_id > 0) {\n                        $recargos_seleccionables_guardar[$destino_id] = $recargo_id;\n                    }\n                }\n            }\n            \n            \/\/ Mantener recargos seleccionables existentes de la sesi\u00f3n si no vienen en POST\n            $cotizacion_anterior = $_SESSION['gofast_mensajero_cotizacion'] ?? null;\n            if (!empty($cotizacion_anterior['recargos_seleccionables']) && empty($recargos_seleccionables_guardar)) {\n                $recargos_seleccionables_guardar = $cotizacion_anterior['recargos_seleccionables'];\n            }\n            \n            if ($origen > 0 && !empty($destinos)) {\n                $_SESSION['gofast_mensajero_cotizacion'] = [\n                    'origen' => $origen,\n                    'destinos' => $destinos,\n                    'negocio_id' => $negocio_id,\n                    'recargos_seleccionables' => $recargos_seleccionables_guardar,\n                ];\n            }\n        }\n\n        $cotizacion = $_SESSION['gofast_mensajero_cotizacion'] ?? null;\n        \n        if (!$cotizacion || empty($cotizacion['origen']) || empty($cotizacion['destinos'])) {\n            \/\/ Volver al paso 1\n            unset($_SESSION['gofast_mensajero_cotizacion']);\n        } else {\n            \/\/ Filtrar solo valores vac\u00edos\/cero (permitir duplicados)\n            $destinos_filtrados = array_values(array_filter($cotizacion['destinos'], function($id) {\n                return $id > 0;\n            }));\n            $cotizacion['destinos'] = $destinos_filtrados;\n            $_SESSION['gofast_mensajero_cotizacion'] = $cotizacion;\n            \n            \/\/ Mostrar resumen editable\n            return gofast_mensajero_mostrar_resumen($cotizacion['origen'], $destinos_filtrados);\n        }\n    }\n\n    \/*******************************************************\n     * PASO 1: FORMULARIO DE COTIZACI\u00d3N\n     *******************************************************\/\n    \n    \/\/ Obtener barrios\n    $barrios_all = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n    $barrios = $barrios_all ?: [];\n\n    \/\/ Recuperar \u00faltima cotizaci\u00f3n\n    $old_data = $_SESSION['gofast_mensajero_last_quote'] ?? ['origen' => '', 'destinos' => []];\n\n    \/\/ Mostrar mensaje de \u00e9xito si existe\n    $success_message = '';\n    if (!empty($_SESSION['gofast_mensajero_success'])) {\n        $success = $_SESSION['gofast_mensajero_success'];\n        $success_message = \"<div class='gofast-box' style='background:#d4edda;border-left:4px solid #28a745;padding:12px;margin-bottom:16px;'>\";\n        $success_message .= \"<strong>\u2705 \" . esc_html($success['message']) . \"<\/strong><br>\";\n        $success_message .= \"<small>ID del servicio: #\" . esc_html($success['service_id']) . \" | Total: $\" . number_format($success['total'], 0, ',', '.') . \"<\/small>\";\n        $success_message .= \"<\/div>\";\n        unset($_SESSION['gofast_mensajero_success']);\n    }\n\n    ob_start();\n    ?>\n\n    <div class=\"gofast-form\">\n        <?php if (!empty($success_message)): ?>\n            <?= $success_message ?>\n        <?php endif; ?>\n        \n        <div class=\"gofast-box\" style=\"background:#e3f2fd;border-left:4px solid #2196F3;padding:12px;margin-bottom:16px;\">\n            <strong>\ud83d\ude9a Modo <?= $rol === 'admin' ? 'Administrador' : 'Mensajero' ?><\/strong><br>\n            <small>Crea servicios r\u00e1pidamente. Al aceptar, el servicio se asignar\u00e1 autom\u00e1ticamente a ti. Si seleccionas un negocio, el servicio quedar\u00e1 en el historial del cliente propietario.<\/small>\n        <\/div>\n\n        <form method=\"post\" action=\"\" id=\"gofast-mensajero-form\">\n            <div class=\"gofast-row\">\n                <div style=\"flex:1;\">\n                    <label><strong>Origen<\/strong><\/label>\n                    <select name=\"origen\" class=\"gofast-select\" id=\"origen\" required>\n                        <option value=\"\">Buscar barrio...<\/option>\n                        <?php \n                        \/\/ Combinar negocios y barrios en un solo array y ordenar alfab\u00e9ticamente\n                        $opciones_origen = [];\n                        \n                        \/\/ Agregar negocios\n                        if (!empty($todos_negocios)): \n                            foreach ($todos_negocios as $neg): \n                                $barrio_nombre = $wpdb->get_var($wpdb->prepare(\n                                    \"SELECT nombre FROM barrios WHERE id = %d\",\n                                    $neg->barrio_id\n                                ));\n                                $opciones_origen[] = [\n                                    'tipo' => 'negocio',\n                                    'valor' => $neg->barrio_id,\n                                    'texto' => '\ud83c\udfea ' . $neg->nombre . ' \u2014 ' . ($barrio_nombre ?: 'Sin barrio'),\n                                    'data' => [\n                                        'is-negocio' => 'true',\n                                        'negocio-id' => $neg->id,\n                                        'negocio-nombre' => $neg->nombre,\n                                        'negocio-direccion' => $neg->direccion_full,\n                                        'cliente-id' => $neg->user_id,\n                                        'cliente-nombre' => $neg->cliente_nombre,\n                                        'cliente-telefono' => $neg->cliente_telefono,\n                                    ],\n                                    'selected' => ((string)$old_data['origen'] === (string)$neg->barrio_id)\n                                ];\n                            endforeach;\n                        endif;\n                        \n                        \/\/ Agregar barrios\n                        foreach ($barrios as $b): \n                            $opciones_origen[] = [\n                                'tipo' => 'barrio',\n                                'valor' => $b->id,\n                                'texto' => $b->nombre,\n                                'data' => [],\n                                'selected' => ((string)$old_data['origen'] === (string)$b->id)\n                            ];\n                        endforeach;\n                        \n                        \/\/ Ordenar alfab\u00e9ticamente por texto (sin el emoji para comparar)\n                        usort($opciones_origen, function($a, $b) {\n                            $texto_a = preg_replace('\/^\ud83c\udfea \/', '', $a['texto']);\n                            $texto_b = preg_replace('\/^\ud83c\udfea \/', '', $b['texto']);\n                            return strcasecmp($texto_a, $texto_b);\n                        });\n                        \n                        \/\/ Mostrar opciones ordenadas\n                        foreach ($opciones_origen as $opcion): \n                        ?>\n                            <option value=\"<?= esc_attr($opcion['valor']) ?>\"\n                                    <?php foreach ($opcion['data'] as $key => $value): ?>\n                                        data-<?= esc_attr($key) ?>=\"<?= esc_attr($value) ?>\"\n                                    <?php endforeach; ?>\n                                    <?= $opcion['selected'] ? 'selected' : '' ?>>\n                                <?= esc_html($opcion['texto']) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                    <?php if (!empty($todos_negocios)): ?>\n                        <small style=\"color: #666; font-size: 12px; display: block; margin-top: 4px;\">\n                            Si seleccionas un negocio, el servicio quedar\u00e1 asociado al cliente propietario y aparecer\u00e1 en su historial.\n                        <\/small>\n                    <?php endif; ?>\n                <\/div>\n\n                <div style=\"flex:1;\">\n                    <label><strong>Primer destino<\/strong><\/label>\n                    <select name=\"destino[]\" class=\"gofast-select\" id=\"destino-principal\" required>\n                        <option value=\"\">Buscar barrio...<\/option>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\"\n                                <?= in_array($b->id, $old_data['destinos'], true) ? 'selected' : '' ?>>\n                                <?= esc_html($b->nombre) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                <\/div>\n            <\/div>\n\n            <div class=\"gofast-destinos-grid\">\n                <div class=\"gofast-destinos-label\">\n                    <label><strong>Destinos adicionales<\/strong><\/label>\n                <\/div>\n                <div id=\"destinos-wrapper\">\n                    <div id=\"destinos-extra\"><\/div>\n                    <button type=\"button\" id=\"btn-add-destino\" class=\"gofast-add-button\" onclick=\"addDestinoMensajero()\">\n                        \u2795 Agregar destino adicional\n                    <\/button>\n                <\/div>\n            <\/div>\n\n            <template id=\"tpl-destino-mensajero\">\n                <div class=\"gofast-destino-item\">\n                    <select name=\"destino[]\" class=\"gofast-select\" required>\n                        <option value=\"\">Buscar barrio...<\/option>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\">\n                                <?= esc_html($b->nombre) ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                    <button type=\"button\" class=\"gofast-remove\" onclick=\"removeDestinoMensajero(this)\">\u274c<\/button>\n                <\/div>\n            <\/template>\n\n            <div class=\"gofast-btn-group\">\n                <button type=\"submit\" name=\"gofast_mensajero_cotizar\" class=\"gofast-submit\" id=\"btn-submit\">\n                    Ver resumen \ud83d\ude80\n                <\/button>\n            <\/div>\n        <\/form>\n    <\/div>\n\n    <script>\n    document.addEventListener('DOMContentLoaded', function(){\n        if (window.jQuery && jQuery.fn.select2) {\n            initSelect2Mensajero('.gofast-form');\n        }\n\n        const form = document.getElementById('gofast-mensajero-form');\n        if (form) {\n            form.addEventListener('submit', function(e){\n                const origen = document.getElementById('origen').value;\n                const destino = document.getElementById('destino-principal').value;\n                if (!origen || !destino){\n                    e.preventDefault();\n                    alert('Debes seleccionar origen y al menos un destino \u26a0\ufe0f');\n                    return false;\n                }\n            });\n        }\n    });\n\n    function addDestinoMensajero(){\n        const tpl = document.getElementById('tpl-destino-mensajero');\n        const cont = document.getElementById('destinos-extra');\n        const btn = document.getElementById('btn-add-destino');\n        if (tpl && cont) {\n            cont.appendChild(tpl.content.cloneNode(true));\n            cont.parentNode.appendChild(btn);\n            if (window.jQuery && jQuery.fn.select2) {\n                initSelect2Mensajero('#destinos-extra');\n            }\n        }\n    }\n\n    function removeDestinoMensajero(btn){\n        btn.parentElement.remove();\n    }\n\n    function initSelect2Mensajero(container){\n        if (!window.jQuery || !jQuery.fn.select2) return;\n        \n        \/***************************************************\n         *  Normalizador (quita tildes)\n         ***************************************************\/\n        const normalize = s => (s || \"\")\n            .toLowerCase()\n            .normalize(\"NFD\")\n            .replace(\/[\\u0300-\\u036f]\/g, \"\")\n            .trim();\n        \n        \/***************************************************\n         *  MATCHER UNIFICADO (igual que cotizador principal)\n         *  Maneja optgroups pero con l\u00f3gica de b\u00fasqueda\n         ***************************************************\/\n        function matcherDestinos(params, data){\n            \/\/ Si no hay data, retornar null\n            if (!data) return null;\n            \n            \/\/ Si es un optgroup (tiene children), dejarlo pasar para que Select2 lo maneje\n            \/\/ Select2 procesar\u00e1 los hijos individualmente con este mismo matcher\n            if (data.children && Array.isArray(data.children)) {\n                return data;\n            }\n            \n            \/\/ Si no tiene id, es un optgroup label o separador\n            \/\/ Sin b\u00fasqueda, mostrarlo; con b\u00fasqueda, ocultarlo\n            if (!data.id) {\n                if (!params.term || !params.term.trim()) {\n                    return data;\n                }\n                return null;\n            }\n            \n            \/\/ Si no tiene text, no mostrar\n            if (!data.text) return null;\n            \n            \/\/ Si no hay t\u00e9rmino de b\u00fasqueda, mostrar todas las opciones\n            if (!params.term || !params.term.trim()) {\n                data.matchScore = 0;\n                return data;\n            }\n\n            const term = normalize(params.term);\n            if (!term) {\n                data.matchScore = 0;\n                return data;\n            }\n\n            const text = normalize(data.text);\n            \n            \/\/ PRIMERO: Verificar coincidencia exacta (ignorando may\u00fasculas y tildes)\n            if (text === term) {\n                data.matchScore = 10000;\n                return data;\n            }\n            \n            \/\/ SEGUNDO: Verificar si el texto comienza exactamente con el t\u00e9rmino\n            if (text.indexOf(term) === 0) {\n                data.matchScore = 9500;\n                return data;\n            }\n            \n            \/\/ Palabras comunes a ignorar en la b\u00fasqueda\n            const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n            \n            const searchWords = term.split(\/\\s+\/).filter(Boolean).filter(word => {\n                return word.length > 2 && !stopWords.includes(word);\n            });\n            \n            \/\/ Detectar si el t\u00e9rmino de b\u00fasqueda parece ser completo (m\u00faltiples palabras o palabra larga)\n            const isCompleteSearch = term.split(\/\\s+\/).length >= 2 || term.length >= 10;\n            \n            \/\/ Si despu\u00e9s de filtrar no quedan palabras, buscar el t\u00e9rmino completo\n            if (searchWords.length === 0) {\n                if (text.indexOf(term) !== -1) {\n                    data.matchScore = 7000;\n                    return data;\n                }\n                return null;\n            }\n            \n            \/\/ Verificar que al menos una palabra significativa est\u00e9 presente\n            const significantMatches = searchWords.filter(word => {\n                if (word.length <= 2) {\n                    return text.split(\/\\s+\/).some(textWord => textWord.indexOf(word) === 0);\n                }\n                return text.indexOf(word) !== -1;\n            });\n            \n            if (significantMatches.length === 0) return null;\n            \n            const allSignificantMatch = searchWords.length === significantMatches.length;\n            \n            \/\/ Si la b\u00fasqueda parece completa y no hay coincidencia exacta, ser m\u00e1s estricto\n            if (isCompleteSearch && text !== term && text.indexOf(term) !== 0) {\n                \/\/ Solo mostrar si el t\u00e9rmino completo est\u00e1 presente (aunque no al inicio)\n                if (text.indexOf(term) === -1) {\n                    \/\/ Verificar si al menos todas las palabras significativas est\u00e1n presentes\n                    const allWordsPresent = searchWords.every(word => text.indexOf(word) !== -1);\n                    if (!allWordsPresent) {\n                        return null; \/\/ Filtrar si no est\u00e1n todas las palabras\n                    }\n                }\n            }\n\n            \/\/ Sistema de puntuaci\u00f3n\n            let score = 0;\n            \n            const textWithoutStopWords = text.split(\/\\s+\/).filter(w => !stopWords.includes(w)).join(' ');\n            const termWithoutStopWords = searchWords.join(' ');\n            \n            \/\/ Coincidencia exacta sin stop words\n            if (textWithoutStopWords === termWithoutStopWords) {\n                score = 10000;\n            } \n            \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 al inicio\n            else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {\n                score = 9000;\n            } \n            \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 en cualquier parte\n            else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {\n                score = 8000;\n            } \n            \/\/ Al menos una palabra significativa al inicio\n            else if (searchWords.some(word => text.indexOf(word) === 0)) {\n                score = 7000;\n            } \n            \/\/ El t\u00e9rmino completo est\u00e1 en cualquier parte\n            else if (text.indexOf(term) !== -1) {\n                score = 6000;\n            } \n            \/\/ Coincidencias parciales\n            else {\n                score = allSignificantMatch ? 5000 : 3000;\n                \n                let lastIndex = -1;\n                let wordsInOrder = true;\n                searchWords.forEach(word => {\n                    const wordIndex = text.indexOf(word, lastIndex + 1);\n                    if (wordIndex === -1) {\n                        wordsInOrder = false;\n                    } else {\n                        if (wordIndex < lastIndex) wordsInOrder = false;\n                        lastIndex = wordIndex;\n                        if (text.indexOf(word) === 0) score += 500;\n                    }\n                });\n                \n                if (wordsInOrder) score += 1000;\n            }\n            \n            data.matchScore = score;\n            return data;\n        }\n        \n        jQuery(container).find('.gofast-select').each(function(){\n            if (jQuery(this).data('select2')) return;\n            \n            jQuery(this).select2({\n                placeholder: '\ud83d\udd0d Escribe para buscar...',\n                width: '100%',\n                dropdownParent: jQuery('body'),\n                allowClear: true,\n                minimumResultsForSearch: 0,\n                matcher: matcherDestinos,\n                sorter: function(results) {\n                    return results.sort(function(a, b) {\n                        const scoreA = a.matchScore || 0;\n                        const scoreB = b.matchScore || 0;\n                        return scoreB - scoreA;\n                    });\n                },\n                templateResult: function(data, container){\n                    \/\/ Manejar optgroups (no tienen id pero tienen children)\n                    if (!data || !data.text) {\n                        if (data && data.children) return data.text; \/\/ Retornar label del optgroup\n                        return data ? data.text : '';\n                    }\n                    \n                    \/\/ Si no tiene id, es un optgroup label, retornar sin modificar\n                    if (!data.id) return data.text;\n\n                    let originalText = data.text;\n                    \n                    \/\/ Obtener el t\u00e9rmino de b\u00fasqueda del campo activo\n                    let searchTerm = \"\";\n                    const $activeField = jQuery('.select2-container--open .select2-search__field');\n                    if ($activeField.length) {\n                        searchTerm = $activeField.val() || \"\";\n                    }\n                    \n                    if (!searchTerm || !searchTerm.trim()) {\n                        const $result = jQuery('<span>' + originalText + '<\/span>');\n                        if (data.matchScore !== undefined) {\n                            $result.attr('data-match-score', data.matchScore);\n                        }\n                        return $result;\n                    }\n\n                    \/\/ Normalizar para b\u00fasqueda sin tildes\n                    const normalizedSearch = normalize(searchTerm);\n                    const normalizedText = normalize(originalText);\n                    \n                    \/\/ Dividir t\u00e9rmino en palabras significativas\n                    const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n                    const searchWords = normalizedSearch.split(\/\\s+\/).filter(Boolean).filter(word => {\n                        return word.length > 2 && !stopWords.includes(word);\n                    });\n                    \n                    \/\/ Si no hay palabras significativas, buscar el t\u00e9rmino completo\n                    const wordsToHighlight = searchWords.length > 0 ? searchWords : [normalizedSearch];\n                    \n                    \/\/ Encontrar coincidencias en el texto normalizado y mapear a texto original\n                    const highlightRanges = [];\n                    \n                    wordsToHighlight.forEach(function(word) {\n                        let searchPos = 0;\n                        while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {\n                            const endPos = searchPos + word.length;\n                            \n                            \/\/ Mapear posiciones normalizadas a originales\n                            let origStart = -1;\n                            let origEnd = -1;\n                            let normPos = 0;\n                            \n                            \/\/ Encontrar inicio\n                            for (let i = 0; i < originalText.length && origStart === -1; i++) {\n                                const charNorm = normalize(originalText[i]);\n                                if (normPos === searchPos) {\n                                    origStart = i;\n                                }\n                                normPos += charNorm.length;\n                            }\n                            \n                            \/\/ Encontrar fin\n                            if (origStart >= 0) {\n                                normPos = searchPos;\n                                for (let i = origStart; i < originalText.length; i++) {\n                                    const charNorm = normalize(originalText[i]);\n                                    normPos += charNorm.length;\n                                    if (normPos >= endPos) {\n                                        origEnd = i + 1;\n                                        break;\n                                    }\n                                }\n                                \n                                if (origStart >= 0 && origEnd > origStart) {\n                                    highlightRanges.push({ start: origStart, end: origEnd });\n                                }\n                            }\n                            \n                            searchPos = endPos;\n                        }\n                    });\n                    \n                    \/\/ Fusionar rangos solapados\n                    if (highlightRanges.length > 0) {\n                        highlightRanges.sort((a, b) => a.start - b.start);\n                        const mergedRanges = [highlightRanges[0]];\n                        \n                        for (let i = 1; i < highlightRanges.length; i++) {\n                            const current = highlightRanges[i];\n                            const last = mergedRanges[mergedRanges.length - 1];\n                            \n                            if (current.start <= last.end) {\n                                last.end = Math.max(last.end, current.end);\n                            } else {\n                                mergedRanges.push(current);\n                            }\n                        }\n                        \n                        \/\/ Construir resultado con resaltados\n                        const parts = [];\n                        let lastIndex = 0;\n                        \n                        mergedRanges.forEach(function(range) {\n                            \/\/ Agregar texto antes del rango\n                            if (range.start > lastIndex) {\n                                parts.push(originalText.substring(lastIndex, range.start));\n                            }\n                            \n                            \/\/ Agregar texto resaltado\n                            const matchText = originalText.substring(range.start, range.end);\n                            parts.push('<span style=\"background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;\">' + \n                                       matchText + '<\/span>');\n                            \n                            lastIndex = range.end;\n                        });\n                        \n                        \/\/ Agregar texto restante despu\u00e9s del \u00faltimo rango\n                        if (lastIndex < originalText.length) {\n                            parts.push(originalText.substring(lastIndex));\n                        }\n                        \n                        const result = parts.join('');\n                        \n                        \/\/ Crear elemento jQuery con el HTML renderizado correctamente\n                        const $result = jQuery('<span>').html(result);\n                        \/\/ Agregar atributo data con el score para poder filtrar despu\u00e9s\n                        if (data.matchScore !== undefined) {\n                            $result.attr('data-match-score', data.matchScore);\n                        }\n                        return $result;\n                    }\n                    \n                    \/\/ Si no hay coincidencias, retornar texto sin resaltar\n                    const $result = jQuery('<span>').text(originalText);\n                    if (data.matchScore !== undefined) {\n                        $result.attr('data-match-score', data.matchScore);\n                    }\n                    return $result;\n                }\n            }).on('select2:open', function(e) {\n                const $select = jQuery(this);\n                const $container = $select.next('.select2-container');\n                \n                \/\/ Asegurar que el campo de b\u00fasqueda sea visible\n                setTimeout(function() {\n                    const $dropdown = jQuery('.select2-dropdown');\n                    const $searchContainer = $dropdown.find('.select2-search--dropdown');\n                    const $searchField = $searchContainer.find('.select2-search__field');\n                    \n                    if ($searchField.length) {\n                        \/\/ Forzar actualizaci\u00f3n din\u00e1mica al escribir\n                        $searchField.on('input.select2-dynamic', function() {\n                            const select2Instance = jQuery(e.target).data('select2');\n                            if (select2Instance) {\n                                const term = jQuery(this).val() || '';\n                                select2Instance.dataAdapter.query({ term: term }, function(data) {\n                                    select2Instance.updateResults(data);\n                                    \n                                    \/\/ Despu\u00e9s de actualizar resultados, filtrar si hay coincidencias exactas\n                                    setTimeout(function() {\n                                        const $results = $dropdown.find('.select2-results__options');\n                                        const $items = $results.find('.select2-results__option[role=\"option\"]:not(.select2-results__option--loading)');\n                                        \n                                        if ($items.length > 0) {\n                                            \/\/ Verificar si hay coincidencias exactas (score 10000)\n                                            let hasExactMatch = false;\n                                            $items.each(function() {\n                                                const $item = jQuery(this);\n                                                const $span = $item.find('span[data-match-score]');\n                                                if ($span.length) {\n                                                    const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                    if (score >= 10000) {\n                                                        hasExactMatch = true;\n                                                        return false; \/\/ break\n                                                    }\n                                                }\n                                            });\n                                            \n                                            if (hasExactMatch) {\n                                                \/\/ Ocultar elementos con score < 9500\n                                                $items.each(function() {\n                                                    const $item = jQuery(this);\n                                                    const $span = $item.find('span[data-match-score]');\n                                                    if ($span.length) {\n                                                        const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                        if (score < 9500) {\n                                                            $item.hide();\n                                                        } else {\n                                                            $item.show();\n                                                        }\n                                                    } else {\n                                                        $item.show(); \/\/ Mostrar si no tiene score\n                                                    }\n                                                });\n                                            } else {\n                                                \/\/ Si no hay exactas, verificar si hay muy cercanas (>= 9000)\n                                                let hasVeryClose = false;\n                                                $items.each(function() {\n                                                    const $item = jQuery(this);\n                                                    const $span = $item.find('span[data-match-score]');\n                                                    if ($span.length) {\n                                                        const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                        if (score >= 9000) {\n                                                            hasVeryClose = true;\n                                                            return false; \/\/ break\n                                                        }\n                                                    }\n                                                });\n                                                \n                                                if (hasVeryClose) {\n                                                    \/\/ Mostrar solo las muy cercanas (hasta 5)\n                                                    let count = 0;\n                                                    $items.each(function() {\n                                                        const $item = jQuery(this);\n                                                        const $span = $item.find('span[data-match-score]');\n                                                        if ($span.length) {\n                                                            const score = parseInt($span.attr('data-match-score') || '0', 10);\n                                                            if (score >= 9000 && count < 5) {\n                                                                $item.show();\n                                                                count++;\n                                                            } else {\n                                                                $item.hide();\n                                                            }\n                                                        } else {\n                                                            $item.hide(); \/\/ Ocultar si no tiene score\n                                                        }\n                                                    });\n                                                } else {\n                                                    \/\/ Mostrar todos (hasta 10)\n                                                    let count = 0;\n                                                    $items.each(function() {\n                                                        if (count < 10) {\n                                                            jQuery(this).show();\n                                                            count++;\n                                                        } else {\n                                                            jQuery(this).hide();\n                                                        }\n                                                    });\n                                                }\n                                            }\n                                        }\n                                    }, 150);\n                                });\n                            }\n                        });\n                    }\n                }, 50);\n            });\n        });\n    }\n    <\/script>\n\n    <?php\n    return ob_get_clean();\n}\n\n\/*******************************************************\n * FUNCI\u00d3N: MOSTRAR RESUMEN EDITABLE\n *******************************************************\/\nfunction gofast_mensajero_mostrar_resumen($origen, $destinos) {\n    global $wpdb;\n    \n    \/\/ Obtener negocio_id de la sesi\u00f3n si existe\n    $cotizacion = $_SESSION['gofast_mensajero_cotizacion'] ?? null;\n    $negocio_id = isset($cotizacion['negocio_id']) ? intval($cotizacion['negocio_id']) : 0;\n    $negocio_user_id = isset($cotizacion['negocio_user_id']) ? intval($cotizacion['negocio_user_id']) : null;\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    \/\/ Datos del origen\n    $sector_origen = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $origen)));\n    $nombre_origen = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $origen));\n\n    \/\/ Recargos\n    $recargos_fijos = $wpdb->get_results(\"SELECT id, nombre, valor_fijo FROM recargos WHERE activo = 1 AND tipo = 'fijo'\");\n    $recargo_fijo_por_envio = 0;\n    $recargos_fijos_nombres = [];\n    foreach ((array) $recargos_fijos as $r) {\n        $monto = intval($r->valor_fijo);\n        if ($monto > 0) {\n            $recargo_fijo_por_envio += $monto;\n            $recargos_fijos_nombres[] = $r->nombre;\n        }\n    }\n    \n    \/\/ Recargos seleccionables (por_volumen_peso)\n    $recargos_seleccionables = $wpdb->get_results(\"SELECT id, nombre, valor_fijo FROM recargos WHERE activo = 1 AND tipo = 'por_volumen_peso' ORDER BY nombre ASC\");\n\n    $recargos_variables = $wpdb->get_results(\"SELECT r.id, r.nombre, rr.monto_min, rr.monto_max, rr.recargo FROM recargos r JOIN recargos_rangos rr ON rr.recargo_id = r.id WHERE r.activo = 1 AND r.tipo = 'por_valor' ORDER BY rr.monto_min ASC\");\n    \n    $calcular_recargos_variables = function($valor) use ($recargos_variables) {\n        $valor = intval($valor);\n        $total_variable = 0;\n        foreach ((array) $recargos_variables as $r) {\n            $min = intval($r->monto_min);\n            $max = intval($r->monto_max);\n            $rec = intval($r->recargo);\n            $cumple_min = ($valor >= $min);\n            $cumple_max = ($max <= 0) ? true : ($valor <= $max);\n            if ($cumple_min && $cumple_max && $rec > 0) {\n                $total_variable += $rec;\n            }\n        }\n        return $total_variable;\n    };\n\n    \/\/ Calcular detalle\n    $detalle_envios = [];\n    $total = 0;\n    $lista_recargos = [];\n\n    foreach ($destinos as $dest_id) {\n        $sector_destino = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $dest_id)));\n        $nombre_destino = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $dest_id));\n\n        $precio = $wpdb->get_var($wpdb->prepare(\n            \"SELECT precio FROM tarifas WHERE origen_sector_id=%d AND destino_sector_id=%d\",\n            $sector_origen,\n            $sector_destino\n        ));\n        $precio = $precio ? intval($precio) : 0;\n\n        $recargo_variable = $calcular_recargos_variables($precio);\n        $recargo_total = $recargo_fijo_por_envio + $recargo_variable;\n        \n        \/\/ Recargo seleccionable inicialmente 0 (se puede cambiar en el resumen)\n        $recargo_seleccionable_valor = 0;\n        \n        $total_trayecto = $precio + $recargo_total + $recargo_seleccionable_valor;\n        $total += $total_trayecto;\n\n        $detalle_envios[] = [\n            'id' => $dest_id,\n            'nombre' => $nombre_destino,\n            'precio' => $precio,\n            'recargo' => $recargo_total,\n            'recargo_seleccionable' => $recargo_seleccionable_valor,\n            'total' => $total_trayecto,\n        ];\n    }\n\n    \/\/ Lista de recargos \u00fanicos\n    foreach ($recargos_fijos_nombres as $nombre) {\n        if (!in_array($nombre, $lista_recargos, true)) {\n            $lista_recargos[] = $nombre;\n        }\n    }\n\n    \/\/ Obtener todos los barrios para agregar nuevos\n    $barrios_all = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n\n    ob_start();\n    ?>\n\n    <div class=\"gofast-checkout-wrapper\">\n        <div class=\"gofast-box\" style=\"max-width:800px;margin:0 auto;\">\n            \n            <div style=\"background:#e3f2fd;border-left:4px solid #2196F3;padding:12px;margin-bottom:20px;border-radius:8px;\">\n                <strong>\ud83d\ude9a Resumen del Servicio<\/strong><br>\n                <small>Puedes eliminar destinos o agregar nuevos antes de aceptar.<\/small>\n            <\/div>\n\n            <h3 style=\"margin-top:0;\">\ud83d\udccd Origen: <?= esc_html($nombre_origen) ?><\/h3>\n\n            <div id=\"destinos-resumen\">\n                <?php foreach ($detalle_envios as $idx => $d): ?>\n                    <div class=\"gofast-destino-resumen-item\" \n                         data-destino-id=\"<?= esc_attr($d['id']) ?>\"\n                         data-precio=\"<?= esc_attr($d['precio']) ?>\"\n                         data-recargo=\"<?= esc_attr($d['recargo']) ?>\"\n                         data-recargo-seleccionable=\"<?= esc_attr($d['recargo_seleccionable'] ?? 0) ?>\"\n                         data-recargo-seleccionable-id=\"<?= esc_attr($d['recargo_seleccionable_id'] ?? '') ?>\"\n                         data-total=\"<?= esc_attr($d['total']) ?>\">\n                        <div style=\"padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;border-left:4px solid #F4C524;\">\n                            <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;\">\n                                <div style=\"flex:1;\">\n                                    <strong>\ud83c\udfaf <?= esc_html($d['nombre']) ?><\/strong>\n                                    <?php if (!empty($d['recargo_seleccionable_id']) && !empty($d['recargo_seleccionable'])): ?>\n                                        <span style=\"background:#4CAF50;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:8px;font-weight:normal;\">\n                                            \u2b50 Con recargo adicional\n                                        <\/span>\n                                    <?php endif; ?>\n                                    <br>\n                                    <small style=\"color:#666;\">\n                                        Base: $<?= number_format($d['precio'], 0, ',', '.') ?> | \n                                        Recargo autom\u00e1tico: $<?= number_format($d['recargo'], 0, ',', '.') ?>\n                                        <?php if (!empty($d['recargo_seleccionable_id']) && !empty($d['recargo_seleccionable'])): ?>\n                                            | <strong style=\"color:#4CAF50;\">Recargo adicional: $<?= number_format($d['recargo_seleccionable'], 0, ',', '.') ?><\/strong>\n                                        <?php endif; ?>\n                                    <\/small>\n                                <\/div>\n                                <button type=\"button\" class=\"gofast-btn-delete\" onclick=\"eliminarDestinoResumen(<?= esc_attr($d['id']) ?>)\" style=\"margin-left:12px;padding:8px 12px;\">\n                                    \u274c Eliminar\n                                <\/button>\n                            <\/div>\n                            <?php if (!empty($recargos_seleccionables)): ?>\n                                <div style=\"margin-top:8px;padding-top:8px;border-top:1px solid #ddd;\">\n                                    <label style=\"display:block;margin-bottom:4px;font-size:13px;color:#666;\">\n                                        <strong>\u2795 Recargo adicional (opcional):<\/strong>\n                                    <\/label>\n                                    <select name=\"recargo_seleccionable[<?= esc_attr($d['id']) ?>]\" \n                                            class=\"recargo-seleccionable-select\" \n                                            data-destino-id=\"<?= esc_attr($d['id']) ?>\"\n                                            style=\"width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:14px;\">\n                                        <option value=\"\">Sin recargo adicional<\/option>\n                                        <?php foreach ($recargos_seleccionables as $rs): ?>\n                                            <option value=\"<?= esc_attr($rs->id) ?>\" \n                                                    data-valor=\"<?= esc_attr($rs->valor_fijo) ?>\"\n                                                    data-nombre=\"<?= esc_attr($rs->nombre) ?>\"\n                                                    <?= (isset($d['recargo_seleccionable_id']) && $d['recargo_seleccionable_id'] == $rs->id) ? 'selected' : '' ?>>\n                                                <?= esc_html($rs->nombre) ?> (+$<?= number_format($rs->valor_fijo, 0, ',', '.') ?>)\n                                            <\/option>\n                                        <?php endforeach; ?>\n                                    <\/select>\n                                <\/div>\n                            <?php endif; ?>\n                            <div style=\"margin-top:8px;text-align:right;\">\n                                <strong style=\"color:#4CAF50;font-size:18px;\" class=\"destino-total-display\">\n                                    $<?= number_format($d['total'], 0, ',', '.') ?>\n                                <\/strong>\n                            <\/div>\n                        <\/div>\n                    <\/div>\n                <?php endforeach; ?>\n            <\/div>\n\n            <?php if (!empty($lista_recargos)): ?>\n                <div class=\"gofast-recargo-box\" style=\"margin:16px 0;\">\n                    \ud83d\udfe1 <b>Recargos aplicados:<\/b><br>\n                    <ul style=\"margin:8px 0 0 20px;\">\n                        <?php foreach ($lista_recargos as $nombre): ?>\n                            <li><?= esc_html($nombre) ?><\/li>\n                        <?php endforeach; ?>\n                    <\/ul>\n                <\/div>\n            <?php endif; ?>\n\n            <div class=\"gofast-total-box\" style=\"margin:20px 0;text-align:center;\" id=\"total-box\">\n                \ud83d\udcb0 <strong style=\"font-size:24px;\" id=\"total-amount\">Total: $<?= number_format($total, 0, ',', '.') ?><\/strong>\n            <\/div>\n\n            <!-- Agregar nuevo destino -->\n            <div style=\"background:#f8f9fa;padding:16px;border-radius:8px;margin:20px 0;\">\n                <label><strong>\u2795 Agregar nuevo destino<\/strong><\/label>\n                <select id=\"nuevo-destino-select\" class=\"gofast-select\" style=\"margin-top:8px;\">\n                    <option value=\"\">Seleccionar barrio...<\/option>\n                    <?php foreach ($barrios_all as $b): ?>\n                        <option value=\"<?= esc_attr($b->id) ?>\" data-nombre=\"<?= esc_attr($b->nombre) ?>\">\n                            <?= esc_html($b->nombre) ?>\n                        <\/option>\n                    <?php endforeach; ?>\n                <\/select>\n                <button type=\"button\" id=\"btn-agregar-destino-resumen\" class=\"gofast-btn-mini\" style=\"margin-top:8px;width:100%;\">\n                    \u2795 Agregar destino\n                <\/button>\n            <\/div>\n\n            <!-- Formulario oculto para enviar -->\n            <form method=\"post\" id=\"form-aceptar-rechazar\">\n                <input type=\"hidden\" name=\"origen\" id=\"input-origen\" value=\"<?= esc_attr($origen) ?>\">\n                <input type=\"hidden\" name=\"destinos_finales\" id=\"input-destinos\" value=\"<?= esc_attr(implode(',', array_column($detalle_envios, 'id'))) ?>\">\n                <!-- Los recargos seleccionables se agregar\u00e1n din\u00e1micamente con JavaScript -->\n\n                <div class=\"gofast-btn-group\" style=\"margin-top:24px;\">\n                    <button type=\"submit\" name=\"gofast_mensajero_aceptar\" class=\"gofast-btn-request\" style=\"background:#4CAF50;color:#fff;\">\n                        \u2705 Aceptar y crear servicio\n                    <\/button>\n                    <button type=\"submit\" name=\"gofast_mensajero_rechazar\" class=\"gofast-btn-action gofast-secondary\">\n                        \u274c Rechazar y volver\n                    <\/button>\n                <\/div>\n            <\/form>\n\n        <\/div>\n    <\/div>\n\n    <script>\n    \/\/ Proteger contra errores de toggleOtro si se ejecuta desde otro archivo\n    (function() {\n        const tipoSelectExists = document.getElementById(\"tipo_negocio\");\n        const wrapperOtroExists = document.getElementById(\"tipo_otro_wrapper\");\n        \n        \/\/ Si los elementos no existen, crear una funci\u00f3n segura desde el inicio\n        if (!tipoSelectExists || !wrapperOtroExists) {\n            if (typeof window.toggleOtro === 'undefined') {\n                window.toggleOtro = function() {\n                    \/\/ Funci\u00f3n vac\u00eda segura - no hacer nada\n                    return;\n                };\n            } else if (typeof window.toggleOtro === 'function') {\n                \/\/ Si existe y los elementos no est\u00e1n presentes, proteger la funci\u00f3n\n                const originalToggleOtro = window.toggleOtro;\n                window.toggleOtro = function() {\n                    try {\n                        const tipoSelect = document.getElementById(\"tipo_negocio\");\n                        const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                        if (tipoSelect && wrapperOtro && tipoSelect.parentNode && wrapperOtro.parentNode) {\n                            return originalToggleOtro();\n                        }\n                    } catch(e) {\n                        \/\/ Silenciar error completamente\n                        return;\n                    }\n                };\n            }\n        }\n        \n        \/\/ Tambi\u00e9n prevenir que setTimeout ejecute toggleOtro si no est\u00e1n los elementos\n        const originalSetTimeout = window.setTimeout;\n        window.setTimeout = function(func, delay) {\n            if (typeof func === 'function') {\n                const funcStr = func.toString();\n                if (funcStr.includes('toggleOtro')) {\n                    const tipoSelect = document.getElementById(\"tipo_negocio\");\n                    const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                    if (!tipoSelect || !wrapperOtro) {\n                        return null; \/\/ No ejecutar si no existen los elementos\n                    }\n                }\n            }\n            return originalSetTimeout.apply(this, arguments);\n        };\n    })();\n    \n    \/\/ Datos para JavaScript\n    const datosResumen = {\n        origen: <?= json_encode($origen) ?>,\n        sector_origen: <?= json_encode($sector_origen) ?>,\n        recargo_fijo: <?= json_encode($recargo_fijo_por_envio) ?>,\n        recargos_variables: <?= json_encode(array_map(function($r) {\n            return [\n                'min' => intval($r->monto_min),\n                'max' => intval($r->monto_max),\n                'recargo' => intval($r->recargo)\n            ];\n        }, $recargos_variables)) ?>\n    };\n    \n    \/\/ Mapa de barrios con sus sectores (para c\u00e1lculo r\u00e1pido)\n    const barriosMap = <?= json_encode(array_map(function($b) use ($wpdb) {\n        $sector = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $b->id)));\n        return ['id' => $b->id, 'nombre' => $b->nombre, 'sector_id' => $sector];\n    }, $barrios_all)) ?>;\n    \n    \/\/ Mapa de tarifas (origen_sector -> destino_sector -> precio)\n    const tarifasMap = {};\n    <?php\n    $tarifas_all = $wpdb->get_results(\"SELECT origen_sector_id, destino_sector_id, precio FROM tarifas\");\n    foreach ($tarifas_all as $t) {\n        if (!isset($tarifasMap[$t->origen_sector_id])) {\n            $tarifasMap[$t->origen_sector_id] = [];\n        }\n        $tarifasMap[$t->origen_sector_id][$t->destino_sector_id] = intval($t->precio);\n    }\n    ?>\n    const tarifasData = <?= json_encode($tarifasMap) ?>;\n    \n    document.addEventListener('DOMContentLoaded', function(){\n        \/\/ Inicializar Select2 para nuevo destino\n        if (window.jQuery && jQuery.fn.select2) {\n            jQuery('#nuevo-destino-select').select2({\n                placeholder: '\ud83d\udd0d Buscar barrio...',\n                width: '100%',\n                dropdownParent: jQuery('body'),\n                minimumResultsForSearch: 0,\n            });\n        }\n\n        \/\/ Agregar nuevo destino\n        const btnAgregar = document.getElementById('btn-agregar-destino-resumen');\n        if (btnAgregar) {\n            btnAgregar.addEventListener('click', function(){\n                const select = document.getElementById('nuevo-destino-select');\n                const destinoId = parseInt(select.value);\n                \n                if (!destinoId) {\n                    alert('Selecciona un destino primero');\n                    return;\n                }\n                \n                \/\/ Agregar destino (recargar para calcular correctamente)\n                agregarDestinoResumen(destinoId);\n            });\n        }\n    });\n\n    function eliminarDestinoResumen(destinoId) {\n        if (!confirm('\u00bfEliminar este destino del resumen?')) return;\n        \n        const item = document.querySelector('[data-destino-id=\\\"' + destinoId + '\\\"]');\n        if (item) {\n            item.remove();\n            actualizarDestinosInput();\n            recalcularTotalJS();\n        }\n    }\n\n    function agregarDestinoResumen(destinoId) {\n        \/\/ Recargar p\u00e1gina con nuevo destino agregado (m\u00e1s confiable para recargos variables)\n        const form = document.createElement('form');\n        form.method = 'POST';\n        form.action = '';\n        \n        const inputOrigen = document.createElement('input');\n        inputOrigen.type = 'hidden';\n        inputOrigen.name = 'origen';\n        const origenInput = document.getElementById('input-origen');\n        if (origenInput) {\n            inputOrigen.value = origenInput.value;\n            form.appendChild(inputOrigen);\n        }\n        \n        \/\/ Agregar todos los destinos actuales\n        const destinosActuales = obtenerDestinosActuales();\n        destinosActuales.forEach(function(id) {\n            const input = document.createElement('input');\n            input.type = 'hidden';\n            input.name = 'destino[]';\n            input.value = id;\n            form.appendChild(input);\n        });\n        \n        \/\/ Agregar el nuevo destino\n        const nuevoDestinoInput = document.createElement('input');\n        nuevoDestinoInput.type = 'hidden';\n        nuevoDestinoInput.name = 'destino[]';\n        nuevoDestinoInput.value = destinoId.toString();\n        form.appendChild(nuevoDestinoInput);\n        \n        \/\/ Agregar recargos seleccionables actuales para preservarlos\n        document.querySelectorAll('.recargo-seleccionable-select').forEach(function(select) {\n            const destinoIdSelect = select.getAttribute('data-destino-id');\n            const recargoId = select.value;\n            if (destinoIdSelect && recargoId && recargoId !== '') {\n                const input = document.createElement('input');\n                input.type = 'hidden';\n                input.name = 'recargo_seleccionable[' + destinoIdSelect + ']';\n                input.value = recargoId;\n                form.appendChild(input);\n            }\n        });\n        \n        const submit = document.createElement('input');\n        submit.type = 'hidden';\n        submit.name = 'gofast_mensajero_cotizar';\n        submit.value = '1';\n        form.appendChild(submit);\n        \n        document.body.appendChild(form);\n        form.submit();\n    }\n\n    function obtenerDestinosActuales() {\n        const items = document.querySelectorAll('.gofast-destino-resumen-item[data-destino-id]');\n        const ids = [];\n        items.forEach(function(item) {\n            const id = item.getAttribute('data-destino-id');\n            if (id && id !== 'null' && id !== 'undefined') {\n                ids.push(id);\n            }\n        });\n        return ids;\n    }\n\n    function actualizarDestinosInput() {\n        const destinos = obtenerDestinosActuales();\n        document.getElementById('input-destinos').value = destinos.join(',');\n    }\n\n    function recalcularTotalJS() {\n        const items = document.querySelectorAll('.gofast-destino-resumen-item');\n        let total = 0;\n        \n        items.forEach(function(item) {\n            const precioBase = parseFloat(item.getAttribute('data-precio')) || 0;\n            const recargoAuto = parseFloat(item.getAttribute('data-recargo')) || 0;\n            const recargoSeleccionable = parseFloat(item.getAttribute('data-recargo-seleccionable')) || 0;\n            const itemTotal = precioBase + recargoAuto + recargoSeleccionable;\n            total += itemTotal;\n            \n            \/\/ Actualizar display del total del destino\n            const totalDisplay = item.querySelector('.destino-total-display');\n            if (totalDisplay) {\n                totalDisplay.textContent = '$' + itemTotal.toLocaleString('es-CO');\n            }\n        });\n        \n        \/\/ Actualizar total en pantalla\n        const totalBox = document.getElementById('total-amount');\n        if (totalBox) {\n            totalBox.textContent = 'Total: $' + total.toLocaleString('es-CO');\n        }\n        \n        \/\/ Validar que haya al menos un destino\n        if (items.length === 0) {\n            alert('Debes tener al menos un destino');\n            \/\/ Recargar para volver al paso 1\n            window.location.href = '<?= esc_url(home_url('\/mensajero-cotizar')) ?>';\n        }\n    }\n    \n    \/\/ Manejar cambio de recargo seleccionable\n    document.addEventListener('change', function(e) {\n        if (e.target.classList.contains('recargo-seleccionable-select')) {\n            const select = e.target;\n            const destinoId = select.getAttribute('data-destino-id');\n            const item = document.querySelector('[data-destino-id=\"' + destinoId + '\"]');\n            \n            if (item) {\n                const option = select.options[select.selectedIndex];\n                const valor = option ? parseFloat(option.getAttribute('data-valor') || 0) : 0;\n                const recargoId = select.value || '';\n                item.setAttribute('data-recargo-seleccionable', valor);\n                item.setAttribute('data-recargo-seleccionable-id', recargoId);\n                recalcularTotalJS();\n            }\n        }\n    });\n    \n    \/\/ Agregar recargos seleccionables al formulario antes de enviar\n    const formAceptar = document.getElementById('form-aceptar-rechazar');\n    if (formAceptar) {\n        formAceptar.addEventListener('submit', function(e) {\n            const form = this;\n            \n            \/\/ Eliminar inputs de recargos anteriores si existen\n            form.querySelectorAll('input[name^=\"recargo_seleccionable\"]').forEach(function(input) {\n                input.remove();\n            });\n            \n            \/\/ Agregar recargos seleccionables actuales\n            document.querySelectorAll('.recargo-seleccionable-select').forEach(function(select) {\n                const destinoId = select.getAttribute('data-destino-id');\n                const recargoId = select.value;\n                if (destinoId && recargoId && recargoId !== '') {\n                    const input = document.createElement('input');\n                    input.type = 'hidden';\n                    input.name = 'recargo_seleccionable[' + destinoId + ']';\n                    input.value = recargoId;\n                    form.appendChild(input);\n                }\n            });\n        });\n    }\n    <\/script>\n\n    <?php\n    return ob_get_clean();\n}\n\nadd_shortcode('gofast_mensajero_cotizar', 'gofast_mensajero_cotizar_shortcode');\n\n","active":true,"modified":"2025-12-11 20:40:50","revision":"1"}]}