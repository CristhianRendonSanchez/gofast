{
  "generator": "Code Snippets v3.9.2",
  "date_created": "2025-11-21 22:43",
  "snippets": [
    {
      "id": 23,
      "name": "gofast_pedidos",
      "code": "/*******************************************************\n * GOFAST ‚Äì LISTADO DE PEDIDOS (CLIENTE / ADMIN / MENSAJERO)\n * Shortcode: [gofast_pedidos]\n * URL: /mis-pedidos\n *******************************************************/\nfunction gofast_pedidos_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    if (empty($_SESSION['gofast_user_id'])) {\n        return \"<div class='gofast-box'>Debes iniciar sesi√≥n para ver tus pedidos.</div>\";\n    }\n\n    $user_id = (int) $_SESSION['gofast_user_id'];\n    $rol     = strtolower($_SESSION['gofast_user_rol'] ?? 'cliente');\n\n    $mensaje_estado = '';\n\n    // Lista de mensajeros (solo para admin)\n    $mensajeros = [];\n    if ($rol === 'admin') {\n        $mensajeros = $wpdb->get_results(\"\n            SELECT id, nombre \n            FROM usuarios_gofast\n            WHERE rol = 'mensajero' AND activo = 1\n            ORDER BY nombre ASC\n        \");\n    }\n\n    /****************************************\n     * 0. GESTI√ìN DE CAMBIO DE ESTADO / MENSAJERO (POST)\n     ****************************************/\n    if (\n        !empty($_POST['gofast_estado_id']) &&\n        !empty($_POST['gofast_estado_nonce']) &&\n        wp_verify_nonce($_POST['gofast_estado_nonce'], 'gofast_cambiar_estado')\n    ) {\n        $pedido_id = (int) $_POST['gofast_estado_id'];\n\n        $pedido = $wpdb->get_row(\n            $wpdb->prepare(\"SELECT * FROM servicios_gofast WHERE id = %d\", $pedido_id)\n        );\n\n        if (!$pedido) {\n            $mensaje_estado = 'Pedido no encontrado.';\n        } else {\n            $estados_validos = ['pendiente','asignado','en_ruta','entregado','cancelado'];\n\n            // Estado nuevo (si viene en POST, si no, se deja igual)\n            $nuevo_estado = $pedido->tracking_estado;\n            if (!empty($_POST['gofast_estado_nuevo'])) {\n                $tmp_estado = sanitize_text_field($_POST['gofast_estado_nuevo']);\n                if (in_array($tmp_estado, $estados_validos, true)) {\n                    $nuevo_estado = $tmp_estado;\n                } else {\n                    $mensaje_estado = 'Estado no v√°lido.';\n                }\n            }\n\n            // Mensajero nuevo\n            $nuevo_mensajero_id = $pedido->mensajero_id;\n\n            if ($rol === 'admin') {\n                // Admin puede asignar cualquier mensajero\n                if (isset($_POST['gofast_mensajero_id'])) {\n                    $tmp_m = (int) $_POST['gofast_mensajero_id'];\n                    $nuevo_mensajero_id = $tmp_m > 0 ? $tmp_m : null;\n                }\n            } elseif ($rol === 'mensajero') {\n                // Mensajero se auto-asigna si el pedido no tiene mensajero y est√° tocando el estado\n                if (empty($pedido->mensajero_id) && !empty($_POST['gofast_estado_nuevo'])) {\n                    $nuevo_mensajero_id = $user_id;\n                }\n            }\n\n            // Permisos\n            $puede = false;\n            if ($rol === 'admin') {\n                $puede = true;\n            } elseif ($rol === 'mensajero') {\n                // puede tocar pendientes o los suyos\n                if ($pedido->tracking_estado === 'pendiente' || (int) $pedido->mensajero_id === $user_id) {\n                    $puede = true;\n                }\n            } else {\n                $puede = false;\n            }\n\n            if (!$puede) {\n                $mensaje_estado = 'No tienes permisos para modificar este pedido.';\n            } else {\n                $data = [];\n\n                if ($nuevo_estado !== $pedido->tracking_estado) {\n                    $data['tracking_estado'] = $nuevo_estado;\n                }\n\n                // Comparaci√≥n con null/int\n                if ((string) $nuevo_mensajero_id !== (string) $pedido->mensajero_id) {\n                    $data['mensajero_id'] = $nuevo_mensajero_id;\n                }\n\n                if (!empty($data)) {\n                    $ok = $wpdb->update('servicios_gofast', $data, ['id' => $pedido_id]);\n                    if ($ok === false) {\n                        $mensaje_estado = 'Error al actualizar: ' . esc_html($wpdb->last_error);\n                    } else {\n                        $mensaje_estado = 'Pedido actualizado correctamente.';\n                    }\n                }\n            }\n        }\n    }\n\n    /****************************************\n     * 1. Filtros (GET)\n     ****************************************/\n    $estado = isset($_GET['estado']) ? sanitize_text_field($_GET['estado']) : '';\n    $buscar = isset($_GET['q'])      ? sanitize_text_field($_GET['q'])      : '';\n    $desde  = isset($_GET['desde'])  ? sanitize_text_field($_GET['desde'])  : '';\n    $hasta  = isset($_GET['hasta'])  ? sanitize_text_field($_GET['hasta'])  : '';\n\n    if ($desde && !preg_match('/^\\d{4}-\\d{2}-\\d{2}$/', $desde)) $desde = '';\n    if ($hasta && !preg_match('/^\\d{4}-\\d{2}-\\d{2}$/', $hasta)) $hasta = '';\n\n    /****************************************\n     * 2. WHERE seg√∫n rol\n     ****************************************/\n    $where  = \"1=1\";\n    $params = [];\n\n    if ($rol === 'admin') {\n        // ve todo\n    } elseif ($rol === 'mensajero') {\n        $where   .= \" AND (tracking_estado = %s OR mensajero_id = %d)\";\n        $params[] = 'pendiente';\n        $params[] = $user_id;\n    } else {\n        $where   .= \" AND user_id = %d\";\n        $params[] = $user_id;\n    }\n\n    if ($estado !== '' && $estado !== 'todos') {\n        $where   .= \" AND tracking_estado = %s\";\n        $params[] = $estado;\n    }\n\n    // b√∫squeda por nombre o tel√©fono\n    if ($buscar !== '') {\n        $like = '%' . $wpdb->esc_like($buscar) . '%';\n        $where   .= \" AND (nombre_cliente LIKE %s OR telefono_cliente LIKE %s)\";\n        $params[] = $like;\n        $params[] = $like;\n    }\n\n    if ($desde !== '') {\n        $where   .= \" AND fecha >= %s\";\n        $params[] = $desde . ' 00:00:00';\n    }\n    if ($hasta !== '') {\n        $where   .= \" AND fecha <= %s\";\n        $params[] = $hasta . ' 23:59:59';\n    }\n\n    /****************************************\n     * 3. Paginaci√≥n\n     ****************************************/\n    $por_pagina = 15;\n    $pagina     = isset($_GET['pg']) ? max(1, (int) $_GET['pg']) : 1;\n    $offset     = ($pagina - 1) * $por_pagina;\n\n    if (!empty($params)) {\n        $sql_count = $wpdb->prepare(\n            \"SELECT COUNT(*) FROM servicios_gofast WHERE $where\",\n            $params\n        );\n    } else {\n        $sql_count = \"SELECT COUNT(*) FROM servicios_gofast WHERE $where\";\n    }\n\n    $total_registros = (int) $wpdb->get_var($sql_count);\n    $total_paginas   = max(1, (int) ceil($total_registros / $por_pagina));\n\n    $params_datos   = $params;\n    $params_datos[] = $por_pagina;\n    $params_datos[] = $offset;\n\n    $sql_datos = $wpdb->prepare(\n        \"SELECT * FROM servicios_gofast \n         WHERE $where\n         ORDER BY fecha DESC\n         LIMIT %d OFFSET %d\",\n        $params_datos\n    );\n\n    $pedidos = $wpdb->get_results($sql_datos);\n\n    // opciones de estado reutilizables\n    $estado_opts = [\n        'pendiente' => 'Pendiente',\n        'asignado'  => 'Asignado',\n        'en_ruta'   => 'En Ruta',\n        'entregado' => 'Entregado',\n        'cancelado' => 'Cancelado',\n    ];\n\n    /****************************************\n     * 4. Render\n     ****************************************/\n    ob_start();\n    ?>\n\n<div class=\"gofast-home\">\n    <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;\">\n        <div>\n            <h1 style=\"margin-bottom:8px;\">üì¶ Pedidos</h1>\n            <p class=\"gofast-home-text\" style=\"margin:0;\">\n                <?php if ($rol === 'admin'): ?>\n                    Gestiona todos los pedidos del sistema.\n                <?php elseif ($rol === 'mensajero'): ?>\n                    Pedidos pendientes y asignados a ti.\n                <?php else: ?>\n                    Tus pedidos y servicios solicitados.\n                <?php endif; ?>\n            </p>\n        </div>\n        <?php if ($rol === 'admin'): ?>\n            <a href=\"<?php echo esc_url( home_url('/dashboard-admin') ); ?>\" class=\"gofast-btn-request\" style=\"text-decoration:none;white-space:nowrap;\">\n                ‚Üê Volver al Dashboard\n            </a>\n        <?php endif; ?>\n    </div>\n\n    <div class=\"gofast-box\">\n        <?php if ($mensaje_estado): ?>\n            <div class=\"gofast-alert-info\" style=\"margin-bottom:16px;\">\n                <?php echo esc_html($mensaje_estado); ?>\n            </div>\n        <?php endif; ?>\n\n        <!-- Filtros -->\n        <form method=\"get\" class=\"gofast-pedidos-filtros\">\n            <div class=\"gofast-pedidos-filtros-row\">\n                <div>\n                    <label>Estado</label>\n                    <select name=\"estado\">\n                        <option value=\"todos\"<?php selected($estado, 'todos'); ?>>Todos</option>\n                        <?php foreach ($estado_opts as $val => $label): ?>\n                            <option value=\"<?php echo esc_attr($val); ?>\"<?php selected($estado, $val); ?>>\n                                <?php echo esc_html($label); ?>\n                            </option>\n                        <?php endforeach; ?>\n                    </select>\n                </div>\n\n                <div>\n                    <label>Nombre / Tel√©fono</label>\n                    <input type=\"text\" name=\"q\" placeholder=\"Ej: Juan o 300...\" value=\"<?php echo esc_attr($buscar); ?>\">\n                </div>\n\n                <div>\n                    <label>Desde</label>\n                    <input type=\"date\" name=\"desde\" value=\"<?php echo esc_attr($desde); ?>\">\n                </div>\n\n                <div>\n                    <label>Hasta</label>\n                    <input type=\"date\" name=\"hasta\" value=\"<?php echo esc_attr($hasta); ?>\">\n                </div>\n\n                <div class=\"gofast-pedidos-filtros-actions\">\n                    <button type=\"submit\" class=\"gofast-btn-mini\">Filtrar</button>\n                    <a href=\"<?php echo esc_url( get_permalink() ); ?>\" class=\"gofast-btn-mini gofast-btn-outline\">Limpiar</a>\n                </div>\n            </div>\n        </form>\n\n        <?php if ($total_registros === 0): ?>\n            <p style=\"margin-top:20px;text-align:center;color:#666;\">No se encontraron pedidos con los filtros seleccionados.</p>\n        <?php else: ?>\n\n            <div class=\"gofast-table-wrap\" style=\"margin-top:20px;\">\n                <table class=\"gofast-table\">\n                    <thead>\n                        <tr>\n                            <th>#</th>\n                            <th>Fecha</th>\n                            <th>Cliente</th>\n                            <th>Tel√©fono</th>\n                            <th>Origen</th>\n                            <th>Destinos</th>\n                            <th>Mensajero</th>\n                            <th>Total</th>\n                            <th>Estado</th>\n                            <th>Ver</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                    <?php foreach ($pedidos as $p):\n\n                        // Decodificar JSON\n                        $origen_barrio   = '';\n                        $destinos_barris = [];\n\n                        if (!empty($p->destinos)) {\n                            $json = json_decode($p->destinos, true);\n                            if (is_array($json)) {\n                                if (!empty($json['origen']['barrio_nombre'])) {\n                                    $origen_barrio = $json['origen']['barrio_nombre'];\n                                }\n                                if (!empty($json['destinos']) && is_array($json['destinos'])) {\n                                    foreach ($json['destinos'] as $d) {\n                                        if (!empty($d['barrio_nombre'])) {\n                                            $destinos_barris[] = $d['barrio_nombre'];\n                                        }\n                                    }\n                                }\n                            }\n                        }\n\n                        if ($origen_barrio === '') {\n                            $origen_barrio = $p->direccion_origen ?: '‚Äî';\n                        }\n                        $destinos_text = !empty($destinos_barris)\n                            ? implode(', ', array_unique($destinos_barris))\n                            : '‚Äî';\n\n                        // Mensajero (solo texto por defecto)\n                        $mensajero_nombre = '‚Äî';\n                        if (!empty($p->mensajero_id)) {\n                            $mensajero_nombre = $wpdb->get_var(\n                                $wpdb->prepare(\n                                    \"SELECT nombre FROM usuarios_gofast WHERE id = %d\",\n                                    $p->mensajero_id\n                                )\n                            ) ?: '‚Äî';\n                        }\n\n                        $estado_actual = $p->tracking_estado;\n                        $estado_class  = 'gofast-badge-estado-' . esc_attr($estado_actual);\n                        $detalle_url   = esc_url( home_url('/servicio-registrado?id=' . $p->id) );\n                        ?>\n                        <tr>\n                            <td>#<?php echo (int) $p->id; ?></td>\n                            <td><?php echo esc_html( date_i18n('Y-m-d H:i', strtotime($p->fecha)) ); ?></td>\n                            <td><?php echo esc_html($p->nombre_cliente ?: '‚Äî'); ?></td>\n                            <td><?php echo esc_html($p->telefono_cliente ?: '‚Äî'); ?></td>\n\n                            <td><?php echo esc_html($origen_barrio); ?></td>\n                            <td><?php echo esc_html($destinos_text); ?></td>\n\n                            <!-- Mensajero -->\n                            <td>\n                                <?php if ($rol === 'admin'): ?>\n                                    <form method=\"post\" class=\"gofast-estado-form\">\n                                        <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                        <input type=\"hidden\" name=\"gofast_estado_id\" value=\"<?php echo (int) $p->id; ?>\">\n                                        <!-- mantener estado actual para que no cambie si solo se asigna mensajero -->\n                                        <input type=\"hidden\" name=\"gofast_estado_nuevo\" value=\"<?php echo esc_attr($estado_actual); ?>\">\n\n                                        <select name=\"gofast_mensajero_id\" class=\"gofast-mensajero-select\" onchange=\"this.form.submit()\">\n                                            <option value=\"\">Sin asignar</option>\n                                            <?php foreach ($mensajeros as $m): ?>\n                                                <option value=\"<?php echo (int) $m->id; ?>\"<?php selected($p->mensajero_id, $m->id); ?>>\n                                                    <?php echo esc_html($m->nombre); ?>\n                                                </option>\n                                            <?php endforeach; ?>\n                                        </select>\n                                    </form>\n                                <?php else: ?>\n                                    <?php echo esc_html($mensajero_nombre); ?>\n                                <?php endif; ?>\n                            </td>\n\n                            <!-- Total -->\n                            <td>$<?php echo number_format($p->total, 0, ',', '.'); ?></td>\n\n                            <!-- Estado -->\n                            <td>\n                                <?php if ($rol === 'admin' || $rol === 'mensajero'): ?>\n                                    <form method=\"post\" class=\"gofast-estado-form\">\n                                        <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                        <input type=\"hidden\" name=\"gofast_estado_id\" value=\"<?php echo (int) $p->id; ?>\">\n                                        <!-- si hay mensajero, lo mantenemos; para mensajero auto-asignado ya lo pone el backend -->\n                                        <?php if ($rol === 'admin' && !empty($p->mensajero_id)): ?>\n                                            <input type=\"hidden\" name=\"gofast_mensajero_id\" value=\"<?php echo (int) $p->mensajero_id); ?>\">\n                                        <?php endif; ?>\n\n                                        <select name=\"gofast_estado_nuevo\" onchange=\"this.form.submit()\">\n                                            <?php foreach ($estado_opts as $val => $label): ?>\n                                                <option value=\"<?php echo esc_attr($val); ?>\"<?php selected($estado_actual, $val); ?>>\n                                                    <?php echo esc_html($label); ?>\n                                                </option>\n                                            <?php endforeach; ?>\n                                        </select>\n                                    </form>\n                                <?php else: ?>\n                                    <span class=\"gofast-badge-estado <?php echo $estado_class; ?>\">\n                                        <?php echo esc_html($estado_opts[$estado_actual] ?? $estado_actual); ?>\n                                    </span>\n                                <?php endif; ?>\n                            </td>\n\n                            <td><a href=\"<?php echo $detalle_url; ?>\" class=\"gofast-link-ver\">Ver</a></td>\n                        </tr>\n                    <?php endforeach; ?>\n                    </tbody>\n                </table>\n            </div>\n\n            <?php if ($total_paginas > 1): ?>\n                <div class=\"gofast-pagination\" style=\"margin-top:20px;\">\n                    <?php\n                    $base_url   = get_permalink();\n                    $query_args = $_GET;\n\n                    for ($i = 1; $i <= $total_paginas; $i++):\n                        $query_args['pg'] = $i;\n                        $url    = esc_url( add_query_arg($query_args, $base_url) );\n                        $active = ($i === $pagina) ? 'gofast-page-current' : '';\n                        ?>\n                        <a href=\"<?php echo $url; ?>\" class=\"gofast-page-link <?php echo $active; ?>\">\n                            <?php echo $i; ?>\n                        </a>\n                    <?php endfor; ?>\n                </div>\n            <?php endif; ?>\n\n        <?php endif; ?>\n    </div>\n</div>\n\n<?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_pedidos', 'gofast_pedidos_shortcode');\n",
      "active": true,
      "modified": "2025-11-21 22:43",
      "revision": "1"
    }
  ]
}
