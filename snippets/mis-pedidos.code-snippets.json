{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":23,"name":"mis-pedidos","code":"\/*******************************************************\n * GOFAST \u2013 LISTADO DE PEDIDOS (CLIENTE \/ ADMIN \/ MENSAJERO)\n * Shortcode: [gofast_pedidos]\n *******************************************************\/\nfunction gofast_pedidos_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    if (empty($_SESSION['gofast_user_id'])) {\n        return \"<div class='gofast-box'>Debes iniciar sesi\u00f3n para ver tus pedidos.<\/div>\";\n    }\n\n    $user_id = (int) $_SESSION['gofast_user_id'];\n    $rol     = strtolower($_SESSION['gofast_user_rol'] ?? 'cliente');\n\n    $mensaje_estado = '';\n\n    \/\/ Lista de mensajeros (solo para admin)\n    $mensajeros = [];\n    \/\/ Lista de barrios para filtros (solo para admin)\n    $barrios = [];\n    \/\/ Lista de usuarios con negocios (solo para admin)\n    $usuarios_negocios = [];\n    \n    if ($rol === 'admin') {\n        $mensajeros = $wpdb->get_results(\"\n            SELECT id, nombre \n            FROM usuarios_gofast\n            WHERE rol = 'mensajero' AND activo = 1\n            ORDER BY nombre ASC\n        \");\n        \n        $barrios = $wpdb->get_results(\"\n            SELECT id, nombre \n            FROM barrios\n            ORDER BY nombre ASC\n        \");\n        \n        \/\/ Obtener negocios (no usuarios) para el filtro\n        $negocios = $wpdb->get_results(\"\n            SELECT DISTINCT n.id, n.nombre, n.user_id\n            FROM negocios_gofast n\n            WHERE n.activo = 1\n            ORDER BY n.nombre ASC\n        \");\n    }\n\n    \/****************************************\n     * 0. GESTI\u00d3N DE ELIMINAR SERVICIO (POST)\n     ****************************************\/\n    if (\n        !empty($_POST['gofast_eliminar_id']) &&\n        !empty($_POST['gofast_eliminar_nonce']) &&\n        wp_verify_nonce($_POST['gofast_eliminar_nonce'], 'gofast_eliminar_servicio') &&\n        $rol === 'admin'\n    ) {\n        $servicio_id = (int) $_POST['gofast_eliminar_id'];\n        $eliminado = $wpdb->delete('servicios_gofast', ['id' => $servicio_id]);\n        if ($eliminado) {\n            $mensaje_estado = 'Servicio eliminado correctamente.';\n        } else {\n            $mensaje_estado = 'Error al eliminar el servicio.';\n        }\n    }\n\n    \/****************************************\n     * 0.1. GESTI\u00d3N DE EDITAR DESTINOS (POST)\n     ****************************************\/\n    if (\n        (!empty($_POST['gofast_editar_destinos']) || !empty($_POST['gofast_editar_destinos_id'])) &&\n        !empty($_POST['gofast_editar_destinos_nonce']) &&\n        wp_verify_nonce($_POST['gofast_editar_destinos_nonce'], 'gofast_editar_destinos') &&\n        $rol === 'admin'\n    ) {\n        $servicio_id = !empty($_POST['gofast_editar_destinos_id']) ? (int) $_POST['gofast_editar_destinos_id'] : 0;\n        \n        if ($servicio_id > 0) {\n            $servicio = $wpdb->get_row($wpdb->prepare(\"SELECT * FROM servicios_gofast WHERE id = %d\", $servicio_id));\n            \n            if ($servicio) {\n                $json_destinos = json_decode($servicio->destinos, true);\n                \n                if (is_array($json_destinos) && !empty($_POST['destinos_editados'])) {\n                    $destinos_editados_json = stripslashes($_POST['destinos_editados']);\n                    $destinos_editados = json_decode($destinos_editados_json, true);\n                    \n                    \/\/ Verificar errores de JSON\n                    if (json_last_error() !== JSON_ERROR_NONE) {\n                        $mensaje_estado = 'Error al decodificar JSON de destinos: ' . json_last_error_msg() . '. JSON recibido: ' . substr($destinos_editados_json, 0, 200);\n                    } elseif (is_array($destinos_editados) && !empty($destinos_editados['destinos'])) {\n                    \/\/ Recalcular total\n                    $total_nuevo = 0;\n                    $destinos_finales = [];\n                    \n                    foreach ($destinos_editados['destinos'] as $dest) {\n                        if (!empty($dest['barrio_id'])) {\n                            $barrio_id = (int) $dest['barrio_id'];\n                            $sector_destino = (int) $wpdb->get_var($wpdb->prepare(\n                                \"SELECT sector_id FROM barrios WHERE id = %d\", $barrio_id\n                            ));\n                            $sector_origen = !empty($json_destinos['origen']['sector_id']) \n                                ? (int) $json_destinos['origen']['sector_id'] \n                                : 0;\n                            \n                            $precio = (int) $wpdb->get_var($wpdb->prepare(\n                                \"SELECT precio FROM tarifas WHERE origen_sector_id=%d AND destino_sector_id=%d\",\n                                $sector_origen, $sector_destino\n                            ));\n                            \n                            $monto_extra = isset($dest['monto']) ? (int) $dest['monto'] : 0;\n                            $total_nuevo += $precio + $monto_extra;\n                            \n                            $destinos_finales[] = [\n                                'barrio_id' => $barrio_id,\n                                'barrio_nombre' => $dest['barrio_nombre'] ?? '',\n                                'sector_id' => $sector_destino,\n                                'direccion' => $dest['direccion'] ?? '',\n                                'monto' => $monto_extra\n                            ];\n                        }\n                    }\n                    \n                    $json_destinos['destinos'] = $destinos_finales;\n                    $json_final = json_encode($json_destinos, JSON_UNESCAPED_UNICODE);\n                    \n                        $actualizado = $wpdb->update(\n                            'servicios_gofast',\n                            [\n                                'destinos' => $json_final,\n                                'total' => $total_nuevo\n                            ],\n                            ['id' => $servicio_id],\n                            ['%s', '%d'],\n                            ['%d']\n                        );\n                        \n                        if ($actualizado !== false) {\n                            $mensaje_estado = '\u2705 Destinos actualizados correctamente.';\n                        } else {\n                            $mensaje_estado = '\u274c Error al actualizar destinos: ' . esc_html($wpdb->last_error);\n                        }\n                    } else {\n                        $mensaje_estado = 'Error: Los destinos editados no tienen el formato correcto.';\n                    }\n                } else {\n                    $mensaje_estado = 'Error: No se recibieron destinos editados.';\n                }\n            } else {\n                $mensaje_estado = 'Error: Servicio no encontrado.';\n            }\n        } else {\n            $mensaje_estado = 'Error: ID de servicio inv\u00e1lido.';\n        }\n    }\n\n    \/****************************************\n     * 0.2. GESTI\u00d3N DE CAMBIO DE ESTADO \/ MENSAJERO (POST)\n     ****************************************\/\n    if (\n        !empty($_POST['gofast_estado_id']) &&\n        !empty($_POST['gofast_estado_nonce']) &&\n        wp_verify_nonce($_POST['gofast_estado_nonce'], 'gofast_cambiar_estado')\n    ) {\n        $pedido_id = (int) $_POST['gofast_estado_id'];\n\n        $pedido = $wpdb->get_row(\n            $wpdb->prepare(\"SELECT * FROM servicios_gofast WHERE id = %d\", $pedido_id)\n        );\n\n        if (!$pedido) {\n            $mensaje_estado = 'Pedido no encontrado.';\n        } else {\n            $estados_validos = ['pendiente','asignado','en_ruta','entregado','cancelado'];\n\n            \/\/ Estado nuevo (si viene en POST, si no, se deja igual)\n            $nuevo_estado = $pedido->tracking_estado;\n            if (!empty($_POST['gofast_estado_nuevo'])) {\n                $tmp_estado = sanitize_text_field($_POST['gofast_estado_nuevo']);\n                if (in_array($tmp_estado, $estados_validos, true)) {\n                    $nuevo_estado = $tmp_estado;\n                } else {\n                    $mensaje_estado = 'Estado no v\u00e1lido.';\n                }\n            }\n\n            \/\/ Mensajero nuevo\n            $nuevo_mensajero_id = $pedido->mensajero_id;\n            $asignado_por_user_id = null; \/\/ Qui\u00e9n asign\u00f3 el mensajero\n\n            if ($rol === 'admin') {\n                \/\/ Admin puede asignar cualquier mensajero\n                if (isset($_POST['gofast_mensajero_id'])) {\n                    $tmp_m = (int) $_POST['gofast_mensajero_id'];\n                    $nuevo_mensajero_id = $tmp_m > 0 ? $tmp_m : null;\n                    \/\/ Si se est\u00e1 asignando un mensajero (no quit\u00e1ndolo), guardar qui\u00e9n lo asign\u00f3\n                    if ($nuevo_mensajero_id > 0 && $nuevo_mensajero_id != $pedido->mensajero_id) {\n                        $asignado_por_user_id = $user_id; \/\/ Admin asign\u00f3\n                    }\n                }\n            } elseif ($rol === 'mensajero') {\n                \/\/ Mensajero se auto-asigna si el pedido no tiene mensajero y est\u00e1 tocando el estado\n                if (empty($pedido->mensajero_id) && !empty($_POST['gofast_estado_nuevo'])) {\n                    $nuevo_mensajero_id = $user_id;\n                    $asignado_por_user_id = $user_id; \/\/ Mensajero se auto-asign\u00f3\n                }\n            }\n\n            \/\/ Permisos\n            $puede = false;\n            if ($rol === 'admin') {\n                $puede = true;\n            } elseif ($rol === 'mensajero') {\n                \/\/ puede tocar pendientes o los suyos\n                if ($pedido->tracking_estado === 'pendiente' || (int) $pedido->mensajero_id === $user_id) {\n                    $puede = true;\n                }\n                \/\/ Mensajero NO puede cancelar\n                if ($nuevo_estado === 'cancelado') {\n                    $puede = false;\n                    $mensaje_estado = 'Los mensajeros no pueden cancelar pedidos.';\n                }\n            } else {\n                $puede = false;\n            }\n\n            if (!$puede) {\n                $mensaje_estado = 'No tienes permisos para modificar este pedido.';\n            } else {\n                $data = [];\n\n                if ($nuevo_estado !== $pedido->tracking_estado) {\n                    $data['tracking_estado'] = $nuevo_estado;\n                }\n\n                \/\/ Comparaci\u00f3n con null\/int\n                if ((string) $nuevo_mensajero_id !== (string) $pedido->mensajero_id) {\n                    $data['mensajero_id'] = $nuevo_mensajero_id;\n                    \/\/ Guardar qui\u00e9n asign\u00f3 el mensajero (si se est\u00e1 asignando)\n                    if ($asignado_por_user_id !== null && $nuevo_mensajero_id > 0) {\n                        \/\/ Verificar si el campo existe, si no, intentar agregarlo\n                        $column_exists = $wpdb->get_results(\"SHOW COLUMNS FROM servicios_gofast LIKE 'asignado_por_user_id'\");\n                        if (empty($column_exists)) {\n                            \/\/ Agregar el campo si no existe\n                            $wpdb->query(\"ALTER TABLE servicios_gofast ADD COLUMN asignado_por_user_id BIGINT(20) UNSIGNED DEFAULT NULL AFTER mensajero_id\");\n                        }\n                        $data['asignado_por_user_id'] = $asignado_por_user_id;\n                    } elseif ($nuevo_mensajero_id === null || $nuevo_mensajero_id == 0) {\n                        \/\/ Si se quita el mensajero, limpiar qui\u00e9n lo asign\u00f3\n                        $column_exists = $wpdb->get_results(\"SHOW COLUMNS FROM servicios_gofast LIKE 'asignado_por_user_id'\");\n                        if (!empty($column_exists)) {\n                            $data['asignado_por_user_id'] = null;\n                        }\n                    }\n                }\n\n                if (!empty($data)) {\n                    $ok = $wpdb->update('servicios_gofast', $data, ['id' => $pedido_id]);\n                    if ($ok === false) {\n                        $mensaje_estado = 'Error al actualizar: ' . esc_html($wpdb->last_error);\n                    } else {\n                        $mensaje_estado = 'Pedido actualizado correctamente.';\n                    }\n                }\n            }\n        }\n    }\n\n    \/****************************************\n     * 1. Filtros (GET)\n     ****************************************\/\n    $estado = isset($_GET['estado']) ? sanitize_text_field($_GET['estado']) : '';\n    $buscar = isset($_GET['q'])      ? sanitize_text_field($_GET['q'])      : '';\n    $desde  = isset($_GET['desde'])  ? sanitize_text_field($_GET['desde'])  : '';\n    $hasta  = isset($_GET['hasta'])  ? sanitize_text_field($_GET['hasta'])  : '';\n    \n    \/\/ Filtros adicionales solo para admin\n    $filtro_mensajero = isset($_GET['filtro_mensajero']) ? (int) $_GET['filtro_mensajero'] : 0;\n    $filtro_origen = isset($_GET['filtro_origen']) ? (int) $_GET['filtro_origen'] : 0;\n    $filtro_destino = isset($_GET['filtro_destino']) ? (int) $_GET['filtro_destino'] : 0;\n    $filtro_negocio = isset($_GET['filtro_negocio']) ? (int) $_GET['filtro_negocio'] : 0;\n    $filtro_asignado_por = isset($_GET['filtro_asignado_por']) ? sanitize_text_field($_GET['filtro_asignado_por']) : '';\n    $filtro_intermunicipal = isset($_GET['filtro_intermunicipal']) ? sanitize_text_field($_GET['filtro_intermunicipal']) : '';\n\n    \/\/ Predefinir fecha al d\u00eda actual si no hay filtros de fecha (para todos los usuarios)\n    \/\/ Usar zona horaria de Colombia\n    if (empty($_GET['desde']) && empty($_GET['hasta'])) {\n        $desde = gofast_current_time('Y-m-d');\n        $hasta = gofast_current_time('Y-m-d');\n    }\n\n    if ($desde && !preg_match('\/^\\d{4}-\\d{2}-\\d{2}$\/', $desde)) $desde = '';\n    if ($hasta && !preg_match('\/^\\d{4}-\\d{2}-\\d{2}$\/', $hasta)) $hasta = '';\n\n    \/****************************************\n     * 2. WHERE seg\u00fan rol\n     ****************************************\/\n    $where  = \"1=1\";\n    $params = [];\n\n    if ($rol === 'admin') {\n        \/\/ ve todo\n    } elseif ($rol === 'mensajero') {\n        \/\/ Mensajero solo ve pendientes SIN mensajero asignado O asignados a \u00e9l\n        \/\/ Pedidos pendientes sin mensajero: (tracking_estado = 'pendiente' AND (mensajero_id IS NULL OR mensajero_id = 0))\n        \/\/ O pedidos asignados a \u00e9l: mensajero_id = user_id\n        $where   .= \" AND ((tracking_estado = %s AND (mensajero_id IS NULL OR mensajero_id = 0)) OR mensajero_id = %d)\";\n        $params[] = 'pendiente';\n        $params[] = $user_id;\n    } else {\n        \/\/ Cliente: ver servicios que cre\u00f3 O servicios de sus negocios\n        \/\/ Obtener IDs de negocios del cliente\n        $negocios_ids = $wpdb->get_col($wpdb->prepare(\n            \"SELECT id FROM negocios_gofast WHERE user_id = %d AND activo = 1\",\n            $user_id\n        ));\n        \n        \/\/ Construir condici\u00f3n: servicios creados por el cliente O servicios de sus negocios\n        \/\/ Como los servicios se asocian por user_id (due\u00f1o del negocio), y el cliente es due\u00f1o de sus negocios,\n        \/\/ los servicios de sus negocios tambi\u00e9n tendr\u00e1n user_id = cliente_id\n        \/\/ Pero por si acaso hay alguna otra relaci\u00f3n, mantenemos el filtro simple\n        $where   .= \" AND user_id = %d\";\n        $params[] = $user_id;\n    }\n\n    if ($estado !== '' && $estado !== 'todos') {\n        $where   .= \" AND tracking_estado = %s\";\n        $params[] = $estado;\n    }\n\n    \/\/ b\u00fasqueda por nombre o tel\u00e9fono\n    if ($buscar !== '') {\n        $like = '%' . $wpdb->esc_like($buscar) . '%';\n        $where   .= \" AND (nombre_cliente LIKE %s OR telefono_cliente LIKE %s)\";\n        $params[] = $like;\n        $params[] = $like;\n    }\n\n    if ($desde !== '') {\n        $where   .= \" AND fecha >= %s\";\n        $params[] = $desde . ' 00:00:00';\n    }\n    if ($hasta !== '') {\n        $where   .= \" AND fecha <= %s\";\n        $params[] = $hasta . ' 23:59:59';\n    }\n    \n    \/\/ Filtros adicionales solo para admin\n    if ($rol === 'admin') {\n        if ($filtro_mensajero > 0) {\n            $where   .= \" AND mensajero_id = %d\";\n            $params[] = $filtro_mensajero;\n        }\n        \n        if ($filtro_negocio > 0) {\n            \/\/ Buscar servicios donde el user_id corresponde al due\u00f1o del negocio\n            $negocio = $wpdb->get_row($wpdb->prepare(\n                \"SELECT user_id FROM negocios_gofast WHERE id = %d AND activo = 1\",\n                $filtro_negocio\n            ));\n            if ($negocio) {\n                $where   .= \" AND user_id = %d\";\n                $params[] = $negocio->user_id;\n            }\n        }\n        \n        \/\/ Filtro por asignado por (admin o mensajero auto-asignado)\n        if ($filtro_asignado_por === 'admin') {\n            \/\/ Servicios donde un admin asign\u00f3 el mensajero (asignado_por_user_id != mensajero_id y es admin)\n            $where .= \" AND asignado_por_user_id IS NOT NULL AND asignado_por_user_id != COALESCE(mensajero_id, 0) AND EXISTS (SELECT 1 FROM usuarios_gofast WHERE id = asignado_por_user_id AND rol = 'admin')\";\n        } elseif ($filtro_asignado_por === 'mensajero') {\n            \/\/ Servicios donde el mensajero se auto-asign\u00f3 (asignado_por_user_id = mensajero_id)\n            $where .= \" AND asignado_por_user_id IS NOT NULL AND asignado_por_user_id = mensajero_id\";\n        }\n        \n        \/\/ Filtro por origen (buscar en JSON)\n        if ($filtro_origen > 0) {\n            $where   .= \" AND JSON_EXTRACT(destinos, '$.origen.barrio_id') = %d\";\n            $params[] = $filtro_origen;\n        }\n        \n        \/\/ Filtro por destino (buscar en JSON array)\n        if ($filtro_destino > 0) {\n            $where   .= \" AND JSON_CONTAINS(destinos, JSON_OBJECT('barrio_id', %d), '$.destinos')\";\n            $params[] = $filtro_destino;\n        }\n        \n        \/\/ Filtro por env\u00edos intermunicipales\n        if ($filtro_intermunicipal === 'si') {\n            $where .= \" AND (JSON_EXTRACT(destinos, '$.tipo_servicio') = 'intermunicipal' OR direccion_origen LIKE %s)\";\n            $params[] = '%(Intermunicipal)%';\n        } elseif ($filtro_intermunicipal === 'no') {\n            $where .= \" AND (JSON_EXTRACT(destinos, '$.tipo_servicio') IS NULL OR JSON_EXTRACT(destinos, '$.tipo_servicio') != 'intermunicipal') AND (direccion_origen IS NULL OR direccion_origen NOT LIKE %s)\";\n            $params[] = '%(Intermunicipal)%';\n        }\n    }\n\n    \/****************************************\n     * 3. Paginaci\u00f3n\n     ****************************************\/\n    $por_pagina = 15;\n    $pagina     = isset($_GET['pg']) ? max(1, (int) $_GET['pg']) : 1;\n    $offset     = ($pagina - 1) * $por_pagina;\n\n    if (!empty($params)) {\n        $sql_count = $wpdb->prepare(\n            \"SELECT COUNT(*) FROM servicios_gofast WHERE $where\",\n            $params\n        );\n    } else {\n        $sql_count = \"SELECT COUNT(*) FROM servicios_gofast WHERE $where\";\n    }\n\n    $total_registros = (int) $wpdb->get_var($sql_count);\n    $total_paginas   = max(1, (int) ceil($total_registros \/ $por_pagina));\n\n    $params_datos   = $params;\n    $params_datos[] = $por_pagina;\n    $params_datos[] = $offset;\n\n    $sql_datos = $wpdb->prepare(\n        \"SELECT * FROM servicios_gofast \n         WHERE $where\n         ORDER BY fecha DESC\n         LIMIT %d OFFSET %d\",\n        $params_datos\n    );\n\n    $pedidos = $wpdb->get_results($sql_datos);\n\n    \/\/ opciones de estado reutilizables\n    $estado_opts = [\n        'pendiente' => 'Pendiente',\n        'asignado'  => 'Asignado',\n        'en_ruta'   => 'En Ruta',\n        'entregado' => 'Entregado',\n        'cancelado' => 'Cancelado',\n    ];\n    \n    \/\/ Para mensajeros, quitar la opci\u00f3n de cancelar\n    $estado_opts_mensajero = $estado_opts;\n    unset($estado_opts_mensajero['cancelado']);\n\n    \/****************************************\n     * 4. Render\n     ****************************************\/\n    ob_start();\n    ?>\n\n<div class=\"gofast-home\">\n    <?php if ($rol === 'admin'): ?>\n        <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;\">\n            <div>\n                <h1 style=\"margin-bottom:8px;\">\ud83d\udce6 Pedidos<\/h1>\n                <p class=\"gofast-home-text\" style=\"margin:0;\">\n                    Gestiona todos los pedidos del sistema.\n                <\/p>\n            <\/div>\n            <a href=\"<?php echo esc_url( home_url('\/dashboard-admin') ); ?>\" class=\"gofast-btn-request\" style=\"text-decoration:none;white-space:nowrap;\">\n                \u2190 Volver al Dashboard\n            <\/a>\n        <\/div>\n    <?php else: ?>\n        <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;\">\n            <div>\n                <h1 style=\"margin-bottom:8px;\">\ud83d\udce6 Pedidos<\/h1>\n                <p class=\"gofast-home-text\" style=\"margin:0;\">\n                    <?php if ($rol === 'mensajero'): ?>\n                        Pedidos pendientes y asignados a ti.\n                    <?php else: ?>\n                        Tus pedidos y servicios solicitados.\n                    <?php endif; ?>\n                <\/p>\n            <\/div>\n        <\/div>\n    <?php endif; ?>\n    \n    <!-- Mensaje de resultado -->\n    <?php if (!empty($mensaje_estado)): ?>\n        <div class=\"gofast-box\" style=\"background: <?= strpos($mensaje_estado, '\u2705') !== false ? '#d4edda' : '#f8d7da' ?>; border-left: 4px solid <?= strpos($mensaje_estado, '\u2705') !== false ? '#28a745' : '#dc3545' ?>; color: <?= strpos($mensaje_estado, '\u2705') !== false ? '#155724' : '#721c24' ?>; margin-bottom: 20px;\">\n            <?= esc_html($mensaje_estado) ?>\n        <\/div>\n    <?php endif; ?>\n\n    <!-- Filtros -->\n    <div class=\"gofast-box\" style=\"margin-bottom: 20px;\">\n        <h3>\ud83d\udd0d Filtros<\/h3>\n        <form method=\"get\" class=\"gofast-filtros-form\">\n            <!-- Mantener otros par\u00e1metros GET si existen -->\n            <?php foreach ($_GET as $key => $value): ?>\n                <?php if (!in_array($key, ['estado', 'q', 'desde', 'hasta', 'filtro_mensajero', 'filtro_origen', 'filtro_destino', 'filtro_negocio', 'filtro_asignado_por', 'filtro_intermunicipal', 'pg'])): ?>\n                    <input type=\"hidden\" name=\"<?= esc_attr($key) ?>\" value=\"<?= esc_attr($value) ?>\">\n                <?php endif; ?>\n            <?php endforeach; ?>\n            \n            <div class=\"gofast-filtros-grid\" style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;\">\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Estado<\/label>\n                    <select name=\"estado\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                        <option value=\"todos\"<?php selected($estado, 'todos'); ?>>Todos<\/option>\n                        <?php foreach ($estado_opts as $val => $label): ?>\n                            <option value=\"<?php echo esc_attr($val); ?>\"<?php selected($estado, $val); ?>>\n                                <?php echo esc_html($label); ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                <\/div>\n\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Nombre \/ Tel\u00e9fono<\/label>\n                    <input type=\"text\" \n                           name=\"q\" \n                           placeholder=\"Ej: Juan o 300...\" \n                           value=\"<?php echo esc_attr($buscar); ?>\"\n                           style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                <\/div>\n\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Fecha desde<\/label>\n                    <input type=\"date\" \n                           name=\"desde\" \n                           value=\"<?php echo esc_attr($desde); ?>\"\n                           style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                <\/div>\n\n                <div>\n                    <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Fecha hasta<\/label>\n                    <input type=\"date\" \n                           name=\"hasta\" \n                           value=\"<?php echo esc_attr($hasta); ?>\"\n                           style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                <\/div>\n\n                <?php if ($rol === 'admin'): ?>\n                    <div>\n                        <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Mensajero<\/label>\n                        <select name=\"filtro_mensajero\" class=\"gofast-select-filtro\" data-placeholder=\"Todos los mensajeros\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                            <option value=\"0\">Todos<\/option>\n                            <?php foreach ($mensajeros as $m): ?>\n                                <option value=\"<?php echo (int) $m->id; ?>\"<?php selected($filtro_mensajero, $m->id); ?>>\n                                    <?php echo esc_html($m->nombre); ?>\n                                <\/option>\n                            <?php endforeach; ?>\n                        <\/select>\n                    <\/div>\n\n                    <div>\n                        <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Origen<\/label>\n                        <select name=\"filtro_origen\" class=\"gofast-select-filtro\" data-placeholder=\"Todos los or\u00edgenes\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                            <option value=\"0\">Todos<\/option>\n                            <?php foreach ($barrios as $b): ?>\n                                <option value=\"<?php echo (int) $b->id; ?>\"<?php selected($filtro_origen, $b->id); ?>>\n                                    <?php echo esc_html($b->nombre); ?>\n                                <\/option>\n                            <?php endforeach; ?>\n                        <\/select>\n                    <\/div>\n\n                    <div>\n                        <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Destino<\/label>\n                        <select name=\"filtro_destino\" class=\"gofast-select-filtro\" data-placeholder=\"Todos los destinos\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                            <option value=\"0\">Todos<\/option>\n                            <?php foreach ($barrios as $b): ?>\n                                <option value=\"<?php echo (int) $b->id; ?>\"<?php selected($filtro_destino, $b->id); ?>>\n                                    <?php echo esc_html($b->nombre); ?>\n                                <\/option>\n                            <?php endforeach; ?>\n                        <\/select>\n                    <\/div>\n\n                    <div>\n                        <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Negocio<\/label>\n                        <select name=\"filtro_negocio\" class=\"gofast-select-filtro\" data-placeholder=\"Todos los negocios\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                            <option value=\"0\">Todos<\/option>\n                            <?php if (!empty($negocios)): ?>\n                                <?php foreach ($negocios as $neg): ?>\n                                    <option value=\"<?php echo (int) $neg->id; ?>\"<?php selected($filtro_negocio, $neg->id); ?>>\n                                        <?php echo esc_html($neg->nombre); ?>\n                                    <\/option>\n                                <?php endforeach; ?>\n                            <?php endif; ?>\n                        <\/select>\n                    <\/div>\n\n                    <div>\n                        <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Asignado por<\/label>\n                        <select name=\"filtro_asignado_por\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                            <option value=\"\">Todos<\/option>\n                            <option value=\"admin\"<?php selected($filtro_asignado_por, 'admin'); ?>>Admin<\/option>\n                            <option value=\"mensajero\"<?php selected($filtro_asignado_por, 'mensajero'); ?>>Mensajero (Auto-asignado)<\/option>\n                        <\/select>\n                    <\/div>\n\n                    <div>\n                        <label style=\"display: block; font-weight: 600; margin-bottom: 4px; font-size: 13px;\">Env\u00edo Intermunicipal<\/label>\n                        <select name=\"filtro_intermunicipal\" style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;\">\n                            <option value=\"\">Todos<\/option>\n                            <option value=\"si\"<?php selected($filtro_intermunicipal, 'si'); ?>>S\u00ed<\/option>\n                            <option value=\"no\"<?php selected($filtro_intermunicipal, 'no'); ?>>No<\/option>\n                        <\/select>\n                    <\/div>\n                <?php endif; ?>\n            <\/div>\n            \n            <div style=\"display: flex; gap: 10px; flex-wrap: wrap;\">\n                <button type=\"submit\" class=\"gofast-btn\" style=\"background: var(--gofast-yellow); flex: 1; min-width: 120px;\">\n                    \ud83d\udd0d Filtrar\n                <\/button>\n                <?php\n                \/\/ Construir URL sin los par\u00e1metros de filtro\n                $clean_url = remove_query_arg(['estado', 'q', 'desde', 'hasta', 'filtro_mensajero', 'filtro_origen', 'filtro_destino', 'filtro_negocio', 'filtro_asignado_por', 'filtro_intermunicipal', 'pg']);\n                if (empty($clean_url) || $clean_url === home_url('\/')) {\n                    $clean_url = get_permalink();\n                }\n                ?>\n                <a href=\"<?= esc_url($clean_url) ?>\" \n                   class=\"gofast-btn gofast-secondary\" \n                   style=\"flex: 1; min-width: 120px; text-align: center; text-decoration: none; display: inline-block;\">\n                    \ud83d\udd04 Limpiar\n                <\/a>\n            <\/div>\n        <\/form>\n        \n        <?php if ($total_registros > 0): ?>\n            <div style=\"margin-top: 12px; padding: 10px; background: #e7f3ff; border-radius: 6px; font-size: 13px;\">\n                <strong>Resultados:<\/strong> \n                <?= $total_registros ?> pedido(s) encontrado(s)\n                <?php if ($total_paginas > 1): ?>\n                    (p\u00e1gina <?= $pagina ?> de <?= $total_paginas ?>)\n                <?php endif; ?>\n            <\/div>\n        <?php endif; ?>\n    <\/div>\n\n    <!-- Listado de pedidos -->\n    <div class=\"gofast-box\">\n        <h3><?= $rol === 'admin' ? '\ud83d\udccb Todos los Pedidos' : ($rol === 'mensajero' ? '\ud83d\udccb Pedidos Asignados' : '\ud83d\udccb Mis Pedidos') ?><\/h3>\n        \n        <?php if ($total_registros === 0): ?>\n            <p style=\"text-align: center; color: #666; padding: 20px;\">\n                No se encontraron pedidos con los filtros seleccionados.\n            <\/p>\n        <?php else: ?>\n            <!-- Vista Desktop: Tabla -->\n            <div class=\"gofast-pedidos-table-wrapper gofast-pedidos-desktop\">\n                <div class=\"gofast-table-wrap\">\n                    <table class=\"gofast-table gofast-pedidos-table\">\n                    <thead>\n                        <tr>\n                            <th>#<\/th>\n                            <th>Fecha<\/th>\n                            <th>Cliente<\/th>\n                            <th>Tel\u00e9fono<\/th>\n                            <th>Origen<\/th>\n                            <th>Destinos<\/th>\n                            <th>Mensajero<\/th>\n                            <th>Total<\/th>\n                            <th>Estado<\/th>\n                            <th>Ver<\/th>\n                            <?php if ($rol === 'admin'): ?>\n                                <th>Acciones<\/th>\n                            <?php endif; ?>\n                        <\/tr>\n                    <\/thead>\n                    <tbody>\n                    <?php foreach ($pedidos as $p):\n\n                        \/\/ Decodificar JSON\n                        $origen_barrio   = '';\n                        $destinos_barris = [];\n\n                        if (!empty($p->destinos)) {\n                            $json = json_decode($p->destinos, true);\n                            if (is_array($json)) {\n                                if (!empty($json['origen']['barrio_nombre'])) {\n                                    $origen_barrio = $json['origen']['barrio_nombre'];\n                                }\n                                if (!empty($json['destinos']) && is_array($json['destinos'])) {\n                                    foreach ($json['destinos'] as $d) {\n                                        if (!empty($d['barrio_nombre'])) {\n                                            $destinos_barris[] = $d['barrio_nombre'];\n                                        }\n                                    }\n                                }\n                            }\n                        }\n\n                        if ($origen_barrio === '') {\n                            $origen_barrio = $p->direccion_origen ?: '\u2014';\n                        }\n                        $destinos_text = !empty($destinos_barris)\n                            ? implode(', ', array_unique($destinos_barris))\n                            : '\u2014';\n                        \n                        \/\/ Detectar si es servicio intermunicipal\n                        $es_intermunicipal = false;\n                        if (!empty($p->destinos)) {\n                            $json = json_decode($p->destinos, true);\n                            if (is_array($json) && !empty($json['tipo_servicio']) && $json['tipo_servicio'] === 'intermunicipal') {\n                                $es_intermunicipal = true;\n                            }\n                        }\n                        if (!$es_intermunicipal && strpos($p->direccion_origen, '(Intermunicipal)') !== false) {\n                            $es_intermunicipal = true;\n                        }\n\n                        \/\/ Mensajero y qui\u00e9n lo asign\u00f3\n                        $mensajero_nombre = '\u2014';\n                        $asignado_por = '\u2014';\n                        $asignado_por_tipo = '';\n                        \n                        if (!empty($p->mensajero_id)) {\n                            $mensajero_nombre = $wpdb->get_var(\n                                $wpdb->prepare(\n                                    \"SELECT nombre FROM usuarios_gofast WHERE id = %d\",\n                                    $p->mensajero_id\n                                )\n                            ) ?: '\u2014';\n                            \n                            \/\/ Determinar qui\u00e9n asign\u00f3 el mensajero\n                            \/\/ Primero verificar si existe el campo asignado_por_user_id\n                            $column_exists = $wpdb->get_results(\"SHOW COLUMNS FROM servicios_gofast LIKE 'asignado_por_user_id'\");\n                            \n                            if (!empty($column_exists) && !empty($p->asignado_por_user_id)) {\n                                \/\/ Usar el campo de la base de datos\n                                if ((int) $p->asignado_por_user_id === (int) $p->mensajero_id) {\n                                    $asignado_por = 'Auto-asignado';\n                                    $asignado_por_tipo = 'auto';\n                                } else {\n                                    $asignador_nombre = $wpdb->get_var(\n                                        $wpdb->prepare(\n                                            \"SELECT nombre FROM usuarios_gofast WHERE id = %d\",\n                                            $p->asignado_por_user_id\n                                        )\n                                    );\n                                    $asignador_rol = $wpdb->get_var(\n                                        $wpdb->prepare(\n                                            \"SELECT rol FROM usuarios_gofast WHERE id = %d\",\n                                            $p->asignado_por_user_id\n                                        )\n                                    );\n                                    if (strtolower($asignador_rol) === 'admin') {\n                                        $asignado_por = 'Asignado por: ' . ($asignador_nombre ?: 'Admin');\n                                        $asignado_por_tipo = 'admin';\n                                    } else {\n                                        $asignado_por = 'Asignado por: ' . ($asignador_nombre ?: 'Usuario');\n                                        $asignado_por_tipo = 'otro';\n                                    }\n                                }\n                            } else {\n                                \/\/ Fallback: inferir basado en l\u00f3gica antigua\n                                if ((int) $p->mensajero_id === (int) $p->user_id) {\n                                    $asignado_por = 'Auto-asignado';\n                                    $asignado_por_tipo = 'auto';\n                                } else {\n                                    $asignado_por = 'Asignado por Admin';\n                                    $asignado_por_tipo = 'admin';\n                                }\n                            }\n                        }\n\n                        $estado_actual = $p->tracking_estado;\n                        $estado_class  = 'gofast-badge-estado-' . esc_attr($estado_actual);\n                        $detalle_url   = esc_url( home_url('\/servicio-registrado?id=' . $p->id) );\n                        ?>\n                        <tr>\n                            <td>#<?php echo (int) $p->id; ?><\/td>\n                            <td><?php echo esc_html( gofast_date_format($p->fecha, 'Y-m-d H:i') ); ?><\/td>\n                            <td><?php echo esc_html($p->nombre_cliente ?: '\u2014'); ?><\/td>\n                            <td><?php echo esc_html($p->telefono_cliente ?: '\u2014'); ?><\/td>\n\n                            <td><?php echo esc_html($origen_barrio); ?><\/td>\n                            <td><?php echo esc_html($destinos_text); ?><\/td>\n\n                            <!-- Mensajero -->\n                            <td>\n                                <?php if ($rol === 'admin'): ?>\n                                    <form method=\"post\" class=\"gofast-estado-form\">\n                                        <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                        <input type=\"hidden\" name=\"gofast_estado_id\" value=\"<?php echo (int) $p->id; ?>\">\n                                        <!-- mantener estado actual para que no cambie si solo se asigna mensajero -->\n                                        <input type=\"hidden\" name=\"gofast_estado_nuevo\" value=\"<?php echo esc_attr($estado_actual); ?>\">\n\n                                        <select name=\"gofast_mensajero_id\" class=\"gofast-mensajero-select\" onchange=\"this.form.submit()\">\n                                            <option value=\"\">Sin asignar<\/option>\n                                            <?php foreach ($mensajeros as $m): ?>\n                                                <option value=\"<?php echo (int) $m->id; ?>\"<?php selected($p->mensajero_id, $m->id); ?>>\n                                                    <?php echo esc_html($m->nombre); ?>\n                                                <\/option>\n                                            <?php endforeach; ?>\n                                        <\/select>\n                                        <?php if (!empty($p->mensajero_id) && $asignado_por !== '\u2014'): ?>\n                                            <div style=\"font-size:10px;color:#666;margin-top:2px;\">\n                                                <?php if ($asignado_por_tipo === 'auto'): ?>\n                                                    <span style=\"color:#28a745;\">\u2713 Auto-asignado<\/span>\n                                                <?php else: ?>\n                                                    <span style=\"color:#007bff;\">\u2713 Por Admin<\/span>\n                                                <?php endif; ?>\n                                            <\/div>\n                                        <?php endif; ?>\n                                    <\/form>\n                                <?php else: ?>\n                                    <div>\n                                        <?php echo esc_html($mensajero_nombre); ?>\n                                        <?php if (!empty($p->mensajero_id) && $asignado_por !== '\u2014'): ?>\n                                            <div style=\"font-size:10px;color:#666;margin-top:2px;\">\n                                                <?php if ($asignado_por_tipo === 'auto'): ?>\n                                                    <span style=\"color:#28a745;\">(Auto-asignado)<\/span>\n                                                <?php else: ?>\n                                                    <span style=\"color:#007bff;\">(Asignado por Admin)<\/span>\n                                                <?php endif; ?>\n                                            <\/div>\n                                        <?php endif; ?>\n                                    <\/div>\n                                <?php endif; ?>\n                            <\/td>\n\n                            <!-- Total -->\n                            <td>$<?php echo number_format($p->total, 0, ',', '.'); ?><\/td>\n\n                            <!-- Estado -->\n                            <td>\n                                <?php if ($rol === 'admin' || $rol === 'mensajero'): ?>\n                                    <form method=\"post\" class=\"gofast-estado-form\">\n                                        <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                        <input type=\"hidden\" name=\"gofast_estado_id\" value=\"<?php echo (int) $p->id; ?>\">\n                                        <!-- si hay mensajero, lo mantenemos; para mensajero auto-asignado ya lo pone el backend -->\n                                        <?php if ($rol === 'admin' && !empty($p->mensajero_id)): ?>\n                                            <input type=\"hidden\" name=\"gofast_mensajero_id\" value=\"<?php echo (int) $p->mensajero_id; ?>\">\n                                        <?php endif; ?>\n\n                                        <select name=\"gofast_estado_nuevo\" onchange=\"this.form.submit()\">\n                                            <?php \n                                            $opciones_estado = ($rol === 'mensajero') ? $estado_opts_mensajero : $estado_opts;\n                                            foreach ($opciones_estado as $val => $label): ?>\n                                                <option value=\"<?php echo esc_attr($val); ?>\"<?php selected($estado_actual, $val); ?>>\n                                                    <?php echo esc_html($label); ?>\n                                                <\/option>\n                                            <?php endforeach; ?>\n                                        <\/select>\n                                    <\/form>\n                                <?php else: ?>\n                                    <span class=\"gofast-badge-estado <?php echo $estado_class; ?>\">\n                                        <?php echo esc_html($estado_opts[$estado_actual] ?? $estado_actual); ?>\n                                    <\/span>\n                                <?php endif; ?>\n                            <\/td>\n\n                            <td><a href=\"<?php echo $detalle_url; ?>\" class=\"gofast-link-ver\">Ver<\/a><\/td>\n                            \n                            <?php if ($rol === 'admin'): ?>\n                                <td style=\"white-space:nowrap;\">\n                                    <button type=\"button\" \n                                            class=\"gofast-btn-mini gofast-btn-editar-destinos\" \n                                            data-servicio-id=\"<?php echo (int) $p->id; ?>\"\n                                            data-destinos='<?php echo esc_attr($p->destinos); ?>'\n                                            data-cliente=\"<?php echo esc_attr($p->nombre_cliente); ?>\"\n                                            data-fecha=\"<?php echo esc_attr(gofast_date_format($p->fecha, 'Y-m-d H:i')); ?>\"\n                                            data-origen=\"<?php echo esc_attr($origen_barrio); ?>\"\n                                            data-total=\"<?php echo number_format($p->total, 0, ',', '.'); ?>\">\n                                        \u270f\ufe0f Editar\n                                    <\/button>\n                                    <form method=\"post\" style=\"display:inline-block;margin-left:4px;\" onsubmit=\"return confirm('\u00bfEst\u00e1s seguro de eliminar este servicio? Esta acci\u00f3n no se puede deshacer.');\">\n                                        <?php wp_nonce_field('gofast_eliminar_servicio', 'gofast_eliminar_nonce'); ?>\n                                        <input type=\"hidden\" name=\"gofast_eliminar_id\" value=\"<?php echo (int) $p->id; ?>\">\n                                        <button type=\"submit\" class=\"gofast-btn-mini\" style=\"background:#dc3545;color:#fff;\">\n                                            \ud83d\uddd1\ufe0f Eliminar\n                                        <\/button>\n                                    <\/form>\n                                <\/td>\n                            <?php endif; ?>\n                        <\/tr>\n                    <?php endforeach; ?>\n                    <\/tbody>\n                <\/table>\n                <\/div>\n            <\/div>\n\n            <!-- Vista M\u00f3vil: Cards -->\n            <div class=\"gofast-pedidos-cards gofast-pedidos-mobile\">\n                <?php foreach ($pedidos as $p): \n                    \/\/ Reutilizar la misma l\u00f3gica de decodificaci\u00f3n que en la tabla\n                    $origen_barrio   = '';\n                    $destinos_barris = [];\n\n                    if (!empty($p->destinos)) {\n                        $json = json_decode($p->destinos, true);\n                        if (is_array($json)) {\n                            if (!empty($json['origen']['barrio_nombre'])) {\n                                $origen_barrio = $json['origen']['barrio_nombre'];\n                            }\n                            if (!empty($json['destinos']) && is_array($json['destinos'])) {\n                                foreach ($json['destinos'] as $d) {\n                                    if (!empty($d['barrio_nombre'])) {\n                                        $destinos_barris[] = $d['barrio_nombre'];\n                                    }\n                                }\n                            }\n                        }\n                    }\n\n                    if ($origen_barrio === '') {\n                        $origen_barrio = $p->direccion_origen ?: '\u2014';\n                    }\n                    $destinos_text = !empty($destinos_barris)\n                        ? implode(', ', array_unique($destinos_barris))\n                        : '\u2014';\n                    \n                    \/\/ Detectar si es servicio intermunicipal\n                    $es_intermunicipal = false;\n                    if (!empty($p->destinos)) {\n                        $json = json_decode($p->destinos, true);\n                        if (is_array($json) && !empty($json['tipo_servicio']) && $json['tipo_servicio'] === 'intermunicipal') {\n                            $es_intermunicipal = true;\n                        }\n                    }\n                    if (!$es_intermunicipal && strpos($p->direccion_origen, '(Intermunicipal)') !== false) {\n                        $es_intermunicipal = true;\n                    }\n\n                    \/\/ Mensajero y qui\u00e9n lo asign\u00f3\n                    $mensajero_nombre = '\u2014';\n                    $asignado_por = '\u2014';\n                    $asignado_por_tipo = '';\n                    \n                    if (!empty($p->mensajero_id)) {\n                        $mensajero_nombre = $wpdb->get_var(\n                            $wpdb->prepare(\n                                \"SELECT nombre FROM usuarios_gofast WHERE id = %d\",\n                                $p->mensajero_id\n                            )\n                        ) ?: '\u2014';\n                        \n                        $column_exists = $wpdb->get_results(\"SHOW COLUMNS FROM servicios_gofast LIKE 'asignado_por_user_id'\");\n                        \n                        if (!empty($column_exists) && !empty($p->asignado_por_user_id)) {\n                            if ((int) $p->asignado_por_user_id === (int) $p->mensajero_id) {\n                                $asignado_por = 'Auto-asignado';\n                                $asignado_por_tipo = 'auto';\n                            } else {\n                                $asignador_nombre = $wpdb->get_var(\n                                    $wpdb->prepare(\n                                        \"SELECT nombre FROM usuarios_gofast WHERE id = %d\",\n                                        $p->asignado_por_user_id\n                                    )\n                                );\n                                $asignador_rol = $wpdb->get_var(\n                                    $wpdb->prepare(\n                                        \"SELECT rol FROM usuarios_gofast WHERE id = %d\",\n                                        $p->asignado_por_user_id\n                                    )\n                                );\n                                if (strtolower($asignador_rol) === 'admin') {\n                                    $asignado_por = 'Asignado por: ' . ($asignador_nombre ?: 'Admin');\n                                    $asignado_por_tipo = 'admin';\n                                } else {\n                                    $asignado_por = 'Asignado por: ' . ($asignador_nombre ?: 'Usuario');\n                                    $asignado_por_tipo = 'otro';\n                                }\n                            }\n                        } else {\n                            if ((int) $p->mensajero_id === (int) $p->user_id) {\n                                $asignado_por = 'Auto-asignado';\n                                $asignado_por_tipo = 'auto';\n                            } else {\n                                $asignado_por = 'Asignado por Admin';\n                                $asignado_por_tipo = 'admin';\n                            }\n                        }\n                    }\n\n                    $estado_actual = $p->tracking_estado;\n                    $estado_class  = 'gofast-badge-estado-' . esc_attr($estado_actual);\n                    $detalle_url   = esc_url( home_url('\/servicio-registrado?id=' . $p->id) );\n                    \n                    \/\/ Colores seg\u00fan estado\n                    $estado_color = '';\n                    $estado_text = '';\n                    switch ($estado_actual) {\n                        case 'pendiente':\n                            $estado_color = '#fff3cd';\n                            $estado_text = '\u23f3 Pendiente';\n                            break;\n                        case 'asignado':\n                            $estado_color = '#cfe2ff';\n                            $estado_text = '\ud83d\udccb Asignado';\n                            break;\n                        case 'en_ruta':\n                            $estado_color = '#d1ecf1';\n                            $estado_text = '\ud83d\ude9a En Ruta';\n                            break;\n                        case 'entregado':\n                            $estado_color = '#d4edda';\n                            $estado_text = '\u2705 Entregado';\n                            break;\n                        case 'cancelado':\n                            $estado_color = '#f8d7da';\n                            $estado_text = '\u274c Cancelado';\n                            break;\n                        default:\n                            $estado_color = '#f8f9fa';\n                            $estado_text = esc_html($estado_opts[$estado_actual] ?? $estado_actual);\n                    }\n                    ?>\n                    <div class=\"gofast-pedido-card\" style=\"background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid <?= $estado_color ?>;\">\n                        <div style=\"display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;\">\n                            <div>\n                                <div style=\"font-size: 12px; color: #666; margin-bottom: 4px;\">\n                                    ID: #<?= esc_html($p->id) ?>\n                                    <?php if ($es_intermunicipal): ?>\n                                        <span style=\"display:inline-block;background:#e0a800;color:#000;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;margin-left:4px;\" title=\"Servicio Intermunicipal\">\ud83d\ude9a INTER<\/span>\n                                    <?php endif; ?>\n                                <\/div>\n                                <div style=\"font-size: 11px; color: #999;\"><?= esc_html(gofast_date_format($p->fecha, 'Y-m-d H:i')) ?><\/div>\n                            <\/div>\n                            <span class=\"gofast-badge-estado <?= $estado_class ?>\" style=\"font-size: 12px; padding: 4px 10px;\">\n                                <?= $estado_text ?>\n                            <\/span>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px;\">\n                            <div style=\"font-size: 24px; font-weight: 700; color: #000;\">\n                                $<?= number_format($p->total, 0, ',', '.') ?>\n                            <\/div>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                            <div style=\"font-size: 13px; color: #666; margin-bottom: 4px;\">Cliente:<\/div>\n                            <div style=\"font-size: 14px; font-weight: 600; color: #000;\">\n                                <?= esc_html($p->nombre_cliente ?: '\u2014') ?>\n                            <\/div>\n                            <div style=\"font-size: 12px; color: #666; margin-top: 2px;\">\n                                <?= esc_html($p->telefono_cliente ?: '\u2014') ?>\n                            <\/div>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                            <div style=\"font-size: 13px; color: #666; margin-bottom: 4px;\">Origen:<\/div>\n                            <div style=\"font-size: 14px; font-weight: 600; color: #000;\">\n                                <?= esc_html($origen_barrio) ?>\n                            <\/div>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                            <div style=\"font-size: 13px; color: #666; margin-bottom: 4px;\">Destinos:<\/div>\n                            <div style=\"font-size: 14px; font-weight: 600; color: #000;\">\n                                <?= esc_html($destinos_text) ?>\n                            <\/div>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                            <div style=\"font-size: 13px; color: #666; margin-bottom: 4px;\">Mensajero:<\/div>\n                            <?php if ($rol === 'admin'): ?>\n                                <form method=\"post\" class=\"gofast-estado-form\">\n                                    <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                    <input type=\"hidden\" name=\"gofast_estado_id\" value=\"<?= (int) $p->id ?>\">\n                                    <input type=\"hidden\" name=\"gofast_estado_nuevo\" value=\"<?= esc_attr($estado_actual) ?>\">\n                                    <select name=\"gofast_mensajero_id\" \n                                            class=\"gofast-mensajero-select\" \n                                            onchange=\"this.form.submit()\"\n                                            style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; margin-bottom: 4px;\">\n                                        <option value=\"\">Sin asignar<\/option>\n                                        <?php foreach ($mensajeros as $m): ?>\n                                            <option value=\"<?= (int) $m->id ?>\"<?php selected($p->mensajero_id, $m->id) ?>>\n                                                <?= esc_html($m->nombre) ?>\n                                            <\/option>\n                                        <?php endforeach; ?>\n                                    <\/select>\n                                    <?php if (!empty($p->mensajero_id) && $asignado_por !== '\u2014'): ?>\n                                        <div style=\"font-size: 11px; color: #666; margin-top: 4px;\">\n                                            <?php if ($asignado_por_tipo === 'auto'): ?>\n                                                <span style=\"color: #28a745;\">\u2713 Auto-asignado<\/span>\n                                            <?php else: ?>\n                                                <span style=\"color: #007bff;\">\u2713 Por Admin<\/span>\n                                            <?php endif; ?>\n                                        <\/div>\n                                    <?php endif; ?>\n                                <\/form>\n                            <?php else: ?>\n                                <div style=\"font-size: 14px; font-weight: 600; color: #000;\">\n                                    <?= esc_html($mensajero_nombre) ?>\n                                <\/div>\n                                <?php if (!empty($p->mensajero_id) && $asignado_por !== '\u2014'): ?>\n                                    <div style=\"font-size: 11px; color: #666; margin-top: 4px;\">\n                                        <?php if ($asignado_por_tipo === 'auto'): ?>\n                                            <span style=\"color: #28a745;\">(Auto-asignado)<\/span>\n                                        <?php else: ?>\n                                            <span style=\"color: #007bff;\">(Asignado por Admin)<\/span>\n                                        <?php endif; ?>\n                                    <\/div>\n                                <?php endif; ?>\n                            <?php endif; ?>\n                        <\/div>\n\n                        <div style=\"margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;\">\n                            <div style=\"font-size: 13px; color: #666; margin-bottom: 8px;\">Estado:<\/div>\n                            <?php if ($rol === 'admin' || $rol === 'mensajero'): ?>\n                                <form method=\"post\" class=\"gofast-estado-form\">\n                                    <?php wp_nonce_field('gofast_cambiar_estado', 'gofast_estado_nonce'); ?>\n                                    <input type=\"hidden\" name=\"gofast_estado_id\" value=\"<?= (int) $p->id ?>\">\n                                    <?php if ($rol === 'admin' && !empty($p->mensajero_id)): ?>\n                                        <input type=\"hidden\" name=\"gofast_mensajero_id\" value=\"<?= (int) $p->mensajero_id ?>\">\n                                    <?php endif; ?>\n                                    <select name=\"gofast_estado_nuevo\" \n                                            onchange=\"this.form.submit()\"\n                                            style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; cursor: pointer;\">\n                                        <?php \n                                        $opciones_estado = ($rol === 'mensajero') ? $estado_opts_mensajero : $estado_opts;\n                                        foreach ($opciones_estado as $val => $label): ?>\n                                            <option value=\"<?= esc_attr($val) ?>\"<?php selected($estado_actual, $val) ?>>\n                                                <?= esc_html($label) ?>\n                                            <\/option>\n                                        <?php endforeach; ?>\n                                    <\/select>\n                                <\/form>\n                            <?php else: ?>\n                                <span class=\"gofast-badge-estado <?= $estado_class ?>\" style=\"font-size: 12px; padding: 4px 10px;\">\n                                    <?= esc_html($estado_opts[$estado_actual] ?? $estado_actual) ?>\n                                <\/span>\n                            <?php endif; ?>\n                        <\/div>\n\n                        <div style=\"display: flex; gap: 8px; margin-top: 12px;\">\n                            <a href=\"<?= $detalle_url ?>\" \n                               class=\"gofast-btn-mini\" \n                               style=\"flex: 1; padding: 10px; background: var(--gofast-yellow); color: #000; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; text-align: center; text-decoration: none; display: inline-block;\">\n                                \ud83d\udc41\ufe0f Ver Detalle\n                            <\/a>\n                            \n                            <?php if ($rol === 'admin'): ?>\n                                <button type=\"button\" \n                                        class=\"gofast-btn-mini gofast-btn-editar-destinos\" \n                                        data-servicio-id=\"<?= (int) $p->id ?>\"\n                                        data-destinos='<?= esc_attr($p->destinos) ?>'\n                                        data-cliente=\"<?= esc_attr($p->nombre_cliente) ?>\"\n                                        data-fecha=\"<?= esc_attr(gofast_date_format($p->fecha, 'Y-m-d H:i')) ?>\"\n                                        data-origen=\"<?= esc_attr($origen_barrio) ?>\"\n                                        data-total=\"<?= number_format($p->total, 0, ',', '.') ?>\"\n                                        style=\"flex: 1; padding: 10px; background: var(--gofast-yellow); color: #000; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;\">\n                                    \u270f\ufe0f Editar\n                                <\/button>\n                                \n                                <form method=\"post\" style=\"flex: 1;\" onsubmit=\"return confirm('\u00bfEst\u00e1s seguro de eliminar este servicio? Esta acci\u00f3n no se puede deshacer.');\">\n                                    <?php wp_nonce_field('gofast_eliminar_servicio', 'gofast_eliminar_nonce'); ?>\n                                    <input type=\"hidden\" name=\"gofast_eliminar_id\" value=\"<?= (int) $p->id ?>\">\n                                    <button type=\"submit\" \n                                            style=\"width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;\">\n                                        \ud83d\uddd1\ufe0f Eliminar\n                                    <\/button>\n                                <\/form>\n                            <?php endif; ?>\n                        <\/div>\n                    <\/div>\n                <?php endforeach; ?>\n            <\/div>\n\n            <?php if ($total_paginas > 1): ?>\n                <div class=\"gofast-pagination\" style=\"margin-top:20px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;\">\n                    <?php\n                    $base_url   = get_permalink();\n                    $query_args = $_GET;\n\n                    for ($i = 1; $i <= $total_paginas; $i++):\n                        $query_args['pg'] = $i;\n                        $url    = esc_url( add_query_arg($query_args, $base_url) );\n                        $active = ($i === $pagina) ? 'gofast-page-current' : '';\n                        ?>\n                        <a href=\"<?php echo $url; ?>\" class=\"gofast-page-link <?php echo $active; ?>\" style=\"padding:8px 12px;border:1px solid #ddd;border-radius:6px;text-decoration:none;color:#333;background:#fff;<?php echo $active ? 'background:var(--gofast-yellow);font-weight:700;' : ''; ?>\">\n                            <?php echo $i; ?>\n                        <\/a>\n                    <?php endfor; ?>\n                <\/div>\n            <?php endif; ?>\n\n        <?php endif; ?>\n    <\/div>\n<\/div>\n\n<?php if ($rol === 'admin'): ?>\n<!-- Modal para editar destinos -->\n<div id=\"modal-editar-destinos\" style=\"display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;overflow-y:auto;padding:20px;\">\n    <div style=\"max-width:700px;margin:20px auto;background:#fff;border-radius:8px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,0.3);\" class=\"modal-editar-destinos-content\">\n        <h2 style=\"margin-top:0;margin-bottom:12px;font-size:20px;\" class=\"modal-editar-destinos-title\">\u270f\ufe0f Editar Destinos del Servicio<\/h2>\n        \n        <!-- Informaci\u00f3n del servicio -->\n        <div id=\"servicio-info\" style=\"background:#f8f9fa;border-left:4px solid var(--gofast-yellow);padding:12px;border-radius:6px;margin-bottom:16px;font-size:13px;\" class=\"modal-servicio-info\">\n            <div style=\"display:grid;grid-template-columns:auto 1fr;gap:8px 12px;align-items:start;\" class=\"modal-servicio-info-grid\">\n                <strong style=\"color:#666;\">Servicio #:<\/strong>\n                <span id=\"info-servicio-id\" style=\"font-weight:600;color:#000;\"><\/span>\n                \n                <strong style=\"color:#666;\">Cliente:<\/strong>\n                <span id=\"info-cliente\" style=\"font-weight:600;color:#000;\"><\/span>\n                \n                <strong style=\"color:#666;\">Fecha:<\/strong>\n                <span id=\"info-fecha\" style=\"color:#000;\"><\/span>\n                \n                <strong style=\"color:#666;\">Origen:<\/strong>\n                <span id=\"info-origen\" style=\"font-weight:600;color:#000;\"><\/span>\n                \n                <strong style=\"color:#666;\">Total actual:<\/strong>\n                <span id=\"info-total\" style=\"font-weight:700;color:var(--gofast-yellow);\">$0<\/span>\n            <\/div>\n        <\/div>\n        \n        <div style=\"margin-bottom:12px;padding:10px;background:#fff3cd;border-radius:6px;font-size:12px;color:#856404;\">\n            <strong>\ud83d\udccd Origen:<\/strong> <span id=\"info-origen-text\"><\/span><br>\n            <strong>\ud83c\udfaf Total de destinos:<\/strong> <span id=\"info-destinos-count\">0<\/span> destino(s) configurado(s)\n        <\/div>\n        \n        <form method=\"post\" id=\"form-editar-destinos\" action=\"\">\n            <?php wp_nonce_field('gofast_editar_destinos', 'gofast_editar_destinos_nonce'); ?>\n            <input type=\"hidden\" name=\"gofast_editar_destinos\" value=\"1\">\n            <input type=\"hidden\" name=\"gofast_editar_destinos_id\" id=\"editar-destinos-id\">\n            <input type=\"hidden\" name=\"destinos_editados\" id=\"destinos-editados-json\">\n            \n            <div style=\"margin-bottom:12px;\">\n                <label style=\"display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:#000;\">Destinos del servicio:<\/label>\n            <\/div>\n            \n            <div id=\"destinos-container\" style=\"margin-bottom:16px;\">\n                <!-- Los destinos se cargar\u00e1n aqu\u00ed din\u00e1micamente -->\n            <\/div>\n            \n            <div style=\"display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:16px;border-top:1px solid #ddd;\" class=\"modal-editar-destinos-buttons\">\n                <button type=\"button\" class=\"gofast-btn-mini gofast-btn-outline\" onclick=\"window.cerrarModalEditar(); return false;\">Cancelar<\/button>\n                <button type=\"submit\" class=\"gofast-btn-mini\">Guardar Cambios<\/button>\n            <\/div>\n        <\/form>\n    <\/div>\n<\/div>\n\n<script>\n(function() {\n    \/\/ Proteger contra errores de toggleOtro si se ejecuta desde otro archivo\n    \/\/ Verificar primero si los elementos existen en esta p\u00e1gina\n    const tipoSelectExists = document.getElementById(\"tipo_negocio\");\n    const wrapperOtroExists = document.getElementById(\"tipo_otro_wrapper\");\n    \n    \/\/ Si los elementos no existen, crear una funci\u00f3n segura desde el inicio\n    if (!tipoSelectExists || !wrapperOtroExists) {\n        window.toggleOtro = function() {\n            \/\/ Funci\u00f3n vac\u00eda segura - no hacer nada\n            return;\n        };\n    } else if (typeof window.toggleOtro === 'function') {\n        \/\/ Si existe y los elementos est\u00e1n presentes, mantener la funci\u00f3n original con protecci\u00f3n\n        const originalToggleOtro = window.toggleOtro;\n        window.toggleOtro = function() {\n            try {\n                const tipoSelect = document.getElementById(\"tipo_negocio\");\n                const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                if (tipoSelect && wrapperOtro && tipoSelect.parentNode && wrapperOtro.parentNode) {\n                    return originalToggleOtro();\n                }\n            } catch(e) {\n                \/\/ Silenciar error completamente\n                return;\n            }\n        };\n    }\n    \n    \/\/ Tambi\u00e9n prevenir que setTimeout ejecute toggleOtro si no est\u00e1n los elementos\n    (function() {\n        const originalSetTimeout = window.setTimeout;\n        window.setTimeout = function(func, delay) {\n            if (typeof func === 'function') {\n                try {\n                    const funcStr = func.toString();\n                    if (funcStr.includes('toggleOtro')) {\n                        const tipoSelect = document.getElementById(\"tipo_negocio\");\n                        const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                        if (!tipoSelect || !wrapperOtro) {\n                            \/\/ Retornar un timeout vac\u00edo en lugar de null para evitar errores\n                            return originalSetTimeout(function() {}, 0);\n                        }\n                    }\n                } catch(e) {\n                    \/\/ Si hay alg\u00fan error al verificar, continuar normalmente\n                }\n            }\n            return originalSetTimeout.apply(this, arguments);\n        };\n    })();\n    \n    const barrios = <?php echo json_encode($barrios); ?>;\n    \n    \/\/ Funci\u00f3n para normalizar texto (sin tildes, min\u00fasculas) - HACER GLOBAL\n    window.normalize = s => (s || \"\")\n        .toLowerCase()\n        .normalize('NFD')\n        .replace(\/[\\u0300-\\u036f]\/g, '')\n        .trim();\n    \n    \/\/ Funci\u00f3n matcher mejorada para b\u00fasqueda de barrios - HACER GLOBAL\n    window.matcherDestinos = function(params, data) {\n        \/\/ Si no hay data, retornar null\n        if (!data) return null;\n        \n        \/\/ Si es un optgroup (tiene children), dejarlo pasar\n        if (data.children && Array.isArray(data.children)) {\n            return data;\n        }\n        \n        \/\/ Si no tiene id, es un optgroup label o separador\n        if (!data.id) {\n            if (!params.term || !params.term.trim()) {\n                return data;\n            }\n            return null;\n        }\n        \n        \/\/ Si no tiene text, no mostrar\n        if (!data.text) return null;\n        \n        \/\/ Si no hay t\u00e9rmino de b\u00fasqueda, mostrar todas las opciones\n        if (!params.term || !params.term.trim()) {\n            data.matchScore = 0;\n            return data;\n        }\n\n        const term = window.normalize(params.term);\n        if (!term) {\n            data.matchScore = 0;\n            return data;\n        }\n\n        const text = window.normalize(data.text);\n        \n        \/\/ PRIMERO: Verificar coincidencia exacta\n        if (text === term) {\n            data.matchScore = 10000;\n            return data;\n        }\n        \n        \/\/ SEGUNDO: Verificar si el texto comienza exactamente con el t\u00e9rmino\n        if (text.indexOf(term) === 0) {\n            data.matchScore = 9500;\n            return data;\n        }\n        \n        \/\/ Palabras comunes a ignorar\n        const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n        \n        const searchWords = term.split(\/\\s+\/).filter(Boolean).filter(word => {\n            return word.length > 2 && !stopWords.includes(word);\n        });\n        \n        \/\/ Si despu\u00e9s de filtrar no quedan palabras, buscar el t\u00e9rmino completo\n        if (searchWords.length === 0) {\n            if (text.indexOf(term) !== -1) {\n                data.matchScore = 7000;\n                return data;\n            }\n            return null;\n        }\n        \n        \/\/ Verificar que al menos una palabra significativa est\u00e9 presente\n        const significantMatches = searchWords.filter(word => {\n            if (word.length <= 2) {\n                return text.split(\/\\s+\/).some(textWord => textWord.indexOf(word) === 0);\n            }\n            return text.indexOf(word) !== -1;\n        });\n        \n        if (significantMatches.length === 0) return null;\n        \n        const allSignificantMatch = searchWords.length === significantMatches.length;\n        \n        \/\/ Sistema de puntuaci\u00f3n\n        let score = 0;\n        \n        const textWithoutStopWords = text.split(\/\\s+\/).filter(w => !stopWords.includes(w)).join(' ');\n        const termWithoutStopWords = searchWords.join(' ');\n        \n        \/\/ Coincidencia exacta sin stop words\n        if (textWithoutStopWords === termWithoutStopWords) {\n            score = 10000;\n        } \n        \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 al inicio\n        else if (textWithoutStopWords.indexOf(termWithoutStopWords) === 0) {\n            score = 9000;\n        } \n        \/\/ El t\u00e9rmino completo (sin stop words) est\u00e1 en cualquier parte\n        else if (textWithoutStopWords.indexOf(termWithoutStopWords) !== -1) {\n            score = 8000;\n        } \n        \/\/ Al menos una palabra significativa al inicio\n        else if (searchWords.some(word => text.indexOf(word) === 0)) {\n            score = 7000;\n        } \n        \/\/ El t\u00e9rmino completo est\u00e1 en cualquier parte\n        else if (text.indexOf(term) !== -1) {\n            score = 6000;\n        } \n        \/\/ Coincidencias parciales\n        else {\n            score = allSignificantMatch ? 5000 : 3000;\n            \n            let lastIndex = -1;\n            let wordsInOrder = true;\n            searchWords.forEach(word => {\n                const wordIndex = text.indexOf(word, lastIndex + 1);\n                if (wordIndex === -1) {\n                    wordsInOrder = false;\n                } else {\n                    if (wordIndex < lastIndex) wordsInOrder = false;\n                    lastIndex = wordIndex;\n                    if (text.indexOf(word) === 0) score += 500;\n                }\n            });\n            \n            if (wordsInOrder) score += 1000;\n        }\n        \n        data.matchScore = score;\n        return data;\n    };\n    \n    \/\/ Funci\u00f3n para inicializar Select2 en los selects de barrios\n    function initSelect2Barrios(selectElement) {\n        if (!window.jQuery || !jQuery.fn.select2) return;\n        \n        \/\/ Evitar inicializar dos veces\n        if (jQuery(selectElement).data('select2')) {\n            return;\n        }\n        \n        jQuery(selectElement).select2({\n            placeholder: \"\ud83d\udd0d Escribe para buscar barrio...\",\n            width: '100%',\n            dropdownParent: jQuery('#modal-editar-destinos'),\n            allowClear: true,\n            minimumResultsForSearch: 0,\n            dropdownAutoWidth: false,\n            dropdownCssClass: \"gofast-select-down-modal\",\n            matcher: window.matcherDestinos,\n            sorter: function(results) {\n                return results.sort(function(a, b) {\n                    return (b.matchScore || 0) - (a.matchScore || 0);\n                });\n            },\n            templateResult: function(data, container) {\n                if (!data || !data.text) {\n                    return data ? data.text : '';\n                }\n                \n                if (!data.id) return data.text;\n                \n                let originalText = data.text;\n                \n                \/\/ Obtener el t\u00e9rmino de b\u00fasqueda\n                let searchTerm = \"\";\n                const $activeField = jQuery('.select2-container--open .select2-search__field');\n                if ($activeField.length) {\n                    searchTerm = $activeField.val() || \"\";\n                }\n                \n                if (!searchTerm || !searchTerm.trim()) {\n                    const $result = jQuery('<span>').text(originalText);\n                    if (data.matchScore !== undefined) {\n                        $result.attr('data-match-score', data.matchScore);\n                    }\n                    return $result;\n                }\n                \n                \/\/ Normalizar para b\u00fasqueda\n                const normalizedSearch = window.normalize(searchTerm);\n                const normalizedText = window.normalize(originalText);\n                \n                \/\/ Dividir t\u00e9rmino en palabras significativas\n                const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n                const searchWords = normalizedSearch.split(\/\\s+\/).filter(Boolean).filter(word => {\n                    return word.length > 2 && !stopWords.includes(word);\n                });\n                \n                const wordsToHighlight = searchWords.length > 0 ? searchWords : [normalizedSearch];\n                \n                \/\/ Encontrar coincidencias y mapear a texto original\n                const highlightRanges = [];\n                \n                wordsToHighlight.forEach(function(word) {\n                    let searchPos = 0;\n                    while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {\n                        const endPos = searchPos + word.length;\n                        \n                        \/\/ Mapear posiciones normalizadas a originales\n                        let origStart = -1;\n                        let origEnd = -1;\n                        let normPos = 0;\n                        \n                        \/\/ Encontrar inicio\n                        for (let i = 0; i < originalText.length && origStart === -1; i++) {\n                            const charNorm = window.normalize(originalText[i]);\n                            if (normPos === searchPos) {\n                                origStart = i;\n                            }\n                            normPos += charNorm.length;\n                        }\n                        \n                        \/\/ Encontrar fin\n                        if (origStart >= 0) {\n                            normPos = searchPos;\n                            for (let i = origStart; i < originalText.length; i++) {\n                                const charNorm = window.normalize(originalText[i]);\n                                normPos += charNorm.length;\n                                if (normPos >= endPos) {\n                                    origEnd = i + 1;\n                                    break;\n                                }\n                            }\n                            \n                            if (origStart >= 0 && origEnd > origStart) {\n                                highlightRanges.push({ start: origStart, end: origEnd });\n                            }\n                        }\n                        \n                        searchPos = endPos;\n                    }\n                });\n                \n                \/\/ Fusionar rangos solapados\n                if (highlightRanges.length > 0) {\n                    highlightRanges.sort((a, b) => a.start - b.start);\n                    const mergedRanges = [highlightRanges[0]];\n                    \n                    for (let i = 1; i < highlightRanges.length; i++) {\n                        const current = highlightRanges[i];\n                        const last = mergedRanges[mergedRanges.length - 1];\n                        \n                        if (current.start <= last.end) {\n                            last.end = Math.max(last.end, current.end);\n                        } else {\n                            mergedRanges.push(current);\n                        }\n                    }\n                    \n                    \/\/ Construir resultado con resaltados\n                    const parts = [];\n                    let lastIndex = 0;\n                    \n                    mergedRanges.forEach(function(range) {\n                        if (range.start > lastIndex) {\n                            parts.push(originalText.substring(lastIndex, range.start));\n                        }\n                        \n                        const matchText = originalText.substring(range.start, range.end);\n                        parts.push('<span style=\"background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;\">' + \n                                   matchText + '<\/span>');\n                        \n                        lastIndex = range.end;\n                    });\n                    \n                    if (lastIndex < originalText.length) {\n                        parts.push(originalText.substring(lastIndex));\n                    }\n                    \n                    const result = parts.join('');\n                    const $result = jQuery('<span>').html(result);\n                    if (data.matchScore !== undefined) {\n                        $result.attr('data-match-score', data.matchScore);\n                    }\n                    return $result;\n                }\n                \n                \/\/ Si no hay coincidencias, retornar texto sin resaltar\n                const $result = jQuery('<span>').text(originalText);\n                if (data.matchScore !== undefined) {\n                    $result.attr('data-match-score', data.matchScore);\n                }\n                return $result;\n            }\n        }).on('select2:open', function(e) {\n            \/\/ Asegurar que el dropdown se posicione correctamente en el modal\n            setTimeout(function() {\n                const $select = jQuery(selectElement);\n                const $selectContainer = $select.closest('.select2-container');\n                const $dropdown = jQuery('.select2-dropdown');\n                const $modal = jQuery('#modal-editar-destinos');\n                const $modalContent = $select.closest('.modal-editar-destinos-content');\n                const $searchContainer = $dropdown.find('.select2-search--dropdown');\n                const $searchField = $searchContainer.find('.select2-search__field');\n                \n                \/\/ Asegurar z-index alto para que aparezca sobre el modal\n                $dropdown.css({\n                    'z-index': '10001',\n                    'position': 'absolute'\n                });\n                \n                if ($searchContainer.length) {\n                    $searchContainer.css({\n                        'display': 'block',\n                        'visibility': 'visible',\n                        'opacity': '1'\n                    });\n                }\n                \n                if ($searchField.length) {\n                    $searchField.css({\n                        'display': 'block',\n                        'visibility': 'visible',\n                        'opacity': '1'\n                    });\n                    \n                    setTimeout(function() {\n                        $searchField.focus();\n                    }, 100);\n                }\n                \n                \/\/ Calcular posici\u00f3n y ajustar si es necesario\n                setTimeout(function() {\n                    const selectOffset = $selectContainer.offset();\n                    const selectHeight = $selectContainer.outerHeight();\n                    const dropdownHeight = $dropdown.outerHeight() || 200; \/\/ altura estimada si a\u00fan no se ha renderizado\n                    const windowHeight = jQuery(window).height();\n                    const windowScrollTop = jQuery(window).scrollTop();\n                    const modalScrollTop = $modal.scrollTop();\n                    \n                    \/\/ Calcular posici\u00f3n relativa al viewport (no al documento)\n                    const selectTopRelative = selectOffset.top - windowScrollTop;\n                    const selectBottomRelative = selectTopRelative + selectHeight;\n                    \n                    \/\/ Calcular espacio disponible\n                    const spaceBelow = windowHeight - selectBottomRelative;\n                    const spaceAbove = selectTopRelative;\n                    \n                    \/\/ Si no hay suficiente espacio debajo pero s\u00ed arriba, forzar que se abra hacia arriba\n                    if (spaceBelow < Math.min(dropdownHeight, 200) && spaceAbove > Math.min(dropdownHeight, 200)) {\n                        $selectContainer.addClass('select2-container--above');\n                        $dropdown.addClass('select2-dropdown--above');\n                    } else {\n                        $selectContainer.removeClass('select2-container--above');\n                        $dropdown.removeClass('select2-dropdown--above');\n                    }\n                    \n                    \/\/ Asegurar que el select sea visible en el viewport haciendo scroll del modal si es necesario\n                    const selectTopInModal = selectOffset.top - $modal.offset().top + modalScrollTop;\n                    const modalViewportTop = modalScrollTop;\n                    const modalViewportBottom = modalScrollTop + $modal.height();\n                    \n                    \/\/ Si el select est\u00e1 cerca del borde inferior del viewport del modal, hacer scroll\n                    if (selectTopInModal + selectHeight > modalViewportBottom - 50) {\n                        const scrollAmount = (selectTopInModal + selectHeight) - (modalViewportBottom - 50);\n                        $modal.animate({ scrollTop: modalScrollTop + scrollAmount }, 200);\n                    } else if (selectTopInModal < modalViewportTop + 50) {\n                        const scrollAmount = (modalViewportTop + 50) - selectTopInModal;\n                        $modal.animate({ scrollTop: modalScrollTop - scrollAmount }, 200);\n                    }\n                    \n                    \/\/ En m\u00f3vil, asegurar que el dropdown sea visible y tenga el ancho correcto\n                    if (window.innerWidth <= 768) {\n                        if ($modalContent.length) {\n                            const contentWidth = $modalContent.width();\n                            $dropdown.css({\n                                'max-width': contentWidth + 'px',\n                                'width': 'auto',\n                                'min-width': '200px',\n                                'left': selectOffset.left + 'px !important'\n                            });\n                        }\n                    } else {\n                        \/\/ En desktop, ajustar posici\u00f3n left para que est\u00e9 alineado con el select\n                        $dropdown.css({\n                            'left': selectOffset.left + 'px !important',\n                            'width': Math.max($selectContainer.outerWidth(), 200) + 'px'\n                        });\n                    }\n                }, 150);\n            }, 50);\n        });\n    }\n    \n    \/\/ Abrir modal de editar destinos\n    document.addEventListener('click', function(e) {\n        if (e.target.classList.contains('gofast-btn-editar-destinos') || e.target.closest('.gofast-btn-editar-destinos')) {\n            const btn = e.target.classList.contains('gofast-btn-editar-destinos') ? e.target : e.target.closest('.gofast-btn-editar-destinos');\n            const servicioId = btn.getAttribute('data-servicio-id');\n            const destinosJson = btn.getAttribute('data-destinos');\n            const cliente = btn.getAttribute('data-cliente') || '\u2014';\n            const fecha = btn.getAttribute('data-fecha') || '\u2014';\n            const origen = btn.getAttribute('data-origen') || '\u2014';\n            const total = btn.getAttribute('data-total') || '0';\n            \n            abrirModalEditar(servicioId, destinosJson, cliente, fecha, origen, total);\n        }\n    });\n    \n    function abrirModalEditar(servicioId, destinosJson, cliente, fecha, origen, total) {\n        document.getElementById('editar-destinos-id').value = servicioId;\n        \n        \/\/ Mostrar informaci\u00f3n del servicio\n        document.getElementById('info-servicio-id').textContent = '#' + servicioId;\n        document.getElementById('info-cliente').textContent = cliente;\n        document.getElementById('info-fecha').textContent = fecha;\n        document.getElementById('info-origen').textContent = origen;\n        document.getElementById('info-total').textContent = '$' + total;\n        document.getElementById('info-origen-text').textContent = origen;\n        \n        const destinos = JSON.parse(destinosJson);\n        const container = document.getElementById('destinos-container');\n        container.innerHTML = '';\n        \n        \/\/ Actualizar contador de destinos\n        const destinosCount = destinos.destinos && Array.isArray(destinos.destinos) ? destinos.destinos.length : 0;\n        document.getElementById('info-destinos-count').textContent = destinosCount;\n        \n        if (destinos.destinos && Array.isArray(destinos.destinos)) {\n            destinos.destinos.forEach(function(destino, index) {\n                const div = document.createElement('div');\n                div.style.cssText = 'margin-bottom:12px;padding:12px;border:1px solid #ddd;border-radius:6px;';\n                div.innerHTML = `\n                    <div style=\"display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:end;\" class=\"destino-item-grid\">\n                        <div>\n                            <label style=\"display:block;margin-bottom:4px;font-weight:bold;font-size:12px;\">Destino ${index + 1}<\/label>\n                            <select name=\"destino_barrio_${index}\" class=\"gofast-select-destino\" required style=\"width:100%;padding:6px 8px;font-size:13px;\">\n                                <option value=\"\">Seleccionar barrio...<\/option>\n                                ${barrios.map(b => `<option value=\"${b.id}\" ${destino.barrio_id == b.id ? 'selected' : ''}>${b.nombre}<\/option>`).join('')}\n                            <\/select>\n                        <\/div>\n                        <div>\n                            <label style=\"display:block;margin-bottom:4px;font-size:12px;\">Direcci\u00f3n espec\u00edfica <span style=\"color:#999;font-weight:normal;\">(direccion)<\/span><\/label>\n                            <input type=\"text\" name=\"destino_dir_${index}\" value=\"${destino.direccion || ''}\" placeholder=\"Ej: Calle 25 # 10-20\" style=\"width:100%;padding:6px 8px;font-size:13px;\">\n                        <\/div>\n                        <div>\n                            <label style=\"display:block;margin-bottom:4px;font-size:12px;\">Monto adicional <span style=\"color:#999;font-weight:normal;\">(monto a pagar)<\/span><\/label>\n                            <input type=\"number\" name=\"destino_monto_${index}\" value=\"${destino.monto || 0}\" min=\"0\" placeholder=\"0\" style=\"width:100%;padding:6px 8px;font-size:13px;\">\n                        <\/div>\n                        <div>\n                            <button type=\"button\" class=\"gofast-btn-mini\" onclick=\"eliminarDestino(this)\" style=\"background:#dc3545;color:#fff;padding:6px 12px;font-size:12px;\">Eliminar<\/button>\n                        <\/div>\n                    <\/div>\n                    <input type=\"hidden\" name=\"destino_barrio_nombre_${index}\" class=\"destino-barrio-nombre\">\n                `;\n                container.appendChild(div);\n                \n                \/\/ Inicializar Select2 en el select de barrio\n                const select = div.querySelector('.gofast-select-destino');\n                if (select) {\n                    initSelect2Barrios(select);\n                    \n                    \/\/ Actualizar nombre del barrio cuando se selecciona\n                    jQuery(select).on('change', function() {\n                        const barrioId = this.value;\n                        const barrio = barrios.find(b => b.id == barrioId);\n                        const hiddenInput = div.querySelector('.destino-barrio-nombre');\n                        if (hiddenInput) {\n                            hiddenInput.value = barrio ? barrio.nombre : '';\n                        }\n                    });\n                    \n                    \/\/ Trigger inicial si hay valor\n                    if (select.value) {\n                        jQuery(select).trigger('change');\n                    }\n                }\n            });\n        }\n        \n        \/\/ Bot\u00f3n para agregar nuevo destino\n        const btnAgregar = document.createElement('button');\n        btnAgregar.type = 'button';\n        btnAgregar.className = 'gofast-btn-mini';\n        btnAgregar.textContent = '\u2795 Agregar Destino';\n        btnAgregar.style.cssText = 'margin-top:12px;padding:8px 16px;font-size:13px;';\n        btnAgregar.setAttribute('data-btn-agregar', 'true'); \/\/ Marcar para identificarlo f\u00e1cilmente\n        btnAgregar.onclick = function() {\n            agregarDestino();\n            \/\/ Actualizar contador\n            actualizarContadorDestinos();\n        };\n        container.appendChild(btnAgregar);\n        \n        \/\/ Mostrar modal y resetear scroll\n        const modal = document.getElementById('modal-editar-destinos');\n        modal.style.display = 'block';\n        \n        \/\/ Resetear scroll a la parte superior\n        modal.scrollTop = 0;\n        \n        \/\/ Prevenir scroll del body cuando el modal est\u00e1 abierto\n        document.body.style.overflow = 'hidden';\n        \n        \/\/ Asegurar que el modal est\u00e9 centrado (forzar reflow)\n        setTimeout(function() {\n            modal.scrollTop = 0;\n            const modalContent = modal.querySelector('.modal-editar-destinos-content');\n            if (modalContent) {\n                \/\/ Asegurar que el contenido est\u00e9 visible\n                modalContent.scrollIntoView({ behavior: 'instant', block: 'start' });\n            }\n        }, 10);\n    }\n    \n    function actualizarContadorDestinos() {\n        const container = document.getElementById('destinos-container');\n        const count = container.querySelectorAll('.gofast-select-destino').length;\n        document.getElementById('info-destinos-count').textContent = count;\n    }\n    \n    function agregarDestino() {\n        const container = document.getElementById('destinos-container');\n        if (!container) return;\n        \n        const index = container.querySelectorAll('.gofast-select-destino').length;\n        const div = document.createElement('div');\n        div.style.cssText = 'margin-bottom:12px;padding:12px;border:1px solid #ddd;border-radius:6px;';\n        div.innerHTML = `\n            <div style=\"display:grid;grid-template-columns:2fr 1fr 1fr auto;gap:8px;align-items:end;\" class=\"destino-item-grid\">\n                <div>\n                    <label style=\"display:block;margin-bottom:4px;font-weight:bold;font-size:12px;\">Destino ${index + 1}<\/label>\n                    <select name=\"destino_barrio_${index}\" class=\"gofast-select-destino\" required style=\"width:100%;padding:6px 8px;font-size:13px;\">\n                        <option value=\"\">Seleccionar barrio...<\/option>\n                        ${barrios.map(b => `<option value=\"${b.id}\">${b.nombre}<\/option>`).join('')}\n                    <\/select>\n                <\/div>\n                <div>\n                    <label style=\"display:block;margin-bottom:4px;font-size:12px;\">Direcci\u00f3n espec\u00edfica <span style=\"color:#999;font-weight:normal;\">(opcional)<\/span><\/label>\n                    <input type=\"text\" name=\"destino_dir_${index}\" placeholder=\"Ej: Calle 25 # 10-20\" style=\"width:100%;padding:6px 8px;font-size:13px;\">\n                <\/div>\n                <div>\n                    <label style=\"display:block;margin-bottom:4px;font-size:12px;\">Monto adicional <span style=\"color:#999;font-weight:normal;\">(extra)<\/span><\/label>\n                    <input type=\"number\" name=\"destino_monto_${index}\" value=\"0\" min=\"0\" placeholder=\"0\" style=\"width:100%;padding:6px 8px;font-size:13px;\">\n                <\/div>\n                <div>\n                    <button type=\"button\" class=\"gofast-btn-mini\" onclick=\"eliminarDestino(this)\" style=\"background:#dc3545;color:#fff;padding:6px 12px;font-size:12px;\">Eliminar<\/button>\n                <\/div>\n            <\/div>\n            <input type=\"hidden\" name=\"destino_barrio_nombre_${index}\" class=\"destino-barrio-nombre\">\n        `;\n        \n        \/\/ Buscar el bot\u00f3n \"Agregar Destino\" espec\u00edficamente usando el atributo data\n        const btnAgregar = container.querySelector('button[data-btn-agregar=\"true\"]');\n        \n        if (btnAgregar && btnAgregar.parentNode === container) {\n            container.insertBefore(div, btnAgregar);\n        } else {\n            \/\/ Si no se encuentra el bot\u00f3n o no es hijo directo, simplemente agregar al final\n            container.appendChild(div);\n        }\n        \n        \/\/ Inicializar Select2 en el nuevo select\n        const select = div.querySelector('.gofast-select-destino');\n        if (select) {\n            initSelect2Barrios(select);\n            \n            \/\/ Event listener para actualizar nombre\n            jQuery(select).on('change', function() {\n                const barrioId = this.value;\n                const barrio = barrios.find(b => b.id == barrioId);\n                const hiddenInput = div.querySelector('.destino-barrio-nombre');\n                if (hiddenInput) {\n                    hiddenInput.value = barrio ? barrio.nombre : '';\n                }\n                actualizarContadorDestinos();\n            });\n        }\n        \n        actualizarContadorDestinos();\n    }\n    \n    window.eliminarDestino = function(btn) {\n        if (confirm('\u00bfEliminar este destino?')) {\n            \/\/ Buscar el contenedor padre del destino (el div con padding y border)\n            const destinoDiv = btn.closest('div[style*=\"padding:12px\"]') || btn.closest('div[style*=\"padding\"]');\n            if (destinoDiv) {\n                destinoDiv.remove();\n                actualizarContadorDestinos();\n            } else {\n                \/\/ Fallback: buscar cualquier div padre que contenga el select\n                const select = btn.closest('div').querySelector('.gofast-select-destino');\n                if (select) {\n                    select.closest('div[style*=\"border\"]')?.remove();\n                    actualizarContadorDestinos();\n                }\n            }\n        }\n    };\n    \n    \/\/ Funci\u00f3n para cerrar el modal - disponible globalmente\n    window.cerrarModalEditar = function() {\n        const modal = document.getElementById('modal-editar-destinos');\n        if (!modal) return;\n        \n        modal.style.display = 'none';\n        \n        \/\/ Restaurar scroll del body\n        document.body.style.overflow = '';\n        \n        \/\/ Resetear scroll del modal para la pr\u00f3xima vez que se abra\n        modal.scrollTop = 0;\n    };\n    \n    \/\/ Tambi\u00e9n exponerla sin el prefijo window para compatibilidad\n    if (typeof cerrarModalEditar === 'undefined') {\n        window.cerrarModalEditar = window.cerrarModalEditar;\n    }\n    \n    \/\/ Cerrar modal al hacer clic fuera\n    const modalElement = document.getElementById('modal-editar-destinos');\n    if (modalElement) {\n        modalElement.addEventListener('click', function(e) {\n            if (e.target === this) {\n                window.cerrarModalEditar();\n            }\n        });\n        \n        \/\/ Prevenir que el modal se cierre al hacer clic en el contenido\n        const modalContent = modalElement.querySelector('.modal-editar-destinos-content');\n        if (modalContent) {\n            modalContent.addEventListener('click', function(e) {\n                e.stopPropagation();\n            });\n        }\n    }\n    \n    \/\/ Agregar event listener al bot\u00f3n de cancelar del modal\n    \/\/ Esto asegura que funcione incluso si el onclick no se ejecuta correctamente\n    document.addEventListener('click', function(e) {\n        const target = e.target;\n        \/\/ Verificar si es el bot\u00f3n de cancelar del modal de editar destinos\n        if (target && target.type === 'button' && \n            target.classList.contains('gofast-btn-outline') &&\n            target.textContent && target.textContent.trim() === 'Cancelar' && \n            target.closest('#modal-editar-destinos')) {\n            e.preventDefault();\n            e.stopPropagation();\n            if (typeof window.cerrarModalEditar === 'function') {\n                window.cerrarModalEditar();\n            }\n            return false;\n        }\n    });\n    \n    \/\/ Procesar formulario antes de enviar\n    document.getElementById('form-editar-destinos').addEventListener('submit', function(e) {\n        e.preventDefault(); \/\/ Prevenir env\u00edo normal para procesar datos primero\n        \n        const destinos = [];\n        const container = document.getElementById('destinos-container');\n        const selects = container.querySelectorAll('.gofast-select-destino');\n        \n        selects.forEach(function(select) {\n            const barrioId = select.value;\n            if (barrioId) {\n                \/\/ Buscar el contenedor padre del destino (div con padding:12px)\n                const parentDiv = select.closest('div[style*=\"padding:12px\"]') || \n                                 select.closest('div[style*=\"padding\"]') ||\n                                 select.closest('div');\n                \n                if (parentDiv) {\n                    \/\/ Obtener el nombre del barrio desde el input hidden\n                    const barrioNombreInput = parentDiv.querySelector('.destino-barrio-nombre');\n                    let barrioNombre = '';\n                    if (barrioNombreInput) {\n                        barrioNombre = barrioNombreInput.value;\n                    } else {\n                        \/\/ Si no existe, buscar en el select el texto seleccionado\n                        const selectedOption = select.options[select.selectedIndex];\n                        barrioNombre = selectedOption ? selectedOption.text : '';\n                    }\n                    \n                    \/\/ Obtener el \u00edndice del nombre del campo\n                    const nameAttr = select.getAttribute('name');\n                    const indexMatch = nameAttr ? nameAttr.match(\/\\d+\/) : null;\n                    const index = indexMatch ? indexMatch[0] : selects.length;\n                    \n                    \/\/ Obtener direcci\u00f3n y monto\n                    const direccionInput = parentDiv.querySelector(`input[name=\"destino_dir_${index}\"]`);\n                    const montoInput = parentDiv.querySelector(`input[name=\"destino_monto_${index}\"]`);\n                    \n                    const direccion = direccionInput ? direccionInput.value.trim() : '';\n                    const monto = montoInput ? (parseInt(montoInput.value) || 0) : 0;\n                    \n                    destinos.push({\n                        barrio_id: parseInt(barrioId),\n                        barrio_nombre: barrioNombre,\n                        direccion: direccion,\n                        monto: monto\n                    });\n                }\n            }\n        });\n        \n        if (destinos.length === 0) {\n            alert('Debe haber al menos un destino.');\n            return false;\n        }\n        \n        \/\/ Guardar en el campo hidden\n        const jsonData = JSON.stringify({ destinos: destinos });\n        document.getElementById('destinos-editados-json').value = jsonData;\n        \n        \/\/ Debug (remover en producci\u00f3n)\n        console.log('Destinos a guardar:', jsonData);\n        console.log('ID del servicio:', document.getElementById('editar-destinos-id').value);\n        \n        \/\/ Enviar el formulario\n        this.submit();\n    });\n    \n    \/\/ Inicializar Select2 para filtros de barrios con buscador mejorado\n    \/\/ Las funciones ya est\u00e1n disponibles globalmente (window.normalize y window.matcherDestinos)\n    if (window.jQuery && jQuery.fn.select2 && typeof window.matcherDestinos === 'function' && typeof window.normalize === 'function') {\n        jQuery('.gofast-select-filtro').each(function() {\n            \/\/ Evitar inicializar dos veces\n            if (jQuery(this).data('select2')) {\n                return;\n            }\n            \n            jQuery(this).select2({\n            placeholder: function() {\n                return jQuery(this).data('placeholder') || '\ud83d\udd0d Escribe para buscar...';\n            },\n            width: '100%',\n            allowClear: false,\n            minimumResultsForSearch: 0,\n            matcher: matcherDestinos,\n            sorter: function(results) {\n                return results.sort(function(a, b) {\n                    return (b.matchScore || 0) - (a.matchScore || 0);\n                });\n            },\n            templateResult: function(data, container) {\n                if (!data || !data.text) {\n                    return data ? data.text : '';\n                }\n                \n                if (!data.id) return data.text;\n                \n                let originalText = data.text;\n                \n                \/\/ Obtener el t\u00e9rmino de b\u00fasqueda\n                let searchTerm = \"\";\n                const $activeField = jQuery('.select2-container--open .select2-search__field');\n                if ($activeField.length) {\n                    searchTerm = $activeField.val() || \"\";\n                }\n                \n                if (!searchTerm || !searchTerm.trim()) {\n                    const $result = jQuery('<span>').text(originalText);\n                    if (data.matchScore !== undefined) {\n                        $result.attr('data-match-score', data.matchScore);\n                    }\n                    return $result;\n                }\n                \n                \/\/ Normalizar para b\u00fasqueda\n                const normalizedSearch = window.normalize(searchTerm);\n                const normalizedText = window.normalize(originalText);\n                \n                \/\/ Dividir t\u00e9rmino en palabras significativas\n                const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n                const searchWords = normalizedSearch.split(\/\\s+\/).filter(Boolean).filter(word => {\n                    return word.length > 2 && !stopWords.includes(word);\n                });\n                \n                const wordsToHighlight = searchWords.length > 0 ? searchWords : [normalizedSearch];\n                \n                \/\/ Encontrar coincidencias y mapear a texto original\n                const highlightRanges = [];\n                \n                wordsToHighlight.forEach(function(word) {\n                    let searchPos = 0;\n                    while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {\n                        const endPos = searchPos + word.length;\n                        \n                        \/\/ Mapear posiciones normalizadas a originales\n                        let origStart = -1;\n                        let origEnd = -1;\n                        let normPos = 0;\n                        \n                        \/\/ Encontrar inicio\n                        for (let i = 0; i < originalText.length && origStart === -1; i++) {\n                            const charNorm = window.normalize(originalText[i]);\n                            if (normPos === searchPos) {\n                                origStart = i;\n                            }\n                            normPos += charNorm.length;\n                        }\n                        \n                        \/\/ Encontrar fin\n                        if (origStart >= 0) {\n                            normPos = searchPos;\n                            for (let i = origStart; i < originalText.length; i++) {\n                                const charNorm = window.normalize(originalText[i]);\n                                normPos += charNorm.length;\n                                if (normPos >= endPos) {\n                                    origEnd = i + 1;\n                                    break;\n                                }\n                            }\n                            \n                            if (origStart >= 0 && origEnd > origStart) {\n                                highlightRanges.push({ start: origStart, end: origEnd });\n                            }\n                        }\n                        \n                        searchPos = endPos;\n                    }\n                });\n                \n                \/\/ Fusionar rangos solapados\n                if (highlightRanges.length > 0) {\n                    highlightRanges.sort((a, b) => a.start - b.start);\n                    const mergedRanges = [highlightRanges[0]];\n                    \n                    for (let i = 1; i < highlightRanges.length; i++) {\n                        const current = highlightRanges[i];\n                        const last = mergedRanges[mergedRanges.length - 1];\n                        \n                        if (current.start <= last.end) {\n                            last.end = Math.max(last.end, current.end);\n                        } else {\n                            mergedRanges.push(current);\n                        }\n                    }\n                    \n                    \/\/ Construir resultado con resaltados\n                    const parts = [];\n                    let lastIndex = 0;\n                    \n                    mergedRanges.forEach(function(range) {\n                        if (range.start > lastIndex) {\n                            parts.push(originalText.substring(lastIndex, range.start));\n                        }\n                        \n                        const matchText = originalText.substring(range.start, range.end);\n                        parts.push('<span style=\"background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;\">' + \n                                   matchText + '<\/span>');\n                        \n                        lastIndex = range.end;\n                    });\n                    \n                    if (lastIndex < originalText.length) {\n                        parts.push(originalText.substring(lastIndex));\n                    }\n                    \n                    const result = parts.join('');\n                    const $result = jQuery('<span>').html(result);\n                    if (data.matchScore !== undefined) {\n                        $result.attr('data-match-score', data.matchScore);\n                    }\n                    return $result;\n                }\n                \n                \/\/ Si no hay coincidencias, retornar texto sin resaltar\n                const $result = jQuery('<span>').text(originalText);\n                if (data.matchScore !== undefined) {\n                    $result.attr('data-match-score', data.matchScore);\n                }\n                return $result;\n            }\n        }).on('select2:open', function(e) {\n            \/\/ Asegurar que el campo de b\u00fasqueda sea visible\n            setTimeout(function() {\n                const $dropdown = jQuery('.select2-dropdown');\n                const $searchContainer = $dropdown.find('.select2-search--dropdown');\n                const $searchField = $searchContainer.find('.select2-search__field');\n                \n                if ($searchContainer.length) {\n                    $searchContainer.css({\n                        'display': 'block',\n                        'visibility': 'visible',\n                        'opacity': '1'\n                    });\n                }\n                \n                if ($searchField.length) {\n                    $searchField.css({\n                        'display': 'block',\n                        'visibility': 'visible',\n                        'opacity': '1'\n                    });\n                    \n                    setTimeout(function() {\n                        $searchField.focus();\n                    }, 100);\n                }\n            }, 50);\n        });\n        });\n        \n        \/\/ Ocultar todos los selects con Select2 inmediatamente despu\u00e9s de inicializarlos\n        jQuery('.gofast-select-filtro').each(function() {\n            if (jQuery(this).data('select2')) {\n                jQuery(this).css({\n                    'visibility': 'hidden',\n                    'position': 'absolute',\n                    'width': '1px',\n                    'height': '1px',\n                    'opacity': '0',\n                    'pointer-events': 'none'\n                });\n            }\n        });\n    } else {\n        \/\/ Si las funciones no est\u00e1n disponibles, reintentar despu\u00e9s de un breve delay\n        setTimeout(function() {\n            if (window.jQuery && jQuery.fn.select2 && typeof window.matcherDestinos === 'function' && typeof window.normalize === 'function') {\n                jQuery('.gofast-select-filtro').each(function() {\n                    if (jQuery(this).data('select2')) {\n                        return;\n                    }\n                    \n                    jQuery(this).select2({\n                        placeholder: function() {\n                            return jQuery(this).data('placeholder') || '\ud83d\udd0d Escribe para buscar...';\n                        },\n                        width: '100%',\n                        allowClear: false,\n                        minimumResultsForSearch: 0,\n                        matcher: window.matcherDestinos,\n                        sorter: function(results) {\n                            return results.sort(function(a, b) {\n                                return (b.matchScore || 0) - (a.matchScore || 0);\n                            });\n                        },\n                        templateResult: function(data, container) {\n                            if (!data || !data.text) {\n                                return data ? data.text : '';\n                            }\n                            \n                            if (!data.id) return data.text;\n                            \n                            let originalText = data.text;\n                            let searchTerm = \"\";\n                            const $activeField = jQuery('.select2-container--open .select2-search__field');\n                            if ($activeField.length) {\n                                searchTerm = $activeField.val() || \"\";\n                            }\n                            \n                            if (!searchTerm || !searchTerm.trim()) {\n                                const $result = jQuery('<span>').text(originalText);\n                                if (data.matchScore !== undefined) {\n                                    $result.attr('data-match-score', data.matchScore);\n                                }\n                                return $result;\n                            }\n                            \n                            const normalizedSearch = window.normalize(searchTerm);\n                            const normalizedText = window.normalize(originalText);\n                            const stopWords = ['las', 'los', 'la', 'el', 'de', 'del', 'en', 'un', 'una', 'y', 'o'];\n                            const searchWords = normalizedSearch.split(\/\\s+\/).filter(Boolean).filter(word => {\n                                return word.length > 2 && !stopWords.includes(word);\n                            });\n                            const wordsToHighlight = searchWords.length > 0 ? searchWords : [normalizedSearch];\n                            const highlightRanges = [];\n                            \n                            wordsToHighlight.forEach(function(word) {\n                                let searchPos = 0;\n                                while ((searchPos = normalizedText.indexOf(word, searchPos)) !== -1) {\n                                    const endPos = searchPos + word.length;\n                                    let origStart = -1;\n                                    let origEnd = -1;\n                                    let normPos = 0;\n                                    \n                                    for (let i = 0; i < originalText.length && origStart === -1; i++) {\n                                        const charNorm = window.normalize(originalText[i]);\n                                        if (normPos === searchPos) {\n                                            origStart = i;\n                                        }\n                                        normPos += charNorm.length;\n                                    }\n                                    \n                                    if (origStart >= 0) {\n                                        normPos = searchPos;\n                                        for (let i = origStart; i < originalText.length; i++) {\n                                            const charNorm = window.normalize(originalText[i]);\n                                            normPos += charNorm.length;\n                                            if (normPos >= endPos) {\n                                                origEnd = i + 1;\n                                                break;\n                                            }\n                                        }\n                                        \n                                        if (origStart >= 0 && origEnd > origStart) {\n                                            highlightRanges.push({ start: origStart, end: origEnd });\n                                        }\n                                    }\n                                    \n                                    searchPos = endPos;\n                                }\n                            });\n                            \n                            if (highlightRanges.length > 0) {\n                                highlightRanges.sort((a, b) => a.start - b.start);\n                                const mergedRanges = [highlightRanges[0]];\n                                \n                                for (let i = 1; i < highlightRanges.length; i++) {\n                                    const current = highlightRanges[i];\n                                    const last = mergedRanges[mergedRanges.length - 1];\n                                    \n                                    if (current.start <= last.end) {\n                                        last.end = Math.max(last.end, current.end);\n                                    } else {\n                                        mergedRanges.push(current);\n                                    }\n                                }\n                                \n                                const parts = [];\n                                let lastIndex = 0;\n                                \n                                mergedRanges.forEach(function(range) {\n                                    if (range.start > lastIndex) {\n                                        parts.push(originalText.substring(lastIndex, range.start));\n                                    }\n                                    \n                                    const matchText = originalText.substring(range.start, range.end);\n                                    parts.push('<span style=\"background-color:#F4C524;color:#000;font-weight:bold;padding:1px 2px;\">' + \n                                               matchText + '<\/span>');\n                                    \n                                    lastIndex = range.end;\n                                });\n                                \n                                if (lastIndex < originalText.length) {\n                                    parts.push(originalText.substring(lastIndex));\n                                }\n                                \n                                const result = parts.join('');\n                                const $result = jQuery('<span>').html(result);\n                                if (data.matchScore !== undefined) {\n                                    $result.attr('data-match-score', data.matchScore);\n                                }\n                                return $result;\n                            }\n                            \n                            const $result = jQuery('<span>').text(originalText);\n                            if (data.matchScore !== undefined) {\n                                $result.attr('data-match-score', data.matchScore);\n                            }\n                            return $result;\n                        }\n                    }).on('select2:open', function(e) {\n                        setTimeout(function() {\n                            const $dropdown = jQuery('.select2-dropdown');\n                            const $searchContainer = $dropdown.find('.select2-search--dropdown');\n                            const $searchField = $searchContainer.find('.select2-search__field');\n                            \n                            if ($searchContainer.length) {\n                                $searchContainer.css({\n                                    'display': 'block',\n                                    'visibility': 'visible',\n                                    'opacity': '1'\n                                });\n                            }\n                            \n                            if ($searchField.length) {\n                                $searchField.css({\n                                    'display': 'block',\n                                    'visibility': 'visible',\n                                    'opacity': '1'\n                                });\n                                \n                                setTimeout(function() {\n                                    $searchField.focus();\n                                }, 100);\n                            }\n                        }, 50);\n                    });\n                });\n            }\n        }, 500);\n    }\n})();\n<\/script>\n<?php endif; ?>\n\n<style>\n\/* Los estilos de gofast-home ya est\u00e1n en css.css *\/\n\n\/* Estilos para modal editar destinos *\/\n#modal-editar-destinos {\n    \/* Asegurar que est\u00e9 oculto por defecto *\/\n    display: none !important;\n    align-items: flex-start;\n    justify-content: center;\n    padding-top: 20px;\n    padding-bottom: 20px;\n}\n\n\/* Solo aplicar flex cuando el modal est\u00e9 visible (cuando se cambia a display: block) *\/\n#modal-editar-destinos[style*=\"display: block\"] {\n    display: flex !important;\n}\n\n\/* Estilos para tabla de pedidos *\/\n.gofast-pedidos-table-wrapper .gofast-table-wrap {\n    width: 100%;\n    max-width: 100%;\n    overflow-x: auto !important;\n    overflow-y: visible !important;\n    -webkit-overflow-scrolling: touch;\n    display: block;\n    margin: 0;\n    padding: 0;\n}\n\n.gofast-pedidos-table-wrapper .gofast-pedidos-table {\n    min-width: 1000px;\n    width: 100%;\n    border-collapse: collapse;\n    margin: 0;\n}\n\n\/* Vista Desktop: Mostrar tabla, ocultar cards *\/\n.gofast-pedidos-desktop {\n    display: block;\n}\n\n\/* Vista M\u00f3vil: Cards (oculta en desktop) *\/\n.gofast-pedidos-mobile {\n    display: none;\n}\n\n.gofast-pedidos-cards {\n    width: 100%;\n    max-width: 100%;\n}\n\n.gofast-pedido-card {\n    width: 100%;\n    max-width: 100%;\n    box-sizing: border-box;\n}\n\n\/* Estilos para formulario de filtros *\/\n.gofast-filtros-form {\n    width: 100%;\n    box-sizing: border-box;\n}\n\n.gofast-filtros-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n    gap: 12px;\n    margin-bottom: 12px;\n    width: 100%;\n    box-sizing: border-box;\n}\n\n.gofast-filtros-form label {\n    display: block;\n    font-weight: 600;\n    margin-bottom: 4px;\n    font-size: 13px;\n    color: #000;\n    width: 100%;\n    box-sizing: border-box;\n}\n\n.gofast-filtros-form input[type=\"date\"],\n.gofast-filtros-form input[type=\"text\"],\n.gofast-filtros-form input[type=\"number\"],\n.gofast-filtros-form select {\n    width: 100%;\n    padding: 8px;\n    border: 1px solid #ddd;\n    border-radius: 6px;\n    font-size: 14px;\n    background: #fff;\n    color: #000;\n    box-sizing: border-box;\n    display: block;\n}\n\n\/* Ocultar select original cuando Select2 est\u00e1 activo - INMEDIATAMENTE *\/\n.gofast-filtros-form select.gofast-select-filtro {\n    visibility: hidden !important;\n    position: absolute !important;\n    width: 1px !important;\n    height: 1px !important;\n    opacity: 0 !important;\n    pointer-events: none !important;\n    margin: 0 !important;\n    padding: 0 !important;\n    border: none !important;\n    overflow: hidden !important;\n    clip: rect(0, 0, 0, 0) !important;\n}\n\n\/* Mostrar el contenedor de Select2 *\/\n.gofast-filtros-form .select2-container {\n    width: 100% !important;\n    display: block !important;\n    margin-bottom: 16px !important;\n}\n\n\/* Estilos unificados para Select2 en filtros (desktop) - igual que en cotizador *\/\n.gofast-filtros-form .select2-container--default .select2-selection--single {\n    background: #fff !important;\n    border: 1px solid var(--gofast-gray-400) !important;\n    border-radius: var(--radius-s) !important;\n    height: 42px !important;\n    padding: 0 !important;\n    padding-left: 10px !important;\n    padding-right: 30px !important;\n    display: flex !important;\n    align-items: center !important;\n    position: relative !important;\n    box-sizing: border-box !important;\n}\n\n.gofast-filtros-form .select2-container--default .select2-selection--single .select2-selection__rendered {\n    background: #fff !important;\n    color: #000 !important;\n    line-height: 30px !important;\n    padding: 0 !important;\n    display: flex !important;\n    align-items: center !important;\n    height: 100% !important;\n    width: calc(100% - 30px) !important;\n    box-sizing: border-box !important;\n    overflow: hidden !important;\n    text-overflow: ellipsis !important;\n    white-space: nowrap !important;\n}\n\n.gofast-filtros-form .select2-selection__rendered {\n    color: #000 !important;\n    line-height: 30px !important;\n    background: #fff !important;\n    display: flex !important;\n    align-items: center !important;\n    padding: 0 !important;\n    width: calc(100% - 30px) !important;\n    box-sizing: border-box !important;\n    overflow: hidden !important;\n    text-overflow: ellipsis !important;\n    white-space: nowrap !important;\n}\n\n.gofast-filtros-form .select2-container--default.select2-container--focus .select2-selection--single,\n.gofast-filtros-form .select2-container--default.select2-container--open .select2-selection--single,\n.gofast-filtros-form .select2-container--default .select2-selection--single[aria-expanded=\"false\"],\n.gofast-filtros-form .select2-container--default .select2-selection--single[aria-expanded=\"true\"] {\n    background: #fff !important;\n}\n\n.gofast-filtros-form .select2-selection__arrow {\n    height: 42px !important;\n    top: 0 !important;\n    right: 8px !important;\n    width: 20px !important;\n    display: flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    position: absolute !important;\n}\n\n.gofast-filtros-form .select2-selection__arrow b {\n    border-color: #555 transparent transparent transparent !important;\n    margin-top: 0 !important;\n    top: 50% !important;\n    transform: translateY(-50%) !important;\n}\n\n\/* Responsive para m\u00f3vil - tabla de pedidos *\/\n@media (max-width: 768px) {\n    \n    .gofast-pedidos-table-wrapper {\n        width: 100% !important;\n        max-width: 100% !important;\n        overflow-x: visible !important;\n        margin: 0;\n        padding: 0;\n        display: block !important;\n        visibility: visible !important;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-table-wrap {\n        overflow-x: scroll !important;\n        -webkit-overflow-scrolling: touch;\n        scrollbar-width: thin;\n        margin: 0;\n        padding: 0;\n        width: 100%;\n        max-width: 100%;\n        display: block !important;\n        visibility: visible !important;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-table-wrap::-webkit-scrollbar {\n        height: 8px;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-table-wrap::-webkit-scrollbar-track {\n        background: #f1f1f1;\n        border-radius: 4px;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-table-wrap::-webkit-scrollbar-thumb {\n        background: #888;\n        border-radius: 4px;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-pedidos-table {\n        min-width: 1000px;\n        font-size: 13px;\n        display: table !important;\n        visibility: visible !important;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-pedidos-table th,\n    .gofast-pedidos-table-wrapper .gofast-pedidos-table td {\n        padding: 10px 8px;\n        font-size: 12px;\n        white-space: nowrap;\n        display: table-cell !important;\n        visibility: visible !important;\n    }\n    \n    \/* Ocultar tabla en m\u00f3vil, mostrar cards *\/\n    .gofast-pedidos-desktop {\n        display: none !important;\n    }\n    \n    .gofast-pedidos-mobile {\n        display: block !important;\n    }\n    \n    .gofast-pedidos-cards {\n        width: 100% !important;\n        max-width: 100% !important;\n        padding: 0 !important;\n        margin: 0 !important;\n        box-sizing: border-box !important;\n    }\n    \n    .gofast-pedido-card {\n        width: 100% !important;\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n    }\n    \n    .gofast-pedido-card * {\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n    }\n    \n    \/* Filtros en m\u00f3vil - Layout corregido *\/\n    .gofast-filtros-grid {\n        grid-template-columns: 1fr !important;\n        gap: 12px !important;\n    }\n    \n    .gofast-filtros-grid > div {\n        width: 100% !important;\n        min-width: 100% !important;\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n        display: block !important;\n        margin: 0 !important;\n        padding: 0 !important;\n        float: none !important;\n        clear: both !important;\n    }\n    \n    .gofast-filtros-form label {\n        display: block !important;\n        width: 100% !important;\n        max-width: 100% !important;\n        margin-bottom: 4px !important;\n        margin-left: 0 !important;\n        margin-right: 0 !important;\n        box-sizing: border-box !important;\n    }\n    \n    .gofast-filtros-form select,\n    .gofast-filtros-form input[type=\"text\"],\n    .gofast-filtros-form input[type=\"date\"] {\n        width: 100% !important;\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n        display: block !important;\n        margin-left: 0 !important;\n        margin-right: 0 !important;\n        float: none !important;\n    }\n    \n    \/* Asegurar que Select2 en filtros m\u00f3viles tenga el ancho correcto *\/\n    .gofast-filtros-form .select2-container {\n        width: 100% !important;\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n        display: block !important;\n        margin: 0 !important;\n    }\n    \n    \/* Estilos Select2 en m\u00f3vil - EXACTAMENTE igual que en el cotizador *\/\n    .gofast-filtros-form .select2-container--default .select2-selection--single {\n        height: 50px !important;\n        padding: 0 !important;\n        padding-left: 12px !important;\n        padding-right: 35px !important;\n        font-size: 16px !important;\n        display: flex !important;\n        align-items: center !important;\n        position: relative !important;\n        box-sizing: border-box !important;\n    }\n    \n    .gofast-filtros-form .select2-container--default .select2-selection--single .select2-selection__rendered {\n        line-height: 34px !important;\n        font-size: 16px !important;\n        padding: 0 !important;\n        display: flex !important;\n        align-items: center !important;\n        height: 100% !important;\n        width: 100% !important;\n        box-sizing: border-box !important;\n        overflow: hidden !important;\n        text-overflow: ellipsis !important;\n        white-space: nowrap !important;\n        margin-right: 35px !important;\n    }\n    \n    .gofast-filtros-form .select2-selection__rendered {\n        line-height: 34px !important;\n        font-size: 16px !important;\n        display: flex !important;\n        align-items: center !important;\n        padding: 0 !important;\n        width: 100% !important;\n        box-sizing: border-box !important;\n        overflow: hidden !important;\n        text-overflow: ellipsis !important;\n        white-space: nowrap !important;\n        margin-right: 35px !important;\n    }\n    \n    \/* Asegurar que el span dentro del rendered tenga el tama\u00f1o correcto *\/\n    .gofast-filtros-form .select2-selection__rendered span,\n    .gofast-filtros-form .select2-container--default .select2-selection--single .select2-selection__rendered span {\n        font-size: 16px !important;\n        line-height: 34px !important;\n        display: inline-block !important;\n        width: 100% !important;\n        overflow: hidden !important;\n        text-overflow: ellipsis !important;\n        white-space: nowrap !important;\n    }\n    \n    .gofast-filtros-form .select2-selection__arrow {\n        display: flex !important;\n        align-items: center !important;\n        justify-content: center !important;\n        position: absolute !important;\n        right: 10px !important;\n        width: 20px !important;\n    }\n    \n    .gofast-filtros-form .select2-selection__arrow b {\n        margin-top: 0 !important;\n        top: 50% !important;\n        transform: translateY(-50%) !important;\n    }\n    \n    .gofast-filtros-form button,\n    .gofast-filtros-form a {\n        width: 100% !important;\n        min-width: 100% !important;\n        max-width: 100% !important;\n        box-sizing: border-box !important;\n    }\n    \n    \/* Modal editar destinos en m\u00f3vil *\/\n    #modal-editar-destinos {\n        padding: 10px !important;\n        \/* No forzar display aqu\u00ed - respetar el display:none del inline style *\/\n        align-items: flex-start !important;\n        justify-content: center !important;\n    }\n    \n    \/* Solo aplicar flex cuando el modal est\u00e9 visible en m\u00f3vil *\/\n    #modal-editar-destinos[style*=\"display: block\"] {\n        display: flex !important;\n        scroll-behavior: auto;\n    }\n    \n    .modal-editar-destinos-content {\n        max-width: 100% !important;\n        margin: 10px auto !important;\n        padding: 16px !important;\n        border-radius: 8px !important;\n    }\n    \n    .modal-editar-destinos-title {\n        font-size: 18px !important;\n        margin-bottom: 12px !important;\n    }\n    \n    .modal-servicio-info {\n        padding: 10px !important;\n        font-size: 12px !important;\n    }\n    \n    .modal-servicio-info-grid {\n        grid-template-columns: 1fr !important;\n        gap: 6px 8px !important;\n    }\n    \n    .modal-servicio-info-grid strong {\n        display: block;\n        margin-top: 4px;\n    }\n    \n    .modal-servicio-info-grid strong:first-child {\n        margin-top: 0;\n    }\n    \n    .destino-item-grid {\n        grid-template-columns: 1fr !important;\n        gap: 8px !important;\n    }\n    \n    .destino-item-grid > div {\n        width: 100% !important;\n    }\n    \n    .modal-editar-destinos-buttons {\n        flex-direction: column !important;\n        gap: 8px !important;\n    }\n    \n    .modal-editar-destinos-buttons button {\n        width: 100% !important;\n    }\n    \n    \/* Asegurar que Select2 funcione bien en m\u00f3vil dentro del modal *\/\n    #modal-editar-destinos .select2-container {\n        width: 100% !important;\n        z-index: auto !important;\n    }\n    \n    #modal-editar-destinos .select2-dropdown {\n        z-index: 10001 !important;\n        position: absolute !important;\n        max-width: 100% !important;\n        max-height: 300px !important;\n        overflow-y: auto !important;\n    }\n    \n    \/* Cuando el modal tiene scroll, el dropdown debe posicionarse correctamente *\/\n    #modal-editar-destinos .select2-container--open {\n        z-index: 10002 !important;\n    }\n    \n    #modal-editar-destinos .select2-container--open .select2-dropdown {\n        z-index: 10001 !important;\n    }\n    \n    \/* Ajustar posicionamiento cuando el dropdown se abre hacia arriba *\/\n    #modal-editar-destinos .select2-container--above .select2-dropdown {\n        margin-top: 0 !important;\n        margin-bottom: 4px !important;\n    }\n    \n    \/* Asegurar que el dropdown sea visible en m\u00f3vil *\/\n    .gofast-select-down-modal {\n        z-index: 10001 !important;\n    }\n    \n    \/* Ajustar posicionamiento cuando el dropdown se abre hacia arriba *\/\n    #modal-editar-destinos .select2-container--above .select2-dropdown {\n        margin-top: 0 !important;\n        margin-bottom: 4px !important;\n    }\n    \n    \/* Asegurar que el dropdown no se corte por overflow *\/\n    #modal-editar-destinos .select2-dropdown {\n        position: fixed !important;\n        max-height: 300px !important;\n        overflow-y: auto !important;\n    }\n    \n}\n\n\/* Para pantallas muy peque\u00f1as *\/\n@media (max-width: 480px) {\n    \n    .gofast-pedidos-table-wrapper .gofast-pedidos-table {\n        min-width: 900px;\n        font-size: 12px;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-pedidos-table th,\n    .gofast-pedidos-table-wrapper .gofast-pedidos-table td {\n        padding: 8px 6px;\n        font-size: 11px;\n    }\n    \n    \/* Ocultar algunas columnas en m\u00f3vil muy peque\u00f1o *\/\n    .gofast-pedidos-table-wrapper .gofast-pedidos-table th:nth-child(4),\n    .gofast-pedidos-table-wrapper .gofast-pedidos-table td:nth-child(4) {\n        display: none !important;\n    }\n    \n    .gofast-pedidos-table-wrapper .gofast-pedidos-table th:nth-child(5),\n    .gofast-pedidos-table-wrapper .gofast-pedidos-table td:nth-child(5) {\n        display: none !important;\n    }\n}\n\n\/* Desktop: Mostrar tabla, ocultar cards *\/\n@media (min-width: 769px) {\n    .gofast-pedidos-desktop {\n        display: block !important;\n    }\n    \n    .gofast-pedidos-mobile {\n        display: none !important;\n    }\n}\n<\/style>\n\n<?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_pedidos', 'gofast_pedidos_shortcode');\n\n\n","active":true,"modified":"2025-12-11 00:01:18","revision":"1"}]}