{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":32,"name":"gofast_cotizar_intermunicipal","code":"\n\/*******************************************************\n * \ud83d\ude9a GOFAST \u2014 COTIZADOR ENV\u00cdOS INTERMUNICIPALES\n * Shortcode: [gofast_cotizar_intermunicipal]\n * URL: \/cotizar-intermunicipal\n * \n * Caracter\u00edsticas:\n * - Origen siempre desde Tulu\u00e1\n * - Destinos fijos con valores predefinidos\n * - Pago anticipado requerido\n * - Solo zona urbana\n *******************************************************\/\n\nfunction gofast_cotizar_intermunicipal_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    \/\/ Obtener destinos intermunicipales desde la base de datos\n    $destinos_intermunicipales = [];\n    \n    try {\n        \/\/ Verificar si la tabla existe antes de consultar (sin prefijo, como otras tablas gofast)\n        $table_exists = $wpdb->get_var(\"SHOW TABLES LIKE 'destinos_intermunicipales'\");\n        \n        if ($table_exists) {\n            $destinos_db = $wpdb->get_results(\n                \"SELECT id, nombre, valor \n                 FROM destinos_intermunicipales \n                 WHERE activo = 1 \n                 ORDER BY orden ASC, nombre ASC\"\n            );\n            \n            if ($destinos_db && is_array($destinos_db)) {\n                foreach ($destinos_db as $destino_db) {\n                    if (isset($destino_db->nombre) && isset($destino_db->valor)) {\n                        $destinos_intermunicipales[$destino_db->nombre] = intval($destino_db->valor);\n                    }\n                }\n            }\n        }\n    } catch (Exception $e) {\n        \/\/ Silenciar error y usar fallback\n        error_log('Error al obtener destinos intermunicipales: ' . $e->getMessage());\n    }\n    \n    \/\/ Fallback si la tabla no existe o no hay resultados\n    if (empty($destinos_intermunicipales)) {\n        $destinos_intermunicipales = [\n            'Andaluc\u00eda' => 20000,\n            'Bugalagrande' => 25000,\n            'Riofr\u00edo' => 20000,\n            'Buga' => 35000,\n            'San Pedro' => 25000,\n            'Los chanchos' => 20000,\n            'Sal\u00f3nica' => 35000,\n            'La Marina' => 25000,\n            'Presidente' => 30000,\n            'La Paila' => 35000,\n            'Zarzal' => 50000,\n        ];\n    }\n\n    \/\/ Origen por defecto es Tulu\u00e1\n    $origen_fijo = 'Tulu\u00e1';\n    \n    \/\/ Obtener negocios del usuario logueado\n    $user_id = isset($_SESSION['gofast_user_id']) ? intval($_SESSION['gofast_user_id']) : 0;\n    $rol = strtolower($_SESSION['gofast_user_rol'] ?? '');\n    $es_mensajero_o_admin = ($rol === 'mensajero' || $rol === 'admin');\n    \n    $mis_negocios = [];\n    if ($user_id > 0) {\n        $mis_negocios = $wpdb->get_results($wpdb->prepare(\n            \"SELECT id, nombre, direccion_full, barrio_id, whatsapp\n             FROM negocios_gofast\n             WHERE user_id = %d AND activo = 1\n             ORDER BY id DESC\",\n            $user_id\n        ));\n    }\n    \n    \/\/ Si es mensajero o admin, obtener TODOS los negocios\n    $todos_negocios = [];\n    if ($es_mensajero_o_admin) {\n        $todos_negocios = $wpdb->get_results(\n            \"SELECT n.id, n.nombre, n.direccion_full, n.barrio_id, n.whatsapp, n.user_id,\n                    u.nombre as cliente_nombre, u.telefono as cliente_telefono\n             FROM negocios_gofast n\n             INNER JOIN usuarios_gofast u ON n.user_id = u.id\n             WHERE n.activo = 1 AND u.activo = 1\n             ORDER BY n.nombre ASC\"\n        );\n    }\n    \n    \/\/ Recuperar \u00faltima selecci\u00f3n de origen\n    $origen_seleccionado = isset($_SESSION['gofast_intermunicipal_last_origen']) \n        ? $_SESSION['gofast_intermunicipal_last_origen'] \n        : 'tulua';\n\n    \/\/ Si se env\u00eda el formulario, redirigir a la p\u00e1gina de solicitud\n    if (isset($_POST['gofast_cotizar_intermunicipal'])) {\n        $destino_seleccionado = sanitize_text_field($_POST['destino_intermunicipal'] ?? '');\n        $origen_seleccionado = sanitize_text_field($_POST['origen_intermunicipal'] ?? 'tulua');\n        $negocio_id_cotizador = isset($_POST['negocio_id']) ? intval($_POST['negocio_id']) : 0;\n        \n        if (empty($destino_seleccionado) || !isset($destinos_intermunicipales[$destino_seleccionado])) {\n            $error = 'Debes seleccionar un destino v\u00e1lido.';\n        } else {\n            \/\/ Determinar origen y datos del negocio\n            $origen_nombre = $origen_fijo;\n            $origen_direccion = $origen_fijo;\n            $negocio_seleccionado = null;\n            $negocio_user_id = null; \/\/ ID del cliente propietario del negocio\n            \n            if ($origen_seleccionado !== 'tulua') {\n                \/\/ Extraer ID del negocio del formato \"negocio_X\"\n                $negocio_id = 0;\n                if (preg_match('\/^negocio_(\\d+)$\/', $origen_seleccionado, $matches)) {\n                    $negocio_id = intval($matches[1]);\n                } else {\n                    \/\/ Fallback: intentar como n\u00famero directo\n                    $negocio_id = intval($origen_seleccionado);\n                }\n                \n                \/\/ Buscar en los negocios del usuario o en todos los negocios\n                $negocios_disponibles = $es_mensajero_o_admin ? $todos_negocios : $mis_negocios;\n                \n                foreach ($negocios_disponibles as $neg) {\n                    if (intval($neg->id) === $negocio_id) {\n                        $negocio_seleccionado = $neg;\n                        $barrio_nombre = $wpdb->get_var($wpdb->prepare(\n                            \"SELECT nombre FROM barrios WHERE id = %d\",\n                            $neg->barrio_id\n                        ));\n                        $origen_nombre = $neg->nombre . ' \u2014 ' . ($barrio_nombre ?: 'Tulu\u00e1');\n                        $origen_direccion = $neg->direccion_full ?: $neg->nombre;\n                        $negocio_user_id = $neg->user_id; \/\/ Guardar el ID del cliente propietario\n                        break;\n                    }\n                }\n            }\n            \n            \/\/ Obtener datos del usuario para prellenar si es Tulu\u00e1\n            $usuario_nombre = '';\n            $usuario_telefono = '';\n            if ($origen_seleccionado === 'tulua' && $user_id > 0) {\n                $usuario_data = $wpdb->get_row($wpdb->prepare(\n                    \"SELECT nombre, telefono \n                     FROM usuarios_gofast \n                     WHERE id = %d AND activo = 1\",\n                    $user_id\n                ));\n                if ($usuario_data) {\n                    $usuario_nombre = $usuario_data->nombre;\n                    $usuario_telefono = $usuario_data->telefono;\n                }\n            }\n            \n            \/\/ Guardar en sesi\u00f3n\n            $_SESSION['gofast_intermunicipal'] = [\n                'origen' => $origen_nombre,\n                'origen_direccion' => $origen_direccion,\n                'origen_tipo' => ($origen_seleccionado === 'tulua') ? 'tulua' : 'negocio',\n                'negocio_id' => $negocio_seleccionado ? $negocio_seleccionado->id : null,\n                'negocio_user_id' => $negocio_user_id, \/\/ ID del cliente propietario\n                'negocio_nombre' => $negocio_seleccionado ? $negocio_seleccionado->nombre : null,\n                'negocio_whatsapp' => $negocio_seleccionado ? ($negocio_seleccionado->whatsapp ?? null) : null,\n                'usuario_nombre' => $usuario_nombre,\n                'usuario_telefono' => $usuario_telefono,\n                'destino' => $destino_seleccionado,\n                'valor' => $destinos_intermunicipales[$destino_seleccionado],\n                'direccion_recogida' => '',\n            ];\n            \n            \/\/ Guardar \u00faltima selecci\u00f3n de origen\n            $_SESSION['gofast_intermunicipal_last_origen'] = $origen_seleccionado;\n            \n            \/\/ Redirigir a p\u00e1gina de solicitud\n            $url_solicitar = esc_url(home_url('\/solicitar-intermunicipal'));\n            return '<script>window.location.href = \"'.$url_solicitar.'\";<\/script>';\n        }\n    }\n\n    ob_start();\n    ?>\n    <div class=\"gofast-form\">\n        \n        <!-- Mensaje informativo -->\n        <div class=\"gofast-box\" style=\"background: #fff3cd; border-left: 5px solid var(--gofast-amber); padding: 16px; margin-bottom: 20px;\">\n            <h3 style=\"margin-top: 0; color: #856404;\">\ud83d\udccb Condiciones del Servicio Intermunicipal<\/h3>\n            <ul style=\"margin: 0; padding-left: 20px; color: #856404;\">\n                <li>\u2705 El pedido debe estar <strong>pago con anticipaci\u00f3n<\/strong> antes de solicitar el servicio.<\/li>\n                <li>\u2705 El valor del env\u00edo tambi\u00e9n debe ser <strong>cancelado antes<\/strong> de despachar al mensajero.<\/li>\n                <li>\u2705 Solo se aceptan env\u00edos para <strong>zona urbana<\/strong>.<\/li>\n                <li>\ud83d\udccd Se debe anexar la <strong>ubicaci\u00f3n en tiempo real<\/strong> del cliente que recibe el domicilio en el destino.<\/li>\n                <li>\u2699\ufe0f La disponibilidad de este servicio est\u00e1 <strong>sujeta a la administraci\u00f3n<\/strong>.<\/li>\n                <li>\u26a0\ufe0f En caso de <strong>devoluci\u00f3n del pedido<\/strong> se cobrar\u00e1 un recargo adicional.<\/li>\n                <li>\ud83d\ude9a El env\u00edo es desde <strong>Tulu\u00e1<\/strong> o desde uno de tus negocios registrados.<\/li>\n            <\/ul>\n        <\/div>\n\n        <?php if (!empty($error)): ?>\n            <div class=\"gofast-box\" style=\"background: #ffe5e5; border-left: 5px solid var(--gofast-danger); padding: 12px; margin-bottom: 16px;\">\n                \u26a0\ufe0f <?php echo esc_html($error); ?>\n            <\/div>\n        <?php endif; ?>\n\n        <form method=\"post\" id=\"gofast-form-intermunicipal\">\n            \n            <!-- Origen (Tulu\u00e1 o negocio del usuario\/mensajero\/admin) -->\n            <div class=\"gofast-row\">\n                <div style=\"flex: 1;\">\n                    <label><strong>Origen<\/strong><\/label>\n                    <?php if (!empty($mis_negocios) || !empty($todos_negocios) || $user_id > 0): ?>\n                        <select name=\"origen_intermunicipal\" class=\"gofast-select\" id=\"origen-intermunicipal\" required>\n                            <option value=\"tulua\" <?php echo ($origen_seleccionado === 'tulua') ? 'selected' : ''; ?>>\n                                \ud83d\ude9a Tulu\u00e1 (Datos del cliente)\n                            <\/option>\n                            <?php \n                            \/\/ Mostrar todos los negocios si es mensajero\/admin, sino solo los del usuario\n                            $negocios_a_mostrar = $es_mensajero_o_admin && !empty($todos_negocios) ? $todos_negocios : $mis_negocios;\n                            \n                            if (!empty($negocios_a_mostrar)): \n                                foreach ($negocios_a_mostrar as $neg): \n                                    $barrio_nombre = $wpdb->get_var($wpdb->prepare(\n                                        \"SELECT nombre FROM barrios WHERE id = %d\",\n                                        $neg->barrio_id\n                                    ));\n                                    \n                                    \/\/ Para todos los negocios (mensajero\/admin), usar formato diferente\n                                    if ($es_mensajero_o_admin && isset($neg->cliente_nombre)) {\n                                        $negocio_value = 'negocio_' . $neg->id;\n                                        $isSelected = ($origen_seleccionado === $negocio_value);\n                            ?>\n                                <option value=\"<?php echo esc_attr($negocio_value); ?>\" \n                                        data-negocio-id=\"<?php echo esc_attr($neg->id); ?>\"\n                                        data-negocio-nombre=\"<?php echo esc_attr($neg->nombre); ?>\"\n                                        data-negocio-direccion=\"<?php echo esc_attr($neg->direccion_full); ?>\"\n                                        data-negocio-whatsapp=\"<?php echo esc_attr($neg->cliente_telefono); ?>\"\n                                        data-cliente-id=\"<?php echo esc_attr($neg->user_id); ?>\"\n                                        <?php echo $isSelected ? 'selected' : ''; ?>>\n                                    \ud83c\udfea <?php echo esc_html($neg->nombre); ?> \u2014 <?php echo esc_html($barrio_nombre ?: 'Tulu\u00e1'); ?>\n                                <\/option>\n                            <?php \n                                    } else {\n                                        \/\/ Para negocios del usuario (formato normal)\n                                        $negocio_value = 'negocio_' . $neg->id;\n                                        $isSelected = ($origen_seleccionado === $negocio_value);\n                            ?>\n                                <option value=\"<?php echo esc_attr($negocio_value); ?>\" \n                                        data-negocio-id=\"<?php echo esc_attr($neg->id); ?>\"\n                                        data-negocio-nombre=\"<?php echo esc_attr($neg->nombre); ?>\"\n                                        data-negocio-direccion=\"<?php echo esc_attr($neg->direccion_full); ?>\"\n                                        data-negocio-whatsapp=\"<?php echo esc_attr($neg->whatsapp); ?>\"\n                                        <?php echo $isSelected ? 'selected' : ''; ?>>\n                                    \ud83c\udfea <?php echo esc_html($neg->nombre); ?> \u2014 <?php echo esc_html($barrio_nombre ?: 'Tulu\u00e1'); ?>\n                                <\/option>\n                            <?php \n                                    }\n                                endforeach; \n                            endif; \n                            ?>\n                        <\/select>\n                        <small style=\"color: #666; font-size: 13px; display: block; margin-top: 4px;\">\n                            <?php if ($es_mensajero_o_admin && !empty($todos_negocios)): ?>\n                                Si seleccionas un negocio, el servicio quedar\u00e1 asociado al cliente propietario y aparecer\u00e1 en su historial.\n                            <?php elseif (!empty($mis_negocios)): ?>\n                                Selecciona \"Tulu\u00e1\" para usar tus datos personales, o uno de tus negocios para usar los datos del negocio.\n                            <?php else: ?>\n                                Selecciona \"Tulu\u00e1\" para usar tus datos personales. <a href=\"<?php echo esc_url(home_url('\/mi-negocio')); ?>\">Registra un negocio<\/a> para m\u00e1s opciones.\n                            <?php endif; ?>\n                        <\/small>\n                    <?php else: ?>\n                        <input type=\"text\" value=\"<?php echo esc_attr($origen_fijo); ?>\" readonly \n                               style=\"background: #f5f5f5; cursor: not-allowed;\" \n                               class=\"gofast-box input\">\n                        <input type=\"hidden\" name=\"origen_intermunicipal\" value=\"tulua\">\n                        <small style=\"color: #666; font-size: 13px; display: block; margin-top: 4px;\">\n                            El env\u00edo siempre es desde Tulu\u00e1. <a href=\"<?php echo esc_url(home_url('\/mi-negocio')); ?>\">Registra un negocio<\/a> para usar direcciones personalizadas.\n                        <\/small>\n                    <?php endif; ?>\n                <\/div>\n            <\/div>\n\n            <!-- Destino -->\n            <div class=\"gofast-row\">\n                <div style=\"flex: 1;\">\n                    <label><strong>Destino<\/strong> <span style=\"color: var(--gofast-danger);\">*<\/span><\/label>\n                    <select name=\"destino_intermunicipal\" class=\"gofast-select\" id=\"destino-intermunicipal\" required>\n                        <option value=\"\">Selecciona un destino...<\/option>\n                        <?php foreach ($destinos_intermunicipales as $destino => $valor): ?>\n                            <option value=\"<?php echo esc_attr($destino); ?>\" \n                                    data-valor=\"<?php echo esc_attr($valor); ?>\">\n                                <?php echo esc_html($destino); ?>\n                            <\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n                <\/div>\n            <\/div>\n\n\n            <!-- Resumen del valor -->\n            <div id=\"resumen-valor\" style=\"display: none; margin-top: 16px;\">\n                <div class=\"gofast-box\" style=\"background: #fff9d6; border-left: 5px solid var(--gofast-yellow); padding: 14px;\">\n                    <div style=\"font-size: 18px; font-weight: 700; color: #000;\">\n                        \ud83d\udcb0 Valor del env\u00edo: <span id=\"valor-envio\">$0<\/span>\n                    <\/div>\n                    <div style=\"font-size: 13px; color: #666; margin-top: 8px;\">\n                        Recuerda que este valor debe ser cancelado antes de despachar al mensajero.\n                    <\/div>\n                <\/div>\n            <\/div>\n\n            <div class=\"gofast-btn-group\" style=\"margin-top: 24px;\">\n                <button type=\"submit\" name=\"gofast_cotizar_intermunicipal\" class=\"gofast-submit\">\n                    Cotizar Env\u00edo Intermunicipal \ud83d\ude80\n                <\/button>\n            <\/div>\n\n        <\/form>\n    <\/div>\n\n    <script>\n    (function() {\n        \/\/ Proteger contra errores de toggleOtro si se ejecuta desde otro archivo\n        const tipoSelectExists = document.getElementById(\"tipo_negocio\");\n        const wrapperOtroExists = document.getElementById(\"tipo_otro_wrapper\");\n        \n        \/\/ Si los elementos no existen, crear una funci\u00f3n segura desde el inicio\n        if (!tipoSelectExists || !wrapperOtroExists) {\n            window.toggleOtro = function() {\n                \/\/ Funci\u00f3n vac\u00eda segura - no hacer nada\n                return;\n            };\n        } else if (typeof window.toggleOtro === 'function') {\n            \/\/ Si existe y los elementos est\u00e1n presentes, mantener la funci\u00f3n original con protecci\u00f3n\n            const originalToggleOtro = window.toggleOtro;\n            window.toggleOtro = function() {\n                try {\n                    const tipoSelect = document.getElementById(\"tipo_negocio\");\n                    const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                    if (tipoSelect && wrapperOtro && tipoSelect.parentNode && wrapperOtro.parentNode) {\n                        return originalToggleOtro();\n                    }\n                } catch(e) {\n                    \/\/ Silenciar error completamente\n                    return;\n                }\n            };\n        }\n        \n        \/\/ Tambi\u00e9n prevenir que setTimeout ejecute toggleOtro si no est\u00e1n los elementos\n        (function() {\n            const originalSetTimeout = window.setTimeout;\n            window.setTimeout = function(func, delay) {\n                if (typeof func === 'function') {\n                    try {\n                        const funcStr = func.toString();\n                        if (funcStr.includes('toggleOtro')) {\n                            const tipoSelect = document.getElementById(\"tipo_negocio\");\n                            const wrapperOtro = document.getElementById(\"tipo_otro_wrapper\");\n                            if (!tipoSelect || !wrapperOtro) {\n                                \/\/ Retornar un timeout vac\u00edo en lugar de null para evitar errores\n                                return originalSetTimeout(function() {}, 0);\n                            }\n                        }\n                    } catch(e) {\n                        \/\/ Si hay alg\u00fan error al verificar, continuar normalmente\n                    }\n                }\n                return originalSetTimeout.apply(this, arguments);\n            };\n        })();\n\n        const selectDestino = document.getElementById('destino-intermunicipal');\n        const resumenValor = document.getElementById('resumen-valor');\n        const valorEnvio = document.getElementById('valor-envio');\n\n        if (selectDestino && resumenValor && valorEnvio) {\n            selectDestino.addEventListener('change', function() {\n                const selectedOption = this.options[this.selectedIndex];\n                if (selectedOption && selectedOption.value) {\n                    const valor = parseInt(selectedOption.getAttribute('data-valor') || '0');\n                    valorEnvio.textContent = '$' + valor.toLocaleString('es-CO');\n                    resumenValor.style.display = 'block';\n                } else {\n                    resumenValor.style.display = 'none';\n                }\n            });\n        }\n\n        \/\/ Validaci\u00f3n del formulario\n        const form = document.getElementById('gofast-form-intermunicipal');\n        if (form) {\n            form.addEventListener('submit', function(e) {\n                const destino = selectDestino ? selectDestino.value : '';\n                if (!destino) {\n                    e.preventDefault();\n                    alert('\u26a0\ufe0f Debes seleccionar un destino para continuar.');\n                    return false;\n                }\n            });\n        }\n    })();\n    <\/script>\n\n    <?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_cotizar_intermunicipal', 'gofast_cotizar_intermunicipal_shortcode');\n\n","active":true,"modified":"2025-12-10 03:09:44","revision":"1"}]}