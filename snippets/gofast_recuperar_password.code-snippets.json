{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:46","snippets":[{"id":47,"name":"gofast_recuperar_password","code":"\n\/***************************************************\n * GOFAST \u2013 RECUPERACI\u00d3N DE CONTRASE\u00d1A\n * Shortcode: [gofast_recuperar_password]\n * URL: \/recuperar-password\n * \n * Sistema seguro de recuperaci\u00f3n de contrase\u00f1a\n * - Genera tokens \u00fanicos con expiraci\u00f3n (1 hora)\n * - Env\u00eda email con enlace seguro\n * - Permite resetear contrase\u00f1a de forma segura\n ***************************************************\/\nfunction gofast_recuperar_password_shortcode() {\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    global $wpdb;\n\n    $mensaje = '';\n    $mensaje_tipo = ''; \/\/ 'success', 'error'\n    $paso = 'solicitar'; \/\/ 'solicitar', 'resetear'\n\n    \/\/ Si viene un token, mostrar formulario de reset\n    if (isset($_GET['token']) && !empty($_GET['token'])) {\n        $paso = 'resetear';\n        $token = sanitize_text_field($_GET['token']);\n\n        \/\/ Verificar si el token es v\u00e1lido\n        $usuario = $wpdb->get_row($wpdb->prepare(\n            \"SELECT id, email, reset_token_expires \n             FROM usuarios_gofast \n             WHERE reset_token = %s \n             AND activo = 1 \n             LIMIT 1\",\n            $token\n        ));\n\n        if (!$usuario) {\n            $mensaje = 'El enlace de recuperaci\u00f3n no es v\u00e1lido o ha expirado.';\n            $mensaje_tipo = 'error';\n            $paso = 'solicitar';\n        } else {\n            \/\/ Verificar si el token expir\u00f3\n            $ahora = gofast_current_time('mysql');\n            if ($usuario->reset_token_expires < $ahora) {\n                $mensaje = 'El enlace de recuperaci\u00f3n ha expirado. Por favor solicita uno nuevo.';\n                $mensaje_tipo = 'error';\n                $paso = 'solicitar';\n                \/\/ Limpiar token expirado\n                $wpdb->update(\n                    'usuarios_gofast',\n                    ['reset_token' => null, 'reset_token_expires' => null],\n                    ['id' => $usuario->id],\n                    ['%s', '%s'],\n                    ['%d']\n                );\n            }\n        }\n    }\n\n    \/*********************************************\n     * FUNCI\u00d3N PARA ENMASCARAR EMAIL\n     *********************************************\/\n    function gofast_mask_email($email) {\n        if (empty($email) || !is_email($email)) {\n            return $email;\n        }\n        \n        $parts = explode('@', $email);\n        $username = $parts[0];\n        $domain = $parts[1] ?? '';\n        \n        \/\/ Si el usuario tiene 2 caracteres o menos, mostrar solo el primero\n        if (strlen($username) <= 2) {\n            $masked_username = substr($username, 0, 1) . '***';\n        } else {\n            \/\/ Mostrar primeros 2 caracteres y enmascarar el resto\n            $masked_username = substr($username, 0, 2) . str_repeat('*', min(4, strlen($username) - 2));\n        }\n        \n        return $masked_username . '@' . $domain;\n    }\n\n    \/*********************************************\n     * PROCESAR SOLICITUD DE RECUPERACI\u00d3N\n     *********************************************\/\n    if (isset($_POST['gofast_solicitar_reset'])) {\n        $usuario_input = trim($_POST['usuario'] ?? ''); \/\/ Email o tel\u00e9fono\n\n        if (empty($usuario_input)) {\n            $mensaje = 'Por favor ingresa tu correo electr\u00f3nico o n\u00famero de tel\u00e9fono.';\n            $mensaje_tipo = 'error';\n        } else {\n            \/\/ Normalizar tel\u00e9fono (solo d\u00edgitos)\n            $tel_norm = preg_replace('\/\\D+\/', '', $usuario_input);\n            \n            \/\/ Buscar usuario por email o tel\u00e9fono\n            $usuario = $wpdb->get_row($wpdb->prepare(\n                \"SELECT id, nombre, email \n                 FROM usuarios_gofast \n                 WHERE activo = 1\n                   AND (\n                         email = %s\n                      OR REPLACE(REPLACE(REPLACE(telefono, '+',''), ' ','') ,'-','') = %s\n                   )\n                 LIMIT 1\",\n                $usuario_input,\n                $tel_norm\n            ));\n\n            if ($usuario) {\n                \/\/ Verificar que tenga email (necesario para enviar recuperaci\u00f3n)\n                if (empty($usuario->email)) {\n                    $mensaje = 'Tu cuenta no tiene un correo electr\u00f3nico registrado. Contacta con soporte.';\n                    $mensaje_tipo = 'error';\n                } else {\n                    \/\/ Generar token \u00fanico y seguro\n                    $token = bin2hex(random_bytes(32)); \/\/ 64 caracteres hexadecimales\n                    $expira = date('Y-m-d H:i:s', strtotime('+1 hour')); \/\/ Expira en 1 hora\n\n                    \/\/ Guardar token en la base de datos\n                    $wpdb->update(\n                        'usuarios_gofast',\n                        [\n                            'reset_token' => $token,\n                            'reset_token_expires' => $expira\n                        ],\n                        ['id' => $usuario->id],\n                        ['%s', '%s'],\n                        ['%d']\n                    );\n\n                    \/\/ Construir URL de recuperaci\u00f3n\n                    $reset_url = home_url('\/recuperar-password?token=' . $token);\n\n                \/\/ Enviar email con formato HTML\n                $asunto = 'Recuperaci\u00f3n de contrase\u00f1a - GoFast';\n                \n                \/\/ Email en HTML para mejor presentaci\u00f3n\n                $mensaje_email_html = '\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <style>\n        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n        .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n        .header { background: #F4C524; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }\n        .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 8px 8px; }\n        .button { display: inline-block; background: #F4C524; color: #000; padding: 12px 24px; \n                  text-decoration: none; border-radius: 6px; font-weight: bold; margin: 20px 0; }\n        .button:hover { background: #e6b91d; }\n        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin: 20px 0; }\n        .footer { text-align: center; margin-top: 20px; color: #666; font-size: 12px; }\n    <\/style>\n<\/head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1 style=\"margin: 0; color: #000;\">\ud83d\ude80 GoFast<\/h1>\n        <\/div>\n        <div class=\"content\">\n            <h2>\u00a1Hola ' . esc_html($usuario->nombre) . '!<\/h2>\n            <p>Recibimos una solicitud para restablecer tu contrase\u00f1a en GoFast.<\/p>\n            <p>Para crear una nueva contrase\u00f1a, haz clic en el siguiente bot\u00f3n (el enlace es v\u00e1lido por 1 hora):<\/p>\n            <div style=\"text-align: center;\">\n                <a href=\"' . esc_url($reset_url) . '\" class=\"button\">Restablecer contrase\u00f1a<\/a>\n            <\/div>\n            <p style=\"font-size: 12px; color: #666; word-break: break-all;\">\n                O copia y pega este enlace en tu navegador:<br>\n                ' . esc_html($reset_url) . '\n            <\/p>\n            <div class=\"warning\">\n                <strong>\u26a0\ufe0f Importante:<\/strong> Si no solicitaste este cambio, puedes ignorar este correo. \n                Tu contrase\u00f1a permanecer\u00e1 sin cambios.\n            <\/div>\n            <p>\u00a1Gracias por usar GoFast!<\/p>\n        <\/div>\n        <div class=\"footer\">\n            <p>Este es un correo autom\u00e1tico, por favor no respondas a este mensaje.<\/p>\n        <\/div>\n    <\/div>\n<\/body>\n<\/html>\n                ';\n\n                \/\/ Enviar email usando wp_mail de WordPress\n                $headers = array('Content-Type: text\/html; charset=UTF-8');\n                $enviado = wp_mail(\n                    $usuario->email,\n                    $asunto,\n                    $mensaje_email_html,\n                    $headers\n                );\n\n                    if ($enviado) {\n                        $email_mask = gofast_mask_email($usuario->email);\n                        $mensaje = 'Se ha enviado un correo a ' . esc_html($email_mask) . ' con las instrucciones para recuperar tu contrase\u00f1a. Revisa tu bandeja de entrada (y spam).';\n                        $mensaje_tipo = 'success';\n                    } else {\n                        $mensaje = 'Hubo un error al enviar el correo. Por favor intenta m\u00e1s tarde.';\n                        $mensaje_tipo = 'error';\n                    }\n                }\n            } else {\n                \/\/ Por seguridad, no revelar si el email\/tel\u00e9fono existe o no\n                $mensaje = 'Si el correo o tel\u00e9fono existe en nuestro sistema, recibir\u00e1s un enlace para recuperar tu contrase\u00f1a.';\n                $mensaje_tipo = 'success';\n            }\n        }\n    }\n\n    \/*********************************************\n     * PROCESAR RESET DE CONTRASE\u00d1A\n     *********************************************\/\n    if (isset($_POST['gofast_reset_password'])) {\n        $token = sanitize_text_field($_POST['token'] ?? '');\n        $password = $_POST['password'] ?? '';\n        $password2 = $_POST['password2'] ?? '';\n\n        if (empty($token) || empty($password) || empty($password2)) {\n            $mensaje = 'Todos los campos son obligatorios.';\n            $mensaje_tipo = 'error';\n            $paso = 'resetear';\n        } elseif ($password !== $password2) {\n            $mensaje = 'Las contrase\u00f1as no coinciden.';\n            $mensaje_tipo = 'error';\n            $paso = 'resetear';\n        } elseif (strlen($password) < 6) {\n            $mensaje = 'La contrase\u00f1a debe tener al menos 6 caracteres.';\n            $mensaje_tipo = 'error';\n            $paso = 'resetear';\n        } else {\n            \/\/ Buscar usuario por token\n            $usuario = $wpdb->get_row($wpdb->prepare(\n                \"SELECT id, reset_token_expires \n                 FROM usuarios_gofast \n                 WHERE reset_token = %s \n                 AND activo = 1 \n                 LIMIT 1\",\n                $token\n            ));\n\n            if (!$usuario) {\n                $mensaje = 'El token no es v\u00e1lido.';\n                $mensaje_tipo = 'error';\n                $paso = 'solicitar';\n            } else {\n                \/\/ Verificar expiraci\u00f3n\n                $ahora = gofast_current_time('mysql');\n                if ($usuario->reset_token_expires < $ahora) {\n                    $mensaje = 'El enlace ha expirado. Por favor solicita uno nuevo.';\n                    $mensaje_tipo = 'error';\n                    $paso = 'solicitar';\n                } else {\n                    \/\/ Actualizar contrase\u00f1a\n                    $hash = password_hash($password, PASSWORD_DEFAULT);\n                    $actualizado = $wpdb->update(\n                        'usuarios_gofast',\n                        [\n                            'password_hash' => $hash,\n                            'reset_token' => null,\n                            'reset_token_expires' => null\n                        ],\n                        ['id' => $usuario->id],\n                        ['%s', '%s', '%s'],\n                        ['%d']\n                    );\n\n                    if ($actualizado !== false) {\n                        $mensaje = '\u00a1Tu contrase\u00f1a ha sido actualizada exitosamente! Ya puedes iniciar sesi\u00f3n.';\n                        $mensaje_tipo = 'success';\n                        $paso = 'solicitar';\n                    } else {\n                        $mensaje = 'Hubo un error al actualizar la contrase\u00f1a. Por favor intenta de nuevo.';\n                        $mensaje_tipo = 'error';\n                        $paso = 'resetear';\n                    }\n                }\n            }\n        }\n    }\n\n    ob_start();\n    ?>\n\n    <div class=\"gofast-recuperar-container\">\n        <h2 class=\"gofast-recuperar-title\">\n            <?= $paso === 'resetear' ? '\ud83d\udd12 Restablecer contrase\u00f1a' : '\ud83d\udd11 Recuperar contrase\u00f1a' ?>\n        <\/h2>\n\n        <?php if ($mensaje): ?>\n            <div class=\"gofast-alert <?= $mensaje_tipo === 'success' ? 'gofast-alert-success' : 'gofast-alert-error' ?>\">\n                <?php if ($mensaje_tipo === 'success'): ?>\u2705<?php else: ?>\u26a0\ufe0f<?php endif; ?>\n                <?= esc_html($mensaje) ?>\n            <\/div>\n        <?php endif; ?>\n\n        <?php if ($paso === 'solicitar'): ?>\n            <!-- Formulario para solicitar recuperaci\u00f3n -->\n            <form method=\"post\" action=\"\" class=\"gofast-recuperar-form\">\n                <p class=\"gofast-recuperar-descripcion\">\n                    Ingresa tu correo electr\u00f3nico o n\u00famero de tel\u00e9fono y te enviaremos un enlace a tu correo para restablecer tu contrase\u00f1a.\n                <\/p>\n\n                <label>Correo electr\u00f3nico o Tel\u00e9fono<\/label>\n                <input type=\"text\" name=\"usuario\" required \n                       placeholder=\"tu@correo.com o 3001234567\" \n                       value=\"<?= ($mensaje_tipo === 'success') ? '' : (isset($_POST['usuario']) ? esc_attr($_POST['usuario']) : '') ?>\">\n\n                <button type=\"submit\" name=\"gofast_solicitar_reset\" class=\"gofast-btn-action\">\n                    \ud83d\udce7 Enviar enlace de recuperaci\u00f3n\n                <\/button>\n\n                <p class=\"gofast-recuperar-footer\">\n                    <a href=\"<?= esc_url(home_url('\/auth')) ?>\">\u2190 Volver al inicio de sesi\u00f3n<\/a>\n                <\/p>\n            <\/form>\n\n        <?php else: ?>\n            <!-- Formulario para resetear contrase\u00f1a -->\n            <form method=\"post\" action=\"\" class=\"gofast-recuperar-form\">\n                <input type=\"hidden\" name=\"token\" value=\"<?= esc_attr($token) ?>\">\n\n                <p class=\"gofast-recuperar-descripcion\">\n                    Ingresa tu nueva contrase\u00f1a (m\u00ednimo 6 caracteres).\n                <\/p>\n\n                <label>Nueva contrase\u00f1a<\/label>\n                <div class=\"gofast-password-wrapper\">\n                    <input type=\"password\" name=\"password\" id=\"reset_pass1\" required \n                           minlength=\"6\" placeholder=\"M\u00ednimo 6 caracteres\">\n                    <button type=\"button\" class=\"gofast-eye-btn\"\n                            onclick=\"gofastTogglePassword('reset_pass1', this)\">\n                        <svg viewBox=\"0 0 24 24\" class=\"gofast-eye-icon\">\n                            <path d=\"M12 4.5C7 4.5 2.7 8 1 12c1.7 4 6 7.5 11 7.5s9.3-3.5 11-7.5c-1.7-4-6-7.5-11-7.5zm0 12a4.5 4.5 0 110-9 4.5 4.5 0 010 9z\"\/>\n                        <\/svg>\n                    <\/button>\n                <\/div>\n\n                <label>Confirmar contrase\u00f1a<\/label>\n                <div class=\"gofast-password-wrapper\">\n                    <input type=\"password\" name=\"password2\" id=\"reset_pass2\" required \n                           minlength=\"6\" placeholder=\"Repite la contrase\u00f1a\">\n                    <button type=\"button\" class=\"gofast-eye-btn\"\n                            onclick=\"gofastTogglePassword('reset_pass2', this)\">\n                        <svg viewBox=\"0 0 24 24\" class=\"gofast-eye-icon\">\n                            <path d=\"M12 4.5C7 4.5 2.7 8 1 12c1.7 4 6 7.5 11 7.5s9.3-3.5 11-7.5c-1.7-4-6-7.5-11-7.5zm0 12a4.5 4.5 0 110-9 4.5 4.5 0 010 9z\"\/>\n                        <\/svg>\n                    <\/button>\n                <\/div>\n\n                <button type=\"submit\" name=\"gofast_reset_password\" class=\"gofast-btn-action\">\n                    \u2705 Actualizar contrase\u00f1a\n                <\/button>\n\n                <p class=\"gofast-recuperar-footer\">\n                    <a href=\"<?= esc_url(home_url('\/recuperar-password')) ?>\">Solicitar nuevo enlace<\/a> |\n                    <a href=\"<?= esc_url(home_url('\/auth')) ?>\">Volver al login<\/a>\n                <\/p>\n            <\/form>\n        <?php endif; ?>\n    <\/div>\n\n    <!-- JavaScript para mostrar\/ocultar contrase\u00f1a -->\n    <script>\n    function gofastTogglePassword(id, btn) {\n        const input = document.getElementById(id);\n        const icon = btn.querySelector(\"svg\");\n\n        if (input.type === \"password\") {\n            input.type = \"text\";\n            icon.style.opacity = \"0.4\";\n        } else {\n            input.type = \"password\";\n            icon.style.opacity = \"1\";\n        }\n    }\n    <\/script>\n\n    <style>\n    .gofast-recuperar-container {\n        max-width: 450px;\n        margin: 40px auto;\n        background: #fff;\n        padding: 32px;\n        border-radius: 12px;\n        color: #000;\n        border: 1px solid #eee;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n        box-sizing: border-box;\n    }\n    .gofast-recuperar-title {\n        font-size: 26px;\n        font-weight: 700;\n        margin-bottom: 20px;\n        text-align: center;\n    }\n    .gofast-recuperar-descripcion {\n        color: #666;\n        margin-bottom: 20px;\n        line-height: 1.6;\n        text-align: center;\n    }\n    .gofast-alert {\n        padding: 12px 16px;\n        margin-bottom: 20px;\n        border-radius: 8px;\n        font-weight: 600;\n    }\n    .gofast-alert-success {\n        background: #d4edda;\n        border-left: 4px solid #28a745;\n        color: #155724;\n    }\n    .gofast-alert-error {\n        background: #ffe5e5;\n        border-left: 4px solid #d60000;\n        color: #700;\n    }\n    .gofast-recuperar-form label {\n        font-weight: 600;\n        margin-top: 16px;\n        display: block;\n        margin-bottom: 6px;\n    }\n    .gofast-recuperar-form input[type=\"text\"],\n    .gofast-recuperar-form input[type=\"email\"],\n    .gofast-recuperar-form input[type=\"password\"] {\n        width: 100%;\n        padding: 12px;\n        border: 1px solid #ccc;\n        border-radius: 8px;\n        font-size: 15px;\n        box-sizing: border-box;\n        margin-bottom: 10px;\n    }\n    .gofast-password-wrapper {\n        position: relative;\n        margin-bottom: 10px;\n    }\n    .gofast-eye-btn {\n        position: absolute;\n        right: 10px;\n        top: 50%;\n        transform: translateY(-50%);\n        background: transparent;\n        border: none;\n        cursor: pointer;\n        padding: 4px;\n    }\n    .gofast-eye-icon {\n        width: 22px;\n        height: 22px;\n        fill: #333;\n        transition: opacity .15s;\n    }\n    .gofast-btn-action {\n        width: 100%;\n        padding: 14px;\n        background: #F4C524;\n        border: 0;\n        border-radius: 8px;\n        font-weight: 700;\n        font-size: 16px;\n        cursor: pointer;\n        margin-top: 20px;\n    }\n    .gofast-btn-action:hover {\n        background: #e6b91d;\n    }\n    .gofast-recuperar-footer {\n        text-align: center;\n        margin-top: 20px;\n        font-size: 14px;\n    }\n    .gofast-recuperar-footer a {\n        color: #0057ff;\n        font-weight: 600;\n        text-decoration: none;\n    }\n    .gofast-recuperar-footer a:hover {\n        text-decoration: underline;\n    }\n    <\/style>\n\n    <?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_recuperar_password', 'gofast_recuperar_password_shortcode');\n\n","active":true,"modified":"2025-12-12 16:24:30","revision":"1"}]}