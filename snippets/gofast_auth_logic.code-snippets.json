{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":20,"name":"gofast_auth_logic","code":"\n\/***************************************************\n * GOFAST \u2013 L\u00d3GICA AUTH (LOGIN, REGISTRO, LOGOUT)\n * Ahora con sesi\u00f3n persistente (cookies 30 d\u00edas)\n ***************************************************\/\nfunction gofast_handle_auth_requests() {\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    global $wpdb;\n\n    \/*********************************************\n     * LOGOUT (?gofast_logout=1)\n     *********************************************\/\n    if (isset($_GET['gofast_logout'])) {\n\n        \/\/ Eliminar sesi\u00f3n\n        unset($_SESSION['gofast_user_id'], $_SESSION['gofast_user_rol']);\n        session_destroy();\n\n        \/\/ Eliminar cookie y token de la base de datos\n        if (!empty($_COOKIE['gofast_token'])) {\n            $token = sanitize_text_field($_COOKIE['gofast_token']);\n            global $wpdb;\n            $tabla_info = $wpdb->get_results(\"SHOW COLUMNS FROM usuarios_gofast LIKE 'remember_token'\");\n            if (!empty($tabla_info)) {\n                \/\/ Limpiar token de la base de datos\n                $wpdb->update(\n                    'usuarios_gofast',\n                    ['remember_token' => null],\n                    ['remember_token' => $token],\n                    ['%s'],\n                    ['%s']\n                );\n            }\n        }\n        \n        \/\/ Eliminar cookie\n        if (PHP_VERSION_ID >= 70300) {\n            setcookie(\"gofast_token\", \"\", [\n                'expires' => time() - 3600,\n                'path' => '\/',\n                'domain' => '',\n                'secure' => false,\n                'httponly' => true,\n                'samesite' => 'Lax'\n            ]);\n        } else {\n            setcookie(\"gofast_token\", \"\", time() - 3600, \"\/\", \"\", false, true);\n        }\n\n        wp_redirect(home_url('\/'));\n        exit;\n    }\n\n    \/\/ Si NO es POST \u2192 no hay login ni registro\n    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\n        return;\n    }\n\n    \/*********************************************\n     * \ud83d\udee1\ufe0f VALIDACI\u00d3N HONEYPOT ANTI-BOT\n     *********************************************\/\n    \/\/ Si el campo honeypot viene con contenido, es un BOT\n    if (isset($_POST['gofast_extra_field']) && !empty($_POST['gofast_extra_field'])) {\n        \/\/ Registrar intento de bot si est\u00e1 en modo debug\n        if (defined('WP_DEBUG') && WP_DEBUG) {\n            error_log('GOFAST AUTH - Bot detectado por honeypot. IP: ' . ($_SERVER['REMOTE_ADDR'] ?? 'unknown'));\n        }\n        status_header(403);\n        exit('Acceso no autorizado');\n    }\n\n    \/*********************************************\n     * LOGIN\n     *********************************************\/\n    if (isset($_POST['gofast_login'])) {\n\n        $user_raw = trim($_POST['user'] ?? '');\n        $password = $_POST['password'] ?? '';\n        $remember = !empty($_POST['remember']); \/\/ checkbox\n\n        if ($user_raw === '' || $password === '') {\n            $_SESSION['gofast_auth_error'] = 'Por favor ingresa usuario y contrase\u00f1a.';\n            wp_redirect(home_url('\/auth'));\n            exit;\n        }\n\n        $tel_norm = preg_replace('\/\\D+\/', '', $user_raw);\n        $tabla    = 'usuarios_gofast';\n\n        \/\/ Buscar usuario\n        $sql = \"\n            SELECT *\n            FROM $tabla\n            WHERE activo = 1\n              AND (\n                    email = %s\n                 OR REPLACE(REPLACE(REPLACE(telefono, '+',''), ' ','') ,'-','') = %s\n              )\n            LIMIT 1\n        \";\n        $usuario = $wpdb->get_row($wpdb->prepare($sql, $user_raw, $tel_norm));\n\n        \/\/ Validar\n        if (\n            !$usuario ||\n            empty($usuario->password_hash) ||\n            !password_verify($password, $usuario->password_hash)\n        ) {\n            \/\/ \ud83d\udee1\ufe0f Incrementar contador de intentos fallidos\n            gofast_increment_login_attempts();\n            \n            $_SESSION['gofast_auth_error'] = 'Usuario o contrase\u00f1a incorrectos.';\n            wp_redirect(home_url('\/auth'));\n            exit;\n        }\n\n        \/\/ Guardar sesi\u00f3n normal\n        $_SESSION['gofast_user_id']  = (int) $usuario->id;\n        $_SESSION['gofast_user_rol'] = strtolower($usuario->rol ?: 'cliente');\n\n        \/\/ \ud83d\udee1\ufe0f Resetear rate limiting en login exitoso\n        $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';\n        $key = 'gofast_login_attempts_' . md5($ip);\n        delete_transient($key);\n\n        \/*********************************************\n         * \ud83d\udd25 COOKIE PERSISTENTE (30 D\u00cdAS)\n         * Solo si el usuario acept\u00f3 cookies\n         *********************************************\/\n        if ($remember) {\n            \/\/ Verificar si el usuario acept\u00f3 cookies\n            $cookies_accepted = isset($_POST['gofast_cookies_accepted']) && $_POST['gofast_cookies_accepted'] === '1';\n            \n            \/\/ Si acept\u00f3 cookies o no se especific\u00f3 (compatibilidad), crear cookie\n            if ($cookies_accepted || !isset($_POST['gofast_cookies_accepted'])) {\n                gofast_create_persistent_cookie($usuario->id, $tabla);\n            }\n        }\n\n        wp_redirect(home_url('\/'));\n        exit;\n    }\n\n    \/*********************************************\n     * REGISTRO\n     *********************************************\/\n    if (isset($_POST['gofast_registro'])) {\n\n        $nombre    = trim($_POST['nombre'] ?? '');\n        $telefono  = trim($_POST['telefono'] ?? '');\n        $email     = trim($_POST['email'] ?? '');\n        $password  = $_POST['password']  ?? '';\n        $password2 = $_POST['password2'] ?? '';\n\n        if ($nombre === '' || $telefono === '' || $email === '' || $password === '' || $password2 === '') {\n            $_SESSION['gofast_auth_error'] = 'Todos los campos son obligatorios.';\n            wp_redirect(home_url('\/auth\/?registro=1'));\n            exit;\n        }\n\n        if (!is_email($email)) {\n            $_SESSION['gofast_auth_error'] = 'El correo no es v\u00e1lido.';\n            wp_redirect(home_url('\/auth\/?registro=1'));\n            exit;\n        }\n\n        if ($password !== $password2) {\n            $_SESSION['gofast_auth_error'] = 'Las contrase\u00f1as no coinciden.';\n            wp_redirect(home_url('\/auth\/?registro=1'));\n            exit;\n        }\n\n        \/\/ Validar longitud m\u00ednima de contrase\u00f1a\n        if (strlen($password) < 6) {\n            $_SESSION['gofast_auth_error'] = 'La contrase\u00f1a debe tener al menos 6 caracteres.';\n            wp_redirect(home_url('\/auth\/?registro=1'));\n            exit;\n        }\n\n        \/\/ Normalizar y validar tel\u00e9fono\n        $tel_norm = preg_replace('\/\\D+\/', '', $telefono);\n        if (strlen($tel_norm) < 10) {\n            $_SESSION['gofast_auth_error'] = 'El tel\u00e9fono debe tener al menos 10 d\u00edgitos.';\n            wp_redirect(home_url('\/auth\/?registro=1'));\n            exit;\n        }\n\n        $tabla    = 'usuarios_gofast';\n\n        \/\/ Verificar duplicados\n        $sql = \"\n            SELECT id\n            FROM $tabla\n            WHERE email = %s\n               OR REPLACE(REPLACE(REPLACE(telefono, '+',''), ' ','') ,'-','') = %s\n            LIMIT 1\n        \";\n        $existe = $wpdb->get_row($wpdb->prepare($sql, $email, $tel_norm));\n\n        if ($existe) {\n            $_SESSION['gofast_auth_error'] = 'Ya existe un usuario con ese correo o tel\u00e9fono.';\n            wp_redirect(home_url('\/auth\/?registro=1'));\n            exit;\n        }\n\n        $hash = password_hash($password, PASSWORD_DEFAULT);\n\n        \/\/ Preparar datos para inserci\u00f3n\n        $datos_insert = [\n            'nombre'         => $nombre,\n            'telefono'       => $telefono,\n            'email'          => $email,\n            'password_hash'  => $hash,\n            'rol'            => 'cliente',\n            'activo'         => 1,\n            'fecha_registro' => gofast_current_time('mysql')\n        ];\n        \n        \/\/ Verificar si el campo remember_token existe en la tabla\n        $tabla_info = $wpdb->get_results(\"SHOW COLUMNS FROM usuarios_gofast LIKE 'remember_token'\");\n        if (!empty($tabla_info)) {\n            $datos_insert['remember_token'] = null;\n        }\n        \n        \/\/ Preparar formatos seg\u00fan los campos\n        $formatos = ['%s','%s','%s','%s','%s','%d','%s'];\n        if (!empty($tabla_info)) {\n            $formatos[] = '%s'; \/\/ remember_token\n        }\n\n        $ok = $wpdb->insert($tabla, $datos_insert, $formatos);\n\n        if (!$ok) {\n            $error_db = $wpdb->last_error;\n            $_SESSION['gofast_auth_error'] = 'No se pudo crear la cuenta. Intenta de nuevo.';\n            \/\/ Log para debug (solo en desarrollo)\n            if (defined('WP_DEBUG') && WP_DEBUG) {\n                error_log(\"GOFAST AUTH - Error al crear usuario: \" . $error_db);\n                error_log(\"GOFAST AUTH - Datos: \" . print_r($datos_insert, true));\n            }\n            wp_redirect(home_url('\/auth\/?registro=1'));\n            exit;\n        }\n\n        $user_id = (int)$wpdb->insert_id;\n\n        \/\/ Login autom\u00e1tico\n        $_SESSION['gofast_user_id']  = $user_id;\n        $_SESSION['gofast_user_rol'] = 'cliente';\n\n        \/\/ Crear cookie persistente autom\u00e1ticamente en registro (30 d\u00edas)\n        \/\/ Solo si el usuario acept\u00f3 cookies\n        $cookies_accepted = isset($_POST['gofast_cookies_accepted']) && $_POST['gofast_cookies_accepted'] === '1';\n        \n        \/\/ Si acept\u00f3 cookies o no se especific\u00f3 (compatibilidad), crear cookie\n        if ($cookies_accepted || !isset($_POST['gofast_cookies_accepted'])) {\n            gofast_create_persistent_cookie($user_id, $tabla);\n        }\n\n        wp_redirect(home_url('\/'));\n        exit;\n    }\n}\n\n\/**\n * Crear cookie persistente para mantener sesi\u00f3n (30 d\u00edas)\n * Solo se crea si el usuario acept\u00f3 cookies (verificado por JavaScript)\n *\/\nfunction gofast_create_persistent_cookie($user_id, $tabla = 'usuarios_gofast') {\n    global $wpdb;\n    \n    \/\/ Verificar si el campo remember_token existe\n    $tabla_info = $wpdb->get_results(\"SHOW COLUMNS FROM usuarios_gofast LIKE 'remember_token'\");\n    if (empty($tabla_info)) {\n        return false; \/\/ Campo no existe\n    }\n    \n    \n    \/\/ Crear token \u00fanico\n    $token = wp_generate_uuid4();\n    \n    \/\/ Guardarlo en DB\n    $wpdb->update(\n        $tabla,\n        ['remember_token' => $token],\n        ['id' => $user_id],\n        ['%s'],\n        ['%d']\n    );\n    \n    \/\/ Guardar cookie 30 d\u00edas con configuraci\u00f3n mejorada\n    $cookie_expire = time() + (86400 * 30); \/\/ 30 d\u00edas\n    $cookie_path = '\/';\n    $cookie_domain = ''; \/\/ Usar dominio actual\n    $cookie_secure = false; \/\/ Cambiar a true si usas HTTPS\n    $cookie_httponly = true;\n    \n    \/\/ Usar setcookie con SameSite (PHP 7.3+)\n    if (PHP_VERSION_ID >= 70300) {\n        setcookie(\n            \"gofast_token\",\n            $token,\n            [\n                'expires' => $cookie_expire,\n                'path' => $cookie_path,\n                'domain' => $cookie_domain,\n                'secure' => $cookie_secure,\n                'httponly' => $cookie_httponly,\n                'samesite' => 'Lax'\n            ]\n        );\n    } else {\n        \/\/ Fallback para versiones anteriores de PHP\n        setcookie(\n            \"gofast_token\",\n            $token,\n            $cookie_expire,\n            $cookie_path . '; SameSite=Lax',\n            $cookie_domain,\n            $cookie_secure,\n            $cookie_httponly\n        );\n    }\n    \n    return true;\n}\n\n\/**\n * \ud83d\udee1\ufe0f Rate limiting por IP para prevenir ataques de fuerza bruta\n * Limita a 5 intentos fallidos en 10 minutos por IP\n *\/\nfunction gofast_login_rate_limit() {\n    \/\/ Solo aplicar a peticiones POST con formulario de login\n    if ($_SERVER['REQUEST_METHOD'] !== 'POST' || empty($_POST['gofast_login_form'])) {\n        return;\n    }\n\n    $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';\n    $key = 'gofast_login_attempts_' . md5($ip);\n\n    $data = get_transient($key);\n    if (!$data) {\n        $data = ['count' => 0, 'blocked' => false];\n    }\n\n    \/\/ Si ya est\u00e1 bloqueado, cortamos\n    if (!empty($data['blocked'])) {\n        status_header(429);\n        exit('Demasiados intentos. Int\u00e9ntalo m\u00e1s tarde.');\n    }\n}\nadd_action('init', 'gofast_login_rate_limit', 4); \/\/ Prioridad 4 para ejecutar antes de gofast_handle_auth_requests\n\n\/**\n * Incrementar contador de intentos fallidos de login\n *\/\nfunction gofast_increment_login_attempts() {\n    $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';\n    $key = 'gofast_login_attempts_' . md5($ip);\n\n    $data = get_transient($key);\n    if (!$data) {\n        $data = ['count' => 0, 'blocked' => false];\n    }\n\n    \/\/ Incrementar intentos\n    $data['count']++;\n\n    \/\/ M\u00e1x 5 intentos en 10 minutos\n    if ($data['count'] > 5) {\n        $data['blocked'] = true;\n    }\n\n    \/\/ Guardar por 10 minutos\n    set_transient($key, $data, 10 * MINUTE_IN_SECONDS);\n}\n\nadd_action('init', 'gofast_handle_auth_requests', 5);\n\n","active":true,"modified":"2025-12-12 13:22:10","revision":"1"}]}