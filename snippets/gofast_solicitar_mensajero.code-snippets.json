{"generator":"Code Snippets v3.9.3","date_created":"2025-12-12 19:47","snippets":[{"id":7,"name":"gofast_solicitar_mensajero","code":"\n\/*******************************************************\n * \u2705 GOFAST \u2014 SOLICITAR MENSAJERO (Resultado de cotizaci\u00f3n)\n * Shortcode: [gofast_resultado]\n * URL: \/solicitar-mensajero\n *******************************************************\/\nfunction gofast_resultado_cotizacion() {\n    global $wpdb;\n\n    \/* ----------------------------------------------------------\n       \u2705 Validaci\u00f3n inicial\n    ---------------------------------------------------------- *\/\n    if (!isset($_POST['origen']) || !isset($_POST['destino'])) {\n        return \"<div class='gofast-box'>No se encontr\u00f3 la cotizaci\u00f3n.<\/div>\";\n    }\n\n    $origen   = intval($_POST['origen']);\n    $destinos = array_map('intval', (array) $_POST['destino']);\n    \n    \/\/ Detectar si el origen es un negocio (buscar en todos los negocios si es mensajero\/admin)\n    $negocio_id_cotizador = 0;\n    $negocio_user_id_cotizador = null;\n    \n    if (!empty($_SESSION['gofast_user_id'])) {\n        $user_id_temp = intval($_SESSION['gofast_user_id']);\n        $usuario_temp = $wpdb->get_row($wpdb->prepare(\n            \"SELECT rol FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n            $user_id_temp\n        ));\n        \n        if ($usuario_temp && (strtolower($usuario_temp->rol) === 'mensajero' || strtolower($usuario_temp->rol) === 'admin')) {\n            \/\/ Si es mensajero\/admin, buscar en todos los negocios\n            $todos_negocios_temp = $wpdb->get_results(\n                \"SELECT n.id, n.barrio_id, n.user_id\n                 FROM negocios_gofast n\n                 WHERE n.activo = 1\"\n            );\n            \n            foreach ($todos_negocios_temp as $neg) {\n                if (intval($neg->barrio_id) === $origen) {\n                    $negocio_id_cotizador = intval($neg->id);\n                    $negocio_user_id_cotizador = intval($neg->user_id);\n                    break;\n                }\n            }\n        }\n    }\n\n    \/* ==========================================================\n       \u2705 0) DETECTAR USUARIO GOFAST LOGUEADO\n    ========================================================== *\/\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    $usuario             = null;\n    $direcciones_previas = [];\n    $negocio_usado       = null; \/\/ \u2b50 negocio detectado como origen (si aplica)\n\n    if (!empty($_SESSION['gofast_user_id'])) {\n\n        $user_id = intval($_SESSION['gofast_user_id']);\n\n        \/\/ \u2705 Datos del usuario\n        $usuario = $wpdb->get_row(\"\n            SELECT id, nombre, telefono, email, rol \n            FROM usuarios_gofast \n            WHERE id = $user_id AND activo = 1\n        \");\n\n        \/\/ \u2705 Cargar negocios del usuario (incluye whatsapp)\n        $mis_negocios = $wpdb->get_results($wpdb->prepare(\n            \"SELECT id, nombre, direccion_full, barrio_id, sector_id, whatsapp\n             FROM negocios_gofast\n             WHERE user_id = %d AND activo = 1\",\n            $user_id\n        ));\n\n        \/\/ \ud83d\udd0d Detectar si el ORIGEN corresponde al barrio de un negocio\n        foreach ((array) $mis_negocios as $n) {\n            if (intval($n->barrio_id) === $origen) {\n                $negocio_usado = $n;\n                break;\n            }\n        }\n\n        \/\/ \u2705 Direcciones usadas anteriormente (solo si NO usamos negocio)\n        if ($usuario && !$negocio_usado) {\n\n            \/\/ Normalizar tel\u00e9fono del usuario (solo d\u00edgitos)\n            $tel_norm = preg_replace('\/\\D+\/', '', $usuario->telefono);\n\n            \/\/ Direcciones previas usando match de tel\u00e9fono flexible\n            $direcciones_previas = $wpdb->get_col(\n                $wpdb->prepare(\n                    \"SELECT DISTINCT direccion_origen\n                     FROM servicios_gofast\n                     WHERE direccion_origen <> ''\n                       AND (\n                            user_id = %d\n                            OR REPLACE(REPLACE(REPLACE(telefono_cliente, '+', ''), '-', ''), ' ', '') = %s\n                       )\n                     ORDER BY id DESC\n                     LIMIT 10\",\n                    $usuario->id,\n                    $tel_norm\n                )\n            );\n        }\n    }\n\n    \/* ==========================================================\n       \u2705 1) Datos del ORIGEN\n    ========================================================== *\/\n    $sector_origen = intval($wpdb->get_var(\"SELECT sector_id FROM barrios WHERE id = $origen\"));\n    $nombre_origen = $wpdb->get_var(\"SELECT nombre FROM barrios WHERE id = $origen\");\n\n    \/* ==========================================================\n       \u2705 2) Recargos activos (FIJOS + POR VALOR)\n    ========================================================== *\/\n\n    \/\/ \ud83d\udd39 Recargos FIJOS (siempre se aplican por cada trayecto)\n    $recargos_fijos = $wpdb->get_results(\"\n        SELECT id, nombre, valor_fijo \n        FROM recargos\n        WHERE activo = 1 AND tipo = 'fijo'\n    \");\n\n    $recargo_fijo_por_envio   = 0;\n    $recargos_fijos_aplicados = []; \/\/ solo nombres\n\n    foreach ((array) $recargos_fijos as $r) {\n        $monto = intval($r->valor_fijo);\n        if ($monto > 0) {\n            $recargo_fijo_por_envio += $monto;\n            $recargos_fijos_aplicados[] = $r->nombre;\n        }\n    }\n\n    \/\/ \ud83d\udd39 Recargos VARIABLES por rango de valor (ej: lluvia)\n    $recargos_variables = $wpdb->get_results(\"\n        SELECT r.id, r.nombre, rr.monto_min, rr.monto_max, rr.recargo\n        FROM recargos r\n        JOIN recargos_rangos rr ON rr.recargo_id = r.id\n        WHERE r.activo = 1 AND r.tipo = 'por_valor'\n        ORDER BY rr.monto_min ASC\n    \");\n\n    \/\/ Helper: dado un valor de tarifa, devuelve:\n    \/\/  - total recargo variable\n    \/\/  - nombres de recargos aplicados\n    $calcular_recargos_variables = function($valor) use ($recargos_variables) {\n        $valor = intval($valor);\n        $total_variable = 0;\n        $nombres = [];\n\n        foreach ((array) $recargos_variables as $r) {\n            $min = intval($r->monto_min);\n            $max = intval($r->monto_max);\n            $rec = intval($r->recargo);\n\n            $cumple_min = ($valor >= $min);\n            $cumple_max = ($max <= 0) ? true : ($valor <= $max);\n\n            if ($cumple_min && $cumple_max && $rec > 0) {\n                $total_variable += $rec;\n                $nombres[] = $r->nombre;\n            }\n        }\n\n        return [\n            'total'   => $total_variable,\n            'nombres' => $nombres,\n        ];\n    };\n\n    \/* ==========================================================\n       \u2705 3) Procesar destinos + tarifas\n    ========================================================== *\/\n    $detalle_envios                = [];\n    $total                         = 0;\n    $total_recargos_aplicados      = 0; \/\/ suma de TODO lo extra vs tarifa base\n    $recargos_variables_aplicados  = []; \/\/ nombres \u00fanicos\n\n    foreach ($destinos as $destino) {\n\n        $sector_destino = intval($wpdb->get_var(\"SELECT sector_id FROM barrios WHERE id = $destino\"));\n        $nombre_destino = $wpdb->get_var(\"SELECT nombre FROM barrios WHERE id = $destino\");\n\n        $precio = $wpdb->get_var(\n            $wpdb->prepare(\n                \"SELECT precio FROM tarifas \n                 WHERE origen_sector_id=%d AND destino_sector_id=%d\",\n                $sector_origen,\n                $sector_destino\n            )\n        );\n\n        $precio = $precio ? intval($precio) : 0;\n\n        \/\/ Recargos variables para este trayecto\n        $calc_var                  = $calcular_recargos_variables($precio);\n        $recargo_variable_monto    = $calc_var['total'];\n        $recargo_variable_nombres  = $calc_var['nombres'];\n\n        \/\/ Marcar recargos variables aplicados (para mostrar solo nombres luego)\n        foreach ($recargo_variable_nombres as $nombre_recargo) {\n            $recargos_variables_aplicados[$nombre_recargo] = true;\n        }\n\n        \/\/ Total de recargos para este trayecto\n        $recargo_total_trayecto = $recargo_fijo_por_envio + $recargo_variable_monto;\n\n        \/\/ Total final trayecto\n        $total_trayecto = $precio + $recargo_total_trayecto;\n\n        $detalle_envios[] = [\n            \"destino\"                  => $nombre_destino,\n            \"destino_id\"               => $destino,\n            \"valor\"                    => $precio,\n            \"recargo_fijo\"             => $recargo_fijo_por_envio,\n            \"recargo_variable_monto\"   => $recargo_variable_monto,\n            \"recargo_variable_nombres\" => $recargo_variable_nombres,\n            \"recargo_total\"            => $recargo_total_trayecto,\n            \"total_trayecto\"           => $total_trayecto,\n        ];\n\n        $total                    += $total_trayecto;\n        $total_recargos_aplicados += $recargo_total_trayecto;\n    }\n\n    \/\/ Lista final de nombres de recargos aplicados (sin duplicados)\n    $lista_nombres_recargos = [];\n\n    foreach ($recargos_fijos_aplicados as $nombre) {\n        if ($nombre !== '' && !in_array($nombre, $lista_nombres_recargos, true)) {\n            $lista_nombres_recargos[] = $nombre;\n        }\n    }\n\n    foreach (array_keys($recargos_variables_aplicados) as $nombre) {\n        if ($nombre !== '' && !in_array($nombre, $lista_nombres_recargos, true)) {\n            $lista_nombres_recargos[] = $nombre;\n        }\n    }\n\n    \/* ==========================================================\n       \u2705 4) VALORES POR DEFECTO (NEGOCIO \/ USUARIO)\n    ========================================================== *\/\n\n    \/\/ Regla 1.C: whatsapp negocio si existe, si no tel\u00e9fono usuario\n    $nombre_default =\n        $negocio_usado ? $negocio_usado->nombre :\n        ($usuario ? $usuario->nombre : '');\n\n    $telefono_default =\n        ($negocio_usado && !empty($negocio_usado->whatsapp))\n            ? $negocio_usado->whatsapp\n            : ($usuario ? $usuario->telefono : '');\n\n    $dir_origen_default =\n        $negocio_usado ? $negocio_usado->direccion_full : '';\n\n    \/* ==========================================================\n\t   \u2705 5) SI CONFIRMA \u2192 GUARDAR SERVICIO Y REDIRIGIR\n\t========================================================== *\/\n\tif (!empty($_POST['confirmar'])) {\n\n\t\t$nombre = sanitize_text_field($_POST['nombre']);\n\t\t$tel    = sanitize_text_field($_POST['telefono']);\n\t\t\n\t\t\/\/ Obtener negocio_id del POST (desde cotizador) o detectar por barrio_id\n\t\t$negocio_id = $negocio_id_cotizador;\n\t\t$negocio_user_id = $negocio_user_id_cotizador;\n\t\t$negocio_seleccionado = null;\n\t\t$cliente_propietario = null;\n\t\t\n\t\t\/\/ Si hay negocio detectado (ya sea desde POST o desde $negocio_usado), obtener datos\n\t\tif ($negocio_id > 0) {\n\t\t\t\/\/ Si es mensajero\/admin y hay negocio_user_id, buscar por ese user_id\n\t\t\tif ($negocio_user_id && $usuario && (strtolower($usuario->rol) === 'mensajero' || strtolower($usuario->rol) === 'admin')) {\n\t\t\t\t$negocio_seleccionado = $wpdb->get_row($wpdb->prepare(\n\t\t\t\t\t\"SELECT n.*, u.nombre as cliente_nombre, u.telefono as cliente_telefono\n\t\t\t\t\t FROM negocios_gofast n\n\t\t\t\t\t INNER JOIN usuarios_gofast u ON n.user_id = u.id\n\t\t\t\t\t WHERE n.id = %d AND n.user_id = %d AND n.activo = 1 AND u.activo = 1\",\n\t\t\t\t\t$negocio_id,\n\t\t\t\t\t$negocio_user_id\n\t\t\t\t));\n\t\t\t} elseif ($negocio_usado && intval($negocio_usado->id) === $negocio_id) {\n\t\t\t\t\/\/ Si ya tenemos el negocio_usado y coincide, usarlo\n\t\t\t\t$negocio_seleccionado = $negocio_usado;\n\t\t\t} else {\n\t\t\t\t\/\/ Buscar negocio del usuario logueado\n\t\t\t\tif ($usuario) {\n\t\t\t\t\t$negocio_seleccionado = $wpdb->get_row($wpdb->prepare(\n\t\t\t\t\t\t\"SELECT id, nombre, direccion_full, whatsapp, user_id\n\t\t\t\t\t\t FROM negocios_gofast\n\t\t\t\t\t\t WHERE id = %d AND user_id = %d AND activo = 1\",\n\t\t\t\t\t\t$negocio_id,\n\t\t\t\t\t\t$usuario->id\n\t\t\t\t\t));\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif ($negocio_seleccionado) {\n\t\t\t\t$cliente_propietario = $negocio_seleccionado->user_id;\n\t\t\t\t\/\/ Usar datos del NEGOCIO (no del cliente)\n\t\t\t\t$nombre = $negocio_seleccionado->nombre; \/\/ Nombre del negocio\n\t\t\t\t$tel = $negocio_seleccionado->whatsapp ?: ($negocio_seleccionado->cliente_telefono ?? ($usuario ? $usuario->telefono : '')); \/\/ WhatsApp del negocio primero\n\t\t\t}\n\t\t} elseif ($negocio_usado) {\n\t\t\t\/\/ Si no hay negocio_id del POST pero hay negocio_usado detectado, usarlo\n\t\t\t$negocio_seleccionado = $negocio_usado;\n\t\t\t$cliente_propietario = $negocio_usado->user_id;\n\t\t\t\/\/ Usar datos del NEGOCIO (no del cliente)\n\t\t\t$nombre = $negocio_usado->nombre; \/\/ Nombre del negocio\n\t\t\t$tel = $negocio_usado->whatsapp ?: ($usuario ? $usuario->telefono : ''); \/\/ WhatsApp del negocio primero\n\t\t}\n\n\t\t\/\/ Direcci\u00f3n origen - Estandarizada seg\u00fan reglas:\n\t\t\/\/ 1. Solo barrio (si no hay negocio y no hay direcci\u00f3n)\n\t\t\/\/ 2. Negocio + direcci\u00f3n (si hay negocio)\n\t\t\/\/ 3. Barrio + direcci\u00f3n (si hay direcci\u00f3n pero no negocio)\n\t\t$dir_origen_input = !empty($_POST['dir_origen_custom'])\n\t\t\t? sanitize_text_field($_POST['dir_origen_custom'])\n\t\t\t: sanitize_text_field($_POST['dir_origen'] ?? '');\n\t\t\n\t\t\/\/ Construir direccion_origen seg\u00fan las reglas\n\t\tif ($negocio_seleccionado) {\n\t\t\t\/\/ Caso 2: Negocio + direcci\u00f3n\n\t\t\t$dir_origen_negocio = $negocio_seleccionado->direccion_full ?: '';\n\t\t\tif (!empty($dir_origen_negocio)) {\n\t\t\t\t$dir_origen = $negocio_seleccionado->nombre . ' \u2014 ' . $dir_origen_negocio;\n\t\t\t} else {\n\t\t\t\t$dir_origen = $negocio_seleccionado->nombre;\n\t\t\t}\n\t\t} elseif (!empty($dir_origen_input)) {\n\t\t\t\/\/ Caso 3: Barrio + direcci\u00f3n\n\t\t\t$dir_origen = $nombre_origen . ' \u2014 ' . $dir_origen_input;\n\t\t} else {\n\t\t\t\/\/ Caso 1: Solo barrio\n\t\t\t$dir_origen = $nombre_origen;\n\t\t}\n\n\t\t\/\/ Direcciones destino opcionales\n\t\t$dirs_dest   = isset($_POST['dir_destino'])   ? (array) $_POST['dir_destino']   : [];\n\t\t$montos_dest = isset($_POST['monto_destino']) ? (array) $_POST['monto_destino'] : [];\n\n\t\tforeach ($montos_dest as $i => $m) {\n\t\t\t$m = trim($m);\n\t\t\t$montos_dest[$i] = ($m === \"\" ? 0 : intval(preg_replace('\/[^\\d]\/', '', $m)));\n\t\t}\n\n\t\t\/\/ JSON de origen\n\t\t$origen_completo = [\n\t\t\t\"barrio_id\"     => $origen,\n\t\t\t\"barrio_nombre\" => $nombre_origen,\n\t\t\t\"sector_id\"     => $sector_origen,\n\t\t\t\"direccion\"     => $dir_origen,\n\t\t\t\"negocio_id\"    => $negocio_seleccionado ? $negocio_seleccionado->id : null,\n\t\t\t\"negocio_user_id\" => $negocio_seleccionado ? $negocio_seleccionado->user_id : null,\n\t\t];\n\n\t\t\/\/ JSON de destinos\n\t\t$destinos_completos = [];\n\t\tforeach ($destinos as $i => $dest_id) {\n\n\t\t\t$barrio_nombre = $wpdb->get_var(\"SELECT nombre FROM barrios WHERE id = $dest_id\");\n\t\t\t$sector_id     = intval($wpdb->get_var(\"SELECT sector_id FROM barrios WHERE id = $dest_id\"));\n\n\t\t\t$destinos_completos[] = [\n\t\t\t\t\"barrio_id\"     => $dest_id,\n\t\t\t\t\"barrio_nombre\" => $barrio_nombre,\n\t\t\t\t\"sector_id\"     => $sector_id,\n\t\t\t\t\"direccion\"     => !empty($dirs_dest[$i]) ? sanitize_text_field($dirs_dest[$i]) : \"\",\n\t\t\t\t\"monto\"         => !empty($montos_dest[$i]) ? $montos_dest[$i] : 0,\n\t\t\t];\n\t\t}\n\n\t\t$json_final = json_encode(\n\t\t\t[\n\t\t\t\t\"origen\"   => $origen_completo,\n\t\t\t\t\"destinos\" => $destinos_completos,\n\t\t\t],\n\t\t\tJSON_UNESCAPED_UNICODE\n\t\t);\n\n\t\t\/\/ Determinar user_id: si hay negocio seleccionado, usar el cliente propietario\n\t\t$user_id_servicio = $usuario ? $usuario->id : null;\n\t\tif ($negocio_seleccionado && $cliente_propietario) {\n\t\t\t$user_id_servicio = $cliente_propietario; \/\/ Asociar al cliente propietario del negocio\n\t\t}\n\t\t\n\t\t\/\/ Guardar servicio\n\t\t$insertado = $wpdb->insert(\"servicios_gofast\", [\n\t\t\t\"nombre_cliente\"   => $nombre,\n\t\t\t\"telefono_cliente\" => $tel,\n\t\t\t\"direccion_origen\" => $dir_origen,\n\t\t\t\"destinos\"         => $json_final,\n\t\t\t\"total\"            => $total,\n\t\t\t\"estado\"           => \"pendiente\",\n\t\t\t\"tracking_estado\"  => \"pendiente\",\n\t\t\t\"mensajero_id\"     => null,\n\t\t\t\"user_id\"          => $user_id_servicio,\n\t\t\t\"fecha\"            => gofast_date_mysql()\n\t\t]);\n\n\t\t\/\/ \u26a0\ufe0f Si falla el INSERT, mostramos el error en pantalla\n\t\tif ($insertado === false) {\n\t\t\treturn \"<div class='gofast-box'>\n\t\t\t\t\t\t<b>Error al guardar el servicio:<\/b><br>\" .\n\t\t\t\t\t\tesc_html($wpdb->last_error) .\n\t\t\t\t   \"<\/div>\";\n\t\t}\n\n\t\t$service_id = (int) $wpdb->insert_id;\n\n\t\tif (!$service_id) {\n\t\t\treturn \"<div class='gofast-box'>No se pudo obtener el ID del servicio.<\/div>\";\n\t\t}\n\n\t\t$_SESSION[\"gofast_pending_service\"] = $service_id;\n\n\t\t\/\/ \u2705 IMPORTANTE: redirigir con JavaScript (no con wp_redirect)\n\t\t$url = esc_url( home_url('\/servicio-registrado?id=' . $service_id) );\n\n\t\treturn '<script>window.location.href = \"'.$url.'\";<\/script>';\n\t}\n\n\n    \/* ==========================================================\n       \u2705 6) HTML FINAL\n    ========================================================== *\/\n    ob_start();\n    ?>\n\n    <div class=\"gofast-checkout-wrapper\">\n\n        <!-- \u2705 COLUMNA IZQUIERDA -->\n        <div class=\"gofast-box\">\n\n            <h3 style=\"margin-top:0;\">\ud83d\udccd Origen: <?= esc_html($nombre_origen) ?><\/h3>\n\n            <div id=\"destinos-resumen\">\n                <?php foreach ($detalle_envios as $idx => $d): ?>\n                    <div class=\"gofast-destino-resumen-item\" \n                         data-destino-id=\"<?= esc_attr($destinos[$idx]) ?>\"\n                         data-destino-index=\"<?= esc_attr($idx) ?>\"\n                         data-precio=\"<?= esc_attr($d['valor']) ?>\"\n                         data-recargo=\"<?= esc_attr($d['recargo_total']) ?>\"\n                         data-total=\"<?= esc_attr($d['total_trayecto']) ?>\">\n                        <div style=\"display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;border-left:4px solid #F4C524;\">\n                            <div style=\"flex:1;\">\n                                <strong>\ud83c\udfaf <?= esc_html($d[\"destino\"]) ?><\/strong><br>\n                                <small style=\"color:#666;\">\n                                    Base: $<?= number_format($d['valor'], 0, ',', '.') ?> | \n                                    Recargo: $<?= number_format($d['recargo_total'], 0, ',', '.') ?>\n                                <\/small><br>\n                                <strong style=\"color:#4CAF50;font-size:18px;\">\n                                    $<?= number_format($d[\"total_trayecto\"], 0, ',', '.') ?>\n                                <\/strong>\n                            <\/div>\n                            <button type=\"button\" class=\"gofast-btn-delete\" onclick=\"eliminarDestinoResumen(<?= esc_attr($idx) ?>)\" style=\"margin-left:12px;padding:8px 12px;\">\n                                \u274c\n                            <\/button>\n                        <\/div>\n                    <\/div>\n                <?php endforeach; ?>\n            <\/div>\n\n            <?php if (!empty($lista_nombres_recargos)): ?>\n                <div class=\"gofast-recargo-box\" style=\"margin:16px 0;\">\n                    \ud83d\udfe1 <b>Recargos aplicados:<\/b><br>\n                    <ul style=\"margin:8px 0 0 20px;\">\n                        <?php foreach ($lista_nombres_recargos as $nombre): ?>\n                            <li><?= esc_html($nombre) ?><\/li>\n                        <?php endforeach; ?>\n                    <\/ul>\n                <\/div>\n            <?php endif; ?>\n\n            <div class=\"gofast-total-box\" style=\"margin:20px 0;text-align:center;\" id=\"total-box\">\n                \ud83d\udcb0 <strong style=\"font-size:24px;\" id=\"total-amount\">Total: $<?= number_format($total, 0, ',', '.') ?><\/strong>\n            <\/div>\n\n            <!-- Agregar nuevo destino -->\n            <?php \n            \/\/ Obtener todos los barrios para el select\n            $barrios_all = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n            $destinos_ids = array_map('intval', $destinos);\n            ?>\n            <div style=\"background:#f8f9fa;padding:16px;border-radius:8px;margin:20px 0;\">\n                <label><strong>\u2795 Agregar nuevo destino<\/strong><\/label>\n                <select id=\"nuevo-destino-select\" class=\"gofast-select\" style=\"margin-top:8px;\">\n                    <option value=\"\">Seleccionar barrio...<\/option>\n                     <?php foreach ($barrios_all as $b): ?>\n                         <option value=\"<?= esc_attr($b->id) ?>\" data-nombre=\"<?= esc_attr($b->nombre) ?>\">\n                             <?= esc_html($b->nombre) ?>\n                         <\/option>\n                     <?php endforeach; ?>\n                <\/select>\n                <button type=\"button\" id=\"btn-agregar-destino-resumen\" class=\"gofast-btn-mini\" style=\"margin-top:8px;width:100%;\">\n                    \u2795 Agregar destino\n                <\/button>\n            <\/div>\n\n        <\/div>\n\n        <!-- \u2705 COLUMNA DERECHA -->\n        <div class=\"gofast-box\">\n\n            <h3>Datos del servicio<\/h3>\n\n            <form method=\"post\" id=\"form-solicitar-servicio\">\n\t\t\t<input type=\"hidden\" name=\"origen\" id=\"input-origen\" value=\"<?= esc_attr($origen) ?>\">\n\t\t\t<div id=\"destinos-hidden-inputs\">\n\t\t\t\t<?php foreach ($destinos as $idx => $d): ?>\n\t\t\t\t\t<input type=\"hidden\" name=\"destino[]\" class=\"destino-input\" value=\"<?= esc_attr($d) ?>\" data-index=\"<?= esc_attr($idx) ?>\">\n\t\t\t\t<?php endforeach; ?>\n\t\t\t<\/div>\n\t\t\t<?php if ($negocio_id_cotizador > 0): ?>\n\t\t\t\t<input type=\"hidden\" name=\"negocio_id\" value=\"<?= esc_attr($negocio_id_cotizador) ?>\">\n\t\t\t\t<input type=\"hidden\" name=\"cliente_id\" value=\"<?= esc_attr($negocio_user_id_cotizador) ?>\">\n\t\t\t<?php elseif ($negocio_usado): ?>\n\t\t\t\t<input type=\"hidden\" name=\"negocio_id\" value=\"<?= esc_attr($negocio_usado->id) ?>\">\n\t\t\t\t<input type=\"hidden\" name=\"cliente_id\" value=\"<?= esc_attr($negocio_usado->user_id) ?>\">\n\t\t\t<?php endif; ?>\n\t\t\t<input type=\"hidden\" name=\"confirmar\" value=\"1\">\n\n                <div class=\"gofast-2col\">\n                    <div>\n                        <label>Tu nombre<\/label>\n                        <input type=\"text\" name=\"nombre\" required\n                               value=\"<?= esc_attr($nombre_default) ?>\">\n                    <\/div>\n\n                    <div>\n                        <label>WhatsApp<\/label>\n                        <input type=\"tel\" name=\"telefono\" required pattern=\"[0-9]{10}\"\n                               value=\"<?= esc_attr($telefono_default) ?>\">\n                    <\/div>\n                <\/div>\n\n                <label>Direcci\u00f3n origen<\/label>\n\n                <?php if ($negocio_usado): ?>\n\n                    <!-- Origen desde negocio -->\n                    <input type=\"text\" name=\"dir_origen\"\n                           value=\"<?= esc_attr($dir_origen_default) ?>\" required>\n\n                <?php elseif (!empty($direcciones_previas)): ?>\n\n                    <select name=\"dir_origen\" class=\"gofast-select\" required>\n                        <option value=\"\">\u2014 Seleccionar \u2014<\/option>\n                        <?php foreach ($direcciones_previas as $dir): ?>\n                            <option value=\"<?= esc_attr($dir) ?>\"><?= esc_html($dir) ?><\/option>\n                        <?php endforeach; ?>\n                    <\/select>\n\n                    <small>Si no aparece tu direcci\u00f3n, escribe una nueva:<\/small>\n                    <input type=\"text\" name=\"dir_origen_custom\"\n                           placeholder=\"Calle 10 #5-22\" style=\"margin-top:8px;\">\n\n                <?php else: ?>\n\n                    <input type=\"text\" name=\"dir_origen\" required placeholder=\"Calle 10 #5-22\">\n\n                <?php endif; ?>\n\n                <br><br>\n\n                <b>Direcciones destino + monto a pagar<\/b><br><br>\n\n                <div id=\"direcciones-destinos-wrapper\">\n                    <?php foreach ($detalle_envios as $idx => $d): ?>\n                        <div class=\"gofast-dir-item\" data-destino-index=\"<?= esc_attr($idx) ?>\" data-destino-id=\"<?= esc_attr($d['destino_id'] ?? '') ?>\">\n                            <label><strong><?= esc_html($d[\"destino\"]) ?><\/strong><\/label>\n\n                            <!-- Direcci\u00f3n destino OPCIONAL -->\n                            <input type=\"text\" name=\"dir_destino[]\" placeholder=\"Ej: Calle 12 #3-15\" style=\"margin-top:8px;\">\n\n                            <!-- Monto OPCIONAL -->\n                            <input type=\"text\" name=\"monto_destino[]\" class=\"gofast-money\" placeholder=\"$ 0\" style=\"margin-top:8px;\">\n                        <\/div>\n                    <?php endforeach; ?>\n                <\/div>\n\n                <div class=\"gofast-btn-group\">\n                   <button type=\"submit\" class=\"gofast-btn-request\">\n\t\t\t\t\t\t\ud83d\udc8c Solicitar servicio\n\t\t\t\t\t<\/button>\n\n                    <a href=\"<?php echo esc_url( home_url('\/cotizar') ); ?>\" class=\"gofast-btn-action gofast-secondary\">\ud83d\udd04 Hacer otra cotizaci\u00f3n<\/a>\n                <\/div>\n\n            <\/form>\n\n        <\/div>\n\n    <\/div>\n\n    <script>\n    \/\/ Datos para JavaScript\n    const datosResumen = {\n        origen: <?= json_encode($origen) ?>,\n        sector_origen: <?= json_encode($sector_origen) ?>,\n        recargo_fijo: <?= json_encode($recargo_fijo_por_envio) ?>,\n        recargos_variables: <?= json_encode(array_map(function($r) {\n            return [\n                'min' => intval($r->monto_min),\n                'max' => intval($r->monto_max),\n                'recargo' => intval($r->recargo)\n            ];\n        }, $recargos_variables)) ?>\n    };\n    \n    \/\/ Mapa de barrios con sus sectores\n    const barriosMap = <?= json_encode(array_map(function($b) use ($wpdb) {\n        $sector = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $b->id)));\n        return ['id' => $b->id, 'nombre' => $b->nombre, 'sector_id' => $sector];\n    }, $barrios_all)) ?>;\n    \n    \/\/ Mapa de tarifas\n    const tarifasMap = {};\n    <?php\n    $tarifas_all = $wpdb->get_results(\"SELECT origen_sector_id, destino_sector_id, precio FROM tarifas\");\n    foreach ($tarifas_all as $t) {\n        if (!isset($tarifasMap[$t->origen_sector_id])) {\n            $tarifasMap[$t->origen_sector_id] = [];\n        }\n        $tarifasMap[$t->origen_sector_id][$t->destino_sector_id] = intval($t->precio);\n    }\n    ?>\n    const tarifasData = <?= json_encode($tarifasMap) ?>;\n    \n    document.addEventListener('DOMContentLoaded', function () {\n      if (window.jQuery && jQuery.fn.select2) {\n        try { if (jQuery.fn.select2.amd) { jQuery.fn.select2.amd = undefined; } } catch(e) {}\n\n        jQuery('.gofast-select').each(function(){\n          jQuery(this).select2({\n            placeholder: \"Buscar direcci\u00f3n...\",\n            width: '100%',\n            dropdownParent: jQuery(this).closest('.gofast-box')\n          });\n        });\n        \n        \/\/ Inicializar Select2 para nuevo destino\n        jQuery('#nuevo-destino-select').select2({\n            placeholder: '\ud83d\udd0d Buscar barrio...',\n            width: '100%',\n            dropdownParent: jQuery('body'),\n            minimumResultsForSearch: 0,\n        });\n      }\n\n      \/\/ Agregar nuevo destino\n      const btnAgregar = document.getElementById('btn-agregar-destino-resumen');\n      if (btnAgregar) {\n          btnAgregar.addEventListener('click', function(){\n              const select = document.getElementById('nuevo-destino-select');\n              const destinoId = parseInt(select.value);\n              \n               if (!destinoId) {\n                   alert('Selecciona un destino primero');\n                   return;\n               }\n               \n               \/\/ Agregar destino (recargar para calcular correctamente)\n               agregarDestinoResumen(destinoId);\n          });\n      }\n    });\n\n    function eliminarDestinoResumen(index) {\n        if (!confirm('\u00bfEliminar este destino del resumen?')) return;\n        \n        \/\/ Obtener el item espec\u00edfico del resumen usando el \u00edndice\n        const itemsResumen = document.querySelectorAll('.gofast-destino-resumen-item');\n        const item = itemsResumen[index];\n        if (!item) return;\n        \n        \/\/ Obtener todos los destinos actuales del resumen\n        const destinosActuales = obtenerDestinosActuales();\n        \n        \/\/ Eliminar solo el destino en la posici\u00f3n del \u00edndice (no todos los que tengan el mismo ID)\n        const destinosFiltrados = [];\n        itemsResumen.forEach(function(itemResumen, idx) {\n            if (idx !== index) {\n                const destinoId = itemResumen.getAttribute('data-destino-id');\n                if (destinoId) {\n                    destinosFiltrados.push(destinoId);\n                }\n            }\n        });\n        \n        \/\/ Validar que haya al menos un destino\n        if (destinosFiltrados.length === 0) {\n            alert('Debes tener al menos un destino');\n            return;\n        }\n        \n        \/\/ Crear formulario para enviar destinos actualizados\n        const form = document.createElement('form');\n        form.method = 'POST';\n        form.action = '';\n        \n        const inputOrigen = document.createElement('input');\n        inputOrigen.type = 'hidden';\n        inputOrigen.name = 'origen';\n        inputOrigen.value = document.getElementById('input-origen').value;\n        form.appendChild(inputOrigen);\n        \n        \/\/ Agregar destinos restantes\n        destinosFiltrados.forEach(function(id) {\n            const input = document.createElement('input');\n            input.type = 'hidden';\n            input.name = 'destino[]';\n            input.value = id;\n            form.appendChild(input);\n        });\n        \n        document.body.appendChild(form);\n        form.submit();\n    }\n\n    function agregarDestinoResumen(destinoId) {\n        \/\/ Recargar p\u00e1gina con nuevo destino agregado\n        const form = document.createElement('form');\n        form.method = 'POST';\n        form.action = '';\n        \n        const inputOrigen = document.createElement('input');\n        inputOrigen.type = 'hidden';\n        inputOrigen.name = 'origen';\n        inputOrigen.value = document.getElementById('input-origen').value;\n        form.appendChild(inputOrigen);\n        \n        const destinosActuales = obtenerDestinosActuales();\n        destinosActuales.push(destinoId.toString());\n        \n        destinosActuales.forEach(function(id) {\n            const input = document.createElement('input');\n            input.type = 'hidden';\n            input.name = 'destino[]';\n            input.value = id;\n            form.appendChild(input);\n        });\n        \n        document.body.appendChild(form);\n        form.submit();\n    }\n\n    function obtenerDestinosActuales() {\n        \/\/ Obtener destinos solo desde los items del resumen (no del formulario)\n        const items = document.querySelectorAll('.gofast-destino-resumen-item[data-destino-id]');\n        const ids = [];\n        items.forEach(function(item) {\n            const destinoId = item.getAttribute('data-destino-id');\n            if (destinoId) {\n                ids.push(destinoId);\n            }\n        });\n        return ids;\n    }\n\n    function actualizarDestinosInputs() {\n        const destinos = obtenerDestinosActuales();\n        const container = document.getElementById('destinos-hidden-inputs');\n        if (container) {\n            container.innerHTML = '';\n            destinos.forEach(function(id, index) {\n                const input = document.createElement('input');\n                input.type = 'hidden';\n                input.name = 'destino[]';\n                input.className = 'destino-input';\n                input.value = id;\n                input.setAttribute('data-index', index);\n                container.appendChild(input);\n            });\n        }\n    }\n\n    function recalcularTotalJS() {\n        const items = document.querySelectorAll('[data-destino-index]');\n        let total = 0;\n        \n        items.forEach(function(item) {\n            const itemTotal = parseFloat(item.getAttribute('data-total')) || 0;\n            total += itemTotal;\n        });\n        \n        \/\/ Actualizar total en pantalla\n        const totalBox = document.getElementById('total-amount');\n        if (totalBox) {\n            totalBox.textContent = 'Total: $' + total.toLocaleString('es-CO');\n        }\n        \n        \/\/ Validar que haya al menos un destino\n        if (items.length === 0) {\n            alert('Debes tener al menos un destino');\n            window.location.href = '<?= esc_url(home_url('\/cotizar')) ?>';\n        }\n    }\n    <\/script>\n\n    <?php\n    return ob_get_clean();\n}\n\nadd_shortcode(\"gofast_resultado\", \"gofast_resultado_cotizacion\");\n\n","active":true,"modified":"2025-12-11 20:46:50","revision":"1"}]}