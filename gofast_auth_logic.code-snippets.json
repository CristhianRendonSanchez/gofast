{
  "generator": "Code Snippets v3.9.2",
  "date_created": "2025-11-21 22:43",
  "snippets": [
    {
      "id": 20,
      "name": "gofast_auth_logic",
      "code": "/***************************************************\n * GOFAST \u2013 L\u00d3GICA AUTH (LOGIN, REGISTRO, LOGOUT)\n * Ahora con sesi\u00f3n persistente (cookies 30 d\u00edas)\n ***************************************************/\nfunction gofast_handle_auth_requests() {\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    global $wpdb;\n\n    /*********************************************\n     * \ud83d\udd25 RESTAURAR SESI\u00d3N SI EXISTE COOKIE\n     *********************************************/\n    if (empty($_SESSION['gofast_user_id']) && !empty($_COOKIE['gofast_token'])) {\n\n        $token = sanitize_text_field($_COOKIE['gofast_token']);\n\n        $usuario = $wpdb->get_row(\n            $wpdb->prepare(\n                \"SELECT * FROM usuarios_gofast WHERE remember_token = %s AND activo = 1\",\n                $token\n            )\n        );\n\n        if ($usuario) {\n            $_SESSION['gofast_user_id']  = (int) $usuario->id;\n            $_SESSION['gofast_user_rol'] = strtolower($usuario->rol ?: 'cliente');\n        }\n    }\n\n    /*********************************************\n     * LOGOUT (?gofast_logout=1)\n     *********************************************/\n    if (isset($_GET['gofast_logout'])) {\n\n        // Eliminar sesi\u00f3n\n        unset($_SESSION['gofast_user_id'], $_SESSION['gofast_user_rol']);\n        session_destroy();\n\n        // Eliminar cookie\n        setcookie(\"gofast_token\", \"\", time() - 3600, \"/\");\n\n        wp_redirect(home_url('/'));\n        exit;\n    }\n\n    // Si NO es POST \u2192 no hay login ni registro\n    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {\n        return;\n    }\n\n    /*********************************************\n     * LOGIN\n     *********************************************/\n    if (isset($_POST['gofast_login'])) {\n\n        $user_raw = trim($_POST['user'] ?? '');\n        $password = $_POST['password'] ?? '';\n        $remember = !empty($_POST['remember']); // checkbox\n\n        if ($user_raw === '' || $password === '') {\n            $_SESSION['gofast_auth_error'] = 'Por favor ingresa usuario y contrase\u00f1a.';\n            wp_redirect(home_url('/auth'));\n            exit;\n        }\n\n        $tel_norm = preg_replace('/\\D+/', '', $user_raw);\n        $tabla    = 'usuarios_gofast';\n\n        // Buscar usuario\n        $sql = \"\n            SELECT *\n            FROM $tabla\n            WHERE activo = 1\n              AND (\n                    email = %s\n                 OR REPLACE(REPLACE(REPLACE(telefono, '+',''), ' ','') ,'-','') = %s\n              )\n            LIMIT 1\n        \";\n        $usuario = $wpdb->get_row($wpdb->prepare($sql, $user_raw, $tel_norm));\n\n        // Validar\n        if (\n            !$usuario ||\n            empty($usuario->password_hash) ||\n            !password_verify($password, $usuario->password_hash)\n        ) {\n            $_SESSION['gofast_auth_error'] = 'Usuario o contrase\u00f1a incorrectos.';\n            wp_redirect(home_url('/auth'));\n            exit;\n        }\n\n        // Guardar sesi\u00f3n normal\n        $_SESSION['gofast_user_id']  = (int) $usuario->id;\n        $_SESSION['gofast_user_rol'] = strtolower($usuario->rol ?: 'cliente');\n\n        /*********************************************\n         * \ud83d\udd25 COOKIE PERSISTENTE (30 D\u00cdAS)\n         *********************************************/\n        if ($remember) {\n\n            // Crear token \u00fanico\n            $token = wp_generate_uuid4();\n\n            // Guardarlo en DB\n            $wpdb->update(\n                $tabla,\n                ['remember_token' => $token],\n                ['id' => $usuario->id],\n                ['%s'],\n                ['%d']\n            );\n\n            // Guardar cookie 30 d\u00edas\n            setcookie(\n                \"gofast_token\",\n                $token,\n                time() + (86400 * 30),\n                \"/\",\n                \"\",\n                false,\n                true\n            );\n        }\n\n        wp_redirect(home_url('/'));\n        exit;\n    }\n\n    /*********************************************\n     * REGISTRO\n     *********************************************/\n    if (isset($_POST['gofast_registro'])) {\n\n        $nombre    = trim($_POST['nombre'] ?? '');\n        $telefono  = trim($_POST['telefono'] ?? '');\n        $email     = trim($_POST['email'] ?? '');\n        $password  = $_POST['password']  ?? '';\n        $password2 = $_POST['password2'] ?? '';\n\n        if ($nombre === '' || $telefono === '' || $email === '' || $password === '' || $password2 === '') {\n            $_SESSION['gofast_auth_error'] = 'Todos los campos son obligatorios.';\n            wp_redirect(home_url('/auth/?registro=1'));\n            exit;\n        }\n\n        if (!is_email($email)) {\n            $_SESSION['gofast_auth_error'] = 'El correo no es v\u00e1lido.';\n            wp_redirect(home_url('/auth/?registro=1'));\n            exit;\n        }\n\n        if ($password !== $password2) {\n            $_SESSION['gofast_auth_error'] = 'Las contrase\u00f1as no coinciden.';\n            wp_redirect(home_url('/auth/?registro=1'));\n            exit;\n        }\n\n        $tel_norm = preg_replace('/\\D+/', '', $telefono);\n        $tabla    = 'usuarios_gofast';\n\n        // Verificar duplicados\n        $sql = \"\n            SELECT id\n            FROM $tabla\n            WHERE email = %s\n               OR REPLACE(REPLACE(REPLACE(telefono, '+',''), ' ','') ,'-','') = %s\n            LIMIT 1\n        \";\n        $existe = $wpdb->get_row($wpdb->prepare($sql, $email, $tel_norm));\n\n        if ($existe) {\n            $_SESSION['gofast_auth_error'] = 'Ya existe un usuario con ese correo o tel\u00e9fono.';\n            wp_redirect(home_url('/auth/?registro=1'));\n            exit;\n        }\n\n        $hash = password_hash($password, PASSWORD_DEFAULT);\n\n        $ok = $wpdb->insert(\n            $tabla,\n            [\n                'nombre'         => $nombre,\n                'telefono'       => $telefono,\n                'email'          => $email,\n                'password_hash'  => $hash,\n                'rol'            => 'cliente',\n                'activo'         => 1,\n                'fecha_registro' => current_time('mysql'),\n                'remember_token' => null\n            ],\n            ['%s','%s','%s','%s','%s','%d','%s','%s']\n        );\n\n        if (!$ok) {\n            $_SESSION['gofast_auth_error'] = 'No se pudo crear la cuenta. Intenta de nuevo.';\n            wp_redirect(home_url('/auth/?registro=1'));\n            exit;\n        }\n\n        $user_id = (int)$wpdb->insert_id;\n\n        // Login autom\u00e1tico\n        $_SESSION['gofast_user_id']  = $user_id;\n        $_SESSION['gofast_user_rol'] = 'cliente';\n\n        wp_redirect(home_url('/'));\n        exit;\n    }\n}\nadd_action('init', 'gofast_handle_auth_requests', 5);\n",
      "active": true,
      "modified": "2025-11-21 21:08:03",
      "revision": "1"
    }
  ]
}
