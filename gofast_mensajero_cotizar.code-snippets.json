{
  "generator": "Code Snippets v3.9.2",
  "date_created": "2025-11-21 22:43",
  "snippets": [
    {
      "id": 27,
      "name": "gofast_mensajero_cotizar",
      "code": "/*******************************************************\n * üöö GOFAST ‚Äî COTIZACI√ìN R√ÅPIDA PARA MENSAJEROS\n * Shortcode: [gofast_mensajero_cotizar]\n * URL: /mensajero-cotizar\n *\n * Funcionalidad:\n * - Paso 1: Seleccionar origen y destinos (igual que cotizar normal)\n * - Paso 2: Resumen editable (eliminar/agregar destinos sin recotizar)\n * - Botones aceptar/rechazar\n * - Al aceptar: crea servicio y lo asigna autom√°ticamente al mensajero\n *******************************************************/\n\nfunction gofast_mensajero_cotizar_shortcode() {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    // Validar que sea mensajero\n    if (empty($_SESSION['gofast_user_id'])) {\n        return \"<div class='gofast-box'>Debes iniciar sesi√≥n como mensajero para usar esta funci√≥n.</div>\";\n    }\n\n    $user_id = (int) $_SESSION['gofast_user_id'];\n    $rol = strtolower($_SESSION['gofast_user_rol'] ?? '');\n\n    // Verificar rol\n    if ($rol !== 'mensajero') {\n        $usuario = $wpdb->get_row($wpdb->prepare(\n            \"SELECT rol FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n            $user_id\n        ));\n        if (!$usuario || strtolower($usuario->rol) !== 'mensajero') {\n            return \"<div class='gofast-box'>‚ö†Ô∏è Solo los mensajeros pueden usar esta funci√≥n.</div>\";\n        }\n        $_SESSION['gofast_user_rol'] = 'mensajero';\n    }\n\n    // Obtener datos del mensajero\n    $mensajero = $wpdb->get_row($wpdb->prepare(\n        \"SELECT id, nombre, telefono, email FROM usuarios_gofast WHERE id = %d AND activo = 1\",\n        $user_id\n    ));\n\n    if (!$mensajero) {\n        return \"<div class='gofast-box'>Error: Usuario no encontrado.</div>\";\n    }\n\n    /*******************************************************\n     * PASO 2: PROCESAR ACEPTAR/RECHAZAR O EDITAR DESTINOS\n     *******************************************************/\n    if (isset($_POST['gofast_mensajero_aceptar']) || isset($_POST['gofast_mensajero_rechazar'])) {\n        \n        if (isset($_POST['gofast_mensajero_rechazar'])) {\n            // Rechazar: volver al paso 1\n            unset($_SESSION['gofast_mensajero_cotizacion']);\n            wp_redirect(home_url('/mensajero-cotizar'));\n            exit;\n        }\n\n        // Aceptar: crear servicio\n        if (empty($_POST['origen']) || empty($_POST['destinos_finales'])) {\n            return \"<div class='gofast-box'>Error: Faltan datos del servicio.</div>\";\n        }\n\n        $origen = intval($_POST['origen']);\n        $destinos_finales = array_map('intval', (array) $_POST['destinos_finales']);\n\n        if (empty($destinos_finales)) {\n            return \"<div class='gofast-box'>Debes tener al menos un destino.</div>\";\n        }\n\n        // Calcular tarifas y recargos (mismo c√≥digo que solicitar-mensajero)\n        $sector_origen = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $origen)));\n        $nombre_origen = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $origen));\n\n        // Recargos fijos\n        $recargos_fijos = $wpdb->get_results(\"SELECT id, nombre, valor_fijo FROM recargos WHERE activo = 1 AND tipo = 'fijo'\");\n        $recargo_fijo_por_envio = 0;\n        foreach ((array) $recargos_fijos as $r) {\n            $monto = intval($r->valor_fijo);\n            if ($monto > 0) {\n                $recargo_fijo_por_envio += $monto;\n            }\n        }\n\n        // Recargos variables\n        $recargos_variables = $wpdb->get_results(\"SELECT r.id, r.nombre, rr.monto_min, rr.monto_max, rr.recargo FROM recargos r JOIN recargos_rangos rr ON rr.recargo_id = r.id WHERE r.activo = 1 AND r.tipo = 'por_valor' ORDER BY rr.monto_min ASC\");\n        \n        $calcular_recargos_variables = function($valor) use ($recargos_variables) {\n            $valor = intval($valor);\n            $total_variable = 0;\n            foreach ((array) $recargos_variables as $r) {\n                $min = intval($r->monto_min);\n                $max = intval($r->monto_max);\n                $rec = intval($r->recargo);\n                $cumple_min = ($valor >= $min);\n                $cumple_max = ($max <= 0) ? true : ($valor <= $max);\n                if ($cumple_min && $cumple_max && $rec > 0) {\n                    $total_variable += $rec;\n                }\n            }\n            return $total_variable;\n        };\n\n        // Calcular total\n        $total = 0;\n        $destinos_completos = [];\n        \n        foreach ($destinos_finales as $dest_id) {\n            $sector_destino = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $dest_id)));\n            $nombre_destino = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $dest_id));\n\n            $precio = $wpdb->get_var($wpdb->prepare(\n                \"SELECT precio FROM tarifas WHERE origen_sector_id=%d AND destino_sector_id=%d\",\n                $sector_origen,\n                $sector_destino\n            ));\n            $precio = $precio ? intval($precio) : 0;\n\n            $recargo_variable = $calcular_recargos_variables($precio);\n            $recargo_total = $recargo_fijo_por_envio + $recargo_variable;\n            $total_trayecto = $precio + $recargo_total;\n            $total += $total_trayecto;\n\n            $destinos_completos[] = [\n                'barrio_id' => $dest_id,\n                'barrio_nombre' => $nombre_destino,\n                'sector_id' => $sector_destino,\n                'direccion' => '',\n                'monto' => 0,\n            ];\n        }\n\n        // JSON final\n        $origen_completo = [\n            'barrio_id' => $origen,\n            'barrio_nombre' => $nombre_origen,\n            'sector_id' => $sector_origen,\n            'direccion' => 'Servicio creado por mensajero',\n        ];\n\n        $json_final = json_encode([\n            'origen' => $origen_completo,\n            'destinos' => $destinos_completos,\n        ], JSON_UNESCAPED_UNICODE);\n\n        // Crear servicio y asignarlo autom√°ticamente al mensajero\n        $insertado = $wpdb->insert('servicios_gofast', [\n            'nombre_cliente' => $mensajero->nombre . ' (Mensajero)',\n            'telefono_cliente' => $mensajero->telefono,\n            'direccion_origen' => 'Servicio creado por mensajero',\n            'destinos' => $json_final,\n            'total' => $total,\n            'estado' => 'asignado',\n            'tracking_estado' => 'asignado',\n            'mensajero_id' => $mensajero->id,\n            'user_id' => $mensajero->id,\n            'fecha' => current_time('mysql'),\n        ]);\n\n        if ($insertado === false) {\n            return \"<div class='gofast-box'><b>Error al crear el servicio:</b><br>\" . esc_html($wpdb->last_error) . \"</div>\";\n        }\n\n        $service_id = (int) $wpdb->insert_id;\n        unset($_SESSION['gofast_mensajero_cotizacion']);\n\n        // Redirigir a confirmaci√≥n\n        wp_redirect(home_url('/servicio-registrado?id=' . $service_id));\n        exit;\n    }\n\n    /*******************************************************\n     * PASO 2: MOSTRAR RESUMEN EDITABLE\n     *******************************************************/\n    if (isset($_POST['gofast_mensajero_cotizar']) || !empty($_SESSION['gofast_mensajero_cotizacion'])) {\n        \n        // Guardar en sesi√≥n\n        if (isset($_POST['gofast_mensajero_cotizar'])) {\n            $origen = intval($_POST['origen'] ?? 0);\n            $destinos = array_map('intval', (array) ($_POST['destino'] ?? []));\n            \n            if ($origen > 0 && !empty($destinos)) {\n                $_SESSION['gofast_mensajero_cotizacion'] = [\n                    'origen' => $origen,\n                    'destinos' => $destinos,\n                ];\n            }\n        }\n\n        $cotizacion = $_SESSION['gofast_mensajero_cotizacion'] ?? null;\n        \n        if (!$cotizacion || empty($cotizacion['origen']) || empty($cotizacion['destinos'])) {\n            // Volver al paso 1\n            unset($_SESSION['gofast_mensajero_cotizacion']);\n        } else {\n            // Mostrar resumen editable\n            return gofast_mensajero_mostrar_resumen($cotizacion['origen'], $cotizacion['destinos']);\n        }\n    }\n\n    /*******************************************************\n     * PASO 1: FORMULARIO DE COTIZACI√ìN\n     *******************************************************/\n    \n    // Obtener barrios\n    $barrios_all = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n    $barrios = $barrios_all ?: [];\n\n    // Recuperar √∫ltima cotizaci√≥n\n    $old_data = $_SESSION['gofast_mensajero_last_quote'] ?? ['origen' => '', 'destinos' => []];\n\n    ob_start();\n    ?>\n\n    <div class=\"gofast-form\">\n        <div class=\"gofast-box\" style=\"background:#e3f2fd;border-left:4px solid #2196F3;padding:12px;margin-bottom:16px;\">\n            <strong>üöö Modo Mensajero</strong><br>\n            <small>Crea servicios r√°pidamente. Al aceptar, el servicio se asignar√° autom√°ticamente a ti.</small>\n        </div>\n\n        <form method=\"post\" action=\"\" id=\"gofast-mensajero-form\">\n            <div class=\"gofast-row\">\n                <div style=\"flex:1;\">\n                    <label><strong>Origen</strong></label>\n                    <select name=\"origen\" class=\"gofast-select\" id=\"origen\" required>\n                        <option value=\"\">Buscar barrio...</option>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\"\n                                <?= ((string)$old_data['origen'] === (string)$b->id ? 'selected' : '') ?>>\n                                <?= esc_html($b->nombre) ?>\n                            </option>\n                        <?php endforeach; ?>\n                    </select>\n                </div>\n\n                <div style=\"flex:1;\">\n                    <label><strong>Primer destino</strong></label>\n                    <select name=\"destino[]\" class=\"gofast-select\" id=\"destino-principal\" required>\n                        <option value=\"\">Buscar barrio...</option>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\"\n                                <?= in_array($b->id, $old_data['destinos'], true) ? 'selected' : '' ?>>\n                                <?= esc_html($b->nombre) ?>\n                            </option>\n                        <?php endforeach; ?>\n                    </select>\n                </div>\n            </div>\n\n            <div class=\"gofast-destinos-grid\">\n                <div class=\"gofast-destinos-label\">\n                    <label><strong>Destinos adicionales</strong></label>\n                </div>\n                <div id=\"destinos-wrapper\">\n                    <div id=\"destinos-extra\"></div>\n                    <button type=\"button\" id=\"btn-add-destino\" class=\"gofast-add-button\" onclick=\"addDestinoMensajero()\">\n                        ‚ûï Agregar destino adicional\n                    </button>\n                </div>\n            </div>\n\n            <template id=\"tpl-destino-mensajero\">\n                <div class=\"gofast-destino-item\">\n                    <select name=\"destino[]\" class=\"gofast-select\" required>\n                        <option value=\"\">Buscar barrio...</option>\n                        <?php foreach ($barrios as $b): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\">\n                                <?= esc_html($b->nombre) ?>\n                            </option>\n                        <?php endforeach; ?>\n                    </select>\n                    <button type=\"button\" class=\"gofast-remove\" onclick=\"removeDestinoMensajero(this)\">‚ùå</button>\n                </div>\n            </template>\n\n            <div class=\"gofast-btn-group\">\n                <button type=\"submit\" name=\"gofast_mensajero_cotizar\" class=\"gofast-submit\" id=\"btn-submit\">\n                    Ver resumen üöÄ\n                </button>\n            </div>\n        </form>\n    </div>\n\n    <script>\n    document.addEventListener('DOMContentLoaded', function(){\n        if (window.jQuery && jQuery.fn.select2) {\n            initSelect2Mensajero('.gofast-form');\n        }\n\n        const form = document.getElementById('gofast-mensajero-form');\n        if (form) {\n            form.addEventListener('submit', function(e){\n                const origen = document.getElementById('origen').value;\n                const destino = document.getElementById('destino-principal').value;\n                if (!origen || !destino){\n                    e.preventDefault();\n                    alert('Debes seleccionar origen y al menos un destino ‚ö†Ô∏è');\n                    return false;\n                }\n            });\n        }\n    });\n\n    function addDestinoMensajero(){\n        const tpl = document.getElementById('tpl-destino-mensajero');\n        const cont = document.getElementById('destinos-extra');\n        const btn = document.getElementById('btn-add-destino');\n        if (tpl && cont) {\n            cont.appendChild(tpl.content.cloneNode(true));\n            cont.parentNode.appendChild(btn);\n            if (window.jQuery && jQuery.fn.select2) {\n                initSelect2Mensajero('#destinos-extra');\n            }\n        }\n    }\n\n    function removeDestinoMensajero(btn){\n        btn.parentElement.remove();\n    }\n\n    function initSelect2Mensajero(container){\n        if (!window.jQuery || !jQuery.fn.select2) return;\n        \n        const normalize = s => (s || '').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').trim();\n        \n        jQuery(container).find('.gofast-select').each(function(){\n            if (jQuery(this).data('select2')) return;\n            \n            jQuery(this).select2({\n                placeholder: 'üîç Escribe para buscar...',\n                width: '100%',\n                dropdownParent: jQuery('body'),\n                allowClear: true,\n                minimumResultsForSearch: 0,\n                matcher: function(params, data){\n                    if (!data || !data.id || !data.text) return null;\n                    if (!params.term || !params.term.trim()) return data;\n                    const term = normalize(params.term);\n                    const text = normalize(data.text);\n                    if (text.indexOf(term) !== -1 || text.startsWith(term)) {\n                        return data;\n                    }\n                    return null;\n                }\n            });\n        });\n    }\n    </script>\n\n    <?php\n    return ob_get_clean();\n}\n\n/*******************************************************\n * FUNCI√ìN: MOSTRAR RESUMEN EDITABLE\n *******************************************************/\nfunction gofast_mensajero_mostrar_resumen($origen, $destinos) {\n    global $wpdb;\n\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    $user_id = (int) $_SESSION['gofast_user_id'];\n\n    // Datos del origen\n    $sector_origen = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $origen)));\n    $nombre_origen = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $origen));\n\n    // Recargos\n    $recargos_fijos = $wpdb->get_results(\"SELECT id, nombre, valor_fijo FROM recargos WHERE activo = 1 AND tipo = 'fijo'\");\n    $recargo_fijo_por_envio = 0;\n    $recargos_fijos_nombres = [];\n    foreach ((array) $recargos_fijos as $r) {\n        $monto = intval($r->valor_fijo);\n        if ($monto > 0) {\n            $recargo_fijo_por_envio += $monto;\n            $recargos_fijos_nombres[] = $r->nombre;\n        }\n    }\n\n    $recargos_variables = $wpdb->get_results(\"SELECT r.id, r.nombre, rr.monto_min, rr.monto_max, rr.recargo FROM recargos r JOIN recargos_rangos rr ON rr.recargo_id = r.id WHERE r.activo = 1 AND r.tipo = 'por_valor' ORDER BY rr.monto_min ASC\");\n    \n    $calcular_recargos_variables = function($valor) use ($recargos_variables) {\n        $valor = intval($valor);\n        $total_variable = 0;\n        foreach ((array) $recargos_variables as $r) {\n            $min = intval($r->monto_min);\n            $max = intval($r->monto_max);\n            $rec = intval($r->recargo);\n            $cumple_min = ($valor >= $min);\n            $cumple_max = ($max <= 0) ? true : ($valor <= $max);\n            if ($cumple_min && $cumple_max && $rec > 0) {\n                $total_variable += $rec;\n            }\n        }\n        return $total_variable;\n    };\n\n    // Calcular detalle\n    $detalle_envios = [];\n    $total = 0;\n    $lista_recargos = [];\n\n    foreach ($destinos as $dest_id) {\n        $sector_destino = intval($wpdb->get_var($wpdb->prepare(\"SELECT sector_id FROM barrios WHERE id = %d\", $dest_id)));\n        $nombre_destino = $wpdb->get_var($wpdb->prepare(\"SELECT nombre FROM barrios WHERE id = %d\", $dest_id));\n\n        $precio = $wpdb->get_var($wpdb->prepare(\n            \"SELECT precio FROM tarifas WHERE origen_sector_id=%d AND destino_sector_id=%d\",\n            $sector_origen,\n            $sector_destino\n        ));\n        $precio = $precio ? intval($precio) : 0;\n\n        $recargo_variable = $calcular_recargos_variables($precio);\n        $recargo_total = $recargo_fijo_por_envio + $recargo_variable;\n        $total_trayecto = $precio + $recargo_total;\n        $total += $total_trayecto;\n\n        $detalle_envios[] = [\n            'id' => $dest_id,\n            'nombre' => $nombre_destino,\n            'precio' => $precio,\n            'recargo' => $recargo_total,\n            'total' => $total_trayecto,\n        ];\n    }\n\n    // Lista de recargos √∫nicos\n    foreach ($recargos_fijos_nombres as $nombre) {\n        if (!in_array($nombre, $lista_recargos, true)) {\n            $lista_recargos[] = $nombre;\n        }\n    }\n\n    // Obtener todos los barrios para agregar nuevos\n    $barrios_all = $wpdb->get_results(\"SELECT id, nombre FROM barrios ORDER BY nombre ASC\");\n\n    ob_start();\n    ?>\n\n    <div class=\"gofast-checkout-wrapper\">\n        <div class=\"gofast-box\" style=\"max-width:800px;margin:0 auto;\">\n            \n            <div style=\"background:#e3f2fd;border-left:4px solid #2196F3;padding:12px;margin-bottom:20px;border-radius:8px;\">\n                <strong>üöö Resumen del Servicio</strong><br>\n                <small>Puedes eliminar destinos o agregar nuevos antes de aceptar.</small>\n            </div>\n\n            <h3 style=\"margin-top:0;\">üìç Origen: <?= esc_html($nombre_origen) ?></h3>\n\n            <div id=\"destinos-resumen\">\n                <?php foreach ($detalle_envios as $idx => $d): ?>\n                    <div class=\"gofast-destino-resumen-item\" data-destino-id=\"<?= esc_attr($d['id']) ?>\">\n                        <div style=\"display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;border-left:4px solid #F4C524;\">\n                            <div style=\"flex:1;\">\n                                <strong>üéØ <?= esc_html($d['nombre']) ?></strong><br>\n                                <small style=\"color:#666;\">\n                                    Base: $<?= number_format($d['precio'], 0, ',', '.') ?> | \n                                    Recargo: $<?= number_format($d['recargo'], 0, ',', '.') ?>\n                                </small><br>\n                                <strong style=\"color:#4CAF50;font-size:18px;\">\n                                    $<?= number_format($d['total'], 0, ',', '.') ?>\n                                </strong>\n                            </div>\n                            <button type=\"button\" class=\"gofast-btn-delete\" onclick=\"eliminarDestinoResumen(<?= esc_attr($d['id']) ?>)\" style=\"margin-left:12px;padding:8px 12px;\">\n                                ‚ùå Eliminar\n                            </button>\n                        </div>\n                    </div>\n                <?php endforeach; ?>\n            </div>\n\n            <?php if (!empty($lista_recargos)): ?>\n                <div class=\"gofast-recargo-box\" style=\"margin:16px 0;\">\n                    üü° <b>Recargos aplicados:</b><br>\n                    <ul style=\"margin:8px 0 0 20px;\">\n                        <?php foreach ($lista_recargos as $nombre): ?>\n                            <li><?= esc_html($nombre) ?></li>\n                        <?php endforeach; ?>\n                    </ul>\n                </div>\n            <?php endif; ?>\n\n            <div class=\"gofast-total-box\" style=\"margin:20px 0;text-align:center;\">\n                üí∞ <strong style=\"font-size:24px;\">Total: $<?= number_format($total, 0, ',', '.') ?></strong>\n            </div>\n\n            <!-- Agregar nuevo destino -->\n            <div style=\"background:#f8f9fa;padding:16px;border-radius:8px;margin:20px 0;\">\n                <label><strong>‚ûï Agregar nuevo destino</strong></label>\n                <select id=\"nuevo-destino-select\" class=\"gofast-select\" style=\"margin-top:8px;\">\n                    <option value=\"\">Seleccionar barrio...</option>\n                    <?php foreach ($barrios_all as $b): ?>\n                        <?php if (!in_array($b->id, array_column($detalle_envios, 'id'))): ?>\n                            <option value=\"<?= esc_attr($b->id) ?>\"><?= esc_html($b->nombre) ?></option>\n                        <?php endif; ?>\n                    <?php endforeach; ?>\n                </select>\n                <button type=\"button\" id=\"btn-agregar-destino-resumen\" class=\"gofast-btn-mini\" style=\"margin-top:8px;width:100%;\">\n                    ‚ûï Agregar destino\n                </button>\n            </div>\n\n            <!-- Formulario oculto para enviar -->\n            <form method=\"post\" id=\"form-aceptar-rechazar\">\n                <input type=\"hidden\" name=\"origen\" id=\"input-origen\" value=\"<?= esc_attr($origen) ?>\">\n                <input type=\"hidden\" name=\"destinos_finales\" id=\"input-destinos\" value=\"<?= esc_attr(implode(',', array_column($detalle_envios, 'id'))) ?>\">\n\n                <div class=\"gofast-btn-group\" style=\"margin-top:24px;\">\n                    <button type=\"submit\" name=\"gofast_mensajero_aceptar\" class=\"gofast-btn-request\" style=\"background:#4CAF50;color:#fff;\">\n                        ‚úÖ Aceptar y crear servicio\n                    </button>\n                    <button type=\"submit\" name=\"gofast_mensajero_rechazar\" class=\"gofast-btn-action gofast-secondary\">\n                        ‚ùå Rechazar y volver\n                    </button>\n                </div>\n            </form>\n\n        </div>\n    </div>\n\n    <script>\n    // Datos de tarifas y recargos desde PHP\n    const datosCotizacion = {\n        origen: <?= json_encode($origen) ?>,\n        sector_origen: <?= json_encode($sector_origen) ?>\n    };\n    \n    // Datos de destinos actuales con precios\n    const destinosData = <?= json_encode(array_map(function($d) {\n        return [\n            'id' => $d['id'],\n            'nombre' => $d['nombre'],\n            'precio' => $d['precio'],\n            'recargo' => $d['recargo'],\n            'total' => $d['total']\n        ];\n    }, $detalle_envios)) ?>;\n    \n    // Datos de todos los barrios para agregar\n    const barriosDisponibles = <?= json_encode(array_map(function($b) {\n        return ['id' => $b->id, 'nombre' => $b->nombre];\n    }, $barrios_all)) ?>;\n    \n    // Recargos fijos\n    const recargoFijo = <?= json_encode($recargo_fijo_por_envio) ?>;\n    \n    document.addEventListener('DOMContentLoaded', function(){\n        // Inicializar Select2 para nuevo destino\n        if (window.jQuery && jQuery.fn.select2) {\n            jQuery('#nuevo-destino-select').select2({\n                placeholder: 'üîç Buscar barrio...',\n                width: '100%',\n                dropdownParent: jQuery('body'),\n                minimumResultsForSearch: 0,\n            });\n        }\n\n        // Agregar nuevo destino\n        const btnAgregar = document.getElementById('btn-agregar-destino-resumen');\n        if (btnAgregar) {\n            btnAgregar.addEventListener('click', function(){\n                const select = document.getElementById('nuevo-destino-select');\n                const destinoId = parseInt(select.value);\n                \n                if (!destinoId) {\n                    alert('Selecciona un destino primero');\n                    return;\n                }\n                \n                // Verificar que no est√© ya agregado\n                if (obtenerDestinosActuales().includes(destinoId.toString())) {\n                    alert('Este destino ya est√° en el resumen');\n                    return;\n                }\n                \n                // Agregar destino v√≠a AJAX\n                agregarDestinoResumenAJAX(destinoId);\n            });\n        }\n    });\n\n    function eliminarDestinoResumen(destinoId) {\n        if (!confirm('¬øEliminar este destino del resumen?')) return;\n        \n        const item = document.querySelector('[data-destino-id=\"' + destinoId + '\"]');\n        if (item) {\n            item.remove();\n            actualizarDestinosInput();\n            recalcularTotalJS();\n        }\n    }\n\n    function agregarDestinoResumenAJAX(destinoId) {\n        // Buscar datos del barrio\n        const barrio = barriosDisponibles.find(b => b.id == destinoId);\n        if (!barrio) {\n            alert('Error: Barrio no encontrado');\n            return;\n        }\n        \n        // Mostrar loading\n        const btnAgregar = document.getElementById('btn-agregar-destino-resumen');\n        const textoOriginal = btnAgregar.textContent;\n        btnAgregar.disabled = true;\n        btnAgregar.textContent = '‚è≥ Calculando...';\n        \n        // Hacer petici√≥n AJAX para obtener precio\n        fetch('<?= esc_url(admin_url('admin-ajax.php')) ?>', {\n            method: 'POST',\n            headers: {'Content-Type': 'application/x-www-form-urlencoded'},\n            body: new URLSearchParams({\n                action: 'gofast_calcular_tarifa',\n                origen_sector: datosCotizacion.sector_origen,\n                destino_id: destinoId\n            })\n        })\n        .then(r => r.json())\n        .then(data => {\n            if (data.success) {\n                const precio = data.precio || 0;\n                const recargo = recargoFijo; // Por ahora solo fijo, se puede mejorar\n                const total = precio + recargo;\n                \n                // Agregar al DOM\n                agregarDestinoAlDOM(destinoId, barrio.nombre, precio, recargo, total);\n                actualizarDestinosInput();\n                recalcularTotalJS();\n                \n                // Limpiar select\n                if (window.jQuery && jQuery.fn.select2) {\n                    jQuery('#nuevo-destino-select').val(null).trigger('change');\n                }\n            } else {\n                alert('Error al calcular tarifa: ' + (data.message || 'Error desconocido'));\n            }\n        })\n        .catch(err => {\n            console.error('Error:', err);\n            // Fallback: recargar p√°gina\n            agregarDestinoResumenRecarga(destinoId);\n        })\n        .finally(() => {\n            btnAgregar.disabled = false;\n            btnAgregar.textContent = textoOriginal;\n        });\n    }\n    \n    function agregarDestinoAlDOM(destinoId, nombre, precio, recargo, total) {\n        const container = document.getElementById('destinos-resumen');\n        if (!container) return;\n        \n        const item = document.createElement('div');\n        item.className = 'gofast-destino-resumen-item';\n        item.setAttribute('data-destino-id', destinoId);\n        item.setAttribute('data-precio', precio);\n        item.setAttribute('data-recargo', recargo);\n        item.setAttribute('data-total', total);\n        item.innerHTML = `\n            <div style=\"display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;border-left:4px solid #F4C524;\">\n                <div style=\"flex:1;\">\n                    <strong>üéØ ${nombre}</strong><br>\n                    <small style=\"color:#666;\">\n                        Base: $${precio.toLocaleString('es-CO')} | \n                        Recargo: $${recargo.toLocaleString('es-CO')}\n                    </small><br>\n                    <strong style=\"color:#4CAF50;font-size:18px;\">\n                        $${total.toLocaleString('es-CO')}\n                    </strong>\n                </div>\n                <button type=\"button\" class=\"gofast-btn-delete\" onclick=\"eliminarDestinoResumen(${destinoId})\" style=\"margin-left:12px;padding:8px 12px;\">\n                    ‚ùå Eliminar\n                </button>\n            </div>\n        `;\n        \n        container.appendChild(item);\n    }\n    \n    function agregarDestinoResumenRecarga(destinoId) {\n        // Fallback: recargar p√°gina con nuevo destino\n        const form = document.createElement('form');\n        form.method = 'POST';\n        form.action = '';\n        \n        const inputOrigen = document.createElement('input');\n        inputOrigen.type = 'hidden';\n        inputOrigen.name = 'origen';\n        inputOrigen.value = document.getElementById('input-origen').value;\n        form.appendChild(inputOrigen);\n        \n        const destinosActuales = obtenerDestinosActuales();\n        destinosActuales.push(destinoId.toString());\n        \n        destinosActuales.forEach(function(id) {\n            const input = document.createElement('input');\n            input.type = 'hidden';\n            input.name = 'destino[]';\n            input.value = id;\n            form.appendChild(input);\n        });\n        \n        const submit = document.createElement('input');\n        submit.type = 'hidden';\n        submit.name = 'gofast_mensajero_cotizar';\n        submit.value = '1';\n        form.appendChild(submit);\n        \n        document.body.appendChild(form);\n        form.submit();\n    }\n\n    function obtenerDestinosActuales() {\n        const items = document.querySelectorAll('[data-destino-id]');\n        const ids = [];\n        items.forEach(function(item) {\n            ids.push(item.getAttribute('data-destino-id'));\n        });\n        return ids;\n    }\n\n    function actualizarDestinosInput() {\n        const destinos = obtenerDestinosActuales();\n        document.getElementById('input-destinos').value = destinos.join(',');\n    }\n\n    function recalcularTotalJS() {\n        const items = document.querySelectorAll('[data-destino-id]');\n        let total = 0;\n        \n        items.forEach(function(item) {\n            const itemTotal = parseFloat(item.getAttribute('data-total')) || 0;\n            total += itemTotal;\n        });\n        \n        // Actualizar total en pantalla\n        const totalBox = document.querySelector('.gofast-total-box strong');\n        if (totalBox) {\n            totalBox.textContent = 'Total: $' + total.toLocaleString('es-CO');\n        }\n    }\n    </script>\n\n    <?php\n    return ob_get_clean();\n}\n\nadd_shortcode('gofast_mensajero_cotizar', 'gofast_mensajero_cotizar_shortcode');\n",
      "active": true,
      "modified": "2025-11-21 22:43",
      "revision": "1"
    }
  ]
}

