{
  "generator": "Code Snippets v3.9.2",
  "date_created": "2025-11-21 22:43",
  "snippets": [
    {
      "id": 26,
      "name": "gofast_reportes_admin",
      "code": "/***************************************************\n * GOFAST ‚Äì ADMIN REPORTES DE PEDIDOS\n * Shortcode: [gofast_reportes_admin]\n * URL: /admin-reportes\n ***************************************************/\nfunction gofast_reportes_admin_shortcode() {\n    if (session_status() === PHP_SESSION_NONE) {\n        session_start();\n    }\n\n    global $wpdb;\n\n    $tabla = 'servicios_gofast';\n\n    /* ==========================================================\n       0. Validar usuario admin\n    ========================================================== */\n    $usuario = null;\n    if (!empty($_SESSION['gofast_user_id'])) {\n        $uid = (int) $_SESSION['gofast_user_id'];\n        $usuario = $wpdb->get_row(\n            $wpdb->prepare(\n                \"SELECT id, nombre, rol, activo \n                 FROM usuarios_gofast \n                 WHERE id = %d AND activo = 1\",\n                $uid\n            )\n        );\n    }\n\n    if (!$usuario || strtolower($usuario->rol) !== 'admin') {\n        return \"<div class='gofast-box'>\n                    ‚ö†Ô∏è Solo los administradores pueden ver reportes.\n                </div>\";\n    }\n\n    /* ==========================================================\n       1. Filtros (GET)\n    ========================================================== */\n    $estado = isset($_GET['estado']) ? sanitize_text_field($_GET['estado']) : '';\n    $desde = isset($_GET['desde']) ? sanitize_text_field($_GET['desde']) : '';\n    $hasta = isset($_GET['hasta']) ? sanitize_text_field($_GET['hasta']) : '';\n    $mensajero_id = isset($_GET['mensajero_id']) ? (int) $_GET['mensajero_id'] : 0;\n    $buscar = isset($_GET['q']) ? sanitize_text_field($_GET['q']) : '';\n\n    if ($desde && !preg_match('/^\\d{4}-\\d{2}-\\d{2}$/', $desde)) $desde = '';\n    if ($hasta && !preg_match('/^\\d{4}-\\d{2}-\\d{2}$/', $hasta)) $hasta = '';\n\n    // Si no hay fechas, usar √∫ltimo mes por defecto\n    if (!$desde && !$hasta) {\n        $desde = date('Y-m-d', strtotime('-30 days'));\n        $hasta = current_time('Y-m-d');\n    }\n\n    $where = \"1=1\";\n    $params = [];\n\n    if ($estado !== '' && $estado !== 'todos') {\n        $where .= \" AND tracking_estado = %s\";\n        $params[] = $estado;\n    }\n\n    if ($desde !== '') {\n        $where .= \" AND fecha >= %s\";\n        $params[] = $desde . ' 00:00:00';\n    }\n    if ($hasta !== '') {\n        $where .= \" AND fecha <= %s\";\n        $params[] = $hasta . ' 23:59:59';\n    }\n\n    if ($mensajero_id > 0) {\n        $where .= \" AND mensajero_id = %d\";\n        $params[] = $mensajero_id;\n    }\n\n    if ($buscar !== '') {\n        $like = '%' . $wpdb->esc_like($buscar) . '%';\n        $where .= \" AND (nombre_cliente LIKE %s OR telefono_cliente LIKE %s)\";\n        $params[] = $like;\n        $params[] = $like;\n    }\n\n    /* ==========================================================\n       2. Estad√≠sticas\n    ========================================================== */\n    if (!empty($params)) {\n        $sql_stats = $wpdb->prepare(\n            \"SELECT \n                COUNT(*) as total_pedidos,\n                SUM(CASE WHEN tracking_estado = 'entregado' THEN total ELSE 0 END) as total_ingresos,\n                AVG(CASE WHEN tracking_estado = 'entregado' THEN total ELSE NULL END) as promedio_pedido,\n                COUNT(CASE WHEN tracking_estado = 'pendiente' THEN 1 END) as pendientes,\n                COUNT(CASE WHEN tracking_estado = 'en_ruta' THEN 1 END) as en_ruta,\n                COUNT(CASE WHEN tracking_estado = 'entregado' THEN 1 END) as entregados,\n                COUNT(CASE WHEN tracking_estado = 'cancelado' THEN 1 END) as cancelados\n             FROM $tabla \n             WHERE $where\",\n            $params\n        );\n    } else {\n        $sql_stats = \"SELECT \n                COUNT(*) as total_pedidos,\n                SUM(CASE WHEN tracking_estado = 'entregado' THEN total ELSE 0 END) as total_ingresos,\n                AVG(CASE WHEN tracking_estado = 'entregado' THEN total ELSE NULL END) as promedio_pedido,\n                COUNT(CASE WHEN tracking_estado = 'pendiente' THEN 1 END) as pendientes,\n                COUNT(CASE WHEN tracking_estado = 'en_ruta' THEN 1 END) as en_ruta,\n                COUNT(CASE WHEN tracking_estado = 'entregado' THEN 1 END) as entregados,\n                COUNT(CASE WHEN tracking_estado = 'cancelado' THEN 1 END) as cancelados\n             FROM $tabla \n             WHERE $where\";\n    }\n\n    $stats = $wpdb->get_row($sql_stats);\n    $total_ingresos = (float) ($stats->total_ingresos ?? 0);\n    $promedio_pedido = (float) ($stats->promedio_pedido ?? 0);\n\n    // Top mensajeros\n    $top_mensajeros = $wpdb->get_results(\n        $wpdb->prepare(\n            \"SELECT \n                u.id,\n                u.nombre,\n                COUNT(s.id) as total_entregados,\n                SUM(s.total) as total_ingresos\n             FROM $tabla s\n             INNER JOIN usuarios_gofast u ON s.mensajero_id = u.id\n             WHERE $where AND s.tracking_estado = 'entregado'\n             GROUP BY u.id, u.nombre\n             ORDER BY total_entregados DESC\n             LIMIT 10\",\n            $params\n        )\n    );\n\n    // Pedidos por d√≠a (√∫ltimos 30 d√≠as)\n    $pedidos_por_dia = $wpdb->get_results(\n        $wpdb->prepare(\n            \"SELECT \n                DATE(fecha) as dia,\n                COUNT(*) as cantidad,\n                SUM(CASE WHEN tracking_estado = 'entregado' THEN total ELSE 0 END) as ingresos\n             FROM $tabla\n             WHERE fecha >= %s AND fecha <= %s\n             GROUP BY DATE(fecha)\n             ORDER BY dia DESC\n             LIMIT 30\",\n            date('Y-m-d', strtotime('-30 days')) . ' 00:00:00',\n            current_time('Y-m-d') . ' 23:59:59'\n        )\n    );\n\n    /* ==========================================================\n       3. Lista de mensajeros para filtro\n    ========================================================== */\n    $mensajeros = $wpdb->get_results(\n        \"SELECT id, nombre \n         FROM usuarios_gofast\n         WHERE rol = 'mensajero' AND activo = 1\n         ORDER BY nombre ASC\n        \"\n    );\n\n    /* ==========================================================\n       4. Exportar a CSV\n    ========================================================== */\n    if (isset($_GET['export']) && $_GET['export'] === 'csv') {\n        header('Content-Type: text/csv; charset=utf-8');\n        header('Content-Disposition: attachment; filename=\"reporte_pedidos_' . date('Y-m-d') . '.csv\"');\n        \n        $output = fopen('php://output', 'w');\n        \n        // BOM para Excel\n        fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));\n        \n        // Encabezados\n        fputcsv($output, ['ID', 'Fecha', 'Cliente', 'Tel√©fono', 'Origen', 'Total', 'Estado', 'Mensajero']);\n        \n        // Datos\n        $params_export = $params;\n        $params_export[] = 10000; // L√≠mite alto para exportaci√≥n\n        \n        $sql_export = $wpdb->prepare(\n            \"SELECT s.*, u.nombre as mensajero_nombre\n             FROM $tabla s\n             LEFT JOIN usuarios_gofast u ON s.mensajero_id = u.id\n             WHERE $where\n             ORDER BY s.fecha DESC\n             LIMIT %d\",\n            $params_export\n        );\n        \n        $pedidos_export = $wpdb->get_results($sql_export);\n        \n        foreach ($pedidos_export as $p) {\n            fputcsv($output, [\n                $p->id,\n                $p->fecha,\n                $p->nombre_cliente,\n                $p->telefono_cliente,\n                $p->direccion_origen,\n                $p->total,\n                $p->tracking_estado,\n                $p->mensajero_nombre ?: 'Sin asignar'\n            ]);\n        }\n        \n        fclose($output);\n        exit;\n    }\n\n    /* ==========================================================\n       5. HTML\n    ========================================================== */\n    ob_start();\n    ?>\n\n<div class=\"gofast-home\">\n    <div style=\"display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;\">\n        <div>\n            <h1 style=\"margin-bottom:8px;\">üìä Reportes y Estad√≠sticas</h1>\n            <p class=\"gofast-home-text\">\n                Analiza el rendimiento de los pedidos y genera reportes detallados.\n            </p>\n        </div>\n        <a href=\"<?php echo esc_url( home_url('/dashboard-admin') ); ?>\" class=\"gofast-btn-request\" style=\"text-decoration:none;\">\n            ‚Üê Volver al Dashboard\n        </a>\n    </div>\n\n    <!-- =====================================================\n         A) FILTROS\n    ====================================================== -->\n    <div class=\"gofast-box\" style=\"margin-bottom:20px;\">\n        <form method=\"get\" class=\"gofast-pedidos-filtros\">\n            <div class=\"gofast-pedidos-filtros-row\">\n                <div>\n                    <label>Estado</label>\n                    <select name=\"estado\">\n                        <option value=\"todos\"<?php selected($estado, 'todos'); ?>>Todos</option>\n                        <option value=\"pendiente\"<?php selected($estado, 'pendiente'); ?>>Pendiente</option>\n                        <option value=\"asignado\"<?php selected($estado, 'asignado'); ?>>Asignado</option>\n                        <option value=\"en_ruta\"<?php selected($estado, 'en_ruta'); ?>>En Ruta</option>\n                        <option value=\"entregado\"<?php selected($estado, 'entregado'); ?>>Entregado</option>\n                        <option value=\"cancelado\"<?php selected($estado, 'cancelado'); ?>>Cancelado</option>\n                    </select>\n                </div>\n\n                <div>\n                    <label>Desde</label>\n                    <input type=\"date\" name=\"desde\" value=\"<?php echo esc_attr($desde); ?>\">\n                </div>\n\n                <div>\n                    <label>Hasta</label>\n                    <input type=\"date\" name=\"hasta\" value=\"<?php echo esc_attr($hasta); ?>\">\n                </div>\n\n                <div>\n                    <label>Mensajero</label>\n                    <select name=\"mensajero_id\">\n                        <option value=\"0\">Todos</option>\n                        <?php foreach ($mensajeros as $m): ?>\n                            <option value=\"<?= (int) $m->id; ?>\"<?php selected($mensajero_id, $m->id); ?>>\n                                <?= esc_html($m->nombre); ?>\n                            </option>\n                        <?php endforeach; ?>\n                    </select>\n                </div>\n\n                <div>\n                    <label>Buscar</label>\n                    <input type=\"text\" name=\"q\" placeholder=\"Cliente o tel√©fono\" value=\"<?php echo esc_attr($buscar); ?>\">\n                </div>\n\n                <div class=\"gofast-pedidos-filtros-actions\">\n                    <button type=\"submit\" class=\"gofast-btn-mini\">Filtrar</button>\n                    <a href=\"<?php echo esc_url( get_permalink() ); ?>\" class=\"gofast-btn-mini gofast-btn-outline\">Limpiar</a>\n                    <a href=\"<?php echo esc_url( add_query_arg(['export' => 'csv'], get_permalink()) ); ?>\" class=\"gofast-btn-mini\" style=\"background:#4CAF50;color:#fff;\">\n                        üì• Exportar CSV\n                    </a>\n                </div>\n            </div>\n        </form>\n    </div>\n\n    <!-- =====================================================\n         B) ESTAD√çSTICAS PRINCIPALES\n    ====================================================== -->\n    <div class=\"gofast-dashboard-stats\" style=\"display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin:24px 0;\">\n        \n        <div class=\"gofast-box\" style=\"text-align:center;padding:20px;\">\n            <div style=\"font-size:32px;margin-bottom:8px;\">üì¶</div>\n            <div style=\"font-size:28px;font-weight:700;color:#F4C524;margin-bottom:4px;\"><?= number_format($stats->total_pedidos ?? 0); ?></div>\n            <div style=\"font-size:13px;color:#666;\">Total Pedidos</div>\n        </div>\n\n        <div class=\"gofast-box\" style=\"text-align:center;padding:20px;\">\n            <div style=\"font-size:32px;margin-bottom:8px;\">üí∞</div>\n            <div style=\"font-size:28px;font-weight:700;color:#4CAF50;margin-bottom:4px;\">$<?= number_format($total_ingresos, 0, ',', '.'); ?></div>\n            <div style=\"font-size:13px;color:#666;\">Ingresos Totales</div>\n        </div>\n\n        <div class=\"gofast-box\" style=\"text-align:center;padding:20px;\">\n            <div style=\"font-size:32px;margin-bottom:8px;\">üìä</div>\n            <div style=\"font-size:28px;font-weight:700;color:#2196F3;margin-bottom:4px;\">$<?= number_format($promedio_pedido, 0, ',', '.'); ?></div>\n            <div style=\"font-size:13px;color:#666;\">Promedio por Pedido</div>\n        </div>\n\n        <div class=\"gofast-box\" style=\"text-align:center;padding:20px;\">\n            <div style=\"font-size:32px;margin-bottom:8px;\">‚úÖ</div>\n            <div style=\"font-size:28px;font-weight:700;color:#4CAF50;margin-bottom:4px;\"><?= number_format($stats->entregados ?? 0); ?></div>\n            <div style=\"font-size:13px;color:#666;\">Entregados</div>\n        </div>\n\n        <div class=\"gofast-box\" style=\"text-align:center;padding:20px;\">\n            <div style=\"font-size:32px;margin-bottom:8px;\">‚è≥</div>\n            <div style=\"font-size:28px;font-weight:700;color:#ff9800;margin-bottom:4px;\"><?= number_format($stats->pendientes ?? 0); ?></div>\n            <div style=\"font-size:13px;color:#666;\">Pendientes</div>\n        </div>\n\n        <div class=\"gofast-box\" style=\"text-align:center;padding:20px;\">\n            <div style=\"font-size:32px;margin-bottom:8px;\">‚ùå</div>\n            <div style=\"font-size:28px;font-weight:700;color:#f44336;margin-bottom:4px;\"><?= number_format($stats->cancelados ?? 0); ?></div>\n            <div style=\"font-size:13px;color:#666;\">Cancelados</div>\n        </div>\n\n    </div>\n\n    <!-- =====================================================\n         C) TOP MENSAJEROS\n    ====================================================== -->\n    <?php if (!empty($top_mensajeros)): ?>\n        <div class=\"gofast-box\" style=\"margin-bottom:20px;\">\n            <h3 style=\"margin-top:0;\">üèÜ Top Mensajeros</h3>\n            <div class=\"gofast-table-wrap\">\n                <table class=\"gofast-table\">\n                    <thead>\n                        <tr>\n                            <th>#</th>\n                            <th>Mensajero</th>\n                            <th>Pedidos Entregados</th>\n                            <th>Total Ingresos</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        <?php foreach ($top_mensajeros as $idx => $m): ?>\n                            <tr>\n                                <td><?= $idx + 1; ?></td>\n                                <td><?= esc_html($m->nombre); ?></td>\n                                <td><?= number_format($m->total_entregados); ?></td>\n                                <td>$<?= number_format($m->total_ingresos, 0, ',', '.'); ?></td>\n                            </tr>\n                        <?php endforeach; ?>\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    <?php endif; ?>\n\n    <!-- =====================================================\n         D) PEDIDOS POR D√çA (√öLTIMOS 30 D√çAS)\n    ====================================================== -->\n    <?php if (!empty($pedidos_por_dia)): ?>\n        <div class=\"gofast-box\">\n            <h3 style=\"margin-top:0;\">üìà Pedidos por D√≠a (√öltimos 30 d√≠as)</h3>\n            <div class=\"gofast-table-wrap\">\n                <table class=\"gofast-table\">\n                    <thead>\n                        <tr>\n                            <th>Fecha</th>\n                            <th>Cantidad de Pedidos</th>\n                            <th>Ingresos</th>\n                        </tr>\n                    </thead>\n                    <tbody>\n                        <?php foreach ($pedidos_por_dia as $dia): ?>\n                            <tr>\n                                <td><?= esc_html( date_i18n('d/m/Y', strtotime($dia->dia)) ); ?></td>\n                                <td><?= number_format($dia->cantidad); ?></td>\n                                <td>$<?= number_format($dia->ingresos, 0, ',', '.'); ?></td>\n                            </tr>\n                        <?php endforeach; ?>\n                    </tbody>\n                </table>\n            </div>\n        </div>\n    <?php endif; ?>\n\n</div>\n\n<?php\n    return ob_get_clean();\n}\nadd_shortcode('gofast_reportes_admin', 'gofast_reportes_admin_shortcode');\n",
      "active": true,
      "modified": "2025-11-21 22:43",
      "revision": "1"
    }
  ]
}

